{"version":3,"mappings":"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","names":["LOG_DRAG","COLORS","styled","text","color","log","label","message","data","prefix","style","logDragStart","pieceId","startX","startY","gridPosition","logDragMove","currentX","currentY","gridCell","isValid","logPlacementValid","row","col","cellsFilled","logLineCleared","lines","cellsCleared","logScoreAdded","points","reason","logGameOver","finalScore","piecesUsed","logPerformanceStart","operation","logPerformanceEnd","duration","logWarning","details","logGameStateSnapshot","state","_gameStartLogged","logGameStart","resetGameStartFlag","logGameMode","mode","GRID_ROWS","GRID_COLS","INVALID_PLACEMENT_SHAKE_DURATION","PIECE_SHAPES","createEmptyGrid","rows","cols","getDefaultDragState","gameState","fillRandomBlocks","grid","ratio","total","toFill","filled","r","c","resetCombo","resetDragState","setScore","newScore","setHighScore","newHighScore","initializeState","currentHighScore","AIHintEngine","piece","currentGrid","context","userPreferences","strategicSituations","hints","weightedHints","optimizedHints","occupiedCells","fragmentationLevel","riskLevel","opportunityScore","playHistory","shape","analysis","futureGrid","spaceOptimization","flexibilityScore","comboAnalysis","riskAreas","defenseScore","riskAnalysis","hint","adjustedScore","neuralWeights","features","mlScore","count","b","typesSeen","diverseHints","remaining","h","presentedHints","chosenHint","outcome","occupied","fragments","nr","nc","occupancy","fragmentation","opportunities","emptyCells","cell","opportunity","score","confidence","reasoning","futureOpportunities","testGrid","completedLines","almostComplete","efficiency","benefits","sr","sc","gridRow","gridCol","completed","columnComplete","currentLines","potentialCombos","surroundingOccupied","reliability","explanation","mitigatedRisks","risk","area","critical","currentRisk","newRisk","riskReduction","weights","typeWeight","hintType","recentMoves","move","PieceUnlockSystem","currentScore","newUnlocks","tiers","tier","tierNames","tierEmojis","groupedByTier","unlock","pieces","p","notification","audio","milestones","milestone","unlockedCount","percentage","nextUnlock","pieceUnlockSystem","domCache","placementCache","clearRowOrColumn","index","isRow","shiftColumn","columnIndex","direction","normalizedDirection","values","first","last","clearAllCaches","clearDOMCache","isInBounds","getRandomPiece","availablePieces","rotatePiece","randomIndex","selectedPiece","i","populateInitialPieces","replaceUsedPiece","pieceData","minR","maxR","minC","height","newShape","newMinR","newMinC","normalizedShape","flipPieceHorizontally","maxC","width","isValidPlacement","pieceShape","startRow","startCol","placePieceOnGrid","checkAndClearLines","placedPieceColor","clearedRows","clearedCols","isColFull","totalLinesCleared","animationColor","getBaseColor","clearedCellsSet","cellsToAnimate","str","pointsEarned","calculateLineClearScore","result","combo","baseScore","comboBonus","updateGameOverState","activePieces","canPieceBePlaced","rot","saveGameState","currentState","undoLastMove","previousState","isLineComplete","getLineCells","cells","rotateSpecificPiece","pieceIndex","colorNumber","findValidPlacements","validPlacements","findBestPlacements","shapeKey","gridChecksum","calculateGridChecksum","cacheKey","allValidPlacements","scoredPlacements","placement","calculatePlacementScore","a","bestPlacements","hash","completionBonus","calculateCompletionPotential","adjacencyBonus","calculateAdjacencyBonus","potential","occupiedRows","occupiedCols","filledCells","fillPercentage","adjacentCount","dr","dc","checkRow","checkCol","audioContext","isAudioInitialized","initAudioContext","playTone","frequency","volume","type","allowWhenInactive","oscillator","gainNode","playHapticFeedback","playPlaceSound","playClearSound","numLines","playGameOverSound","playRotateSound","playUIButtonSound","playPauseSound","playResumeSound","playRestartSound","playPieceAppearSound","AnimationPool","size","item","animPool","dom","cellElements","highlightedCells","lastPieceColor","PIECE_ANIMATION_DURATION","cacheDOMElements","id","createUnlockProgressIndicator","existingProgress","progressDiv","onClickOutside","e","cleanup","autoDismissId","updateUnlockProgress","createGridDOM","rowElements","blockWrapper","createPieceElement","pieceElement","pieceGrid","createPieceGridElement","maxRow","maxCol","visualGrid","block","hasPieceChanged","existingElement","newPieceData","shouldBeEmpty","isCurrentlyEmpty","existingId","nextId","animatePieceEntry","isInitialLoad","allowSound","delay","audio.playPieceAppearSound","rebuildPiecesContainer","animateAll","updateGridDisplay","updates","cellValue","cellElement","needsCreation","newClass","clearPlacementFlag","animatePlacement","centerR","centerC","cellsWithDelay","obj","distance","_a","jitter","finalDelay","updatePiecesDisplay","renderedPieces","nextPieces","changedIndices","soundPlayed","newElement","reference","updateScoreDisplay","scoreEl","progressInfo","progressFill","progressText","nextUnlockText","updateOverlays","showGameOver","playAgainBtn","newBtn","__vitePreload","gameLogic","logic","main","err","updateControlButtons","showComboMessage","comboCount","comboMsg","cleanupOldFloatingScores","floatingScores","now","maxAge","element","created","createDraggedPieceClone","blockSize","cloneBlock","gap","cloneGrid","computed","gapValue","parsedGap","cloneStyle","paddingX","paddingY","hideDraggedPieceClone","shakeDraggedPieceClone","updateDraggedPiecePosition","clientX","clientY","offsetX","offsetY","metricsCached","cloneWidth","cloneHeight","measuredBlockSize","measuredGap","measuredPaddingX","measuredPaddingY","measuredWidth","measuredHeight","anchorXInClone","anchorYInClone","rawLeft","rawTop","clearHighlights","showGhostAndHighlight","highlightClass","cls","highlightClearableLines","clearLineHighlights","cleanupOldParticles","particles","particle","timeoutId","__perfLite","createMagicStars","container","colors","star","createSpecialShapes","createSparkles","sparkle","activateMagicUniverseBackground","bgContainer","__pb","__rb","applyStatusBar","theme","S","_b","t","initDebugOverlay","n","o","s","isNative","readyNativeUI","attachAppLifecycle","A","isActive","ev","hapticTap","H","hapticSuccess","hapticHeavy","LOGIC_DELAY_MS","VISUAL_CLEANUP_DELAY_MS","getFrameColor","dominantColor","isDarkTheme","baseColor","brightness","getColorBrightness","lightenPercent","lightenColor","extractCellColors","rowOrColIndex","pieceColor","colorCount","idx","filledClass","maxCount","defaults","hex","percent","num","g","getGridCellBorderRadius","gameGrid","fallbackVar","fallback","sampleCell","triggerGameAreaShake","normalCls","strongCls","useStrong","onAnimEnd","playGalaxyRowClear","rowIndex","gameAreaParent","onComplete","createClearBar","animatedBlocks","blockCount","shakeDuration","isStrong","target","playGalaxyColClear","colIndex","createClearBarColumn","parentRect","gridStyle","firstCellRect","targetCellIndex","topInParent","leftInParent","barWidth","barBorderRadius","barContainer","inner","particleCount","isMobile","isLowEnd","frameColor","baseSize","left","dur","dxStart","dyStart","dxEnd","dyEnd","gameAreaRect","targetCellRect","lastCellRect","barHeight","top","LINE_DELAY","OVERLAY_HOST_ID","overlayHostElement","ensureOverlayHost","host","alignOverlayHost","gridRect","overlay","hostRect","animateLineClearSpectra","ctx","boardSize","onClearRow","onClearCol","onDone","syncStart","metrics","computeGridMetrics","tasks","order","line","buildRowData","resolve","runRowAnimation","buildColData","runColAnimation","totalRows","x","y","cellCenter","createCellOverlay","particleEngine","onLogicalClear","onResolved","gameArea","cleanupLineOverlays","canvas","cellW","cellH","overlayHost","rect","colorDark1","colorDark2","colorCoreLight","colorCoreMid","colorBevelLight","colorBevelDark","borderRadius","cleanupOverlayHostIfEmpty","parent","initMain","boot","initializeSettings","initializeGame","initializeLandingPageEffects","selectedGameMode","whenDomReady","callback","specialActionListenersAttached","legacyLandingSetupDone","updateLandingPageStats","highScoreEl","savedHighScore","piecesUnlockedEl","unlockedPieces","achievementsEl","achievements","logger.resetGameStartFlag","logger.logGameStart","cleanupGameResources","gameContainer","render.cacheDOMElements","listenersAttached","togglePause","addNeonClickEffect","handleRestart","render.createGridDOM","logger.logGameMode","logic.populateInitialPieces","logger.logPerformanceStart","landingPage","render.createUnlockProgressIndicator","render.updateGridDisplay","render.updatePiecesDisplay","render.updateScoreDisplay","render.updateControlButtons","updateSpecialActionButtons","attachPieceEventListeners","attachGridEventListeners","logger.logPerformanceEnd","button","audio.playUIButtonSound","themeToggleLanding","btn","audio.playPauseSound","audio.playResumeSound","logger.logGameStateSnapshot","logger.log","audio.playRestartSound","handlePieceClick","event","logic.rotateSpecificPiece","audio.playRotateSound","showSpecialModeMessage","flipped","logic.flipPieceHorizontally","__lastMouseEvent","__mouseRAF","handleMouseMove","render.updateDraggedPiecePosition","dx","dy","_handleMouseMoveInner","pos","getCellFromPoint","render.clearHighlights","logic.isValidPlacement","logger.LOG_DRAG","logger.logDragMove","render.showGhostAndHighlight","handleMouseUp","finishDrag","lastTargetRow","lastTargetCol","processSuccessfulPlacement","processFailedPlacement","cacheGridMetrics","cellSize","probe","cs","padL","padT","bordL","bordT","step","gridLeft","gridTop","gridWidth","gridHeight","handleDragStart","audio.initAudioContext","audio.playHapticFeedback","logger.logDragStart","pieceRect","clickXInPiece","clickYInPiece","closestBlock","blockRect","blockCenterX","blockCenterY","render.createDraggedPieceClone","handleDragOver","handleDrop","handleDragEnd","handleDragEndFallback","cleanupTouchListeners","__dragRAF","handleTouchMove","handleTouchEnd","__lastTouchEvent","touch","_handleTouchMoveInner","handleTouchStart","touchXInPiece","touchYInPiece","TOUCH_OFFSET_Y","logger.logPlacementValid","logic.saveGameState","logic.placePieceOnGrid","audio.playPlaceSound","logic.replaceUsedPiece","clearResult","logic.checkAndClearLines","totalLines","logger.logLineCleared","logger.logScoreAdded","handleLineClearEffects","logic.updateGameOverState","audio.playGameOverSound","logger.logGameOver","render.updateOverlays","checkSpecialRewards","logger.logWarning","render.shakeDraggedPieceClone","render.hideDraggedPieceClone","render.animatePlacement","render.clearPlacementFlag","audio.playClearSound","visualPieceColor","firstAnim","render.showComboMessage","rotateBtn","undoBtn","clearLineBtn","flipBtn","rotateCountEl","undoCountEl","clearLineCountEl","flipCountEl","setupSpecialActionButtons","handleRotateAction","handleUndoAction","logic.undoLastMove","handleClearLineAction","activating","render.highlightClearableLines","render.clearLineHighlights","handleFlipAction","legacyRotateBtn","fabRotateBtn","legacyUndoBtn","fabUndoBtn","legacyClearLineBtn","fabClearLineBtn","legacyFlipBtn","fabFlipBtn","handleDelegatedPieceClick","syntheticEvent","handleDelegatedPieceTouch","piecesContainer","shouldDisableDrag","setupLegacyLandingFlow","render.dom","classicModeCard","collectionModeCard","feedbackElement","selectGameMode","card","savedMode","specialActions","handleGridCellClick","clearedCells","shouldClearRow","shouldClearCol","autoHideDelay","messageElement","displayMsg","render.cleanupOldParticles","render.cleanupOldFloatingScores","unlockProgress","nativeBridge","m","gc","lastBreakpoint","resizeDebounce","currentBreakpoint","mobileCssLink","desktopCssLink","el"],"ignoreList":[],"sources":["../../js/logger.js","../../js/constants.js","../../js/state.js","../../js/aiHints.js","../../js/pieceUnlockSystem.js","../../js/gameLogic.js","../../js/audio.js","../../js/render.js","../../js/backgroundEffects.js","../../js/statusBarTheme.js","../../js/debugOverlay.js","../../js/nativeBridge.js","../../js/animationAdapters/galaxyRowClear.js","../../js/rowClearSpectra.js","../../js/main.js"],"sourcesContent":["/**\n * Game Logger - Monitors all important game events and state changes\n * Useful for debugging, performance analysis, and understanding game flow\n */\n\n// Enable/disable logging globally\nexport const LOG_ENABLED = true;\nexport const LOG_DRAG = true;\nexport const LOG_PLACEMENT = true;\nexport const LOG_SCORE = true;\nexport const LOG_PERFORMANCE = true;\nexport const LOG_GRID = true;\nexport const LOG_ERRORS = true;\n\n// Color coding for console\nconst COLORS = {\n    DRAG: '#FF6B6B',      // Red\n    PLACEMENT: '#4ECDC4', // Teal\n    SCORE: '#FFE66D',     // Yellow\n    PERF: '#95E1D3',      // Mint\n    GRID: '#A8D8EA',      // Light Blue\n    ERROR: '#FF4444',     // Dark Red\n    SUCCESS: '#66BB6A',   // Green\n    INFO: '#90CAF9'       // Bright Blue\n};\n\nfunction styled(text, color) {\n    return `%c${text}`;\n}\n\nexport function log(label, message, color, data = null) {\n    if (!LOG_ENABLED) return;\n    \n    const timestamp = new Date().toLocaleTimeString('en-US', { \n        hour12: false, \n        hour: '2-digit', \n        minute: '2-digit', \n        second: '2-digit',\n        fractionalSecondDigits: 3\n    });\n    \n    const prefix = `[${timestamp}] ${label}`;\n    const style = `color: ${color}; font-weight: bold; font-size: 12px;`;\n    \n    if (data) {\n        console.log(styled(prefix, color), style, message, data);\n    } else {\n        console.log(styled(prefix, color), style, message);\n    }\n}\n\n// ============= DRAG & DROP LOGGING =============\nexport function logDragStart(pieceId, startX, startY, gridPosition) {\n    if (!LOG_DRAG) return;\n    log('DRAG START', `Piece #${pieceId} from (${startX}, ${startY})`, COLORS.DRAG, { gridPosition });\n}\n\nexport function logDragMove(pieceId, currentX, currentY, gridCell, isValid) {\n    if (!LOG_DRAG) return;\n    const status = isValid ? ' VALID' : ' INVALID';\n    log('DRAG MOVE', `${status} - Piece #${pieceId}  Cell (${gridCell.row}, ${gridCell.col})`, \n        isValid ? COLORS.SUCCESS : '#FF9800', \n        { pos: `${currentX},${currentY}` });\n}\n\nexport function logDragEnd(pieceId, gridCell, isPlaced) {\n    if (!LOG_DRAG) return;\n    const result = isPlaced ? ' PLACED' : ' CANCELED';\n    log('DRAG END', `${result} - Piece #${pieceId}`, \n        isPlaced ? COLORS.SUCCESS : '#FF9800');\n}\n\n// ============= PLACEMENT LOGGING =============\nexport function logPlacementAttempt(pieceId, row, col, rotations) {\n    if (!LOG_PLACEMENT) return;\n    log('PLACEMENT', `Attempting piece #${pieceId} at (${row}, ${col}) [${rotations} rotations]`, \n        COLORS.PLACEMENT);\n}\n\nexport function logPlacementValid(pieceId, row, col, cellsFilled) {\n    if (!LOG_PLACEMENT) return;\n    log('PLACEMENT ', `Valid placement - Piece #${pieceId} fills ${cellsFilled} cells`, \n        COLORS.SUCCESS, { position: `(${row}, ${col})` });\n}\n\nexport function logPlacementInvalid(pieceId, row, col, reason) {\n    if (!LOG_PLACEMENT) return;\n    log('PLACEMENT ', `Invalid - ${reason}`, '#FF9800', \n        { piece: pieceId, position: `(${row}, ${col})` });\n}\n\nexport function logLineCleared(lines, cellsCleared) {\n    if (!LOG_PLACEMENT) return;\n    log('LINE CLEAR', `${lines.length} line(s) cleared! ${cellsCleared} cells freed`, \n        COLORS.SUCCESS, { lines: lines.join(', ') });\n}\n\n// ============= SCORE LOGGING =============\nexport function logScoreAdded(points, reason) {\n    if (!LOG_SCORE) return;\n    log('SCORE +', `+${points} points (${reason})`, COLORS.SCORE, { totalAfter: 'see game state' });\n}\n\nexport function logCombo(multiplier, totalBonus) {\n    if (!LOG_SCORE) return;\n    log('COMBO!', `${multiplier}x multiplier! +${totalBonus} bonus`, \n        COLORS.SUCCESS, { multiplier });\n}\n\nexport function logGameOver(finalScore, piecesUsed) {\n    if (!LOG_SCORE) return;\n    log('GAME OVER', `Final Score: ${finalScore} (${piecesUsed} pieces used)`, \n        '#FF4444', { finalScore, piecesUsed });\n}\n\n// ============= PERFORMANCE LOGGING =============\nexport function logPerformanceStart(operation) {\n    if (!LOG_PERFORMANCE) return;\n    performance.mark(`${operation}-start`);\n}\n\nexport function logPerformanceEnd(operation) {\n    if (!LOG_PERFORMANCE) return;\n    try {\n        performance.mark(`${operation}-end`);\n        performance.measure(operation, `${operation}-start`, `${operation}-end`);\n        const measure = performance.getEntriesByName(operation)[0];\n        const duration = measure.duration.toFixed(2);\n        \n        const color = duration > 16 ? '#FF6B6B' : COLORS.PERF;\n        log('PERF', `${operation}: ${duration}ms`, color);\n        \n        performance.clearMarks(`${operation}-start`);\n        performance.clearMarks(`${operation}-end`);\n        performance.clearMeasures(operation);\n    } catch (e) {\n        console.warn('Performance measurement failed:', e);\n    }\n}\n\n// ============= GRID STATE LOGGING =============\nexport function logGridState(gridData, emptyCount) {\n    if (!LOG_GRID) return;\n    log('GRID STATE', `${emptyCount} empty cells remaining`, COLORS.GRID, \n        { occupied: (100 - emptyCount), coverage: `${((100-emptyCount)/100*100).toFixed(1)}%` });\n}\n\nexport function logAvailableMoves(moveCount) {\n    if (!LOG_GRID) return;\n    const status = moveCount > 0 ? ` ${moveCount} moves` : ' NO MOVES';\n    log('MOVES', status, moveCount > 0 ? COLORS.SUCCESS : '#FF9800');\n}\n\nexport function logGridCellOccupied(row, col, pieceId) {\n    if (!LOG_GRID) return;\n    log('GRID CELL', `Cell (${row}, ${col}) occupied by piece #${pieceId}`, '#90CAF9');\n}\n\n// ============= ERROR LOGGING =============\nexport function logError(errorType, message, details = null) {\n    if (!LOG_ERRORS) return;\n    log('ERROR!', `${errorType}: ${message}`, COLORS.ERROR, details);\n    console.trace('Error stacktrace:');\n}\n\nexport function logWarning(message, details = null) {\n    if (!LOG_ERRORS) return;\n    log('WARNING', message, '#FFA500', details);\n}\n\n// ============= STATE LOGGING =============\nexport function logGameStateSnapshot(state) {\n    if (!LOG_ENABLED) return;\n    \n    console.group('%c GAME STATE SNAPSHOT', `color: ${COLORS.INFO}; font-weight: bold;`);\n    console.log('Score:', state.score);\n    console.log('High Score:', state.highScore);\n    console.log('Game Over:', state.isGameOver);\n    console.log('Paused:', state.isPaused);\n    console.log('Combo Multiplier:', state.currentComboMultiplier);\n    console.log('Grid Empty Cells:', state.gridEmptyCellCount);\n    console.log('Dragging:', state.dragState.isDragging);\n    console.groupEnd();\n}\n\nexport function logMoveHistory(moves) {\n    if (!LOG_ENABLED) return;\n    \n    console.group('%c MOVE HISTORY', `color: ${COLORS.INFO}; font-weight: bold;`);\n    moves.forEach((move, idx) => {\n        console.log(`${idx + 1}. Piece #${move.pieceId}  (${move.row}, ${move.col}) = +${move.pointsEarned}`);\n    });\n    console.groupEnd();\n}\n\n// ============= INITIALIZATION =============\nlet _gameStartLogged = false; // Prevent duplicate logging on resume\n\nexport function logGameStart() {\n    if (!LOG_ENABLED || _gameStartLogged) return;\n    _gameStartLogged = true; // Mark that we've logged start\n    // Note: console.clear() blocked by 'Preserve log' setting - using separator instead\n    console.log('%c' + '='.repeat(80), `color: ${COLORS.SUCCESS}; font-size: 11px;`);\n    console.log('%c BLOKUS GAME STARTED', `color: ${COLORS.SUCCESS}; font-size: 16px; font-weight: bold;`);\n    console.log('%cLogger enabled - monitoring all game events', `color: ${COLORS.INFO};`);\n}\n\nexport function resetGameStartFlag() {\n    _gameStartLogged = false; // Reset for next full game session\n}\n\nexport function logGameMode(mode) {\n    if (!LOG_ENABLED) return;\n    log('GAME MODE', `Mode: ${mode}`, COLORS.INFO);\n}\n\n// ============= DETAILED PERFORMANCE TIMING GUIDE =============\n/**\n * Guide for interpreting detailed performance timings\n * Use this to understand what console.time/timeEnd logs mean\n */\nexport function logPerformanceGuide() {\n    if (!LOG_ENABLED) return;\n    \n    console.group('%c DETAILED PERFORMANCE TIMING GUIDE', `color: ${COLORS.PERF}; font-weight: bold; font-size: 14px;`);\n    \n    console.log('%cPLACEMENT TIMINGS:', 'color: #FFE66D; font-weight: bold;');\n    console.log('   placement:save-state: Time to save game state for undo');\n    console.log('   placement:place-piece: Time to add piece to grid array');\n    console.log('   placement:replace-piece: Time to generate new random piece');\n    console.log('   placement:detect-lines: Time to scan for completed lines (CRITICAL)');\n    console.log('   placement:animate-lines: Time for line clear animation');\n    console.log('   placement:update-state: Time to update game state after clears');\n    console.log('   placement:finish-drag: Time to reset UI after placement');\n    console.log('   placement:finish-drag-no-clear: Same as above but without line clears');\n    \n    console.log('%cFINISH DRAG TIMINGS:', 'color: #FFE66D; font-weight: bold;');\n    console.log('   finishDrag:total: Total time for all cleanup and UI updates');\n    console.log('   finishDrag:hide-elements: Hide clone and highlights');\n    console.log('   finishDrag:reset-state: Reset drag state object');\n    console.log('   finishDrag:update-grid: Redraw entire game grid');\n    console.log('   finishDrag:animate-placement: Show placement animation');\n    console.log('   finishDrag:update-pieces: Refresh piece display and event listeners');\n    console.log('   finishDrag:update-ui: Update score, buttons, overlays');\n    \n    console.log('%cDRAG MOVEMENT TIMINGS (per frame):', 'color: #FFE66D; font-weight: bold;');\n    console.log('   drag:hit-test: Total time for hit-testing and validation');\n    console.log('   drag:validate-placement: Time to check if piece placement is valid');\n    console.log('   drag:highlight: Time to update ghost piece and highlights');\n    console.log('   touch:hit-test: Same as drag:hit-test but for touch events');\n    console.log('   touch:validate-placement: Same as drag:validate-placement but for touch');\n    console.log('   touch:highlight: Same as drag:highlight but for touch');\n    \n    console.log('%c PERFORMANCE TARGETS:', 'color: #66BB6A; font-weight: bold;');\n    console.log('   placement:detect-lines < 10ms (critical - runs on every placement)');\n    console.log('   drag:hit-test < 16ms (must complete in one frame)');\n    console.log('   finishDrag:total < 50ms (should be much faster)');\n    console.log('   drag:validate-placement < 5ms (bottleneck for smoothness)');\n    \n    console.groupEnd();\n}\n","// js/constants.js\n\n// --- Grid Dimensions ---\nexport const GRID_ROWS = 10;\nexport const GRID_COLS = 10;\n\n// --- Timing & Animations (in milliseconds) ---\nexport const COMBO_MESSAGE_DURATION = 1500;\nexport const GRID_CLEAR_ANIMATION_DELAY = 300;\nexport const GRID_RENDER_AFTER_CLEAR_DELAY = 400; // Duhet t jet > GRID_CLEAR_ANIMATION_DELAY\nexport const INVALID_PLACEMENT_SHAKE_DURATION = 400;\n\n// --- Piece Definitions ---\n// Pieces are now managed by PieceUnlockSystem\n// This maintains backward compatibility while allowing dynamic piece management\nexport const PIECE_SHAPES = [\n    { shape: [[0, 0]], color: 1, size: 1, name: '1x1' },\n    { shape: [[0, 0], [0, 1]], color: 2, size: 2, name: '1x2' },\n    { shape: [[0, 0], [1, 0]], color: 2, size: 2, name: '2x1' },\n    { shape: [[0, 0], [0, 1], [0, 2]], color: 3, size: 3, name: '1x3' },\n    { shape: [[0, 0], [1, 0], [2, 0]], color: 3, size: 3, name: '3x1' },\n    { shape: [[0, 0], [0, 1], [0, 2], [0, 3]], color: 4, size: 4, name: '1x4' },\n    { shape: [[0, 0], [1, 0], [2, 0], [3, 0]], color: 4, size: 4, name: '4x1' },\n    { shape: [[0, 0], [0, 1], [0, 2], [0, 3], [0, 4]], color: 5, size: 5, name: '1x5' },\n    { shape: [[0, 0], [1, 0], [2, 0], [3, 0], [4, 0]], color: 5, size: 5, name: '5x1' },\n    { shape: [[0, 0], [0, 1], [1, 0], [1, 1]], color: 6, size: 4, name: '2x2' },\n    { shape: [[0,0],[0,1],[0,2],[1,0],[1,1],[1,2],[2,0],[2,1],[2,2]], color: 7, size: 9, name: '3x3'},\n    { shape: [[0, 0], [1, 0], [2, 0], [2, 1]], color: 1, size: 4, name: 'L4_1' },\n    { shape: [[0, 0], [1, 0], [0, 1], [0, 2]], color: 1, size: 4, name: 'L4_2' },\n    { shape: [[0, 1], [1, 0], [1, 1], [1, 2]], color: 2, size: 4, name: 'T4' },\n    { shape: [[0, 0], [0, 1], [1, 1], [1, 2]], color: 3, size: 4, name: 'Z4' },\n    { shape: [[0, 1], [1, 0], [1, 1], [2, 0]], color: 3, size: 4, name: 'Z4_vert' }\n];\n\n// --- Theming ---\n","// State structure for the game. Comments cleaned for clarity.\n\nimport { GRID_ROWS, GRID_COLS } from './constants.js';\n\nexport function createEmptyGrid(rows = GRID_ROWS, cols = GRID_COLS) {\n    return Array.from({ length: rows }, () => Array(cols).fill(0));\n}\n\nfunction getDefaultDragState() {\n    return {\n        isDragging: false,\n        pieceIndex: -1,\n        pieceSourceElement: null,\n        offsetX: 0,\n        offsetY: 0,\n        touchIdentifier: null,\n    touchOffsetY: 0,\n        lastTargetRow: undefined,\n        lastTargetCol: undefined,\n        blockSize: 30,\n        gap: 0,\n        paddingX: 0,\n        paddingY: 0,\n        metricsCached: false,\n        cloneWidth: 80,\n        cloneHeight: 80,\n        startX: 0,\n        startY: 0,\n        startTime: 0,\n        hasMoved: false,\n        // Grid metrics caching for performance optimization (used in getCellFromPoint)\n        gridMetricsCached: false,\n        gridRect: { left: 0, top: 0 },\n        cellSize: 0,\n        step: 0,\n        gridPadL: 0,\n        gridPadT: 0,\n        gridBordL: 0,\n        gridBordT: 0,\n    };\n}\n\n// Objekti kryesor i gjendjes\nexport const gameState = {\n    grid: [],\n    score: 0,\n    highScore: 0,\n    isGameOver: false,\n    isPaused: false,\n    currentPieces: [],\n    combo: {\n        count: 0,\n        timeoutId: null\n    },\n    dragState: getDefaultDragState(),\n    rotateTokens: 0,\n    undoTokens: 0,\n    clearLineTokens: 0,\n    flipTokens: 0,\n    swapTokens: 0,\n    // Cells of the most recently placed piece for animation\n    lastPlacementCells: [],\n    // Shtuar pr veprime speciale\n    gameHistory: [], // Pr undo functionality\n    specialModes: {\n        rotateMode: false,\n        undoMode: false, // Player can undo one move\n        clearLineMode: false,\n        flipMode: false, // Player can flip piece 180\n        isWaitingForRotate: false,\n        isWaitingForFlip: false\n    }\n};\n\n/**\n * Mbush nj prqindje t caktuar t fushs me blloqe rastsore\n * @param {array} grid - matrica e lojs\n * @param {number} ratio - prqindja (0-1) e blloqeve fillestare\n */\nfunction fillRandomBlocks(grid, ratio) {\n    const rows = grid.length;\n    const cols = grid[0].length;\n    const total = rows * cols;\n    const toFill = Math.floor(total * ratio);\n    let filled = 0;\n    while (filled < toFill) {\n        const r = Math.floor(Math.random() * rows);\n        const c = Math.floor(Math.random() * cols);\n        if (grid[r][c] === 0) {\n            // vendos ngjyr rastsore 1-7\n            grid[r][c] = Math.ceil(Math.random() * 7);\n            filled++;\n        }\n    }\n}\n\n// Funksion ndihms pr t resetuar combo\nexport function resetCombo() {\n    if (gameState.combo.timeoutId) {\n        clearTimeout(gameState.combo.timeoutId);\n    }\n    gameState.combo.count = 0;\n    gameState.combo.timeoutId = null;\n}\n\n// Funksion ndihms pr t resetuar dragState\nexport function resetDragState() {\n    gameState.dragState = getDefaultDragState();\n}\n\n// Funksion pr t vendosur pikt\nexport function setScore(newScore) {\n    gameState.score = newScore;\n}\n\n// Funksion pr t vendosur highScore\nexport function setHighScore(newHighScore) {\n    gameState.highScore = newHighScore;\n}\n\n// Funksion pr t inicializuar ose resetuar gjendjen e lojs\nexport function initializeState() {\n    // Ruaj high score, reset-o gjithka tjetr\n    const currentHighScore = localStorage.getItem('blokusHighScore') ? parseInt(localStorage.getItem('blokusHighScore')) : 0;\n\n    gameState.grid = createEmptyGrid();\n    setScore(0);\n    setHighScore(currentHighScore);\n    gameState.isGameOver = false;\n    gameState.isPaused = false;\n    gameState.currentPieces = [];\n    resetCombo();\n    resetDragState();\n    \n    // Reset special action states\n    gameState.gameHistory = [];\n    gameState.specialModes = {\n        rotateMode: false,\n        undoMode: false, // Player can undo one move\n        clearLineMode: false,\n        flipMode: false, // Player can flip piece 180\n        isWaitingForRotate: false,\n        isWaitingForFlip: false\n    };\n    \n    // N Classic Mode, mbush rastsisht nj prqindje t fushs me blloqe parazgjedhje\n    const selectedMode = localStorage.getItem('selectedGameMode') || 'collection';\n    if (selectedMode === 'classic') {\n        fillRandomBlocks(gameState.grid, 0.2);\n    }\n    // Starting tokens for all players (mobile, desktop, production)\n    // Players earn additional tokens during gameplay as rewards\n    // Every 1000 points = 1 rotate token\n    // Every 2000 points = 1 undo token\n    // Combo >= 4 = 1 clear line token\n    // Every 3000 points = 1 hint token\n    // Flip tokens are earned through special events/milestones\n    gameState.rotateTokens = 1;\n    gameState.undoTokens = 1;\n    gameState.clearLineTokens = 1;\n    gameState.flipTokens = 1;\n    gameState.swapTokens = 0;\n    // Reset placement animation cells\n    gameState.lastPlacementCells = [];\n}","// AI-Enhanced Hints System pr lojn Tetris/Blokus\n// Ky sistem analizon stilin e lojs s prdoruesit dhe jep hints inteligjente\n\nimport { gameState } from './state.js';\nimport { GRID_ROWS, GRID_COLS } from './constants.js';\n\n/**\n * AI-Powered Hint Engine q mson nga lojrat e prdoruesit\n */\nexport class AIHintEngine {\n    constructor() {\n        this.userPlayStyle = this.loadUserPlayStyle();\n        this.gameAnalytics = this.loadGameAnalytics();\n        this.learningData = this.loadLearningData();\n    }\n\n    /**\n     * Gjneron hints inteligjente bazuar n AI analysis\n     */\n    generateSmartHints(piece, currentGrid) {\n        const context = this.analyzeGameContext(currentGrid);\n        const userPreferences = this.analyzeUserPreferences();\n        const strategicSituations = this.identifyStrategicSituations(currentGrid);\n        \n        // Multi-layered analysis\n        const hints = [\n            ...this.analyzeLineCompletionPotential(piece, currentGrid),\n            ...this.analyzeFutureSpaceOptimization(piece, currentGrid),\n            ...this.analyzeComboSetupOpportunities(piece, currentGrid),\n            ...this.analyzeDefensivePositioning(piece, currentGrid),\n            ...this.analyzeRiskMitigation(piece, currentGrid)\n        ];\n\n        // AI Weight Application bazuar n user behavior\n        const weightedHints = this.applyAIWeights(hints, context, userPreferences);\n        \n        // Machine Learning Optimization\n        const optimizedHints = this.applyMLOptimization(weightedHints, strategicSituations);\n        \n        return this.selectBestHints(optimizedHints, 3);\n    }\n\n    /**\n     * Analizon kontekstin aktual t lojs\n     */\n    analyzeGameContext(grid) {\n        const occupiedCells = this.calculateOccupancy(grid);\n        const fragmentationLevel = this.calculateFragmentation(grid);\n        const riskLevel = this.calculateRiskLevel(grid);\n        const opportunityScore = this.calculateOpportunityScore(grid);\n        \n        return {\n            gamePhase: this.determineGamePhase(occupiedCells),\n            urgencyLevel: this.calculateUrgencyLevel(riskLevel, occupiedCells),\n            spaceEfficiency: this.calculateSpaceEfficiency(grid),\n            strategicPriority: this.determineStrategicPriority(fragmentationLevel, opportunityScore)\n        };\n    }\n\n    /**\n     * Analizon preferencat e prdoruesit bazuar n historikun e lojrave\n     */\n    analyzeUserPreferences() {\n        const playHistory = this.userPlayStyle.recentMoves || [];\n        \n        return {\n            preferredStrategy: this.identifyPreferredStrategy(playHistory),\n            riskTolerance: this.calculateRiskTolerance(playHistory),\n            planningHorizon: this.calculatePlanningHorizon(playHistory),\n            efficiencyFocus: this.calculateEfficiencyFocus(playHistory)\n        };\n    }\n\n    /**\n     * Advanced Line Completion Analysis me AI prediction\n     */\n    analyzeLineCompletionPotential(piece, grid) {\n        const hints = [];\n        const shape = piece.currentShape || piece.shape;\n        \n        for (let r = 0; r < GRID_ROWS; r++) {\n            for (let c = 0; c < GRID_COLS; c++) {\n                if (this.isValidPlacement(shape, r, c, grid)) {\n                    const analysis = this.analyzeLinePotential(shape, r, c, grid);\n                    \n                    if (analysis.score > 0.6) { // Threshold pr hints t mir\n                        hints.push({\n                            row: r,\n                            col: c,\n                            type: 'line_completion',\n                            score: analysis.score,\n                            confidence: analysis.confidence,\n                            reasoning: analysis.reasoning,\n                            futureOpportunities: analysis.futureOpportunities\n                        });\n                    }\n                }\n            }\n        }\n        \n        return hints;\n    }\n\n    /**\n     * Future Space Optimization Analysis\n     */\n    analyzeFutureSpaceOptimization(piece, grid) {\n        const hints = [];\n        const shape = piece.currentShape || piece.shape;\n        \n        for (let r = 0; r < GRID_ROWS; r++) {\n            for (let c = 0; c < GRID_COLS; c++) {\n                if (this.isValidPlacement(shape, r, c, grid)) {\n                    // Simulo vendosjen dhe analizoj t ardhmen\n                    const futureGrid = this.simulatePlacement(shape, r, c, grid);\n                    const spaceOptimization = this.calculateSpaceOptimization(futureGrid);\n                    const flexibilityScore = this.calculateFlexibilityScore(futureGrid);\n                    \n                    if (spaceOptimization.score > 0.7) {\n                        hints.push({\n                            row: r,\n                            col: c,\n                            type: 'space_optimization',\n                            score: spaceOptimization.score,\n                            confidence: flexibilityScore,\n                            reasoning: `Optimizes future space usage: ${spaceOptimization.benefits}`,\n                            futureFlexibility: flexibilityScore\n                        });\n                    }\n                }\n            }\n        }\n        \n        return hints;\n    }\n\n    /**\n     * Combo Setup Analysis me predictive modeling\n     */\n    analyzeComboSetupOpportunities(piece, grid) {\n        const hints = [];\n        const shape = piece.currentShape || piece.shape;\n        \n        for (let r = 0; r < GRID_ROWS; r++) {\n            for (let c = 0; c < GRID_COLS; c++) {\n                if (this.isValidPlacement(shape, r, c, grid)) {\n                    const comboAnalysis = this.predictComboOpportunities(shape, r, c, grid);\n                    \n                    if (comboAnalysis.potentialCombos > 1) {\n                        hints.push({\n                            row: r,\n                            col: c,\n                            type: 'combo_setup',\n                            score: comboAnalysis.totalScore,\n                            confidence: comboAnalysis.confidence,\n                            reasoning: `Sets up ${comboAnalysis.potentialCombos}-line combo`,\n                            comboDetails: comboAnalysis.details\n                        });\n                    }\n                }\n            }\n        }\n        \n        return hints;\n    }\n\n    /**\n     * Defensive Positioning Analysis\n     */\n    analyzeDefensivePositioning(piece, grid) {\n        const hints = [];\n        const shape = piece.currentShape || piece.shape;\n        const riskAreas = this.identifyRiskAreas(grid);\n        \n        for (let r = 0; r < GRID_ROWS; r++) {\n            for (let c = 0; c < GRID_COLS; c++) {\n                if (this.isValidPlacement(shape, r, c, grid)) {\n                    const defenseScore = this.calculateDefenseScore(shape, r, c, grid, riskAreas);\n                    \n                    if (defenseScore.score > 0.6) {\n                        hints.push({\n                            row: r,\n                            col: c,\n                            type: 'defensive',\n                            score: defenseScore.score,\n                            confidence: defenseScore.reliability,\n                            reasoning: defenseScore.explanation,\n                            riskMitigation: defenseScore.mitigatedRisks\n                        });\n                    }\n                }\n            }\n        }\n        \n        return hints;\n    }\n\n    /**\n     * Risk Mitigation Analysis\n     */\n    analyzeRiskMitigation(piece, grid) {\n        const hints = [];\n        const criticalAreas = this.identifyCriticalAreas(grid);\n        const shape = piece.currentShape || piece.shape;\n        \n        for (let r = 0; r < GRID_ROWS; r++) {\n            for (let c = 0; c < GRID_COLS; c++) {\n                if (this.isValidPlacement(shape, r, c, grid)) {\n                    const riskAnalysis = this.analyzeGameOverRisk(shape, r, c, grid);\n                    \n                    if (riskAnalysis.riskReduction > 0.5) {\n                        hints.push({\n                            row: r,\n                            col: c,\n                            type: 'risk_mitigation',\n                            score: riskAnalysis.score,\n                            confidence: riskAnalysis.confidence,\n                            reasoning: `Reduces game over risk by ${Math.round(riskAnalysis.riskReduction * 100)}%`,\n                            riskFactors: riskAnalysis.factors\n                        });\n                    }\n                }\n            }\n        }\n        \n        return hints;\n    }\n\n    /**\n     * Aplikon pesha AI bazuar n kontekstin e lojs\n     */\n    applyAIWeights(hints, context, userPreferences) {\n        return hints.map(hint => {\n            let adjustedScore = hint.score;\n            \n            // Context-based weights\n            switch (context.gamePhase) {\n                case 'early':\n                    if (hint.type === 'space_optimization') adjustedScore *= 1.3;\n                    break;\n                case 'middle':\n                    if (hint.type === 'combo_setup') adjustedScore *= 1.2;\n                    break;\n                case 'late':\n                    if (hint.type === 'risk_mitigation') adjustedScore *= 1.5;\n                    break;\n            }\n            \n            // User preference weights\n            if (userPreferences.preferredStrategy === 'aggressive' && hint.type === 'combo_setup') {\n                adjustedScore *= 1.2;\n            }\n            if (userPreferences.riskTolerance === 'low' && hint.type === 'defensive') {\n                adjustedScore *= 1.3;\n            }\n            \n            return { ...hint, adjustedScore };\n        });\n    }\n\n    /**\n     * Machine Learning Optimization\n     */\n    applyMLOptimization(hints, strategicSituations) {\n        // Simulate neural network weights based on historical data\n        const neuralWeights = this.calculateNeuralWeights(strategicSituations);\n        \n        return hints.map(hint => {\n            const features = this.extractHintFeatures(hint);\n            const mlScore = this.calculateMLScore(features, neuralWeights);\n            \n            return {\n                ...hint,\n                mlScore,\n                finalScore: (hint.adjustedScore * 0.7) + (mlScore * 0.3)\n            };\n        });\n    }\n\n    /**\n     * Zgjedh hints-et m t mira\n     */\n    selectBestHints(hints, count = 3) {\n        // Sort by final score\n        hints.sort((a, b) => b.finalScore - a.finalScore);\n        \n        // Ensure diversity in hint types\n        const diverseHints = this.ensureHintDiversity(hints.slice(0, count * 2));\n        \n        return diverseHints.slice(0, count);\n    }\n\n    /**\n     * Siguron diversitet n llojet e hints-ave\n     */\n    ensureHintDiversity(hints) {\n        const typesSeen = new Set();\n        const diverseHints = [];\n        \n        for (const hint of hints) {\n            if (!typesSeen.has(hint.type) || diverseHints.length < 2) {\n                diverseHints.push(hint);\n                typesSeen.add(hint.type);\n            }\n        }\n        \n        // Fill remaining slots with best remaining hints\n        const remaining = hints.filter(h => !diverseHints.includes(h));\n        diverseHints.push(...remaining.slice(0, 3 - diverseHints.length));\n        \n        return diverseHints;\n    }\n\n    /**\n     * Ruaj t dhnat e t msuarit pr prmirsim t vazhdueshm\n     */\n    recordUserDecision(presentedHints, chosenHint, outcome) {\n        this.learningData.decisions.push({\n            timestamp: Date.now(),\n            hints: presentedHints,\n            chosen: chosenHint,\n            outcome: outcome, // success, failure, ignored\n            gameContext: this.analyzeGameContext(gameState.grid)\n        });\n        \n        // Update user play style\n        this.updateUserPlayStyle(chosenHint, outcome);\n        \n        // Save to localStorage\n        this.saveLearningData();\n    }\n\n    // Utility methods pr AI calculations\n    calculateOccupancy(grid) {\n        let occupied = 0;\n        for (let r = 0; r < GRID_ROWS; r++) {\n            for (let c = 0; c < GRID_COLS; c++) {\n                if (grid[r][c] !== 0) occupied++;\n            }\n        }\n        return occupied / (GRID_ROWS * GRID_COLS);\n    }\n    \n    calculateFragmentation(grid) {\n        let fragments = 0;\n        for (let r = 0; r < GRID_ROWS; r++) {\n            for (let c = 0; c < GRID_COLS; c++) {\n                if (grid[r][c] === 0) {\n                    // Count isolated empty cells\n                    const neighbors = [\n                        [r-1, c], [r+1, c], [r, c-1], [r, c+1]\n                    ];\n                    const emptyNeighbors = neighbors.filter(([nr, nc]) => \n                        nr >= 0 && nr < GRID_ROWS && nc >= 0 && nc < GRID_COLS && grid[nr][nc] === 0\n                    ).length;\n                    if (emptyNeighbors < 2) fragments++;\n                }\n            }\n        }\n        return Math.min(fragments / (GRID_ROWS * GRID_COLS), 1);\n    }\n    \n    calculateRiskLevel(grid) {\n        const occupancy = this.calculateOccupancy(grid);\n        const fragmentation = this.calculateFragmentation(grid);\n        return Math.min((occupancy * 0.7) + (fragmentation * 0.3), 1);\n    }\n    \n    calculateOpportunityScore(grid) {\n        let opportunities = 0;\n        // Check for almost complete lines\n        for (let r = 0; r < GRID_ROWS; r++) {\n            const emptyCells = grid[r].filter(cell => cell === 0).length;\n            if (emptyCells <= 2 && emptyCells > 0) opportunities++;\n        }\n        for (let c = 0; c < GRID_COLS; c++) {\n            let emptyCells = 0;\n            for (let r = 0; r < GRID_ROWS; r++) {\n                if (grid[r][c] === 0) emptyCells++;\n            }\n            if (emptyCells <= 2 && emptyCells > 0) opportunities++;\n        }\n        return Math.min(opportunities / 10, 1);\n    }\n    \n    determineGamePhase(occupancy) {\n        if (occupancy < 0.3) return 'early';\n        if (occupancy < 0.7) return 'middle';\n        return 'late';\n    }\n    \n    calculateUrgencyLevel(riskLevel, occupancy) {\n        return Math.min(riskLevel + (occupancy * 0.3), 1);\n    }\n    \n    calculateSpaceEfficiency(grid) {\n        const occupancy = this.calculateOccupancy(grid);\n        const fragmentation = this.calculateFragmentation(grid);\n        return Math.max(0, occupancy - (fragmentation * 0.5));\n    }\n    \n    determineStrategicPriority(fragmentation, opportunity) {\n        if (fragmentation > 0.6) return 'cleanup';\n        if (opportunity > 0.5) return 'completion';\n        return 'expansion';\n    }\n    \n    identifyPreferredStrategy(playHistory) {\n        if (playHistory.length === 0) return 'balanced';\n        // Simple heuristic - more moves = more aggressive\n        return playHistory.length > 50 ? 'aggressive' : 'defensive';\n    }\n    \n    calculateRiskTolerance(playHistory) {\n        // Default to medium risk tolerance\n        return 'medium';\n    }\n    \n    calculatePlanningHorizon(playHistory) {\n        return playHistory.length > 30 ? 'long-term' : 'short-term';\n    }\n    \n    calculateEfficiencyFocus(playHistory) {\n        return 0.7; // Default efficiency focus\n    }\n    \n    analyzeLinePotential(shape, row, col, grid) {\n        let score = 0;\n        let confidence = 0.5;\n        let reasoning = '';\n        let futureOpportunities = 0;\n        \n        // Check if this placement would complete lines\n        const testGrid = this.simulatePlacement(shape, row, col, grid);\n        const completedLines = this.countCompletedLines(testGrid) - this.countCompletedLines(grid);\n        \n        if (completedLines > 0) {\n            score = 0.8 + (completedLines * 0.1);\n            confidence = 0.9;\n            reasoning = `Completes ${completedLines} line(s)`;\n            futureOpportunities = completedLines * 2;\n        } else {\n            // Check for almost complete lines\n            const almostComplete = this.countAlmostCompleteLines(testGrid);\n            if (almostComplete > 0) {\n                score = 0.6;\n                confidence = 0.7;\n                reasoning = `Sets up ${almostComplete} line(s) for completion`;\n                futureOpportunities = almostComplete;\n            }\n        }\n        \n        return { score, confidence, reasoning, futureOpportunities };\n    }\n    \n    calculateSpaceOptimization(grid) {\n        const efficiency = this.calculateSpaceEfficiency(grid);\n        const benefits = efficiency > 0.7 ? 'high space efficiency' : 'moderate space usage';\n        return { score: efficiency, benefits };\n    }\n    \n    calculateFlexibilityScore(grid) {\n        const fragmentation = this.calculateFragmentation(grid);\n        return Math.max(0, 1 - fragmentation);\n    }\n    \n    simulatePlacement(shape, row, col, grid) {\n        const testGrid = grid.map(r => [...r]);\n        shape.forEach(([sr, sc]) => {\n            const gridRow = row + sr;\n            const gridCol = col + sc;\n            if (gridRow >= 0 && gridRow < GRID_ROWS && gridCol >= 0 && gridCol < GRID_COLS) {\n                testGrid[gridRow][gridCol] = 1; // Temporary value\n            }\n        });\n        return testGrid;\n    }\n    \n    countCompletedLines(grid) {\n        let completed = 0;\n        // Check rows\n        for (let r = 0; r < GRID_ROWS; r++) {\n            if (grid[r].every(cell => cell !== 0)) completed++;\n        }\n        // Check columns\n        for (let c = 0; c < GRID_COLS; c++) {\n            let columnComplete = true;\n            for (let r = 0; r < GRID_ROWS; r++) {\n                if (grid[r][c] === 0) {\n                    columnComplete = false;\n                    break;\n                }\n            }\n            if (columnComplete) completed++;\n        }\n        return completed;\n    }\n    \n    countAlmostCompleteLines(grid) {\n        let almostComplete = 0;\n        // Check rows\n        for (let r = 0; r < GRID_ROWS; r++) {\n            const emptyCells = grid[r].filter(cell => cell === 0).length;\n            if (emptyCells <= 2 && emptyCells > 0) almostComplete++;\n        }\n        // Check columns\n        for (let c = 0; c < GRID_COLS; c++) {\n            let emptyCells = 0;\n            for (let r = 0; r < GRID_ROWS; r++) {\n                if (grid[r][c] === 0) emptyCells++;\n            }\n            if (emptyCells <= 2 && emptyCells > 0) almostComplete++;\n        }\n        return almostComplete;\n    }\n    \n    predictComboOpportunities(shape, row, col, grid) {\n        const testGrid = this.simulatePlacement(shape, row, col, grid);\n        const currentLines = this.countCompletedLines(grid);\n        const newLines = this.countCompletedLines(testGrid);\n        const potentialCombos = newLines - currentLines;\n        \n        return {\n            potentialCombos,\n            totalScore: potentialCombos * 0.8,\n            confidence: potentialCombos > 0 ? 0.8 : 0.3,\n            details: `${potentialCombos} potential combo lines`\n        };\n    }\n    \n    identifyRiskAreas(grid) {\n        const riskAreas = [];\n        for (let r = 0; r < GRID_ROWS; r++) {\n            for (let c = 0; c < GRID_COLS; c++) {\n                if (grid[r][c] === 0) {\n                    const surroundingOccupied = this.countSurroundingOccupied(grid, r, c);\n                    if (surroundingOccupied >= 3) {\n                        riskAreas.push({ row: r, col: c, risk: surroundingOccupied / 4 });\n                    }\n                }\n            }\n        }\n        return riskAreas;\n    }\n    \n    countSurroundingOccupied(grid, row, col) {\n        const neighbors = [\n            [row-1, col], [row+1, col], [row, col-1], [row, col+1]\n        ];\n        return neighbors.filter(([r, c]) => \n            r >= 0 && r < GRID_ROWS && c >= 0 && c < GRID_COLS && grid[r][c] !== 0\n        ).length;\n    }\n    \n    calculateDefenseScore(shape, row, col, grid, riskAreas) {\n        let score = 0.5;\n        let reliability = 0.6;\n        let explanation = 'Standard placement';\n        let mitigatedRisks = 0;\n        \n        // Check if placement fills risky areas\n        shape.forEach(([sr, sc]) => {\n            const gridRow = row + sr;\n            const gridCol = col + sc;\n            const risk = riskAreas.find(area => area.row === gridRow && area.col === gridCol);\n            if (risk) {\n                score += risk.risk * 0.2;\n                mitigatedRisks++;\n            }\n        });\n        \n        if (mitigatedRisks > 0) {\n            explanation = `Fills ${mitigatedRisks} risky gap(s)`;\n            reliability = 0.8;\n        }\n        \n        return { score, reliability, explanation, mitigatedRisks };\n    }\n    \n    identifyCriticalAreas(grid) {\n        const critical = [];\n        const occupancy = this.calculateOccupancy(grid);\n        if (occupancy > 0.7) {\n            // In late game, all empty spaces are critical\n            for (let r = 0; r < GRID_ROWS; r++) {\n                for (let c = 0; c < GRID_COLS; c++) {\n                    if (grid[r][c] === 0) {\n                        critical.push({ row: r, col: c });\n                    }\n                }\n            }\n        }\n        return critical;\n    }\n    \n    analyzeGameOverRisk(shape, row, col, grid) {\n        const currentRisk = this.calculateRiskLevel(grid);\n        const testGrid = this.simulatePlacement(shape, row, col, grid);\n        const newRisk = this.calculateRiskLevel(testGrid);\n        const riskReduction = Math.max(0, currentRisk - newRisk);\n        \n        return {\n            score: 0.5 + (riskReduction * 0.5),\n            confidence: riskReduction > 0.1 ? 0.8 : 0.4,\n            riskReduction,\n            factors: ['space optimization', 'fragmentation reduction']\n        };\n    }\n    \n    calculateNeuralWeights(strategicSituations) {\n        // Simplified neural network weights simulation\n        return {\n            lineCompletion: 0.8,\n            spaceOptimization: 0.6,\n            comboSetup: 0.7,\n            defensive: 0.5,\n            riskMitigation: 0.9\n        };\n    }\n    \n    extractHintFeatures(hint) {\n        return {\n            score: hint.score || 0,\n            confidence: hint.confidence || 0.5,\n            type: hint.type || 'unknown',\n            position: [hint.row || 0, hint.col || 0]\n        };\n    }\n    \n    calculateMLScore(features, weights) {\n        const typeWeight = weights[features.type] || 0.5;\n        return (features.score * 0.4) + (features.confidence * 0.3) + (typeWeight * 0.3);\n    }\n    \n    ensureHintDiversity(hints) {\n        const typesSeen = new Set();\n        const diverseHints = [];\n        \n        for (const hint of hints) {\n            if (!typesSeen.has(hint.type) || diverseHints.length < 2) {\n                diverseHints.push(hint);\n                typesSeen.add(hint.type);\n            }\n        }\n        \n        // Fill remaining slots with best remaining hints\n        const remaining = hints.filter(h => !diverseHints.includes(h));\n        diverseHints.push(...remaining.slice(0, 3 - diverseHints.length));\n        \n        return diverseHints;\n    }\n    \n    recordUserDecision(presentedHints, chosenHint, outcome) {\n        if (!this.learningData.decisions) {\n            this.learningData.decisions = [];\n        }\n        \n        this.learningData.decisions.push({\n            timestamp: Date.now(),\n            hints: presentedHints,\n            chosen: chosenHint,\n            outcome: outcome,\n            gameContext: this.analyzeGameContext(gameState.grid)\n        });\n        \n        this.updateUserPlayStyle(chosenHint, outcome);\n        this.saveLearningData();\n    }\n    \n    updateUserPlayStyle(chosenHint, outcome) {\n        if (!this.userPlayStyle.preferences) {\n            this.userPlayStyle.preferences = {};\n        }\n        \n        const hintType = chosenHint?.type || 'unknown';\n        if (!this.userPlayStyle.preferences[hintType]) {\n            this.userPlayStyle.preferences[hintType] = { count: 0, success: 0 };\n        }\n        \n        this.userPlayStyle.preferences[hintType].count++;\n        if (outcome === 'success') {\n            this.userPlayStyle.preferences[hintType].success++;\n        }\n    }\n    \n    analyzeRecentPerformance() {\n        const recentMoves = this.gameAnalytics.recentMoves || [];\n        if (recentMoves.length === 0) {\n            return { averageSuccess: 0.5 };\n        }\n        \n        const successes = recentMoves.filter(move => move.success).length;\n        return { averageSuccess: successes / recentMoves.length };\n    }\n    \n    calculateGameDuration() {\n        return gameState.startTime ? Date.now() - gameState.startTime : 0;\n    }\n    \n    identifyStrategicSituations(grid) {\n        return {\n            occupancy: this.calculateOccupancy(grid),\n            fragmentation: this.calculateFragmentation(grid),\n            opportunities: this.calculateOpportunityScore(grid)\n        };\n    }\n    \n    isValidPlacement(shape, row, col, grid) {\n        for (const [sr, sc] of shape) {\n            const gridRow = row + sr;\n            const gridCol = col + sc;\n            if (gridRow < 0 || gridRow >= GRID_ROWS || gridCol < 0 || gridCol >= GRID_COLS) {\n                return false;\n            }\n            if (grid[gridRow][gridCol] !== 0) {\n                return false;\n            }\n        }\n        return true;\n    }\n    \n    // Data persistence methods\n    loadUserPlayStyle() {\n        return JSON.parse(localStorage.getItem('aiHints_userStyle') || '{}');\n    }\n    \n    loadGameAnalytics() {\n        return JSON.parse(localStorage.getItem('aiHints_analytics') || '{\"recentMoves\": [], \"performance\": []}');\n    }\n    \n    loadLearningData() {\n        return JSON.parse(localStorage.getItem('aiHints_learningData') || '{\"decisions\": [], \"patterns\": {}}');\n    }\n    \n    saveLearningData() {\n        localStorage.setItem('aiHints_learningData', JSON.stringify(this.learningData));\n        localStorage.setItem('aiHints_userStyle', JSON.stringify(this.userPlayStyle));\n        localStorage.setItem('aiHints_analytics', JSON.stringify(this.gameAnalytics));\n    }\n}\n\n// Export pr prdorim n gameLogic.js\nexport const aiHintEngine = new AIHintEngine();\n","// Progressive Piece Unlock System\n// Sistem i hapjes graduale t pjesve bazuar n pik dhe achievements\n\nimport { gameState } from './state.js';\n\n/**\n * Sistema e hapjes graduale t pjesve\n */\nexport class PieceUnlockSystem {\n    constructor() {\n        this.unlockedPieces = this.loadUnlockedPieces();\n        this.lastScore = 0;\n    }\n\n    /**\n     * Kontrollon pr unlock t rinj bazuar n pikt aktuale\n     */\n    checkForUnlocks(currentScore) {\n        const newUnlocks = [];\n        \n        // Check each tier\n        const tiers = this.getUnlockTiers();\n        \n        for (const tier of tiers) {\n            if (currentScore >= tier.requiredScore && !this.unlockedPieces.includes(tier.id)) {\n                this.unlockedPieces.push(tier.id);\n                newUnlocks.push(tier);\n            }\n        }\n        \n        if (newUnlocks.length > 0) {\n            this.saveUnlockedPieces();\n            this.showUnlockNotification(newUnlocks);\n        }\n        \n        return newUnlocks;\n    }\n\n    /**\n     * Merr t gjitha pjest e disponueshme pr prdorim\n     */\n    getAvailablePieces() {\n        const allPieces = this.getAllPieceDefinitions();\n        return allPieces.filter(piece => \n            piece.tier === 'starter' || this.unlockedPieces.includes(piece.id)\n        );\n    }\n\n    /**\n     * Definon tier-at e unlock-ave\n     */\n    getUnlockTiers() {\n        return [\n            // Tier 2 - Bronze (1000 pik)\n            { id: 'bronze1', requiredScore: 1000, name: 'P-Shape', tier: 'bronze' },\n            { id: 'bronze2', requiredScore: 1000, name: 'U-Shape', tier: 'bronze' },\n            { id: 'bronze3', requiredScore: 1000, name: 'Y-Shape', tier: 'bronze' },\n            { id: 'bronze4', requiredScore: 1000, name: 'F-Shape', tier: 'bronze' },\n            { id: 'bronze5', requiredScore: 1000, name: 'N-Shape', tier: 'bronze' },\n            \n            // Tier 3 - Silver (3000 pik)\n            { id: 'silver1', requiredScore: 3000, name: 'V-Shape', tier: 'silver' },\n            { id: 'silver2', requiredScore: 3000, name: 'W-Shape', tier: 'silver' },\n            { id: 'silver3', requiredScore: 3000, name: 'Cross', tier: 'silver' },\n            { id: 'silver4', requiredScore: 3000, name: 'Plus', tier: 'silver' },\n            { id: 'silver5', requiredScore: 3000, name: 'Corner', tier: 'silver' },\n            { id: 'silver6', requiredScore: 3000, name: 'Step', tier: 'silver' },\n            \n            // Tier 4 - Gold (7000 pik)\n            { id: 'gold1', requiredScore: 7000, name: 'Spiral', tier: 'gold' },\n            { id: 'gold2', requiredScore: 7000, name: 'Diamond', tier: 'gold' },\n            { id: 'gold3', requiredScore: 7000, name: 'Arrow', tier: 'gold' },\n            { id: 'gold4', requiredScore: 7000, name: 'Bridge', tier: 'gold' },\n            { id: 'gold5', requiredScore: 7000, name: 'Claw', tier: 'gold' },\n            { id: 'gold6', requiredScore: 7000, name: 'Wave', tier: 'gold' },\n            \n            // Tier 5 - Platinum (15000 pik)\n            { id: 'platinum1', requiredScore: 15000, name: 'Master-1', tier: 'platinum' },\n            { id: 'platinum2', requiredScore: 15000, name: 'Master-2', tier: 'platinum' },\n            { id: 'platinum3', requiredScore: 15000, name: 'Master-3', tier: 'platinum' },\n            { id: 'platinum4', requiredScore: 15000, name: 'Master-4', tier: 'platinum' },\n            { id: 'platinum5', requiredScore: 15000, name: 'Master-5', tier: 'platinum' },\n            { id: 'platinum6', requiredScore: 15000, name: 'Master-6', tier: 'platinum' }\n        ];\n    }\n\n    /**\n     * Merr milestones pr unlock\n     */\n    getUnlockMilestones() {\n        return [\n            { id: 'bronze', requiredScore: 1000, name: 'Bronze Tier', tierName: 'bronze' },\n            { id: 'silver', requiredScore: 3000, name: 'Silver Tier', tierName: 'silver' },\n            { id: 'gold', requiredScore: 7000, name: 'Gold Tier', tierName: 'gold' },\n            { id: 'platinum', requiredScore: 15000, name: 'Platinum Tier', tierName: 'platinum' }\n        ];\n    }\n\n    /**\n     * T gjitha pjest e lojs - 30 total\n     */\n    getAllPieceDefinitions() {\n        return [\n            // TIER 1 - STARTER (7 pjes klasike)\n            { id: 'I', name: 'I-Line', shape: [[0, 0], [0, 1], [0, 2], [0, 3]], color: 1, tier: 'starter' },\n            { id: 'O', name: 'O-Square', shape: [[0, 0], [0, 1], [1, 0], [1, 1]], color: 2, tier: 'starter' },\n            { id: 'T', name: 'T-Shape', shape: [[0, 1], [1, 0], [1, 1], [1, 2]], color: 3, tier: 'starter' },\n            { id: 'S', name: 'S-Shape', shape: [[0, 1], [0, 2], [1, 0], [1, 1]], color: 4, tier: 'starter' },\n            { id: 'Z', name: 'Z-Shape', shape: [[0, 0], [0, 1], [1, 1], [1, 2]], color: 5, tier: 'starter' },\n            { id: 'J', name: 'J-Shape', shape: [[0, 0], [1, 0], [1, 1], [1, 2]], color: 6, tier: 'starter' },\n            { id: 'L', name: 'L-Shape', shape: [[0, 2], [1, 0], [1, 1], [1, 2]], color: 7, tier: 'starter' },\n            \n            // TIER 2 - BRONZE (5 pjes t reja)\n            { id: 'bronze1', name: 'P-Shape', shape: [[0, 0], [0, 1], [1, 0], [1, 1], [2, 0]], color: 1, tier: 'bronze' },\n            { id: 'bronze2', name: 'U-Shape', shape: [[0, 0], [0, 2], [1, 0], [1, 1], [1, 2]], color: 2, tier: 'bronze' },\n            { id: 'bronze3', name: 'Y-Shape', shape: [[0, 1], [1, 0], [1, 1], [2, 1], [3, 1]], color: 3, tier: 'bronze' },\n            { id: 'bronze4', name: 'F-Shape', shape: [[0, 1], [0, 2], [1, 0], [1, 1], [2, 1]], color: 4, tier: 'bronze' },\n            { id: 'bronze5', name: 'N-Shape', shape: [[0, 1], [1, 0], [1, 1], [2, 0], [3, 0]], color: 5, tier: 'bronze' },\n            \n            // TIER 3 - SILVER (6 pjes intermediate)\n            { id: 'silver1', name: 'V-Shape', shape: [[0, 0], [1, 0], [2, 0], [2, 1], [2, 2]], color: 6, tier: 'silver' },\n            { id: 'silver2', name: 'W-Shape', shape: [[0, 0], [1, 0], [1, 1], [2, 1], [2, 2]], color: 7, tier: 'silver' },\n            { id: 'silver3', name: 'Cross', shape: [[0, 1], [1, 0], [1, 1], [1, 2], [2, 1]], color: 1, tier: 'silver' },\n            { id: 'silver4', name: 'Plus', shape: [[0, 1], [1, 0], [1, 1], [1, 2], [2, 1]], color: 2, tier: 'silver' },\n            { id: 'silver5', name: 'Corner', shape: [[0, 0], [0, 1], [0, 2], [1, 0], [2, 0]], color: 3, tier: 'silver' },\n            { id: 'silver6', name: 'Step', shape: [[0, 0], [1, 0], [1, 1], [2, 1], [2, 2]], color: 4, tier: 'silver' },\n            \n            // TIER 4 - GOLD (6 pjes advanced)\n            { id: 'gold1', name: 'Spiral', shape: [[0, 0], [0, 1], [1, 1], [1, 2], [2, 0], [2, 2]], color: 5, tier: 'gold' },\n            { id: 'gold2', name: 'Diamond', shape: [[0, 1], [1, 0], [1, 1], [1, 2], [2, 1]], color: 6, tier: 'gold' },\n            { id: 'gold3', name: 'Arrow', shape: [[0, 1], [1, 0], [1, 1], [1, 2], [2, 1], [3, 1]], color: 7, tier: 'gold' },\n            { id: 'gold4', name: 'Bridge', shape: [[0, 0], [0, 1], [0, 2], [1, 0], [1, 2]], color: 1, tier: 'gold' },\n            { id: 'gold5', name: 'Claw', shape: [[0, 0], [0, 2], [1, 0], [1, 1], [1, 2]], color: 2, tier: 'gold' },\n            { id: 'gold6', name: 'Wave', shape: [[0, 0], [0, 1], [1, 1], [1, 2], [2, 2], [2, 3]], color: 3, tier: 'gold' },\n            \n            // TIER 5 - PLATINUM (6 pjes master)\n            { id: 'platinum1', name: 'Master-1', shape: [[0, 0], [0, 1], [0, 2], [1, 1], [2, 0], [2, 2]], color: 4, tier: 'platinum' },\n            { id: 'platinum2', name: 'Master-2', shape: [[0, 1], [1, 0], [1, 1], [1, 2], [2, 0], [2, 2]], color: 5, tier: 'platinum' },\n            { id: 'platinum3', name: 'Master-3', shape: [[0, 0], [0, 2], [1, 0], [1, 1], [1, 2], [2, 1]], color: 6, tier: 'platinum' },\n            { id: 'platinum4', name: 'Master-4', shape: [[0, 0], [0, 1], [1, 1], [1, 2], [2, 1], [3, 1]], color: 7, tier: 'platinum' },\n            { id: 'platinum5', name: 'Master-5', shape: [[0, 1], [1, 0], [1, 1], [2, 1], [2, 2], [3, 1]], color: 1, tier: 'platinum' },\n            { id: 'platinum6', name: 'Master-6', shape: [[0, 0], [0, 1], [0, 2], [1, 0], [1, 2], [2, 1]], color: 2, tier: 'platinum' }\n        ];\n    }\n\n    /**\n     * Shfaq notification pr unlock t rinj\n     */\n    showUnlockNotification(newUnlocks) {\n        const tierNames = {\n            bronze: 'BRONZE TIER',\n            silver: 'SILVER TIER', \n            gold: 'GOLD TIER',\n            platinum: 'PLATINUM TIER'\n        };\n\n        const tierEmojis = {\n            bronze: '',\n            silver: '', \n            gold: '',\n            platinum: ''\n        };\n\n        const groupedByTier = {};\n        newUnlocks.forEach(unlock => {\n            if (!groupedByTier[unlock.tier]) {\n                groupedByTier[unlock.tier] = [];\n            }\n            groupedByTier[unlock.tier].push(unlock);\n        });\n\n        Object.keys(groupedByTier).forEach(tier => {\n            const pieces = groupedByTier[tier];\n            const message = `${tierEmojis[tier]} ${tierNames[tier]} UNLOCKED!\\n${pieces.length} new pieces available: ${pieces.map(p => p.name).join(', ')}`;\n            \n            this.displayUnlockNotification(message, tier);\n        });\n    }\n\n    /**\n     * Shfaq notification n UI\n     */\n    displayUnlockNotification(message, tier) {\n        // Create notification element\n        const notification = document.createElement('div');\n        notification.className = `unlock-notification unlock-${tier}`;\n        notification.innerHTML = `\n            <div class=\"unlock-content\">\n                <h3> NEW PIECES UNLOCKED!</h3>\n                <p>${message}</p>\n            </div>\n        `;\n\n        // Add to page\n        document.body.appendChild(notification);\n\n        // Animate in\n        setTimeout(() => notification.classList.add('show'), 100);\n\n        // Remove after 4 seconds\n        setTimeout(() => {\n            notification.classList.remove('show');\n            setTimeout(() => document.body.removeChild(notification), 500);\n        }, 4000);\n\n        // Play unlock sound if available\n        this.playUnlockSound();\n    }\n\n    /**\n     * Play unlock sound\n     */\n    playUnlockSound() {\n        try {\n            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LGeSYELYTO8teMOAcabLvs5Z0TAA4A');\n            audio.volume = 0.3;\n            audio.play();\n        } catch (e) {\n            // Ignore audio errors\n        }\n    }\n\n    /**\n     * Merr informacion pr unlock-un e ardhshm\n     */\n    getNextUnlock() {\n        const currentScore = gameState?.score || 0;\n        const milestones = this.getUnlockMilestones();\n\n        for (const milestone of milestones) {\n            if (currentScore < milestone.requiredScore) {\n                return {\n                    name: milestone.name,\n                    requiredScore: milestone.requiredScore,\n                    remaining: Math.max(0, milestone.requiredScore - currentScore)\n                };\n            }\n        }\n\n        return null; // All unlocked\n    }\n\n    /**\n     * Load unlocked pieces nga localStorage\n     */\n    loadUnlockedPieces() {\n        try {\n            return JSON.parse(localStorage.getItem('blocustema_unlockedPieces') || '[]');\n        } catch {\n            return [];\n        }\n    }\n\n    /**\n     * Save unlocked pieces n localStorage\n     */\n    saveUnlockedPieces() {\n        localStorage.setItem('blocustema_unlockedPieces', JSON.stringify(this.unlockedPieces));\n    }\n\n    /**\n     * Merr informacionin e progresit t unlock-eve\n     */\n    getProgressInfo() {\n        const totalPieces = 30;\n        \n        // Count actual unlocked pieces, not just tier unlocks\n        const availablePieces = this.getAvailablePieces();\n        const unlockedCount = availablePieces.length;\n        const percentage = (unlockedCount / totalPieces) * 100;\n        const nextUnlock = this.getNextUnlock();\n\n        return {\n            totalPieces,\n            unlockedCount,\n            percentage: Math.round(percentage),\n            nextUnlock\n        };\n    }\n\n    /**\n     * Reset t gjitha unlock-et (pr testing)\n     */\n    resetUnlocks() {\n        this.unlockedPieces = [];\n        this.saveUnlockedPieces();\n    }\n}\n\n// Export instance\nexport const pieceUnlockSystem = new PieceUnlockSystem();\n","// Centralized game logic. All duplicate or legacy comments removed for clarity.\n\nimport { gameState, initializeState } from './state.js';\nimport { PIECE_SHAPES, GRID_ROWS, GRID_COLS } from './constants.js';\nimport { aiHintEngine } from './aiHints.js';\nimport { pieceUnlockSystem } from './pieceUnlockSystem.js';\n\nexport { createEmptyGrid } from './state.js';\n\n// Cache pr DOM elements - pr optimizimin e performancs\nconst domCache = new Map();\n// Cache pr placement calculations\nconst placementCache = new Map();\nexport function clearRowOrColumn(index, isRow = true) {\n    if (typeof index !== 'number') {\n        return false;\n    }\n\n    if (isRow) {\n        if (index < 0 || index >= GRID_ROWS) {\n            return false;\n        }\n        for (let col = 0; col < GRID_COLS; col++) {\n            gameState.grid[index][col] = 0;\n        }\n    } else {\n        if (index < 0 || index >= GRID_COLS) {\n            return false;\n        }\n        for (let row = 0; row < GRID_ROWS; row++) {\n            gameState.grid[row][index] = 0;\n        }\n    }\n\n    placementCache.clear();\n    gameState.lastPlacementCells = [];\n    return true;\n}\n\nexport function shiftColumn(columnIndex, direction = 1) {\n    if (columnIndex < 0 || columnIndex >= GRID_COLS) {\n        return false;\n    }\n\n    const normalizedDirection = direction >= 0 ? 1 : -1;\n    const values = [];\n    for (let row = 0; row < GRID_ROWS; row++) {\n        values.push(gameState.grid[row][columnIndex]);\n    }\n\n    if (normalizedDirection === 1) {\n        const first = values.shift();\n        values.push(first ?? 0);\n    } else {\n        const last = values.pop();\n        values.unshift(last ?? 0);\n    }\n\n    for (let row = 0; row < GRID_ROWS; row++) {\n        gameState.grid[row][columnIndex] = values[row];\n    }\n\n    placementCache.clear();\n    gameState.lastPlacementCells = [];\n    return true;\n}\n\n/**\n * Pastron t gjitha cache-et\n */\nexport function clearAllCaches() {\n    domCache.clear();\n    placementCache.clear();\n}\n\n/**\n * Merr nj grid cell nga cache ose DOM\n * @param {number} row - Rreshti\n * @param {number} col - Kolona\n * @returns {HTMLElement|null} - Elementi i grid cell-it\n */\nfunction getCachedGridCell(row, col) {\n    const key = `cell-${row}-${col}`;\n    if (!domCache.has(key)) {\n        const cell = document.querySelector(`[data-row=\"${row}\"][data-col=\"${col}\"]`);\n        if (cell) {\n            domCache.set(key, cell);\n        }\n        return cell;\n    }\n    return domCache.get(key);\n}\n\n/**\n * Pastron cache-in e DOM elements\n */\nexport function clearDOMCache() {\n    domCache.clear();\n}\n\n/**\n * Validon bounds m efikasishm\n * @param {number} row - Rreshti\n * @param {number} col - Kolona\n * @returns {boolean} - True nse sht n bounds\n */\nfunction isInBounds(row, col) {\n    return row >= 0 && row < GRID_ROWS && col >= 0 && col < GRID_COLS;\n}\n\n/**\n * Zgjedh nj form t rastsishme nga pjest e disponueshme.\n * @returns {object} Nj objekt i ri pjese.\n */\nexport function getRandomPiece() {\n    // Unified piece selection: always use unlock system\n    const availablePieces = pieceUnlockSystem.getAvailablePieces();\n    \n    if (availablePieces.length === 0) {\n        // Fallback to PIECE_SHAPES if unlock system fails\n        let piece = { ...PIECE_SHAPES[Math.floor(Math.random() * PIECE_SHAPES.length)], id: Date.now() + Math.random() };\n        piece.currentShape = piece.shape;\n        piece.size = piece.shape.length;  // Add size for fallback case too\n        // Apply random rotations for varied orientation\n        for (let i = 0, r = Math.floor(Math.random() * 4); i < r; i++) {\n            piece = rotatePiece(piece);\n        }\n        return piece;\n    }\n    \n    // Select random piece from available unlocked pieces\n    const randomIndex = Math.floor(Math.random() * availablePieces.length);\n    const selectedPiece = availablePieces[randomIndex];\n    \n    // Create piece instance\n    let piece = {\n        ...selectedPiece,\n        id: Date.now() + Math.random(),\n        currentShape: selectedPiece.shape,\n        size: selectedPiece.shape.length  // Add size based on shape length\n    };\n    // Apply random rotations for varied orientation\n    for (let i = 0, r = Math.floor(Math.random() * 4); i < r; i++) {\n        piece = rotatePiece(piece);\n    }\n    return piece;\n}\n\n/**\n * Mbush raftin e pjesve me 3 pjes t reja.\n */\nexport function populateInitialPieces() {\n    gameState.currentPieces = [];\n    for (let i = 0; i < 3; i++) {\n        gameState.currentPieces.push(getRandomPiece());\n    }\n}\n\n/**\n * Zvendson nj pjes t prdorur me nj t re.\n * @param {number} index - Indeksi i pjess q do t zvendsohet.\n */\nexport function replaceUsedPiece(index) {\n    gameState.currentPieces[index] = getRandomPiece();\n}\n\n/**\n * Rrotullon formn e nj pjese 90 grad.\n * @param {object} pieceData - Objekti i pjess q do t rrotullohet.\n * @returns {object} - Objekti i pjess me formn e rrotulluar.\n */\nexport function rotatePiece(pieceData) {\n    if (!pieceData || !pieceData.currentShape) return pieceData;\n\n    // Gjej dimensionet e forms aktuale\n    let minR = Infinity, maxR = -Infinity, minC = Infinity, maxC = -Infinity;\n    pieceData.currentShape.forEach(([r, c]) => {\n        minR = Math.min(minR, r); maxR = Math.max(maxR, r);\n        minC = Math.min(minC, c); maxC = Math.max(maxC, c);\n    });\n    const height = maxR - minR;\n\n    // Apliko rrotullimin\n    const newShape = pieceData.currentShape.map(([r, c]) => [(c - minC), (height - (r - minR))]);\n\n    // Normalizo formn e re q t filloj nga (0,0)\n    let newMinR = Infinity, newMinC = Infinity;\n    newShape.forEach(([r, c]) => {\n        newMinR = Math.min(newMinR, r);\n        newMinC = Math.min(newMinC, c);\n    });\n\n    const normalizedShape = newShape.map(([r, c]) => [r - newMinR, c - newMinC]);\n    \n    return { ...pieceData, currentShape: normalizedShape };\n}\n\n/**\n * Pasqyron nj pjes horizontalisht (flip majtas-djathtas)\n * @param {object} pieceData - Objekti i pjess\n * @returns {object} - Pjes e pasqyruar\n */\nexport function flipPieceHorizontally(pieceData) {\n    if (!pieceData || !pieceData.currentShape) return pieceData;\n\n    // Gjej dimensionet e forms aktuale\n    let minR = Infinity, maxR = -Infinity, minC = Infinity, maxC = -Infinity;\n    pieceData.currentShape.forEach(([r, c]) => {\n        minR = Math.min(minR, r); maxR = Math.max(maxR, r);\n        minC = Math.min(minC, c); maxC = Math.max(maxC, c);\n    });\n    const width = maxC - minC;\n\n    // Apliko pasqyrimin horizontal: c -> (width - (c - minC))\n    const newShape = pieceData.currentShape.map(([r, c]) => [r, width - (c - minC)]);\n\n    // Normalizo formn e re q t filloj nga (0,0)\n    let newMinR = Infinity, newMinC = Infinity;\n    newShape.forEach(([r, c]) => {\n        newMinR = Math.min(newMinR, r);\n        newMinC = Math.min(newMinC, c);\n    });\n\n    const normalizedShape = newShape.map(([r, c]) => [r - newMinR, c - newMinC]);\n    \n    return { ...pieceData, currentShape: normalizedShape };\n}\n\n\n/**\n * Kontrollon nse nj pjes mund t vendoset n nj pozicion t caktuar n rrjet.\n * @param {array} pieceShape - Forma e pjess.\n * @param {number} startRow - Rreshti fillestar.\n * @param {number} startCol - Kolona fillestare.\n * @returns {boolean} - True nse vendosja sht e vlefshme.\n */\nexport function isValidPlacement(pieceShape, startRow, startCol) {\n    for (const [r, c] of pieceShape) {\n        const gridRow = startRow + r;\n        const gridCol = startCol + c;\n        if (\n            !isInBounds(gridRow, gridCol) ||\n            gameState.grid[gridRow][gridCol] !== 0\n        ) {\n            return false;\n        }\n    }\n    return true;\n}\n\n/**\n * Vendos nj pjes n rrjet (vetm n modelin e t dhnave).\n * @param {object} piece - Objekti i pjess.\n * @param {number} startRow - Rreshti ku vendoset.\n * @param {number} startCol - Kolona ku vendoset.\n */\nexport function placePieceOnGrid(piece, startRow, startCol) {\n    piece.currentShape.forEach(([r, c]) => {\n        gameState.grid[startRow + r][startCol + c] = piece.color;\n    });\n    gameState.score += piece.size;\n    // Pastro cache-in kur grid-i ndryshon\n    placementCache.clear();\n}\n\n/**\n * Kontrollon dhe pastron rreshtat dhe kolonat e plota.\n * @param {number} placedPieceColor - Ngjyra e pjess q sapo u vendos dhe shkaktoi pastrimin\n * @returns {object|null} - Objekt me t dhna pr efektet vizuale, ose null nse nuk pastrohet gj.\n */\nexport function checkAndClearLines(placedPieceColor = null) {\n  const beforeClearScore = (typeof gameState !== 'undefined' && gameState.score) || 0;\n\n    const clearedRows = [];\n    const clearedCols = [];\n\n    // Gjej rreshtat e plot\n    for (let r = 0; r < GRID_ROWS; r++) {\n        if (gameState.grid[r].every(cell => cell !== 0)) {\n            clearedRows.push(r);\n        }\n    }\n\n    // Gjej kolonat e plota\n    for (let c = 0; c < GRID_COLS; c++) {\n        let isColFull = true;\n        for (let r = 0; r < GRID_ROWS; r++) {\n            if (gameState.grid[r][c] === 0) {\n                isColFull = false;\n                break;\n            }\n        }\n        if (isColFull) {\n            clearedCols.push(c);\n        }\n    }    const totalLinesCleared = clearedRows.length + clearedCols.length;\n    if (totalLinesCleared === 0) {\n        gameState.combo.count = 0; // Reset combo if no lines cleared\n        return null;\n    }\n\n    // Prcakto ngjyrn pr animacion - prdor ngjyrn e pjess s fundit nse sht dhn\n    const animationColor = placedPieceColor ? getBaseColor(placedPieceColor) : 'rgba(133, 76, 19, 1)';\n\n    // Mblidh t dhnat pr efektet vizuale\n    const clearedCellsSet = new Set();\n    \n    clearedRows.forEach(r => { \n        for (let c = 0; c < GRID_COLS; c++) {\n            clearedCellsSet.add(JSON.stringify({ row: r, col: c }));\n        }\n    });\n    \n    clearedCols.forEach(c => { \n        for (let r = 0; r < GRID_ROWS; r++) {\n            clearedCellsSet.add(JSON.stringify({ row: r, col: c }));\n        }\n    });\n    \n    const cellsToAnimate = Array.from(clearedCellsSet).map(str => {\n        const cell = JSON.parse(str);\n        return {\n            ...cell,\n            animationColor: animationColor // Prdor ngjyrn e pjess s fundit pr t gjitha qelizat\n        };\n    });\n\n    // Llogarit pikt dhe combo\n    gameState.combo.count++;\n    const pointsEarned = calculateLineClearScore(totalLinesCleared, gameState.combo.count);\n    gameState.score += pointsEarned;\n\n    // Mos pastro menjher rrjetn ktu; lejo animacionin t prfundoj.\n    // Pastrimi kryhet n shtresn e UI-s (main.js) sapo t prfundoj animacioni pr secilin rresht/kolon.\n\n    const result = {\n        cellsToAnimate,\n        pointsEarned,\n        comboCount: gameState.combo.count,\n        totalLinesCleared,\n        clearedRows,\n        clearedCols,\n        placedPieceColor: placedPieceColor  // Include the piece color that caused the clear\n    };\n    // Pastro cache-in kur grid-i ndryshon\n    placementCache.clear();\n    return result;\n}\n\n/**\n * Llogarit pikt pr pastrimin e rreshtave, duke prfshir bonusin e combo-s.\n * Shton bonus spektakular pr combo >= 5.\n */\nfunction calculateLineClearScore(lines, combo) {\n    let baseScore = 0;\n    if (lines === 1) baseScore = 100;\n    else if (lines === 2) baseScore = 250;\n    else if (lines === 3) baseScore = 500;\n    else if (lines === 4) baseScore = 800;\n    else if (lines >= 5) baseScore = 1000 + (lines - 4) * 200;\n    \n    let comboBonus = combo > 1 ? (combo - 1) * 50 : 0;\n    // Bonus spektakular pr combo shum t larta\n    if (combo >= 5) comboBonus += 500 + (combo - 5) * 100;\n    return baseScore + comboBonus;\n}\n\n/**\n * Kontrollon nse ka ndonj lvizje t mundshme pr lojtarin.\n * Logjika hibride: kontrollon formn aktuale + rrotullimet nse ka token.\n * Prditson gameState.isGameOver.\n */\nexport function updateGameOverState() {\n    // Kontrollo vetm nse ka pjes aktive n raft\n    const activePieces = gameState.currentPieces.filter(p => p);\n    if (activePieces.length === 0) {\n        gameState.isGameOver = false; // Nuk ka pjes, nuk mund t jet game over\n        return;\n    }\n\n    for (const piece of activePieces) {\n        // 1. Provo formn aktuale (pa rrotullim)\n        if (canPieceBePlaced(piece.currentShape)) {\n            gameState.isGameOver = false;\n            return;\n        }\n        \n        // 2. Nse ka token rrotullimi, provo edhe rrotullimet\n        if (gameState.rotateTokens > 0) {\n            let shape = piece.currentShape;\n            for (let rot = 1; rot < 4; rot++) { // Fillo nga rrotullimi 1 (0 sht aktuale)\n                shape = rotatePiece({ ...piece, currentShape: shape }).currentShape;\n                if (canPieceBePlaced(shape)) {\n                    gameState.isGameOver = false;\n                    return;\n                }\n            }\n        }\n    }\n\n    // Nse arrijm ktu, asnj pjes nuk mund t vendoset\n    gameState.isGameOver = true;\n}\n\n// --- SISTEMA E RE PR VEPRIME SPECIALE ---\n\n/**\n * Ruan gjendjen aktuale t lojs pr undo functionality\n */\nexport function saveGameState() {\n    const currentState = {\n        grid: gameState.grid.map(row => [...row]), // Deep copy\n        score: gameState.score,\n        currentPieces: gameState.currentPieces.map(piece => {\n            if (!piece) return null;\n            return {\n                ...piece,\n                currentShape: Array.isArray(piece.currentShape) ? [...piece.currentShape] : piece.currentShape\n            };\n        }),\n        combo: { ...gameState.combo },\n        rotateTokens: gameState.rotateTokens,\n        undoTokens: gameState.undoTokens,\n        clearLineTokens: gameState.clearLineTokens,\n        swapTokens: gameState.swapTokens,\n        timestamp: Date.now()\n    };\n    \n    gameState.gameHistory.push(currentState);\n    \n    // Ruaj vetm 10 hapat e fundit pr t menaxhuar memorjen\n    if (gameState.gameHistory.length > 10) {\n        gameState.gameHistory.shift();\n    }\n}\n\n/**\n * Kthen lojn n gjendjen e mparshme\n * @returns {boolean} true nse undo u krye me sukses\n */\nexport function undoLastMove() {\n    if (gameState.gameHistory.length === 0) {\n        return false;\n    }\n    \n    const previousState = gameState.gameHistory.pop();\n    \n    // Rivendos gjendjen e mparshme\n    gameState.grid = previousState.grid;\n    gameState.score = previousState.score;\n    gameState.currentPieces = previousState.currentPieces;\n    gameState.combo = previousState.combo;\n    gameState.rotateTokens = previousState.rotateTokens;\n    gameState.undoTokens = previousState.undoTokens;\n    gameState.clearLineTokens = previousState.clearLineTokens;\n    gameState.swapTokens = previousState.swapTokens;\n    \n    return true;\n}\n\n/**\n * Kontrollon nse nj rresht ose kolon sht e plot\n * @param {number} index - Indeksi i rreshtit ose kolons\n * @param {boolean} isRow - true pr rresht, false pr kolon\n * @returns {boolean}\n */\nexport function isLineComplete(index, isRow) {\n    if (isRow) {\n        return gameState.grid[index].every(cell => cell !== 0);\n    } else {\n        return gameState.grid.every(row => row[index] !== 0);\n    }\n}\n\n/**\n * Merr koordinatat e t gjitha qelizave n nj rresht ose kolon\n * @param {number} index - Indeksi i rreshtit ose kolons\n * @param {boolean} isRow - true pr rresht, false pr kolon\n * @returns {Array} Array me koordinatat {row, col}\n */\nexport function getLineCells(index, isRow) {\n    const cells = [];\n    if (isRow) {\n        for (let c = 0; c < GRID_COLS; c++) {\n            cells.push({ row: index, col: c });\n        }\n    } else {\n        for (let r = 0; r < GRID_ROWS; r++) {\n            cells.push({ row: r, col: index });\n        }\n    }\n    return cells;\n}\n\n/**\n * Rrotullon nj pjes specifike duke prdorur token\n * @param {number} pieceIndex - Indeksi i pjess pr t'u rrotulluar\n * @returns {boolean} true nse rrotullimi u krye me sukses\n */\nexport function rotateSpecificPiece(pieceIndex) {\n    if (gameState.rotateTokens <= 0 || !gameState.currentPieces[pieceIndex]) {\n        return false;\n    }\n    \n    gameState.currentPieces[pieceIndex] = rotatePiece(gameState.currentPieces[pieceIndex]);\n    // Change ID to force UI update since only shape changed\n    gameState.currentPieces[pieceIndex].id = Date.now() + Math.random();\n    \n    return true;\n}\n\n/**\n * Funksion ndihms q kontrollon nse nj form mund t vendoset n grid\n * @param {array} shape - Forma pr t kontrolluar\n * @returns {boolean} - True nse forma mund t vendoset diku\n */\nfunction canPieceBePlaced(shape) {\n    for (let r = 0; r < GRID_ROWS; r++) {\n        for (let c = 0; c < GRID_COLS; c++) {\n            if (isValidPlacement(shape, r, c)) {\n                return true;\n            }\n        }\n    }\n    return false;\n}\n\n/**\n * Konverton numrin e ngjyrs n ngjyr CSS.\n * @param {number} colorNumber - Numri i ngjyrs nga gameState.grid\n * @returns {string} - Ngjyra CSS (hex code)\n */\nexport function getBaseColor(colorNumber) {\n    switch(colorNumber) {\n        case 1: return '#0072ff'; // Blu i thell\n        case 2: return '#56ab2f'; // Jeshile e gjall\n        case 3: return '#6b4f2a'; // Dark bronze\n        case 4: return '#fc4a1a'; // Portokalli i zjarrt\n        case 5: return '#333399'; // Purpur/Lejla\n        case 6: return '#fecfef'; // Roz e but\n        case 7: return '#fed6e3'; // Roz e leht\n        default: return '#FFD700'; // Default ari\n    }\n}\n\n/**\n * Gjen t gjitha pozicionet e mundshme ku mund t vendoset nj pjes.\n * @param {object} piece - Pjesa q do t vendoset\n * @returns {array} - Lista e pozicioneve t mundshme {row, col}\n */\nexport function findValidPlacements(piece) {\n    const validPlacements = [];\n    const shape = piece.currentShape || piece.shape;\n    \n    for (let row = 0; row < GRID_ROWS; row++) {\n        for (let col = 0; col < GRID_COLS; col++) {\n            if (isValidPlacement(shape, row, col)) {\n                validPlacements.push({ row, col });\n            }\n        }\n    }\n    \n    return validPlacements;\n}\n\n/**\n * Gjen vendet m t mira strategjike pr vendosjen e nj pjese (me caching)\n * @param {Object} piece - Pjesa pr t ciln duam t gjejm vendet m t mira\n * @returns {Array} Array me vendet m t mira t renditura sipas strategjis\n */\nexport function findBestPlacements(piece) {\n    // Krijo cache key bazuar n piece shape dhe grid state\n    const shapeKey = JSON.stringify(piece.currentShape || piece.shape);\n    const gridChecksum = calculateGridChecksum();\n    const cacheKey = `${shapeKey}-${gridChecksum}`;\n    \n    // Kontrollo cache\n    if (placementCache.has(cacheKey)) {\n        return placementCache.get(cacheKey);\n    }\n    \n    const allValidPlacements = findValidPlacements(piece);\n    const shape = piece.currentShape || piece.shape;\n    \n    if (allValidPlacements.length === 0) {\n        placementCache.set(cacheKey, []);\n        return [];\n    }\n    \n    // Vlerso do vendosje dhe jep pik strategjike\n    const scoredPlacements = allValidPlacements.map(placement => {\n        const { row, col } = placement;\n        const score = calculatePlacementScore(shape, row, col);\n        return { ...placement, score };\n    });\n    \n    // Renditi sipas pikve (m t mirt n fillim)\n    scoredPlacements.sort((a, b) => b.score - a.score);\n    \n    // Merr vetm 5-8 vendet m t mira (jo t gjitha)\n    const bestPlacements = scoredPlacements.slice(0, Math.min(8, Math.max(3, Math.ceil(scoredPlacements.length * 0.2))));\n    \n    // Ruaj n cache\n    placementCache.set(cacheKey, bestPlacements);\n    \n    return bestPlacements;\n}\n\n/**\n * Kalkulon nj checksum t shpejt pr grid state\n * @returns {string} - Checksum i grid-it\n */\nfunction calculateGridChecksum() {\n    let hash = 0;\n    for (let r = 0; r < GRID_ROWS; r++) {\n        for (let c = 0; c < GRID_COLS; c++) {\n            hash = ((hash << 5) - hash + gameState.grid[r][c]) >>> 0; // 32-bit rolling hash\n        }\n    }\n    return hash.toString(16);\n}\n\n/**\n * Kalkulon score-n pr nj placement specifik\n * @param {Array} shape - Forma e pjess\n * @param {number} row - Rreshti\n * @param {number} col - Kolona\n * @returns {number} - Score i placement-it\n */\nfunction calculatePlacementScore(shape, row, col) {\n    let score = 0;\n    \n    // 1. BONUS pr vendosje n qoshe (strategjike pr loj)\n    const isCorner = (row === 0 || row === GRID_ROWS - 1) && (col === 0 || col === GRID_COLS - 1);\n    if (isCorner) score += 50;\n    \n    // 2. BONUS pr vendosje pran mureve\n    const nearWall = (row === 0 || row === GRID_ROWS - 1 || col === 0 || col === GRID_COLS - 1);\n    if (nearWall) score += 30;\n    \n    // 3. BONUS pr vendosje q mund t kompletojn rreshta/kolona\n    const completionBonus = calculateCompletionPotential(shape, row, col);\n    score += completionBonus * 20;\n    \n    // 4. BONUS pr vendosje pran pjesve ekzistuese (konsolidim)\n    const adjacencyBonus = calculateAdjacencyBonus(shape, row, col);\n    score += adjacencyBonus * 15;\n    \n    // 5. PENALITET pr vendosje n mes (m pak strategjike)\n    const isCenter = row > 2 && row < GRID_ROWS - 3 && col > 2 && col < GRID_COLS - 3;\n    if (isCenter) score -= 20;\n    \n    return score;\n}\n\n/**\n * Kalkulon potencialin pr kompletimin e rreshtave/kolonave\n */\nfunction calculateCompletionPotential(shape, startRow, startCol) {\n    let potential = 0;\n    \n    // Kontrollo pr do rresht q prekon kjo pjes\n    const occupiedRows = new Set();\n    const occupiedCols = new Set();\n    \n    shape.forEach(([r, c]) => {\n        const gridRow = startRow + r;\n        const gridCol = startCol + c;\n        if (isInBounds(gridRow, gridCol)) {\n            occupiedRows.add(gridRow);\n            occupiedCols.add(gridCol);\n        }\n    });\n    \n    // Kontrollo sa t mbushura jan rreshtat/kolonat\n    occupiedRows.forEach(row => {\n        let filledCells = 0;\n        for (let col = 0; col < GRID_COLS; col++) {\n            if (gameState.grid[row][col] !== 0) filledCells++;\n        }\n        const fillPercentage = filledCells / GRID_COLS;\n        if (fillPercentage > 0.6) potential += fillPercentage * 2; // Bonus i lart pr rreshta pothuajse t mbushur\n    });\n    \n    occupiedCols.forEach(col => {\n        let filledCells = 0;\n        for (let row = 0; row < GRID_ROWS; row++) {\n            if (gameState.grid[row][col] !== 0) filledCells++;\n        }\n        const fillPercentage = filledCells / GRID_ROWS;\n        if (fillPercentage > 0.6) potential += fillPercentage * 2; // Bonus i lart pr kolona pothuajse t mbushura\n    });\n    \n    return potential;\n}\n\n/**\n * Kalkulon bonusin pr vendosje pran pjesve ekzistuese\n */\nfunction calculateAdjacencyBonus(shape, startRow, startCol) {\n    let adjacentCount = 0;\n    \n    shape.forEach(([r, c]) => {\n        const gridRow = startRow + r;\n        const gridCol = startCol + c;\n        \n        if (isInBounds(gridRow, gridCol)) {\n            // Kontrollo qelizat prreth\n            const directions = [[-1, 0], [1, 0], [0, -1], [0, 1]];\n            directions.forEach(([dr, dc]) => {\n                const checkRow = gridRow + dr;\n                const checkCol = gridCol + dc;\n                if (isInBounds(checkRow, checkCol) &&\n                    gameState.grid[checkRow][checkCol] !== 0) {\n                    adjacentCount++;\n                }\n            });\n        }\n    });\n    \n    return adjacentCount;\n}\n\n","// js/audio.js\n// Menaxhon t gjith logjikn pr tingujt dhe feedback-un haptik.\n\nimport { gameState } from './state.js'; // Importo gjendjen pr t kontrolluar pauzn/game over\n\nlet audioContext;\nlet isAudioInitialized = false;\n\n/**\n * Inicializon AudioContext. Duhet t thirret vetm nj her pas interaksionit\n * t par t prdoruesit pr t respektuar politikat e browser-ave.\n */\nexport function initAudioContext() {\n    if (isAudioInitialized) return;\n    try {\n        // Krijo AudioContext. Prdor 'webkit' pr pajtueshmri me Safari m t vjetr.\n        audioContext = new (window.AudioContext || window.webkitAudioContext)();\n        isAudioInitialized = true;\n    } catch (e) {\n        // Audio initialization failed - continue silently\n    }\n}\n\n/**\n * Funksion i brendshm, i prgjithshm pr t luajtur nj not muzikore.\n * @param {number} frequency Frekuenca e nots n Hz.\n * @param {number} duration Kohzgjatja n sekonda.\n * @param {number} volume Volumi (0.0 deri 1.0).\n * @param {string} type Tipi i vals ('sine', 'square', 'sawtooth', 'triangle').\n */\nfunction playTone(frequency, duration, volume, type = 'sine', { allowWhenInactive = false } = {}) {\n    if (!isAudioInitialized || !audioContext) return;\n    \n    // Check if sound is enabled\n    const soundEnabled = localStorage.getItem('soundEnabled') !== 'false';\n    if (!soundEnabled) return;\n    \n    // Mos luaj tinguj n pauz/game over, prve rasteve kur krkohet shprehimisht\n    if ((gameState.isPaused || gameState.isGameOver) && !allowWhenInactive) return;\n\n    const oscillator = audioContext.createOscillator();\n    const gainNode = audioContext.createGain();\n\n    oscillator.connect(gainNode);\n    gainNode.connect(audioContext.destination);\n\n    oscillator.type = type;\n    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);\n    gainNode.gain.setValueAtTime(volume, audioContext.currentTime);\n    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);\n\n    oscillator.start(audioContext.currentTime);\n    oscillator.stop(audioContext.currentTime + duration);\n}\n\n/**\n * Aktivizon vibrimin n pajisjet q e suportojn.\n * @param {number|number[]} duration Kohzgjatja e vibrimit n milisekonda.\n */\nexport function playHapticFeedback(duration = 50) {\n    // Check if vibration is enabled\n    const vibrationEnabled = localStorage.getItem('vibrationEnabled') !== 'false';\n    if (!vibrationEnabled) return;\n    \n    if (window.navigator && window.navigator.vibrate) {\n        window.navigator.vibrate(duration);\n    }\n}\n\n\n// --- Tingujt specifik t lojs ---\n\nexport const playPlaceSound = () => {\n    playTone(440, 0.1, 0.3, 'square');\n    playHapticFeedback(30);\n};\n\nexport const playClearSound = (numLines) => {\n    playTone(600 + (numLines * 50), 0.15, 0.4, 'triangle');\n    playHapticFeedback([50, 30, 50]);\n};\n\nexport const playComboSound = (comboCount) => {\n    playTone(800 + (comboCount * 100), 0.2, 0.5, 'sine');\n};\n\nexport const playGameOverSound = () => {\n    // Luaj tingullin edhe nse loja sht n pauz\n    initAudioContext();\n    if (!audioContext) return;\n    playTone(200, 0.5, 0.5, 'sawtooth', { allowWhenInactive: true });\n    setTimeout(() => playTone(150, 0.5, 0.5, 'sawtooth', { allowWhenInactive: true }), 200);\n};\n\nexport const playRotateSound = () => {\n    playTone(1200, 0.05, 0.1, 'sine');\n    playHapticFeedback(20);\n}\n/**\n * UI button click sound effect\n */\nexport const playUIButtonSound = () => {\n    // Ensure audio context is initialized on user gesture\n    initAudioContext();\n    // Resume context if suspended (common on browsers) so sound plays reliably\n    if (audioContext && audioContext.state === 'suspended') {\n        audioContext.resume();\n    }\n    // Simple click tone and light haptic feedback\n    playTone(400, 0.05, 0.3, 'square', { allowWhenInactive: true });\n    playHapticFeedback(20);\n};\n\n// Specialized sound for pause action\nexport const playPauseSound = () => {\n    initAudioContext();\n    if (audioContext && audioContext.state === 'suspended') {\n        audioContext.resume();\n    }\n    playTone(250, 0.1, 0.3, 'triangle', { allowWhenInactive: true });\n    playHapticFeedback(30);\n};\n\n// Specialized sound for resume action\nexport const playResumeSound = () => {\n    initAudioContext();\n    if (audioContext && audioContext.state === 'suspended') {\n        audioContext.resume();\n    }\n    playTone(550, 0.1, 0.3, 'triangle', { allowWhenInactive: true });\n    playHapticFeedback(30);\n};\n\n// Specialized sound for restart action\nexport const playRestartSound = () => {\n    initAudioContext();\n    if (audioContext && audioContext.state === 'suspended') {\n        audioContext.resume();\n    }\n    playTone(700, 0.1, 0.3, 'sawtooth', { allowWhenInactive: true });\n    playHapticFeedback(40);\n};\n\n// Gentle sound for piece appearance animation\nexport const playPieceAppearSound = () => {\n    initAudioContext();\n    if (audioContext && audioContext.state === 'suspended') {\n        audioContext.resume();\n    }\n    // Soft, pleasant tone for piece entrance\n    playTone(660, 0.08, 0.15, 'sine');\n    playHapticFeedback(15);\n};","// Rendering and UI update functions\n\nimport { gameState } from './state.js';\nimport { GRID_ROWS, GRID_COLS } from './constants.js';\nimport { pieceUnlockSystem } from './pieceUnlockSystem.js';\nimport * as audio from './audio.js';\n\n//  PERFORMANCE: Object Pool to reduce Garbage Collection pauses\nclass AnimationPool {\n    constructor(size = 100) {\n        this.pool = Array.from({ length: size }, () => ({ r: 0, c: 0, delay: 0 }));\n        this.index = 0;\n    }\n    acquire() {\n        const item = this.pool[this.index];\n        this.index = (this.index + 1) % this.pool.length;\n        return item;\n    }\n}\nconst animPool = new AnimationPool();\n\n// Element Cache\nconst dom = {};\nlet cellElements = [];\n// Cache pr highlighted cells pr performance\nlet highlightedCells = new Set();\n// Track current highlight state to avoid redundant updates\nlet lastHighlightedCells = new Set();\nlet lastHighlightClass = '';\nlet lastPieceColor = '';\nconst PIECE_ANIMATION_DURATION = 950;\n\n\n\n\n/**\n * Gjen t gjitha elementet e nevojshme nga DOM-i dhe i ruan n objektin 'dom'.\n */\nexport function cacheDOMElements() {\n    const ids = [\n        'landingPage', 'startButton', 'gameGrid', 'piecesContainer', 'score',\n        'highscore-display', 'restartButton', 'pauseButton', 'settingsButton',\n        'gameOverMessage', 'gameOverRestartButton', 'darkModeToggleGame',\n        'particles-overlay', 'comboMessage', 'themeSelectorContainer', 'draggedPieceClone',\n        'pieces-unlocked', 'achievements-count', 'finalScore', 'gameOverHighScore'\n    ];\n    ids.forEach(id => dom[id] = document.getElementById(id));\n    dom.gameContainer = document.querySelector('.game-container');\n    \n    // Note: createUnlockProgressIndicator() moved to initializeState based on game mode\n}\n\n/**\n * Krijon indicator pr unlock progress\n */\nfunction createUnlockProgressIndicator() {\n    // Remove existing progress indicator if it exists\n    const existingProgress = document.getElementById('unlock-progress');\n    if (existingProgress) {\n        existingProgress.remove();\n    }\n    \n    \n    const progressDiv = document.createElement('div');\n    progressDiv.id = 'unlock-progress';\n    progressDiv.className = 'unlock-progress';\n    progressDiv.innerHTML = `\n        <h4> Piece Collection</h4>\n        <div class=\"progress-bar\">\n            <div class=\"progress-fill\" id=\"progress-fill\"></div>\n        </div>\n        <div class=\"progress-text\" id=\"progress-text\">7/30 pieces unlocked</div>\n        <div class=\"progress-text\" id=\"next-unlock-text\">Next unlock: 1000 points</div>\n    `;\n    document.body.appendChild(progressDiv);\n    dom.unlockProgress = progressDiv;\n    // Close progress indicator on click\n    const onClickOutside = (e) => {\n        if (!progressDiv.contains(e.target)) {\n            cleanup();\n        }\n    };\n    const cleanup = () => {\n        if (progressDiv.parentNode) {\n            progressDiv.remove();\n        }\n        document.removeEventListener('click', onClickOutside);\n        if (autoDismissId) {\n            clearTimeout(autoDismissId);\n        }\n    };\n    progressDiv.addEventListener('click', cleanup);\n    // Auto-dismiss after 3 seconds\n    const autoDismissId = setTimeout(() => {\n        cleanup();\n    }, 3000);\n    // Close on click outside progress indicator\n    document.addEventListener('click', onClickOutside);\n    \n    // Update initial progress\n    updateUnlockProgress();\n}\n\n/**\n * Krijon rrjetn e qelizave n DOM vetm nj her. Kjo sht thelbsore pr performancn.\n */\nexport function createGridDOM() {\n    dom.gameGrid.innerHTML = '';\n    cellElements = [];\n    for (let r = 0; r < GRID_ROWS; r++) {\n        const rowElements = [];\n        for (let c = 0; c < GRID_COLS; c++) {\n            const cell = document.createElement('div');\n            cell.classList.add('grid-cell');\n            cell.dataset.row = r;\n            cell.dataset.col = c;\n            \n            // Create a block wrapper inside the cell - this is what we animate\n            const blockWrapper = document.createElement('div');\n            blockWrapper.classList.add('grid-cell-block');\n            cell.appendChild(blockWrapper);\n            \n            dom.gameGrid.appendChild(cell);\n            rowElements.push(cell);\n        }\n        cellElements.push(rowElements);\n    }\n}\n\n/**\n * Krijon elementin HTML pr nj pjes t vetme.\n */\nfunction createPieceElement(pieceData, index) {\n    const pieceElement = document.createElement('div');\n    pieceElement.classList.add('piece');\n    pieceElement.dataset.pieceIndex = index;\n\n    if (!pieceData) {\n        pieceElement.classList.add('empty');\n        pieceElement.dataset.pieceId = '';\n        return pieceElement;\n    }\n    \n    // Add piece ID for tracking changes\n    pieceElement.dataset.pieceId = pieceData.id ? pieceData.id.toString() : '';\n    \n    pieceElement.setAttribute('draggable', 'true');\n    const pieceGrid = createPieceGridElement(pieceData);\n    pieceElement.appendChild(pieceGrid);\n    \n    return pieceElement;\n}\n\n/**\n * Krijon rrjetn vizuale pr nj pjes (prdoret pr pjest n raft dhe pr klonin).\n */\nfunction createPieceGridElement(pieceData) {\n    const pieceGrid = document.createElement('div');\n    pieceGrid.classList.add('piece-grid');\n\n    let maxRow = 0, maxCol = 0;\n    pieceData.currentShape.forEach(([r, c]) => {\n        maxRow = Math.max(maxRow, r);\n        maxCol = Math.max(maxCol, c);\n    });\n\n    pieceGrid.style.gridTemplateRows = `repeat(${maxRow + 1}, var(--piece-block-size))`;\n    pieceGrid.style.gridTemplateColumns = `repeat(${maxCol + 1}, var(--piece-block-size))`;\n\n    const visualGrid = Array.from({ length: maxRow + 1 }, () => Array(maxCol + 1).fill(0));\n    pieceData.currentShape.forEach(([r, c]) => { visualGrid[r][c] = pieceData.color; });\n\n    for (let r = 0; r <= maxRow; r++) {\n        for (let c = 0; c <= maxCol; c++) {\n            const block = document.createElement('div');\n            block.classList.add('piece-block');\n            if (visualGrid[r][c] !== 0) {\n                block.classList.add(`color-${visualGrid[r][c]}`);\n                block.dataset.shapeRow = r;\n                block.dataset.shapeCol = c;\n            } else {\n                block.style.visibility = 'hidden';\n            }\n            pieceGrid.appendChild(block);\n        }\n    }\n    \n    return pieceGrid;\n}\n\nfunction hasPieceChanged(existingElement, newPieceData) {\n    const shouldBeEmpty = !newPieceData;\n    const isCurrentlyEmpty = !existingElement || existingElement.classList.contains('empty');\n\n    if (shouldBeEmpty || isCurrentlyEmpty) {\n        return shouldBeEmpty !== isCurrentlyEmpty;\n    }\n\n    const existingId = existingElement.dataset.pieceId || '';\n    const nextId = newPieceData.id ? newPieceData.id.toString() : '';\n    return existingId !== nextId;\n}\n\nfunction animatePieceEntry(pieceElement, index, { isInitialLoad = false, allowSound = true } = {}) {\n    if (!pieceElement || pieceElement.classList.contains('empty')) {\n        return;\n    }\n\n    pieceElement.classList.add('new-piece');\n\n    if (isInitialLoad) {\n        const delay = index * 150;\n        pieceElement.style.animationDelay = `${delay}ms`;\n        if (allowSound) {\n            setTimeout(() => audio.playPieceAppearSound(), delay);\n        }\n        setTimeout(() => {\n            pieceElement.classList.remove('new-piece');\n            pieceElement.style.animationDelay = '';\n        }, PIECE_ANIMATION_DURATION + delay);\n        return;\n    }\n\n    if (allowSound) {\n        audio.playPieceAppearSound();\n    }\n    setTimeout(() => {\n        pieceElement.classList.remove('new-piece');\n    }, PIECE_ANIMATION_DURATION);\n}\n\nfunction rebuildPiecesContainer({ animateAll = false } = {}) {\n    if (!dom.piecesContainer) {\n        return;\n    }\n\n    dom.piecesContainer.innerHTML = '';\n    gameState.currentPieces.forEach((pieceData, index) => {\n        const pieceElement = createPieceElement(pieceData, index);\n        dom.piecesContainer.appendChild(pieceElement);\n        if (animateAll) {\n            animatePieceEntry(pieceElement, index, { isInitialLoad: true, allowSound: true });\n        }\n    });\n}\n\n// --- Main Render Functions ---\n\n/**\n *  PERFORMANCE: Batched DOM updates to prevent Layout Thrashing\n * PHASE 1: READ all DOM state without modifications\n * PHASE 2: WRITE all changes in batch (single layout recalculation)\n */\nexport function updateGridDisplay() {\n    const updates = []; // Store changes temporarily\n\n    // PHASE 1: READ ONLY (Do not touch DOM)\n    for (let r = 0; r < GRID_ROWS; r++) {\n        for (let c = 0; c < GRID_COLS; c++) {\n            const cellValue = gameState.grid[r][c];\n            const cellElement = cellElements[r][c];\n            \n            // Check if wrapper exists without creating it yet\n            let blockWrapper = cellElement.firstChild;\n            let needsCreation = !blockWrapper;\n            \n            updates.push({\n                cellElement,\n                blockWrapper, \n                needsCreation,\n                cellValue,\n                // Calculate class here, not during write\n                newClass: cellValue !== 0 ? `filled-${cellValue}` : null\n            });\n        }\n    }\n\n    // PHASE 2: WRITE ONLY (Apply changes)\n    updates.forEach(({ cellElement, blockWrapper, needsCreation, cellValue, newClass }) => {\n        if (needsCreation) {\n            blockWrapper = document.createElement('div');\n            blockWrapper.classList.add('grid-cell-block');\n            cellElement.appendChild(blockWrapper);\n        }\n\n        // Reset classes\n        blockWrapper.className = 'grid-cell-block';\n\n        // Add new class if needed\n        if (newClass) {\n            blockWrapper.classList.add(newClass);\n        }\n    });\n}\n\n/**\n * Clears lastPlacement after one render cycle to avoid re-animating\n */\nexport function clearPlacementFlag() {\n    // Reset lastPlacementCells to avoid re-triggering animation\n    gameState.lastPlacementCells = [];\n}\n/**\n * Animon qelizat e sapo vendosura me nj efekt vale fluid dhe organik.\n * @param {Array<{r:number, c:number}>} cells - Vargu i pozicioneve t qelizave pr t'u animuar.\n */\nexport function animatePlacement(cells) {\n    if (!Array.isArray(cells) || cells.length === 0) return;\n\n    let centerR = 0;\n    let centerC = 0;\n    cells.forEach(({ r, c }) => {\n        centerR += r;\n        centerC += c;\n    });\n    centerR /= cells.length;\n    centerC /= cells.length;\n\n    const cellsWithDelay = cells.map(({ r, c }) => {\n        //  Use pool instead of creating new object\n        const obj = animPool.acquire(); \n        \n        // Simple distance calculation for ripple effect\n        // Assuming grid center is roughly 4,4 (adjust if grid size differs)\n        const distance = Math.hypot(r - 4, c - 4); \n        \n        obj.r = r;\n        obj.c = c;\n        obj.delay = distance * 30; \n        return obj;\n    });\n\n    cells.forEach(({ r, c }) => {\n        const cell = cellElements[r]?.[c];\n        if (!cell) return;\n        const blockWrapper = cell.querySelector('.grid-cell-block');\n        if (!blockWrapper) return;\n        blockWrapper.classList.remove('placed');\n        blockWrapper.style.animation = 'none';\n        void blockWrapper.offsetWidth;\n    });\n\n    cellsWithDelay.forEach(({ r, c, delay }) => {\n        const cell = cellElements[r]?.[c];\n        if (!cell) return;\n        const blockWrapper = cell.querySelector('.grid-cell-block');\n        if (!blockWrapper) return;\n\n        const jitter = (Math.random() - 0.5) * 14;\n        const finalDelay = Math.max(0, delay + jitter);\n\n        blockWrapper.style.animation = '';\n        blockWrapper.style.animationDelay = `${finalDelay}ms`;\n        blockWrapper.classList.add('placed');\n\n        blockWrapper.addEventListener('animationend', () => {\n            blockWrapper.classList.remove('placed');\n            blockWrapper.style.animationDelay = '';\n        }, { once: true });\n    });\n}\n\n/**\n * Prditson pamjen e pjesve n dispozitiv.\n */\nexport function updatePiecesDisplay(isInitialLoad = false) {\n    if (!dom.piecesContainer || !Array.isArray(gameState.currentPieces)) {\n        return;\n    }\n\n    const renderedPieces = Array.from(dom.piecesContainer.children);\n    const nextPieces = gameState.currentPieces;\n\n    if (isInitialLoad || renderedPieces.length !== nextPieces.length) {\n        rebuildPiecesContainer({ animateAll: isInitialLoad });\n        return;\n    }\n\n    const changedIndices = [];\n    for (let i = 0; i < nextPieces.length; i++) {\n        if (hasPieceChanged(renderedPieces[i], nextPieces[i])) {\n            changedIndices.push(i);\n        }\n    }\n\n    if (changedIndices.length === 0) {\n        return;\n    }\n\n    let soundPlayed = false;\n    changedIndices.forEach((index) => {\n        const newPieceData = nextPieces[index];\n        const newElement = createPieceElement(newPieceData, index);\n        const reference = renderedPieces[index];\n\n        if (reference && reference.parentNode === dom.piecesContainer) {\n            reference.replaceWith(newElement);\n        } else if (dom.piecesContainer.children[index]) {\n            dom.piecesContainer.replaceChild(newElement, dom.piecesContainer.children[index]);\n        } else {\n            dom.piecesContainer.appendChild(newElement);\n        }\n\n        if (newPieceData) {\n            const allowSound = !soundPlayed;\n            animatePieceEntry(newElement, index, { allowSound, isInitialLoad: false });\n            if (allowSound) {\n                soundPlayed = true;\n            }\n        }\n    });\n}\n\n/**\n * Prditson shfaqjen e pikve dhe pikve m t larta.\n */\nexport function updateScoreDisplay() {\n    // Update current score text\n    dom.score.textContent = gameState.score;\n    // Pop animation on score change\n    const scoreEl = dom.score;\n    if (scoreEl) {\n        scoreEl.classList.remove('score-animated');\n        void scoreEl.offsetWidth; // force reflow to restart animation\n        scoreEl.classList.add('score-animated');\n    }\n    if (gameState.score > gameState.highScore) {\n        gameState.highScore = gameState.score;\n        localStorage.setItem('blokusHighScore', gameState.highScore);\n    }\n    // Update high score only in landing page, not during game\n    if (dom['highscore-display']) {\n        dom['highscore-display'].textContent = gameState.highScore;\n    }\n}\n/**\n * Prditson unlock progress indicator\n */\nfunction updateUnlockProgress() {\n    const gameMode = localStorage.getItem('selectedGameMode') || 'collection';\n    \n    // Only update progress in Collection Mode\n    if (gameMode !== 'collection') {\n        return;\n    }\n    \n    const progressInfo = pieceUnlockSystem.getProgressInfo();\n    \n    const progressFill = document.getElementById('progress-fill');\n    const progressText = document.getElementById('progress-text');\n    const nextUnlockText = document.getElementById('next-unlock-text');\n    \n    if (progressFill) {\n        progressFill.style.width = `${progressInfo.percentage}%`;\n    }\n    \n    if (progressText) {\n        progressText.textContent = `${progressInfo.unlockedCount}/${progressInfo.totalPieces} pieces unlocked`;\n    }\n    \n    if (nextUnlockText && progressInfo.nextUnlock) {\n        nextUnlockText.textContent = `Next: ${progressInfo.nextUnlock.name} (${progressInfo.nextUnlock.remaining} points)`;\n    } else if (nextUnlockText) {\n        nextUnlockText.textContent = \" All pieces unlocked!\";\n    }\n}\n\n\n// --- UI Panels and Messages ---\n\n/**\n * Update overlays - now only handles game over screen\n */\nexport function updateOverlays() {\n    try {\n        const showGameOver = gameState.isGameOver;\n\n        if (dom.gameOverMessage) {\n            dom.gameOverMessage.classList.toggle('hidden', !showGameOver);\n            \n            // If showing game over, attach the Play Again listener\n            if (showGameOver) {\n                setTimeout(() => {\n                    const playAgainBtn = document.getElementById('gameOverRestartButton');\n                    \n                    if (playAgainBtn) {\n                        // Remove existing listeners\n                        playAgainBtn.onclick = null;\n                        const newBtn = playAgainBtn.cloneNode(true);\n                        playAgainBtn.parentNode.replaceChild(newBtn, playAgainBtn);\n                        \n                        newBtn.addEventListener('click', function(e) {\n                            e.preventDefault();\n                            e.stopPropagation();\n                            \n                            // Import necessary modules and restart game\n                            import('./state.js').then(({ initializeState }) => {\n                                import('./gameLogic.js').then((logic) => {\n                                    // Hide game over message\n                                    dom.gameOverMessage.classList.add('hidden');\n                                    \n                                    // Reset game state\n                                    initializeState();\n                                    logic.populateInitialPieces();\n                                    \n                                    // Update displays\n                                    updateGridDisplay();\n                                    updatePiecesDisplay();\n                                    updateScoreDisplay();\n                                    updateOverlays();\n                                    \n                                    // Re-attach piece event listeners using main.js function\n                                    setTimeout(() => {\n                                        if (window.attachPieceEventListeners) {\n                                            window.attachPieceEventListeners();\n                                        } else {\n                                            // Fallback: try to call the function from main module\n                                            import('./main.js').then((main) => {\n                                                if (main.attachPieceEventListeners) {\n                                                    main.attachPieceEventListeners();\n                                                }\n                                            });\n                                        }\n                                    }, 200);\n                                    \n                                }).catch(err => console.log('Error loading gameLogic:', err));\n                            }).catch(err => console.log('Error loading state:', err));\n                        });\n                        \n                    }\n                }, 100);\n            }\n        }\n\n        // Only dim background when game over overlay is active, not when paused\n        if (showGameOver) {\n            if (dom.piecesContainer) dom.piecesContainer.style.opacity = '0.5';\n            if (dom.gameGrid) dom.gameGrid.style.opacity = '0.5';\n        } else {\n            if (dom.piecesContainer) dom.piecesContainer.style.opacity = '1';\n            if (dom.gameGrid) dom.gameGrid.style.opacity = '1';\n        }\n    } catch (error) {\n        // Silent error handling - continue operation\n    }\n}\n\nexport function showGameOverMessage() {\n    // Update final score and high score in game over screen\n    if (dom.finalScore) {\n        dom.finalScore.textContent = gameState.score;\n    }\n    if (dom.gameOverHighScore) {\n        dom.gameOverHighScore.textContent = gameState.highScore;\n    }\n    \n    dom.gameOverMessage.classList.remove('hidden');\n    dom.piecesContainer.style.opacity = '0.5';\n    \n    // Attach play again listener\n    setTimeout(() => {\n        const playAgainBtn = document.getElementById('gameOverRestartButton');\n        \n        if (playAgainBtn) {\n            // Remove any existing listeners\n            playAgainBtn.onclick = null;\n            const newBtn = playAgainBtn.cloneNode(true);\n            playAgainBtn.parentNode.replaceChild(newBtn, playAgainBtn);\n            \n            // Add new listener - reload page to restart game\n            newBtn.addEventListener('click', function(e) {\n                e.preventDefault();\n                e.stopPropagation();\n                location.reload();\n            });\n        }\n    }, 500);\n}\n\nexport function hideGameOverMessage() {\n    dom.gameOverMessage.classList.add('hidden');\n    dom.piecesContainer.style.opacity = '1';\n}\n\nexport function updateControlButtons() {\n    if (dom.pauseButton) {\n        dom.pauseButton.disabled = gameState.isGameOver;\n        dom.pauseButton.innerHTML = gameState.isPaused ? '<i class=\"fas fa-play\"></i>' : '<i class=\"fas fa-pause\"></i>';\n        dom.pauseButton.title = gameState.isPaused ? 'Resume Game' : 'Pause Game';\n        dom.pauseButton.setAttribute('aria-label', gameState.isPaused ? 'Resume Game' : 'Pause Game');\n    }\n    \n    if (dom.restartButton) {\n        dom.restartButton.disabled = gameState.isGameOver;\n        // Explicitly show or hide restart button based on pause state\n        if (gameState.isPaused) {\n            dom.restartButton.classList.remove('hidden');\n        } else {\n            dom.restartButton.classList.add('hidden');\n        }\n    }\n}\n// Shfaq mesazh combo spektakolar\nexport function showComboMessage(comboCount) {\n    const comboMsg = dom.comboMessage;\n    comboMsg.textContent = comboCount >= 5 ? `SPEKTAKOLARE! COMBO x${comboCount}` : `Combo x${comboCount}`;\n    comboMsg.classList.remove('hidden');\n    if (comboCount >= 5) comboMsg.classList.add('spectacular');\n    setTimeout(() => {\n        comboMsg.classList.add('hidden');\n        comboMsg.classList.remove('spectacular');\n    }, 1200);\n}\n\n\n/**\n * Clean up old floating score elements to prevent memory leaks\n */\nexport function cleanupOldFloatingScores() {\n    const floatingScores = document.querySelectorAll('.floating-score');\n    const now = Date.now();\n    const maxAge = 5000; // 5 seconds max age\n    \n    floatingScores.forEach(element => {\n        const created = parseInt(element.dataset.created);\n        if (created && (now - created) > maxAge) {\n            element.remove();\n        }\n    });\n}\n\n// --- Drag & Drop Visuals (nga dragVisuals.js) ---\n\n/**\n * Krijon klonin vizual t pjess q trhiqet.\n */\nexport function createDraggedPieceClone(pieceData) {\n    if (!dom.draggedPieceClone) {\n        console.warn('draggedPieceClone element not found in DOM');\n        return;\n    }\n    \n    const pieceGrid = createPieceGridElement(pieceData);\n    dom.draggedPieceClone.innerHTML = '';\n    // Mark the clone container so CSS can easily exclude it from grid animations\n    dom.draggedPieceClone.setAttribute('data-clone', 'true');\n    // Mark inner blocks so they can be targeted precisely if needed\n    pieceGrid.querySelectorAll('.piece-block').forEach(b => b.classList.add('clone-block'));\n    dom.draggedPieceClone.appendChild(pieceGrid);\n    dom.draggedPieceClone.classList.remove('hidden', 'shake');\n    dom.draggedPieceClone.classList.add('show');\n    \n    // Cache geometry metrics for smoother drag calculations\n    let blockSize = 30;\n    const cloneBlock = dom.draggedPieceClone.querySelector('.piece-block');\n    if (cloneBlock) {\n        const rect = cloneBlock.getBoundingClientRect();\n        blockSize = rect.width;\n    }\n\n    let gap = 0;\n    const cloneGrid = dom.draggedPieceClone.querySelector('.piece-grid');\n    if (cloneGrid) {\n        const computed = getComputedStyle(cloneGrid);\n        const gapValue = computed.gap || computed.gridGap;\n        const parsedGap = parseFloat(gapValue);\n        if (!Number.isNaN(parsedGap)) {\n            gap = parsedGap;\n        }\n    }\n\n    const cloneStyle = getComputedStyle(dom.draggedPieceClone);\n    const paddingX = parseFloat(cloneStyle.paddingLeft) || 0;\n    const paddingY = parseFloat(cloneStyle.paddingTop) || 0;\n\n    Object.assign(gameState.dragState, {\n        blockSize,\n        gap,\n        paddingX,\n        paddingY,\n        metricsCached: true,\n    });\n    // debug logs removed for production\n}\n\nexport function hideDraggedPieceClone() {\n    dom.draggedPieceClone.classList.remove('show');\n}\n\nexport function shakeDraggedPieceClone(duration) {\n    dom.draggedPieceClone.classList.add('shake');\n    setTimeout(() => {\n        dom.draggedPieceClone.classList.remove('shake');\n    }, duration);\n}\n\n/**\n * Prditson pozicionin e klonit t trhequr pr t ndjekur kursorin/gishtin,\n * duke marr parasysh padding-un pr pozicionim t sakt t bllokut t ankors.\n * OPTIMIZED: Avoids offsetWidth/offsetHeight reads which force reflow\n */\nexport function updateDraggedPiecePosition(clientX, clientY) {\n    if (!dom.draggedPieceClone) return;\n    if (!dom.draggedPieceClone.classList.contains('show')) return;\n    // aktivizo do transformim ekzistues\n    dom.draggedPieceClone.style.transform = 'none';\n    const { offsetX, offsetY } = gameState.dragState;\n    \n    let { blockSize, gap, paddingX, paddingY, metricsCached, cloneWidth, cloneHeight } = gameState.dragState;\n\n    if (!metricsCached) {\n        let measuredBlockSize = blockSize;\n        const cloneBlock = dom.draggedPieceClone.querySelector('.piece-block');\n        if (cloneBlock) {\n            const rect = cloneBlock.getBoundingClientRect();\n            measuredBlockSize = rect.width;\n        }\n\n        let measuredGap = gap;\n        const cloneGrid = dom.draggedPieceClone.querySelector('.piece-grid');\n        if (cloneGrid) {\n            const computed = getComputedStyle(cloneGrid);\n            const gapValue = computed.gap || computed.gridGap;\n            const parsedGap = parseFloat(gapValue);\n            if (!Number.isNaN(parsedGap)) {\n                measuredGap = parsedGap;\n            }\n        }\n\n        const cloneStyle = getComputedStyle(dom.draggedPieceClone);\n        const measuredPaddingX = parseFloat(cloneStyle.paddingLeft) || 0;\n        const measuredPaddingY = parseFloat(cloneStyle.paddingTop) || 0;\n        \n        // CRITICAL: Cache clone dimensions ONCE to avoid offsetWidth/offsetHeight reflows during drag\n        const measuredWidth = dom.draggedPieceClone.offsetWidth || 80;\n        const measuredHeight = dom.draggedPieceClone.offsetHeight || 80;\n\n        Object.assign(gameState.dragState, {\n            blockSize: measuredBlockSize || 30,\n            gap: !Number.isNaN(measuredGap) ? measuredGap : 0,\n            paddingX: measuredPaddingX,\n            paddingY: measuredPaddingY,\n            metricsCached: true,\n            cloneWidth: measuredWidth,\n            cloneHeight: measuredHeight,\n        });\n\n        ({ blockSize, gap, paddingX, paddingY, cloneWidth, cloneHeight } = gameState.dragState);\n    }\n\n    if (!blockSize || blockSize <= 0) {\n        blockSize = 30;\n    }\n    if (!Number.isFinite(gap)) {\n        gap = 0;\n    }\n    if (!Number.isFinite(paddingX)) {\n        paddingX = 0;\n    }\n    if (!Number.isFinite(paddingY)) {\n        paddingY = 0;\n    }\n\n    // Llogaritjet e pozicionit - vendos gishtin n qendrn e bllokut t ankors\n    const anchorXInClone = paddingX + (offsetX * (blockSize + gap)) + (blockSize / 2);\n    const anchorYInClone = paddingY + (offsetY * (blockSize + gap)) + (blockSize / 2);\n    \n    // Prdor metodn absolute t pozicionimit\n    const rawLeft = clientX - anchorXInClone;\n    const rawTop = clientY - anchorYInClone;\n    \n    // FIX: HEQJE e viewport clamping - kloni duhet t lviz lirshm n screen\n    // Viewport clamping po e bnte klonin ndalohet brenda ekranit dhe nuk shfaqej n qelizat e poshtme t grids\n    // Tani clone lviz lirshm me pointer pa klamping artificial\n    // Ghost preview (highlighted cells) po punojn sakt sepse jan grid-cell-based\n    \n    // OPTIMIZATION: Prdor transform translate3d pr hardware acceleration\n    // Kjo sht shum m e shpejt se left/top n mobile\n    // Use setProperty with 'important' to override any stylesheet rules that might\n    // force transform to 'none' (some legacy CSS used '!important'). This ensures\n    // the inline transform is applied on all browsers.\n    // DRAG LATENCY FIX: Direct translate3d keeps clone perfectly in sync with pointer\n    dom.draggedPieceClone.style.setProperty('transform', `translate3d(${rawLeft}px, ${rawTop}px, 0)`, 'important');\n    dom.draggedPieceClone.style.left = '0';\n    dom.draggedPieceClone.style.top = '0';\n}\n\n/**\n * Pastron t gjitha highlight-et dhe hijet nga rrjeta.\n * OPTIMIZED: Prdor cache n vend t querySelectorAll pr performance m t mir\n */\nexport function clearHighlights() {\n    highlightedCells.forEach(cell => {\n        // Remove highlight classes from the cell itself\n        cell.classList.remove('highlight', 'invalid-highlight');\n        \n        // Clean up ghost + color classes from the inner block wrapper\n        const blockWrapper = cell.querySelector('.grid-cell-block');\n        if (blockWrapper) {\n            blockWrapper.classList.remove('ghost');\n            if (lastPieceColor) {\n                blockWrapper.classList.remove(`filled-${lastPieceColor}`);\n            }\n        }\n        \n        // Clear any inline background styles\n        cell.style.backgroundColor = '';\n    });\n    // Clear cache\n    highlightedCells.clear();\n}\n\n/**\n * Shfaq hijen e pjess n rrjet ku do t vendoset.\n * OPTIMIZED: Prdor cache dhe redukton DOM manipulations\n */\nexport function showGhostAndHighlight(piece, startRow, startCol, isValid) {\n    clearHighlights();\n    const highlightClass = isValid ? 'highlight' : 'invalid-highlight';\n    \n    // Cache the piece color for cleanup later\n    lastPieceColor = piece.color;\n    lastHighlightClass = highlightClass;\n    \n    piece.currentShape.forEach(([r, c]) => {\n        const gridRow = startRow + r;\n        const gridCol = startCol + c;\n        if (gridRow >= 0 && gridRow < GRID_ROWS && gridCol >= 0 && gridCol < GRID_COLS) {\n            const cell = cellElements[gridRow][gridCol];\n            if (!cell) return;\n            \n            const blockWrapper = cell.querySelector('.grid-cell-block');\n            if (!blockWrapper) return;\n            \n            // Check if the underlying blockWrapper is already filled on the grid\n            const isGridFilled = Array.from(blockWrapper.classList).some(cls => cls.startsWith('filled-'));\n            \n            // Only draw ghost/highlight on empty grid blocks\n            if (!isGridFilled) {\n                cell.classList.add(highlightClass);\n                if (isValid) {\n                    // Apply ghost class + filled color for the 3D designed appearance\n                    // The filled-* class provides the 3D block design, ghost makes it semi-transparent\n                    blockWrapper.classList.add('ghost', `filled-${piece.color}`);\n                }\n                // Track the cell for fast cleanup later\n                highlightedCells.add(cell);\n            }\n        }\n    });\n}\n\n\n/**\n * Prditson emrin e tems q shfaqet n faqe\n * @param {string} themeName - Emri i tems\n */\n/**\n * Krijon elementet dinamik pr temn \"Future Galaxies\"\n */\n/**\n * Krijon elementet dinamik pr temn \"Future Galaxies - Universi i Pafund\"\n */\nfunction createGalaxyElements() {\n    // Krijo yjet e afrt\n    const closeStars = document.createElement('div');\n    closeStars.className = 'close-stars galaxy-element';\n    closeStars.style.overflow = 'hidden';\n    document.body.appendChild(closeStars);\n\n    // Krijo nebula efektet\n    const nebula1 = document.createElement('div');\n    nebula1.className = 'nebula-1 galaxy-element';\n    document.body.appendChild(nebula1);\n\n    const nebula2 = document.createElement('div');\n    nebula2.className = 'nebula-2 galaxy-element';\n    document.body.appendChild(nebula2);\n\n    // Krijo yje kryesore me shklqim\n    const celestialBodies = document.createElement('div');\n    celestialBodies.className = 'galaxy-element';\n    celestialBodies.style.position = 'fixed';\n    celestialBodies.style.top = '0';\n    celestialBodies.style.left = '0';\n    celestialBodies.style.width = '100%';\n    celestialBodies.style.height = '100%';\n    celestialBodies.style.pointerEvents = 'none';\n    \n    // Krijo 40 yje kryesore\n    for (let i = 0; i < 40; i++) {\n        const star = document.createElement('div');\n        star.className = 'celestial-star';\n        \n        // Pozicionim\n        star.style.left = `${Math.random() * 100}%`;\n        star.style.top = `${Math.random() * 100}%`;\n        \n        // Madhsi dhe shklqim\n        const size = Math.random() * 1.2 + 0.3;\n        star.style.width = `${size}px`;\n        star.style.height = `${size}px`;\n        \n        // Animacion personalizuar\n        star.style.animationDelay = `${Math.random() * 5}s`;\n        star.style.animationDuration = `${Math.random() * 5 + 5}s`;\n        \n        // Shto efekte 3D t lehta\n        star.style.transform = `translateZ(${Math.random() * 100}px)`;\n        \n        celestialBodies.appendChild(star);\n    }\n    document.body.appendChild(celestialBodies);\n\n    // Krijo comets\n    const comets = [\n        { top: '20%', left: '10%', delay: '3s' },\n        { top: '70%', left: '30%', delay: '8s' }\n    ];\n\n    comets.forEach(cometData => {\n        const comet = document.createElement('div');\n        comet.className = 'comet galaxy-element';\n        comet.style.top = cometData.top;\n        comet.style.left = cometData.left;\n        comet.style.animationDelay = cometData.delay;\n        document.body.appendChild(comet);\n    });\n\n    // Krijo starfield me Canvas pr realism maksimal\n    createStarfield();\n    \n    // Krijo efekte dinamike\n    createDynamicEffects();\n}\n\n/**\n * Krijon yje shtes me Canvas pr realism\n */\nfunction createStarfield() {\n    const canvas = document.createElement('canvas');\n    canvas.className = 'starfield-canvas galaxy-element';\n    canvas.style.position = 'fixed';\n    canvas.style.top = '0';\n    canvas.style.left = '0';\n    canvas.style.width = '100%';\n    canvas.style.height = '100%';\n    canvas.style.pointerEvents = 'none';\n    canvas.style.zIndex = '-4';\n    document.body.appendChild(canvas);\n    \n    // Inicializo canvas\n    const ctx = canvas.getContext('2d');\n    canvas.width = window.innerWidth;\n    canvas.height = window.innerHeight;\n    \n    // Vizato yje t vegjl\n    for (let i = 0; i < 2000; i++) {\n        const x = Math.random() * canvas.width;\n        const y = Math.random() * canvas.height;\n        const opacity = Math.random();\n        const radius = Math.random() * 0.5;\n        \n        ctx.beginPath();\n        ctx.arc(x, y, radius, 0, Math.PI * 2);\n        ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;\n        ctx.fill();\n    }\n    \n    // Prditso kur ndryshon madhsia\n    window.addEventListener('resize', () => {\n        canvas.width = window.innerWidth;\n        canvas.height = window.innerHeight;\n    });\n}\n\n/**\n * Krijon efekte dinamike\n */\nfunction createDynamicEffects() {\n    // Krijo disa yje pulsuese t mdhenj\n    for (let i = 0; i < 5; i++) {\n        const pulsar = document.createElement('div');\n        pulsar.className = 'celestial-star galaxy-element';\n        pulsar.style.left = `${10 + (i * 20)}%`;\n        pulsar.style.top = `${15 + (i * 10)}%`;\n        pulsar.style.width = '2px';\n        pulsar.style.height = '2px';\n        pulsar.style.boxShadow = '0 0 10px 5px rgba(255,255,255,0.7)';\n        pulsar.style.animation = 'pulsar-glow 3s ease-in-out infinite';\n        pulsar.style.zIndex = '-3';\n        document.body.appendChild(pulsar);\n    }\n}\n\n /**\n * Highlights grid lines that can be cleared\n */\nexport function highlightClearableLines() {\n    clearLineHighlights();\n    \n    // Check all rows\n    for (let r = 0; r < GRID_ROWS; r++) {\n        if (gameState.grid[r].every(cell => cell !== 0)) {\n            for (let c = 0; c < GRID_COLS; c++) {\n                cellElements[r][c].classList.add('clearable-line');\n            }\n        }\n    }\n    \n    // Check all columns\n    for (let c = 0; c < GRID_COLS; c++) {\n        let isColFull = true;\n        for (let r = 0; r < GRID_ROWS; r++) {\n            if (gameState.grid[r][c] === 0) {\n                isColFull = false;\n                break;\n            }\n        }\n        if (isColFull) {\n            for (let r = 0; r < GRID_ROWS; r++) {\n                cellElements[r][c].classList.add('clearable-line');\n            }\n        }\n    }\n}\n\n/**\n * Removes clearable line highlights\n */\nexport function clearLineHighlights() {\n    document.querySelectorAll('.grid-cell.clearable-line').forEach(cell => {\n        cell.classList.remove('clearable-line');\n    });\n}\n\n/**\n * Periodic cleanup function to remove old particles that may have been missed\n * This prevents memory leaks from accumulating DOM elements\n */\nexport function cleanupOldParticles() {\n    if (!dom['particles-overlay']) return;\n    \n    const overlay = dom['particles-overlay'];\n    const particles = overlay.querySelectorAll('.particle');\n    const now = Date.now();\n    const maxAge = 5000; // 5 seconds max age\n    \n    particles.forEach(particle => {\n        const created = parseInt(particle.dataset.created);\n        if (created && (now - created) > maxAge) {\n            // Clear timeout if it exists\n            const timeoutId = particle.dataset.timeoutId;\n            if (timeoutId) {\n                clearTimeout(parseInt(timeoutId));\n            }\n            particle.remove();\n        }\n    });\n}\n\n// Run periodic cleanup every 10 seconds\nsetInterval(cleanupOldParticles, 10000);\n\n\n\nexport { dom, createUnlockProgressIndicator };\n\n","let __perfLite=false;document.addEventListener('perf:lite',()=>{__perfLite=true});\n// === Kodi pr backgroundEffects.js ===\n\nfunction createMagicStars() {\n    const container = document.getElementById('magicStars');\n    if (!container) return;\n    container.innerHTML = ''; // Pastron yjet e vjetr\n    const colors = ['rgba(255, 200, 255, 0.9)', 'rgba(200, 220, 255, 0.9)', 'rgba(255, 220, 200, 0.9)'];\n    for (let i = 0; i < (__perfLite ? 8 : 25); i++) {\n        const star = document.createElement('div');\n        star.className = 'magic-star';\n        star.style.left = `${Math.random() * 100}%`;\n        star.style.top = `${Math.random() * 100}%`;\n        const size = Math.random() * 5 + 3;\n        star.style.width = `${size}px`;\n        star.style.height = `${size}px`;\n        star.style.background = colors[Math.floor(Math.random() * colors.length)];\n        star.style.animationDelay = `${Math.random() * 5}s`;\n        container.appendChild(star);\n    }\n}\n\nfunction createSpecialShapes() {\n    const container = document.getElementById('specialShapes');\n    if (!container) return;\n    container.innerHTML = '';\n    for (let i = 0; i < (__perfLite ? 4 : 10); i++) {\n        const shape = document.createElement('div');\n        shape.className = Math.random() > 0.5 ? 'star-shape' : 'heart-shape';\n        shape.style.left = `${Math.random() * 100}%`;\n        shape.style.top = `${Math.random() * 100}%`;\n        const color = `hsl(${Math.random() * 60 + 300}, 80%, 80%)`;\n        shape.style.background = color;\n        shape.style.animationDelay = `${Math.random() * 10}s`;\n        shape.style.animationDuration = `${Math.random() * 10 + 10}s`;\n        container.appendChild(shape);\n    }\n}\n\nfunction createSparkles() {\n    const container = document.getElementById('sparkles');\n    if (!container) return;\n    container.innerHTML = '';\n    for (let i = 0; i < (__perfLite ? 10 : 30); i++) {\n        const sparkle = document.createElement('div');\n        sparkle.className = 'sparkle';\n        sparkle.style.left = `${Math.random() * 100}%`;\n        sparkle.style.top = `${Math.random() * 100}%`;\n        sparkle.style.animationDelay = `${Math.random() * 30}s`;\n        sparkle.style.animationDuration = `${Math.random() * 30 + 45}s`; // 45-75 seconds for gentle snow\n        const size = Math.random() * 4 + 2;\n        sparkle.style.width = `${size}px`;\n        sparkle.style.height = `${size}px`;\n        container.appendChild(sparkle);\n    }\n}\n\n// Kto dy funksione do t'i thrrassh nga main.js pr t ndezur ose fikur sfondin\nexport function activateMagicUniverseBackground() {\n    const bgContainer = document.querySelector('.magic-universe-background');\n    if (bgContainer) {\n        bgContainer.style.display = 'block';\n    }\n    createMagicStars();\n    createSpecialShapes();\n    createSparkles();\n}\n\nexport function deactivateMagicUniverseBackground() {\n    const bgContainer = document.querySelector('.magic-universe-background');\n    if (bgContainer) {\n        bgContainer.style.display = 'none'; // Hide the background when deactivated\n    }\n}\n\nfunction __pb(){const c=document.querySelector('.magic-universe-background'); if(c) c.classList.add('paused');}\nfunction __rb(){const c=document.querySelector('.magic-universe-background'); if(c) c.classList.remove('paused');}\ndocument.addEventListener('visibilitychange',()=>{document.hidden?__pb():__rb()});\ndocument.addEventListener('app:pause',__pb);document.addEventListener('app:resume',__rb);\n","export async function applyStatusBar(theme){try{const S=window.Capacitor?.Plugins?.StatusBar;if(!S)return;if(theme==='dark'){await S.setStyle({style:'DARK'});await S.setBackgroundColor({color:'#0b0f1a'})}else{await S.setStyle({style:'LIGHT'});await S.setBackgroundColor({color:'#f2f5ff'})}}catch{}}","let e=new URLSearchParams(location.search).get('debug')==='1',t=null,a=0;export function initDebugOverlay(){if(!e||t)return;t=document.createElement('div');t.id='fpsOverlay';t.textContent='FPS: --';document.body.appendChild(t);let n=0,o=performance.now();const r=s=>{n++;if(s-o>=1000){t&&(t.textContent='FPS: '+n);n=0;o=s}a=requestAnimationFrame(r)};a=requestAnimationFrame(r)}","export const isNative=!!(window.Capacitor&&window.Capacitor.isNativePlatform);export function readyNativeUI(){if(isNative)document.body.classList.add('capacitor-native')}export function attachAppLifecycle(){const A=window.Capacitor?.Plugins?.App;if(!A)return;try{A.addListener('appStateChange',({isActive})=>{const ev=new CustomEvent(isActive?'app:resume':'app:pause');document.dispatchEvent(ev);})}catch{}}export async function hapticTap(){try{const H=window.Capacitor?.Plugins?.Haptics;if(H?.impact)await H.impact({style:'light'})}catch{}}export async function hapticSuccess(){try{const H=window.Capacitor?.Plugins?.Haptics;if(H?.notification)await H.notification({type:'SUCCESS'});else if(H?.impact)await H.impact({style:'Medium'})}catch{}}export async function hapticHeavy(){try{const H=window.Capacitor?.Plugins?.Haptics;if(H?.impact)await H.impact({style:'Heavy'})}catch{}}","// Galaxy Row Clear Animation Adapter\n// Integrated into the game's row-clear flow\n// Blocks use piece styling; particles emerge from cells without touching grid\n// VERSION: 3.0 (Dynamic color system - theme-aware)\n\nimport { GRID_ROWS, GRID_COLS } from '../constants.js';\nimport { getBaseColor } from '../gameLogic.js';\n\n// Time to call onComplete callback (non-blocking, decoupled from visual duration)\nconst LOGIC_DELAY_MS = 80;\n\n// Time to wait before cleaning up DOM (matches visual animation end - 1000ms for faster, smoother experience)\nconst VISUAL_CLEANUP_DELAY_MS = 1000;\n\n/**\n * Get the frame color - prioritize placedPieceColor if provided\n * @param {number} placedPieceColor - Color number (1-7) or null\n * @param {string} dominantColor - Fallback if placedPieceColor not provided\n * @returns {string} - Hex color code\n */\nfunction getFrameColor(placedPieceColor, dominantColor) {\n    const isDarkTheme = document.body.getAttribute('data-theme') === 'dark';\n    \n    // Support two types for placedPieceColor:\n    // - number (1-7) -> palette index, use getBaseColor\n    // - string (hex or rgb) -> use directly as base color\n    if ((typeof placedPieceColor === 'number' && placedPieceColor >= 1 && placedPieceColor <= 7) || (typeof placedPieceColor === 'string' && placedPieceColor)) {\n        let baseColor = typeof placedPieceColor === 'number' ? getBaseColor(placedPieceColor) : placedPieceColor;\n        \n        // Adaptive lightening for dark theme based on color brightness\n        if (isDarkTheme) {\n            const brightness = getColorBrightness(baseColor);\n            \n            // Adaptive lightening strategy:\n            // - Dark colors (< 100 brightness): lighten 40%\n            // - Medium colors (100-180): lighten 25%\n            // - Light colors (180-220): lighten 10%\n            // - Very light colors (> 220): no lightening (already visible)\n            let lightenPercent = 0;\n            if (brightness < 100) {\n                lightenPercent = 40;\n            } else if (brightness < 180) {\n                lightenPercent = 25;\n            } else if (brightness < 220) {\n                lightenPercent = 10;\n            }\n            // else: ngjyra sht tashm shum e leht, mos e ndrio\n            \n            if (lightenPercent > 0) {\n                baseColor = lightenColor(baseColor, lightenPercent);\n            }\n        }\n        \n        return baseColor;\n    }\n    return dominantColor; // Fallback to dominant color from grid\n}\n\n/**\n * Extract colors from grid cells and adapt for current theme\n * If placedPieceColor is provided, use ONLY that color for all particles (unified design)\n * Otherwise extract actual colors from cells\n * @param {NodeList} cellElements - All grid cells\n * @param {number} rowOrColIndex - The row/column index to extract colors from\n * @param {boolean} isRow - True if extracting from row, false if from column\n * @param {number} placedPieceColor - Color number (1-7) of the piece that caused the clear, or null\n * @returns {Object} - {colors: Array<string>, dominantColor: string}\n */\nfunction extractCellColors(cellElements, rowOrColIndex, isRow, placedPieceColor = null) {\n    const isDarkTheme = document.body.getAttribute('data-theme') === 'dark';\n    \n    // If placedPieceColor is provided, use ONLY that color for unified effect\n    if (placedPieceColor && placedPieceColor >= 1 && placedPieceColor <= 7) {\n        let pieceColor = getBaseColor(placedPieceColor);\n        \n        // Lighten for dark theme if needed\n        if (isDarkTheme) {\n            const brightness = getColorBrightness(pieceColor);\n            let lightenPercent = 0;\n            if (brightness < 100) {\n                lightenPercent = 40;\n            } else if (brightness < 180) {\n                lightenPercent = 25;\n            } else if (brightness < 220) {\n                lightenPercent = 10;\n            }\n            if (lightenPercent > 0) {\n                pieceColor = lightenColor(pieceColor, lightenPercent);\n            }\n        }\n        \n        // Return same color repeated + cyan accent for sparkle\n        // All particles will use the piece color for unified design\n        return { \n            colors: [pieceColor, pieceColor, pieceColor, '#22d3ee'], \n            dominantColor: pieceColor \n        };\n    }\n    \n    // Original logic: extract colors from actual grid cells\n    const colorCount = {};\n    const colors = [];\n    \n    cellElements.forEach((cell, idx) => {\n        const cellPos = isRow ? Math.floor(idx / GRID_COLS) : idx % GRID_COLS;\n        if (cellPos === rowOrColIndex) {\n            const blockWrapper = cell.querySelector('.grid-cell-block');\n            if (!blockWrapper) return;\n            \n            // Find filled-X class to get color number\n            const filledClass = Array.from(blockWrapper.classList).find(cls => cls.startsWith('filled-'));\n            if (filledClass) {\n                const colorNumber = parseInt(filledClass.replace('filled-', ''));\n                let baseColor = getBaseColor(colorNumber);\n                \n                // Lighten colors for dark theme to maintain visibility\n                if (isDarkTheme) {\n                    baseColor = lightenColor(baseColor, 20);\n                }\n                \n                colors.push(baseColor);\n                colorCount[baseColor] = (colorCount[baseColor] || 0) + 1;\n            }\n        }\n    });\n    \n    // Find dominant color (most frequent)\n    let dominantColor = '#60a5fa'; // Default cyan-blue\n    let maxCount = 0;\n    for (const [color, count] of Object.entries(colorCount)) {\n        if (count > maxCount) {\n            maxCount = count;\n            dominantColor = color;\n        }\n    }\n    \n    // Add cyan accent for sparkle effect (complements most colors)\n    colors.push('#22d3ee');\n    \n    // If no colors found, use theme-appropriate defaults\n    if (colors.length === 1) {\n        const defaults = isDarkTheme \n            ? ['#60a5fa', '#22d3ee', '#a78bfa']\n            : ['#3b82f6', '#06b6d4', '#8b5cf6'];\n        return { colors: defaults, dominantColor: defaults[0] };\n    }\n    \n    return { colors, dominantColor };\n}\n\n/**\n * Lighten a hex color by a percentage\n * @param {string} hex - Hex color code\n * @param {number} percent - Percentage to lighten (0-100)\n * @returns {string} - Lightened hex color\n */\nfunction lightenColor(hex, percent) {\n    const num = parseInt(hex.replace('#', ''), 16);\n    const r = Math.min(255, ((num >> 16) & 0xff) + Math.round(255 * (percent / 100)));\n    const g = Math.min(255, ((num >> 8) & 0xff) + Math.round(255 * (percent / 100)));\n    const b = Math.min(255, (num & 0xff) + Math.round(255 * (percent / 100)));\n    return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;\n}\n\n/**\n * Calculate color brightness (0-255 scale)\n * @param {string} hex - Hex color code\n * @returns {number} - Brightness value (0-255)\n */\nfunction getColorBrightness(hex) {\n    const num = parseInt(hex.replace('#', ''), 16);\n    const r = (num >> 16) & 0xff;\n    const g = (num >> 8) & 0xff;\n    const b = num & 0xff;\n    // Use perceived brightness formula (human eye sensitivity)\n    return (r * 0.299 + g * 0.587 + b * 0.114);\n}\n\nfunction getGridCellBorderRadius(gameGrid) {\n    const fallbackVar = getComputedStyle(document.documentElement).getPropertyValue('--grid-cell-radius')?.trim();\n    const fallback = fallbackVar && fallbackVar.length ? fallbackVar : '8px';\n\n    if (!gameGrid) {\n        return fallback;\n    }\n\n    try {\n        const sampleCell = gameGrid.querySelector('.grid-cell');\n        if (sampleCell) {\n            const computed = window.getComputedStyle(sampleCell).borderRadius;\n            if (computed && computed.trim().length) {\n                return computed;\n            }\n        }\n    } catch (err) {\n        console.warn('[galaxyRowClear] Failed to read grid cell border radius', err);\n    }\n\n    return fallback;\n}\n\n/**\n * Trigger a subtle shake on the main game area to emphasize clears.\n * @param {number} duration - ms to keep the shake class applied (default 380ms)\n */\nfunction triggerGameAreaShake(duration = 380) {\n    try {\n        // Prefer animating the inner grid element because some mobile CSS\n        // pins `.game-area` with `transform: translate(...) !important` which\n        // can prevent transform-based animations from being visible. Animating\n        // `.game-grid` (the actual grid) avoids that conflict. Fall back to\n        // `.game-grid-container` if present, otherwise `.game-area`.\n        const container = document.querySelector('.game-area .game-grid') || document.querySelector('.game-area .game-grid-container') || document.querySelector('.game-area');\n        if (!container) return;\n        const normalCls = 'ext-game-area-shake';\n        const strongCls = 'ext-game-area-shake-strong';\n        // Default to normal shake unless caller set data-strong attribute on container\n        const useStrong = container.getAttribute('data-ext-shake-strong') === '1';\n        // Debug: log invocation so we can verify shake is fired for rows/cols\n        try {\n        } catch (logErr) {\n            // ignore logging errors in older browsers\n        }\n        const cls = useStrong ? strongCls : normalCls;\n        container.classList.add(cls);\n        // Remove class when the CSS animation ends so duration is controlled by CSS\n        const onAnimEnd = (ev) => {\n            try {\n                // Only respond to animationend from the container itself\n                if (ev && ev.target !== container) return;\n            } catch (e) {}\n            try {\n                container.classList.remove(cls);\n                container.removeEventListener('animationend', onAnimEnd);\n                // Clear the transient strong marker so future calls compute correctly\n                try { container.removeAttribute('data-ext-shake-strong'); } catch (e) {}\n            } catch (e) {\n                // swallow cleanup errors\n            }\n        };\n        // Use once:true so listener auto-removes in older browsers; we also remove in handler for safety\n        container.addEventListener('animationend', onAnimEnd, { once: true });\n    } catch (e) {\n        console.warn('triggerGameAreaShake error', e);\n    }\n}\n\n/**\n * Plays Galaxy Row Clear animation at specified row\n * NON-BLOCKING: onComplete fires at LOGIC_DELAY_MS (~150ms) instead of waiting for full animation\n * Visual effects (bar, particles, block collapse) continue for full VISUAL_CLEANUP_DELAY_MS (~900ms)\n * \n * @param {number} rowIndex - The row to animate\n * @param {HTMLElement} gameGrid - The game grid DOM element\n * @param {HTMLElement} gameAreaParent - The parent container (usually .game-area)\n * @param {Function} onComplete - Callback fired quickly to resume game logic (not blocked by animation)\n * @param {number} placedPieceColor - The color number (1-7) of the piece that caused the clear\n */\nexport function playGalaxyRowClear(rowIndex, gameGrid, gameAreaParent, onComplete, placedPieceColor = null) {\n    if (!gameGrid || rowIndex < 0 || rowIndex >= GRID_ROWS) {\n        if (onComplete) onComplete();\n        return;\n    }\n\n    const cellElements = gameGrid.querySelectorAll('.grid-cell');\n    \n    // Create and play clear bar animation\n    createClearBar(rowIndex, gameGrid, gameAreaParent, placedPieceColor);\n    const animatedBlocks = [];\n    cellElements.forEach((cell, idx) => {\n        const cellRow = Math.floor(idx / GRID_COLS);\n        if (cellRow === rowIndex) {\n            const blockWrapper = cell.querySelector('.grid-cell-block');\n            if (!blockWrapper) return;\n            \n            const isFilled = Array.from(blockWrapper.classList).some(cls => cls.startsWith('filled-'));\n            if (isFilled) {\n                // Reset animation and apply it\n                blockWrapper.classList.remove('ext-galaxy-block-collapse');\n                void blockWrapper.offsetWidth; // Trigger reflow\n                blockWrapper.classList.add('ext-galaxy-block-collapse');\n                animatedBlocks.push(blockWrapper);\n            }\n        }\n    });\n\n    // Trigger shake after we've determined how many blocks are animating so\n    // we can scale duration/intensity to match the collapse animation.\n    try {\n        const blockCount = animatedBlocks.length;\n        // Use a short, CSS-driven shake duration (JS no longer controls removal)\n        const shakeDuration = 380;\n        // If many blocks clear, use a stronger shake\n        const isStrong = blockCount >= 6;\n        // mark container so triggerGameAreaShake picks the strong class\n        const target = document.querySelector('.game-area .game-grid') || document.querySelector('.game-area .game-grid-container') || document.querySelector('.game-area');\n        if (target) target.setAttribute('data-ext-shake-strong', isStrong ? '1' : '0');\n        triggerGameAreaShake(shakeDuration);\n    } catch (e) {\n        console.warn('shake trigger failed', e);\n    }\n\n    // EARLY CALLBACK: Fire onComplete quickly to unblock game logic\n    // This allows the game to continue immediately while animations run on GPU\n    setTimeout(() => {\n        if (onComplete) onComplete();\n    }, LOGIC_DELAY_MS);\n\n    // LATE CLEANUP: Remove filled classes and animation class after visual effects complete\n    // This happens in background and doesn't block game flow\n    setTimeout(() => {\n        cellElements.forEach((cell, idx) => {\n            const cellRow = Math.floor(idx / GRID_COLS);\n            if (cellRow === rowIndex) {\n                const blockWrapper = cell.querySelector('.grid-cell-block');\n                if (!blockWrapper) return;\n                \n                // Remove animation class to stop animation\n                blockWrapper.classList.remove('ext-galaxy-block-collapse');\n                \n                // Remove all filled-* classes from the block wrapper\n                Array.from(blockWrapper.classList).forEach(cls => {\n                    if (cls.startsWith('filled-')) {\n                        blockWrapper.classList.remove(cls);\n                    }\n                });\n            }\n        });\n    }, VISUAL_CLEANUP_DELAY_MS);\n}\n\n/**\n * Plays Galaxy Column Clear animation at specified column\n * NON-BLOCKING: onComplete fires at LOGIC_DELAY_MS (~150ms) instead of waiting for full animation\n * Visual effects (bar, particles, block collapse) continue for full VISUAL_CLEANUP_DELAY_MS (~900ms)\n * \n * @param {number} colIndex - The column to animate\n * @param {HTMLElement} gameGrid - The game grid DOM element\n * @param {HTMLElement} gameAreaParent - The parent container\n * @param {Function} onComplete - Callback fired quickly to resume game logic (not blocked by animation)\n * @param {number} placedPieceColor - The color number (1-7) of the piece that caused the clear\n */\nexport function playGalaxyColClear(colIndex, gameGrid, gameAreaParent, onComplete, placedPieceColor = null) {\n    if (!gameGrid || colIndex < 0 || colIndex >= GRID_COLS) {\n        if (onComplete) onComplete();\n        return;\n    }\n\n    const cellElements = gameGrid.querySelectorAll('.grid-cell');\n    \n    // Create and play clear bar animation\n    createClearBarColumn(colIndex, gameGrid, gameAreaParent, placedPieceColor);\n\n    // Animate the filled blocks directly (no copies needed)\n    const animatedBlocks = [];\n    cellElements.forEach((cell, idx) => {\n        const cellCol = idx % GRID_COLS;\n        if (cellCol === colIndex) {\n            const blockWrapper = cell.querySelector('.grid-cell-block');\n            if (!blockWrapper) return;\n            \n            const isFilled = Array.from(blockWrapper.classList).some(cls => cls.startsWith('filled-'));\n            if (isFilled) {\n                // Reset animation and apply it\n                blockWrapper.classList.remove('ext-galaxy-block-collapse');\n                void blockWrapper.offsetWidth; // Trigger reflow\n                blockWrapper.classList.add('ext-galaxy-block-collapse');\n                animatedBlocks.push(blockWrapper);\n            }\n        }\n    });\n\n    // Trigger shake after we've determined how many blocks are animating so\n    // we can scale duration/intensity to match the collapse animation.\n    try {\n        const blockCount = animatedBlocks.length;\n        const shakeDuration = 380;\n        const isStrong = blockCount >= 6;\n        const target = document.querySelector('.game-area .game-grid') || document.querySelector('.game-area .game-grid-container') || document.querySelector('.game-area');\n        if (target) target.setAttribute('data-ext-shake-strong', isStrong ? '1' : '0');\n        triggerGameAreaShake(shakeDuration);\n    } catch (e) {\n        console.warn('shake trigger failed', e);\n    }\n\n    // EARLY CALLBACK: Fire onComplete quickly to unblock game logic\n    // This allows the game to continue immediately while animations run on GPU\n    setTimeout(() => {\n        if (onComplete) onComplete();\n    }, LOGIC_DELAY_MS);\n\n    // LATE CLEANUP: Remove filled classes and animation class after visual effects complete\n    // This happens in background and doesn't block game flow\n    setTimeout(() => {\n        cellElements.forEach((cell, idx) => {\n            const cellCol = idx % GRID_COLS;\n            if (cellCol === colIndex) {\n                const blockWrapper = cell.querySelector('.grid-cell-block');\n                if (!blockWrapper) return;\n                \n                // Remove animation class to stop animation\n                blockWrapper.classList.remove('ext-galaxy-block-collapse');\n                \n                // Remove all filled-* classes from the block wrapper\n                Array.from(blockWrapper.classList).forEach(cls => {\n                    if (cls.startsWith('filled-')) {\n                        blockWrapper.classList.remove(cls);\n                    }\n                });\n            }\n        });\n    }, VISUAL_CLEANUP_DELAY_MS);\n}\n\n/**\n * Creates and animates the clear bar for a row\n * @private\n */\nfunction createClearBar(rowIndex, gameGrid, gameAreaParent, placedPieceColor = null) {\n    if (!gameAreaParent || !gameGrid) return;\n\n    const gridRect = gameGrid.getBoundingClientRect();\n    const parentRect = gameAreaParent.getBoundingClientRect();\n    const gridStyle = getComputedStyle(gameGrid);\n\n    // Get exact grid parameters\n    const cellSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-cell-size')) || 40;\n    const gap = parseFloat(gridStyle.gap) || 0;\n    const gridPaddingLeft = parseFloat(gridStyle.paddingLeft) || 0;\n    const gridPaddingTop = parseFloat(gridStyle.paddingTop) || 0;\n    const gridBorderLeft = parseFloat(gridStyle.borderLeftWidth) || 0;\n    const gridBorderTop = parseFloat(gridStyle.borderTopWidth) || 0;\n\n    // Get first cell element to calculate exact position\n    const cellElements = gameGrid.querySelectorAll('.grid-cell');\n    if (cellElements.length === 0) return;\n    \n    const firstCell = cellElements[0];\n    const firstCellRect = firstCell.getBoundingClientRect();\n    \n    // Calculate the Y position of the target row\n    let targetCellIndex = rowIndex * GRID_COLS;\n    if (cellElements.length > targetCellIndex) {\n        const targetCell = cellElements[targetCellIndex];\n        const targetCellRect = targetCell.getBoundingClientRect();\n        \n        const topInParent = targetCellRect.top - parentRect.top;\n        const leftInParent = firstCellRect.left - parentRect.left;\n        const barWidth = firstCellRect.width * GRID_COLS + gap * (GRID_COLS - 1);\n\n        const barBorderRadius = getGridCellBorderRadius(gameGrid);\n\n        const barContainer = document.createElement('div');\n        barContainer.className = 'ext-galaxy-clear-bar-container';\n        barContainer.style.position = 'absolute';\n        barContainer.style.top = topInParent + 'px';\n        barContainer.style.left = leftInParent + 'px';\n        barContainer.style.width = barWidth + 'px';\n        barContainer.style.height = firstCellRect.height + 'px';\n        barContainer.style.borderRadius = barBorderRadius;\n\n        const inner = document.createElement('div');\n        inner.className = 'ext-galaxy-clear-bar-inner';\n        inner.style.borderRadius = barBorderRadius;\n\n        // Adaptive particle count based on device\n        let particleCount = 30;\n        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);\n        const isLowEnd = (navigator.hardwareConcurrency || 4) <= 4;\n        if (isMobile) {\n            particleCount = isLowEnd ? 15 : 22;\n        }\n\n        // Extract colors from the actual grid cells being cleared\n        // Pass placedPieceColor to use unified piece color if available\n        const { colors, dominantColor } = extractCellColors(cellElements, rowIndex, true, placedPieceColor);\n        \n        // Get frame color from the piece that caused the clear, or use dominant grid color\n        const frameColor = getFrameColor(placedPieceColor, dominantColor);\n        \n        // Apply frame color as border with strong inner glow only\n        inner.style.border = `2px solid ${frameColor}`;\n        inner.style.background = `radial-gradient(ellipse at center, ${frameColor}15, transparent)`;\n        inner.style.boxShadow = `\n            inset 0 0 40px ${frameColor}80,\n            inset 0 0 30px ${frameColor}70,\n            inset 0 0 20px ${frameColor}60,\n            inset 0 0 10px ${frameColor}40\n        `;\n\n        for (let i = 0; i < particleCount; i++) {\n            const p = document.createElement('div');\n            p.className = 'ext-galaxy-particle';\n\n            // Make particles smaller on mobile to avoid large squares inside the frame\n            const baseSize = isMobile ? (4 + Math.random() * 6) : (8 + Math.random() * 12);\n            const size = Math.round(baseSize);\n            const color = colors[Math.floor(Math.random() * colors.length)];\n            const left = Math.random() * 100;\n\n            const dur = (isMobile ? 700 : 900) + Math.random() * (isMobile ? 400 : 600);  // slightly faster on mobile\n            const delay = Math.random() * 150;\n\n            const dxStart = (Math.random() - 0.5) * (isMobile ? 12 : 20);\n            const dyStart = (Math.random() - 0.5) * (isMobile ? 6 : 10);\n\n            const direction = Math.random() > 0.5 ? 1 : -1;\n            const dxEnd = direction * ((isMobile ? 30 : 50) + Math.random() * (isMobile ? 40 : 80));\n            const dyEnd = (Math.random() - 0.5) * (isMobile ? 18 : 30);\n\n            p.style.width = size + 'px';\n            p.style.height = size + 'px';\n            p.style.backgroundColor = color;\n            p.style.color = color;\n            p.style.left = left + '%';\n            p.style.top = '50%';\n            p.style.marginTop = (-size / 2) + 'px';\n            p.style.borderRadius = Math.max(2, Math.round(size * 0.25)) + 'px';\n\n            p.style.animationDuration = dur + 'ms';\n            p.style.animationDelay = delay + 'ms';\n\n            p.style.setProperty('--ext-dx-start', dxStart + 'px');\n            p.style.setProperty('--ext-dy-start', dyStart + 'px');\n            p.style.setProperty('--ext-dx-end', dxEnd + 'px');\n            p.style.setProperty('--ext-dy-end', dyEnd + 'px');\n\n            inner.appendChild(p);\n        }\n\n        barContainer.appendChild(inner);\n        gameAreaParent.appendChild(barContainer);\n\n        // Clean up after animation\n        setTimeout(() => {\n            if (barContainer.parentNode) {\n                barContainer.remove();\n            }\n        }, 1500);\n    }\n}\n\n/**\n * Creates and animates the clear bar for a column (vertical variant)\n * @private\n */\nfunction createClearBarColumn(colIndex, gameGrid, gameAreaParent, placedPieceColor = null) {\n    if (!gameAreaParent || !gameGrid) return;\n\n    const gameAreaRect = gameAreaParent.getBoundingClientRect();\n    const gridStyle = getComputedStyle(gameGrid);\n    \n    // Get cell elements\n    const cellElements = gameGrid.querySelectorAll('.grid-cell');\n    if (cellElements.length === 0) return;\n\n    // Get the first cell and target cell to calculate positions\n    const firstCell = cellElements[0];\n    const firstCellRect = firstCell.getBoundingClientRect();\n    \n    // Calculate the X position of the target column\n    let targetCellIndex = colIndex;\n    if (cellElements.length > targetCellIndex) {\n        const targetCell = cellElements[targetCellIndex];\n        const targetCellRect = targetCell.getBoundingClientRect();\n        \n        // Calculate height (all rows)\n        const lastCell = cellElements[cellElements.length - 1];\n        const lastCellRect = lastCell.getBoundingClientRect();\n        const gap = parseFloat(gridStyle.gap) || 0;\n        const barHeight = (lastCellRect.bottom - firstCellRect.top) + gap;\n\n        const leftInParent = targetCellRect.left - gameAreaRect.left;\n        const topInParent = firstCellRect.top - gameAreaRect.top;\n\n        const barBorderRadius = getGridCellBorderRadius(gameGrid);\n\n        const barContainer = document.createElement('div');\n        barContainer.className = 'ext-galaxy-clear-bar-container';\n        barContainer.style.position = 'absolute';\n        barContainer.style.left = leftInParent + 'px';\n        barContainer.style.top = topInParent + 'px';\n        barContainer.style.width = firstCellRect.width + 'px';\n        barContainer.style.height = barHeight + 'px';\n        barContainer.style.borderRadius = barBorderRadius;\n\n        const inner = document.createElement('div');\n        inner.className = 'ext-galaxy-clear-bar-inner';\n        inner.style.width = '100%';\n        inner.style.height = '100%';\n        inner.style.borderRadius = barBorderRadius;\n\n        // Adaptive particle count based on device\n        let particleCount = 30;\n        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);\n        const isLowEnd = (navigator.hardwareConcurrency || 4) <= 4;\n        if (isMobile) {\n            particleCount = isLowEnd ? 15 : 22;\n        }\n\n        // Extract colors from the actual grid cells being cleared\n        // Pass placedPieceColor to use unified piece color if available\n        const { colors, dominantColor } = extractCellColors(cellElements, colIndex, false, placedPieceColor);\n        \n        // Get frame color from the piece that caused the clear, or use dominant grid color\n        const frameColor = getFrameColor(placedPieceColor, dominantColor);\n        \n        // Apply frame color as border with strong inner glow\n        inner.style.border = `2px solid ${frameColor}`;\n        inner.style.background = `radial-gradient(ellipse at center, ${frameColor}15, transparent)`;\n        inner.style.boxShadow = `\n            inset 0 0 40px ${frameColor}80,\n            inset 0 0 30px ${frameColor}70,\n            inset 0 0 20px ${frameColor}60,\n            inset 0 0 10px ${frameColor}40\n        `;\n\n        for (let i = 0; i < particleCount; i++) {\n            const p = document.createElement('div');\n            p.className = 'ext-galaxy-particle';\n\n            const baseSize = isMobile ? (4 + Math.random() * 6) : (8 + Math.random() * 12);\n            const size = Math.round(baseSize);\n            const color = colors[Math.floor(Math.random() * colors.length)];\n            const top = Math.random() * 100;\n\n            const dur = (isMobile ? 700 : 900) + Math.random() * (isMobile ? 400 : 600);\n            const delay = Math.random() * 150;\n\n            const dxStart = (Math.random() - 0.5) * (isMobile ? 8 : 10);\n            const dyStart = (Math.random() - 0.5) * (isMobile ? 12 : 20);\n\n            const direction = Math.random() > 0.5 ? 1 : -1;\n            const dxEnd = (Math.random() - 0.5) * (isMobile ? 18 : 30);\n            const dyEnd = direction * ((isMobile ? 30 : 50) + Math.random() * (isMobile ? 40 : 80));\n\n            p.style.width = size + 'px';\n            p.style.height = size + 'px';\n            p.style.backgroundColor = color;\n            p.style.color = color;\n            p.style.left = '50%';\n            p.style.marginLeft = (-size / 2) + 'px';\n            p.style.top = top + '%';\n            p.style.borderRadius = Math.max(2, Math.round(size * 0.25)) + 'px';\n\n            p.style.animationDuration = dur + 'ms';\n            p.style.animationDelay = delay + 'ms';\n\n            p.style.setProperty('--ext-dx-start', dxStart + 'px');\n            p.style.setProperty('--ext-dy-start', dyStart + 'px');\n            p.style.setProperty('--ext-dx-end', dxEnd + 'px');\n            p.style.setProperty('--ext-dy-end', dyEnd + 'px');\n\n            inner.appendChild(p);\n        }\n\n        barContainer.appendChild(inner);\n        gameAreaParent.appendChild(barContainer);\n\n        setTimeout(() => {\n            if (barContainer.parentNode) {\n                barContainer.remove();\n            }\n        }, 1500);\n    }\n}\n","// Row clear animation - Galaxy Row Clear integration with grid isolation\n\nimport { playGalaxyRowClear, playGalaxyColClear } from './animationAdapters/galaxyRowClear.js';\n\nconst LINE_DELAY = 110;          // ms between lines when not sync\nconst OVERLAY_HOST_ID = 'rowClearOverlay';\nlet overlayHostElement = null;\n\nfunction ensureOverlayHost(host = document.querySelector('.game-area') || document.body) {\n  if (!host) return null;\n  if (!overlayHostElement) {\n    overlayHostElement = document.getElementById(OVERLAY_HOST_ID) || document.createElement('div');\n    overlayHostElement.id = OVERLAY_HOST_ID;\n    overlayHostElement.setAttribute('aria-hidden', 'true');\n  }\n  if (overlayHostElement.parentElement !== host) {\n    host.appendChild(overlayHostElement);\n  }\n  return overlayHostElement;\n}\n\nfunction alignOverlayHost(gridRect, host) {\n  const overlay = ensureOverlayHost(host);\n  if (!overlay || !gridRect || !host) return overlay;\n  const hostRect = host.getBoundingClientRect();\n  overlay.style.position = 'absolute';\n  overlay.style.left = `${gridRect.left - hostRect.left}px`;\n  overlay.style.top = `${gridRect.top - hostRect.top}px`;\n  overlay.style.width = `${gridRect.width}px`;\n  overlay.style.height = `${gridRect.height}px`;\n  return overlay;\n}\n\nexport function animateRowClearSpectra({\n  ctx,\n  rows,\n  blockSize,\n  boardSize,\n  getCellColor,   // (r,c)=>color (unused for animation core but kept for API compat)\n  renderBase,     // () => redraw board below canvas; kept to avoid regressions\n  onLogicalClear, // (rowIndex)=>void\n  onDone          // ()=>void\n}) {\n  if (!rows || !rows.length) { onDone && onDone(); return; }\n\n  // Align canvas to grid at 1x to reduce pixel cost\n  const canvas = ctx?.canvas;\n  const gameGrid = document.getElementById('gameGrid');\n  const metrics = computeGridMetrics(gameGrid, canvas);\n\n  // Build per-line data once (DOM lookups once, no per-frame layout)\n  const totalCols = boardSize;\n  const lines = rows.map((rowIndex, order) => buildRowData({\n    rowIndex,\n    order,\n    boardSize: totalCols,\n    metrics,\n    gameGrid\n  }));\n\n  const tasks = lines.map(line => new Promise(resolve => {\n    setTimeout(() => runRowAnimation({\n      line,\n      metrics,\n      onLogicalClear,\n      onResolved: resolve\n    }), line.delay);\n  }));\n\n  Promise.all(tasks).then(() => {\n    onDone && onDone();\n  });\n}\n\n// Combined lightweight line clear for rows and columns to match existing integration\nexport function animateLineClearSpectra({\n  ctx,\n  rows = [],\n  cols = [],\n  boardSize,\n  onClearRow,\n  onClearCol,\n  onDone,\n  syncStart = false,\n  placedPieceColor = null\n}) {\n  const canvas = ctx?.canvas;\n  const gameGrid = document.getElementById('gameGrid');\n  const metrics = computeGridMetrics(gameGrid, canvas);\n\n  const tasks = [];\n\n  // Rows\n  rows.forEach((rowIndex, order) => {\n    const line = buildRowData({ rowIndex, order: syncStart ? 0 : order, boardSize, metrics, gameGrid });\n    tasks.push(new Promise(resolve => {\n      setTimeout(() => runRowAnimation({\n        line,\n        metrics,\n        onLogicalClear: (r) => onClearRow && onClearRow(r),\n        onResolved: resolve,\n        placedPieceColor\n      }), line.delay);\n    }));\n  });\n\n  // Columns\n  cols.forEach((colIndex, order) => {\n    const line = buildColData({ colIndex, order: syncStart ? 0 : (rows.length + order), boardSize, metrics, gameGrid });\n    tasks.push(new Promise(resolve => {\n      setTimeout(() => runColAnimation({\n        line,\n        metrics,\n        onLogicalClear: (c) => onClearCol && onClearCol(c),\n        onResolved: resolve,\n        placedPieceColor\n      }), line.delay);\n    }));\n  });\n\n  if (!tasks.length) { onDone && onDone(); return; }\n\n  Promise.all(tasks).then(() => {\n    onDone && onDone();\n  });\n}\n\nfunction buildColData({ colIndex, order, boardSize, metrics, gameGrid }) {\n  const cells = [];\n  if (metrics && gameGrid) {\n    const totalRows = Math.floor(gameGrid.children.length / boardSize) || boardSize;\n    for (let r = 0; r < totalRows; r++) {\n      const element = gameGrid.children[r * boardSize + colIndex];\n      if (!element) continue;\n      \n      // Only include filled cells (blocks) that will be cleared\n      const isFilled = Array.from(element.classList).some(cls => cls.startsWith('filled-'));\n      if (!isFilled) continue;\n      \n      const { x, y } = cellCenter(r, colIndex, metrics);\n      const overlay = createCellOverlay(element);\n      cells.push({ element, centerX: x, centerY: y, overlay });\n    }\n  }\n  return {\n    colIndex,\n    cells,\n    delay: order * LINE_DELAY,\n    cleared: false\n  };\n}\n\nfunction runColAnimation({ line, metrics, particleEngine, onLogicalClear, onResolved, placedPieceColor }) {\n  // Play Galaxy Column Clear animation\n  const gameGrid = document.getElementById('gameGrid');\n  const gameArea = document.querySelector('.game-area');\n  \n  playGalaxyColClear(line.colIndex, gameGrid, gameArea, () => {\n    // Perform logical clear AFTER animation\n    if (!line.cleared) {\n      onLogicalClear && onLogicalClear(line.colIndex);\n      line.cleared = true;\n    }\n    cleanupLineOverlays(line);\n    onResolved();\n  }, placedPieceColor);\n}\n\nfunction runRowAnimation({ line, metrics, particleEngine, onLogicalClear, onResolved, placedPieceColor }) {\n  // Play Galaxy Row Clear animation\n  const gameGrid = document.getElementById('gameGrid');\n  const gameArea = document.querySelector('.game-area');\n  \n  playGalaxyRowClear(line.rowIndex, gameGrid, gameArea, () => {\n    // Perform logical clear AFTER animation\n    if (!line.cleared) {\n      onLogicalClear && onLogicalClear(line.rowIndex);\n      line.cleared = true;\n    }\n    cleanupLineOverlays(line);\n    onResolved();\n  }, placedPieceColor);\n}\n\nfunction buildRowData({ rowIndex, order, boardSize, metrics, gameGrid }) {\n  const cells = [];\n  if (gameGrid) {\n    for (let c = 0; c < boardSize; c++) {\n      const element = gameGrid.children[rowIndex * boardSize + c];\n      if (!element) continue;\n      \n      // Only include filled cells (blocks) that will be cleared\n      const isFilled = Array.from(element.classList).some(cls => cls.startsWith('filled-'));\n      if (!isFilled) continue;\n      \n      if (metrics) {\n        const { x, y } = cellCenter(rowIndex, c, metrics);\n        const overlay = createCellOverlay(element);\n        cells.push({ element, centerX: x, centerY: y, overlay });\n      } else {\n        cells.push({ element, centerX: 0, centerY: 0, overlay: null });\n      }\n    }\n  }\n  return {\n    rowIndex,\n    cells,\n    delay: order * LINE_DELAY,\n    cleared: false\n  };\n}\n\nfunction computeGridMetrics(gameGrid, canvas) {\n  if (!gameGrid || !canvas) return null;\n  const gridRect = gameGrid.getBoundingClientRect();\n  const host = canvas.offsetParent || document.querySelector('.game-area') || document.body;\n  const hostRect = host.getBoundingClientRect();\n  const style = getComputedStyle(gameGrid);\n\n  const padLeft = parseFloat(style.paddingLeft) || 0;\n  const padRight = parseFloat(style.paddingRight) || 0;\n  const padTop = parseFloat(style.paddingTop) || 0;\n  const padBottom = parseFloat(style.paddingBottom) || 0;\n  const gap = parseFloat(style.getPropertyValue('--grid-gap')) || parseFloat(style.gap) || 0;\n\n  // Align canvas in CSS pixels (no DPR scaling)\n  canvas.style.position = 'absolute';\n  canvas.style.left = `${gridRect.left - hostRect.left}px`;\n  canvas.style.top = `${gridRect.top - hostRect.top}px`;\n  canvas.style.width = `${gridRect.width}px`;\n  canvas.style.height = `${gridRect.height}px`;\n  canvas.width = Math.round(gridRect.width);\n  canvas.height = Math.round(gridRect.height);\n  canvas.getContext('2d')?.setTransform(1, 0, 0, 1, 0, 0);\n\n  alignOverlayHost(gridRect, host);\n\n  return {\n    padLeft, padRight, padTop, padBottom,\n    colGap: gap, rowGap: gap,\n    canvasWidth: Math.round(gridRect.width),\n    canvasHeight: Math.round(gridRect.height)\n  };\n}\n\nfunction cellCenter(row, col, metrics) {\n  const width = metrics.canvasWidth - metrics.padLeft - metrics.padRight;\n  const height = metrics.canvasHeight - metrics.padTop - metrics.padBottom;\n  const gameGrid = document.getElementById('gameGrid');\n  const cols = gameGrid ? (getComputedStyle(gameGrid).gridTemplateColumns.split(' ').length) : 10;\n  const rows = gameGrid ? (getComputedStyle(gameGrid).gridTemplateRows.split(' ').length) : 10;\n  const cellW = cols ? (width - metrics.colGap * (cols - 1)) / cols : 0;\n  const cellH = rows ? (height - metrics.rowGap * (rows - 1)) / rows : 0;\n  const x = metrics.padLeft + col * (cellW + metrics.colGap) + cellW / 2;\n  const y = metrics.padTop + row * (cellH + metrics.rowGap) + cellH / 2;\n  return { x, y };\n}\n\nfunction createCellOverlay(element) {\n  if (!element) return null;\n  \n  const host = overlayHostElement?.parentElement || document.querySelector('.game-area') || document.body;\n  const grid = document.getElementById('gameGrid');\n  const gridRect = grid?.getBoundingClientRect() || null;\n  alignOverlayHost(gridRect, host);\n  const overlayHost = overlayHostElement || ensureOverlayHost(host);\n  if (!overlayHost) return null;\n  \n  const hostRect = overlayHost.getBoundingClientRect();\n  if (!hostRect.width || !hostRect.height) return null;\n  \n  // Batch getComputedStyle() call - vetm nj her\n  const style = getComputedStyle(element);\n  const rect = element.getBoundingClientRect();\n  \n  // Lexo t gjitha ngjyrat n nj pass\n  const colorDark1 = style.getPropertyValue('--color-dark-1') || '#14b8a6';\n  const colorDark2 = style.getPropertyValue('--color-dark-2') || '#0f766e';\n  const colorCoreLight = style.getPropertyValue('--color-core-light') || 'rgba(173, 255, 219, 0.8)';\n  const colorCoreMid = style.getPropertyValue('--color-core-mid') || 'rgba(81, 238, 176, 0.5)';\n  const colorBevelLight = style.getPropertyValue('--color-bevel-light') || 'rgba(255,255,255,0.2)';\n  const colorBevelDark = style.getPropertyValue('--color-bevel-dark') || 'rgba(0,0,0,0.4)';\n  const borderRadius = style.borderRadius || '25%';\n  \n  // Krijo overlay\n  const overlay = document.createElement('div');\n  overlay.className = 'cell-clear-overlay';\n  \n  // Poziciono dhe vendos madhsin\n  overlay.style.left = `${rect.left - hostRect.left}px`;\n  overlay.style.top = `${rect.top - hostRect.top}px`;\n  overlay.style.width = `${rect.width}px`;\n  overlay.style.height = `${rect.height}px`;\n  overlay.style.borderRadius = borderRadius;\n  \n  // Vendos t gjitha CSS variablat n nj batch\n  overlay.style.setProperty('--color-dark-1', colorDark1);\n  overlay.style.setProperty('--color-dark-2', colorDark2);\n  overlay.style.setProperty('--color-core-light', colorCoreLight);\n  overlay.style.setProperty('--color-core-mid', colorCoreMid);\n  overlay.style.setProperty('--color-bevel-light', colorBevelLight);\n  overlay.style.setProperty('--color-bevel-dark', colorBevelDark);\n  overlay.style.setProperty('--overlay-color', colorDark1);\n  overlay.style.setProperty('--row-clear-color', colorDark1);\n  \n  // Vendos background gradient\n  overlay.style.background = `linear-gradient(135deg, ${colorDark1}, ${colorDark2})`;\n  \n  overlayHost.appendChild(overlay);\n  return overlay;\n}\n\nfunction cleanupLineOverlays(line) {\n  if (!line || !line.cells) return;\n  line.cells.forEach(cell => {\n    // Rikthe opacity-n e blloqeve origjinale\n    if (cell && cell.element) {\n      cell.element.style.opacity = '';\n    }\n    // Fshi overlay-t\n    if (cell && cell.overlay) {\n      cell.overlay.remove();\n      cell.overlay = null;\n    }\n  });\n  cleanupOverlayHostIfEmpty();\n}\n\nfunction cleanupOverlayHostIfEmpty() {\n  if (!overlayHostElement) return;\n  if (overlayHostElement.childElementCount > 0) return;\n  const parent = overlayHostElement.parentElement;\n  overlayHostElement.remove();\n  overlayHostElement = null;\n  if (parent && parent.hasChildNodes()) return;\n}\n\n\n","// Main game logic and event handlers\n//  IMPORTANT: When making optimizations/fixes, increment version in:\n//    1. index.html  <meta name=\"app-version\" content=\"vX.X\">\n//    2. The version badge will automatically change color so user sees the refresh\n\nimport { gameState, initializeState, resetDragState } from './state.js';\nimport * as logic from './gameLogic.js';\nimport * as render from './render.js';\nimport { dom } from './render.js';  // DOM cache used in initMain\nimport * as audio from './audio.js';\nimport { INVALID_PLACEMENT_SHAKE_DURATION, COMBO_MESSAGE_DURATION, GRID_COLS, GRID_ROWS } from './constants.js';\nimport { activateMagicUniverseBackground, deactivateMagicUniverseBackground } from './backgroundEffects.js';\n// import FABManager removed (we no longer use a floating action button container)\nimport { pieceUnlockSystem } from './pieceUnlockSystem.js';\nimport { applyStatusBar } from './statusBarTheme.js';\nimport { initDebugOverlay } from './debugOverlay.js';\nimport { readyNativeUI, attachAppLifecycle } from './nativeBridge.js';\nimport { initializeSettings } from './modalManager.js';\nimport { animateLineClearSpectra } from './rowClearSpectra.js';\nimport * as logger from './logger.js';\n\n// Exported bootstrap expected by app.js\nexport function initMain() {\n    // If DOM is already ready, run immediately\n    const boot = () => {\n        try { readyNativeUI(); } catch(e) {}\n        try { attachAppLifecycle(); } catch(e) {}\n        try { initDebugOverlay(); } catch(e) {}\n        try { applyStatusBar(document.body.dataset.theme || 'dark'); } catch(e) {}\n        try { initializeSettings(); } catch(e) { console.warn('Failed to initialize settings:', e); }\n        // Initialize the game UI and logic\n        try { initializeGame(); } catch(e) { /* initializeGame defined later */ }\n        // Initialize landing page button effects\n        try { initializeLandingPageEffects(); } catch(e) {}\n    };\n    if (document.readyState === 'complete' || document.readyState === 'interactive') {\n        setTimeout(boot, 0);\n    } else {\n        document.addEventListener('DOMContentLoaded', boot);\n    }\n}\n\n// --- Simple FPS sampler + auto lite-mode ---\n\n\n// --- Game Mode Management ---\nlet selectedGameMode = null; // 'classic' or 'collection'\n\nfunction whenDomReady(callback) {\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', callback, { once: true });\n    } else {\n        callback();\n    }\n}\n\nlet specialActionListenersAttached = false;\nlet legacyLandingSetupDone = false;\n\n\n// --- Landing Page Stats Update ---\nexport function updateLandingPageStats() {\n    // Update high score\n    const highScoreEl = document.getElementById('highscore-display');\n    if (highScoreEl) {\n        const savedHighScore = localStorage.getItem('blokusHighScore') || '0';\n        highScoreEl.textContent = savedHighScore;\n    }\n    \n    // Update pieces unlocked based on current progress\n    const piecesUnlockedEl = document.getElementById('pieces-unlocked');\n    if (piecesUnlockedEl) {\n        try {\n            const currentScore = parseInt(localStorage.getItem('blokusHighScore') || '0');\n            if (typeof pieceUnlockSystem !== 'undefined' && pieceUnlockSystem.getAvailablePieces) {\n                const unlockedPieces = pieceUnlockSystem.getAvailablePieces();\n                piecesUnlockedEl.textContent = unlockedPieces.length;\n            } else {\n                // Fallback calculation\n                let pieces = 7; // Start with 7 basic pieces\n                if (currentScore >= 2000) pieces += 6;\n                if (currentScore >= 4000) pieces += 6;\n                if (currentScore >= 6000) pieces += 6;\n                if (currentScore >= 8000) pieces += 5;\n                piecesUnlockedEl.textContent = Math.min(pieces, 30);\n            }\n        } catch (error) {\n            piecesUnlockedEl.textContent = '7';\n        }\n    }\n    \n    // Update achievements count (placeholder for future implementation)\n    const achievementsEl = document.getElementById('achievements-count');\n    if (achievementsEl) {\n        // For now, calculate based on score milestones\n        const currentScore = parseInt(localStorage.getItem('blokusHighScore') || '0');\n        let achievements = 0;\n        if (currentScore >= 1000) achievements++;\n        if (currentScore >= 5000) achievements++;\n        if (currentScore >= 10000) achievements++;\n        if (currentScore >= 20000) achievements++;\n        if (currentScore >= 50000) achievements++;\n        achievementsEl.textContent = achievements;\n    }\n}\n\n// --- Main Game Flow ---\n\n\nfunction initializeGame() {\n    // Clean up resources from previous game session and reset paused state\n    logger.resetGameStartFlag(); // Reset for fresh game session\n    logger.logGameStart();\n    cleanupGameResources();\n    // Remove paused class so animations run on new game\n    const gameContainer = document.querySelector('.game-container');\n    if (gameContainer) {\n        gameContainer.classList.remove('paused');\n    }\n    render.cacheDOMElements();\n    // Attach pause, restart, and settings handlers once DOM cache is ready\n    if (!listenersAttached) {\n        if (dom.pauseButton) {\n            dom.pauseButton.addEventListener('click', togglePause);\n            addNeonClickEffect(dom.pauseButton);\n        }\n        if (dom.restartButton) {\n            dom.restartButton.addEventListener('click', handleRestart);\n            addNeonClickEffect(dom.restartButton);\n        }\n        if (dom.settingsButton && window.showSettingsModal) {\n            dom.settingsButton.addEventListener('click', window.showSettingsModal);\n            addNeonClickEffect(dom.settingsButton);\n        }\n        if (dom.darkModeToggleGame) {\n            addNeonClickEffect(dom.darkModeToggleGame);\n        }\n        listenersAttached = true;\n    }\n    render.createGridDOM();\n    initializeState();\n    logger.logGameMode('Blokus Grid');\n    logic.populateInitialPieces();\n    logger.logPerformanceStart('game-init');\n    // Always create unlock progress indicator when landing hidden\n    const landingPage = document.getElementById('landingPage');\n    if (typeof render.createUnlockProgressIndicator === 'function' && landingPage && landingPage.classList.contains('hidden')) {\n        render.createUnlockProgressIndicator();\n    }\n    render.updateGridDisplay();\n    render.updatePiecesDisplay(true); // Pass true for initial load animation\n    render.updateScoreDisplay();\n    render.updateControlButtons();\n    updateSpecialActionButtons();\n    attachPieceEventListeners();\n    attachGridEventListeners();\n    logger.logPerformanceEnd('game-init');\n}\n\n// Add neon glow effect on button click\nfunction addNeonClickEffect(button) {\n    if (!button) return;\n    \n    button.addEventListener('click', function(e) {\n        // Remove existing class if present\n        this.classList.remove('neon-clicked');\n        \n        // Trigger reflow\n        void this.offsetWidth;\n        \n    // Play click sound effect\n    audio.playUIButtonSound();\n    // Add the neon effect class\n        this.classList.add('neon-clicked');\n        \n        // Remove the class after animation completes\n        setTimeout(() => {\n            this.classList.remove('neon-clicked');\n        }, 400);\n    });\n}\n\n// Initialize landing page button effects\nfunction initializeLandingPageEffects() {\n    const themeToggleLanding = document.getElementById('theme-toggle');\n    if (themeToggleLanding) {\n        addNeonClickEffect(themeToggleLanding);\n    }\n    // Add sound + neon click to mode buttons\n    const modeButtons = document.querySelectorAll('.mode-button.selectable');\n    modeButtons.forEach(btn => addNeonClickEffect(btn));\n}\n\nfunction togglePause() {\n    if (gameState.isGameOver) return;\n    gameState.isPaused = !gameState.isPaused;\n    \n    render.updateControlButtons();\n    // Play pause or resume sound and toggle background animations\n    if (gameState.isPaused) {\n        audio.playPauseSound();\n        document.dispatchEvent(new Event('app:pause'));\n        const gameContainer = document.querySelector('.game-container');\n        if (gameContainer) {\n            gameContainer.classList.add('paused');\n        }\n    } else {\n        audio.playResumeSound();\n        document.dispatchEvent(new Event('app:resume'));\n        const gameContainer = document.querySelector('.game-container');\n        if (gameContainer) {\n            gameContainer.classList.remove('paused');\n            // Force reflow to restart paused animations\n            void gameContainer.offsetWidth;\n        }\n    }\n}\n\nfunction handleRestart() {\n    logger.logGameStateSnapshot(gameState);\n    logger.log('INFO', ' Game Restarted', '#90CAF9');\n    // Play restart sound\n    audio.playRestartSound();\n    // Remove paused state from container so animations reset\n    const gameContainer = document.querySelector('.game-container');\n    if (gameContainer) {\n        gameContainer.classList.remove('paused');\n    }\n    // Then reinitialize game\n    initializeGame();\n    // Ensure control buttons are updated (hide restart based on pause state)\n    render.updateControlButtons();\n}\n\n// --- Event Handlers ---\n\nfunction handlePieceClick(event) {\n    if (gameState.isPaused || gameState.isGameOver || gameState.dragState.isDragging) {\n        return;\n    }\n    \n    const pieceElement = event.target.closest('.piece');\n    \n    if (!pieceElement || pieceElement.classList.contains('empty')) {\n        return;\n    }\n    \n    const pieceIndex = parseInt(pieceElement.dataset.pieceIndex);\n    \n    // If we are in rotate mode, use token and rotate\n    if (gameState.specialModes.rotateMode && gameState.specialModes.isWaitingForRotate) {\n        const success = logic.rotateSpecificPiece(pieceIndex);\n        \n        if (success) {\n            gameState.rotateTokens--; // Consume token on success\n            render.updatePiecesDisplay();\n            audio.playRotateSound();\n            showSpecialModeMessage('rotate', 'Piece rotated successfully!', 1000);\n        }\n        \n        // Reset rotate mode\n        gameState.specialModes.rotateMode = false;\n        gameState.specialModes.isWaitingForRotate = false;\n        updateSpecialActionButtons();\n        // Re-enable dragging after exiting rotate mode\n        attachPieceEventListeners();\n        return;\n    }\n\n    // If we are in flip mode, flip piece horizontally\n    if (gameState.specialModes.flipMode && gameState.specialModes.isWaitingForFlip) {\n        const piece = gameState.currentPieces[pieceIndex];\n        \n        if (!piece || !piece.currentShape) {\n            showSpecialModeMessage('flip', 'Cannot flip this piece', 1500);\n            return;\n        }\n        \n        // Apply horizontal flip (mirror left-right)\n        const flipped = logic.flipPieceHorizontally(piece);\n        \n        if (!flipped || !flipped.currentShape) {\n            showSpecialModeMessage('flip', 'Flip failed', 1500);\n            return;\n        }\n        \n        piece.currentShape = flipped.currentShape;\n        piece.id = Date.now() + Math.random(); // Force UI update\n        gameState.flipTokens--; // Consume flip token\n        \n        render.updatePiecesDisplay();\n        audio.playRotateSound();\n        showSpecialModeMessage('flip', 'Piece flipped!', 1000);\n        \n        // Reset flip mode\n        gameState.specialModes.flipMode = false;\n        gameState.specialModes.isWaitingForFlip = false;\n        updateSpecialActionButtons();\n        attachPieceEventListeners();\n        return;\n    }\n\n    // If we are in clear line mode, user should click a grid cell not a piece\n    if (gameState.specialModes.clearLineMode) {\n        showSpecialModeMessage('clearLine', 'Click on a grid cell to clear a line', 1500);\n        return;\n    }\n}\n\n// --- MOUSE EVENT HANDLERS FOR CUSTOM DRAG (Alternative to HTML5 drag & drop) ---\n\n// --- MOUSE MOVE OPTIMIZATION ---\nlet __lastMouseEvent = null;\nlet __mouseRAF = 0;\nconst DRAG_PROFILING_ENABLED = false;\nfunction startDragTimer(label) {\n    if (DRAG_PROFILING_ENABLED) console.time(label);\n}\nfunction endDragTimer(label) {\n    if (DRAG_PROFILING_ENABLED) console.timeEnd(label);\n}\n\n/**\n * Wrapper for mousemove to throttle via requestAnimationFrame for better performance\n * BUT updates visual position IMMEDIATELY without waiting for RAF for smooth feel\n */\nfunction handleMouseMove(event) {\n    if (!gameState.dragState.isDragging) return;\n    \n    // DRAG LATENCY FIX: Update visual position IMMEDIATELY - don't wait for RAF\n    const clientX = event.clientX;\n    const clientY = event.clientY;\n    render.updateDraggedPiecePosition(clientX, clientY);\n    \n    // Mark as moved if threshold exceeded (immediate feedback)\n    if (!gameState.dragState.hasMoved) {\n        const dx = clientX - gameState.dragState.startX;\n        const dy = clientY - gameState.dragState.startY;\n        if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {\n            gameState.dragState.hasMoved = true;\n        }\n    }\n    \n    // Store event for RAF processing (hit-testing and highlighting are deferred to RAF)\n    __lastMouseEvent = event;\n    if (!__mouseRAF) {\n        __mouseRAF = requestAnimationFrame(() => {\n            const ev = __lastMouseEvent;\n            __mouseRAF = 0;\n            if (ev) _handleMouseMoveInner(ev);\n        });\n    }\n}\n\n/**\n * Inner handler q ekzekuton logjikn aktuale t lvizjes s mouse\n * OPTIMIZED: Shmanget prditsimi kur pozicioni nuk ka ndryshuar\n * NOTE: Visual position update is done IMMEDIATELY in handleMouseMove(), not here\n */\nfunction _handleMouseMoveInner(event) {\n    if (!gameState.dragState.isDragging) return;\n    \n    startDragTimer('drag:hit-test');\n    const clientX = event.clientX;\n    const clientY = event.clientY;\n    \n    //  Store current pointer position for line clear grid re-positioning\n    gameState.dragState.clientX = clientX;\n    gameState.dragState.clientY = clientY;\n    \n    // NOTE: Visual position update is now done IMMEDIATELY in handleMouseMove(), not here\n    // This eliminates lag and makes drag feel elastic-free\n    \n    // Determine drop target using math-based mapping\n    const pos = getCellFromPoint(clientX, clientY);\n    if (!pos) {\n        endDragTimer('drag:hit-test');\n        render.clearHighlights();\n        gameState.dragState.lastTargetRow = undefined;\n        gameState.dragState.lastTargetCol = undefined;\n        return;\n    }\n    \n    const startRow = pos.row - gameState.dragState.offsetY;\n    const startCol = pos.col - gameState.dragState.offsetX;\n    \n    // OPTIMIZATION: Shmanget prditsimi nse pozicioni nuk ka ndryshuar\n    if (startRow === gameState.dragState.lastTargetRow && \n        startCol === gameState.dragState.lastTargetCol) {\n        endDragTimer('drag:hit-test');\n        return; // Asnj ndryshim, mos bj asgj\n    }\n    \n    startDragTimer('drag:validate-placement');\n    const piece = gameState.currentPieces[gameState.dragState.pieceIndex];\n    const isValid = logic.isValidPlacement(piece.currentShape, startRow, startCol);\n    endDragTimer('drag:validate-placement');\n    \n    // Log only when validity changes (not every frame)\n    if ((!gameState.dragState._lastValidState || gameState.dragState._lastValidState !== isValid) && logger.LOG_DRAG) {\n        logger.logDragMove(gameState.dragState.pieceIndex, clientX, clientY, \n                          { row: startRow, col: startCol }, isValid);\n        gameState.dragState._lastValidState = isValid;\n    }\n    \n    startDragTimer('drag:highlight');\n    render.showGhostAndHighlight(piece, startRow, startCol, isValid);\n    endDragTimer('drag:highlight');\n    \n    gameState.dragState.lastTargetRow = startRow;\n    gameState.dragState.lastTargetCol = startCol;\n    endDragTimer('drag:hit-test');\n}\n\nfunction handleMouseUp(event) {\n    if (!gameState.dragState.isDragging) return;\n    \n    // Cancel any pending RAF\n    if (__mouseRAF) {\n        cancelAnimationFrame(__mouseRAF);\n        __mouseRAF = 0;\n    }\n    \n    // Clean up mouse listeners\n    document.removeEventListener('mousemove', handleMouseMove);\n    document.removeEventListener('mouseup', handleMouseUp);\n    window.removeEventListener('mouseup', handleMouseUp);\n    document.removeEventListener('mouseleave', handleMouseUp);\n    if ('onpointerup' in window) {\n        document.removeEventListener('pointerup', handleMouseUp);\n    }\n    \n    const duration = Date.now() - (gameState.dragState.startTime || 0);\n    if (!gameState.dragState.hasMoved && duration < 300) {\n        // Tap/click  cancel drag without placement\n        finishDrag();\n        return;\n    }\n    \n    // Process drop like touch\n    const { pieceIndex, lastTargetRow, lastTargetCol } = gameState.dragState;\n    \n    if (lastTargetRow !== undefined && lastTargetCol !== undefined) {\n        const piece = gameState.currentPieces[pieceIndex];\n        const isValid = logic.isValidPlacement(piece.currentShape, lastTargetRow, lastTargetCol);\n        \n        if (isValid) {\n            // IMPORTANT: processSuccessfulPlacement itself will call finishDrag()\n            // (either directly or via the line-clear animation callback).\n            processSuccessfulPlacement(piece, pieceIndex, lastTargetRow, lastTargetCol);\n        } else {\n            // Invalid placement  shake + single finishDrag()\n            processFailedPlacement();\n            finishDrag();\n        }\n    } else {\n        // No target at all  failed placement + single finishDrag()\n        processFailedPlacement();\n        finishDrag();\n    }\n}\n\n// --- DRAG & DROP (MOUSE) HANDLERS ---\n\n// OPTIMIZATION: Cache grid metrics at drag start to avoid repeated DOM reads during drag move\nfunction cacheGridMetrics() {\n    const grid = dom.gameGrid;\n    if (!grid) return;\n\n    const rect = grid.getBoundingClientRect();\n    let cellSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-cell-size'));\n    if (!cellSize || Number.isNaN(cellSize)) {\n        const probe = grid.querySelector('.grid-cell');\n        if (probe) cellSize = probe.getBoundingClientRect().width; else cellSize = 40;\n    }\n    let gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-gap'));\n    if (Number.isNaN(gap)) gap = 0;\n\n    const cs = getComputedStyle(grid);\n    const padL = parseFloat(cs.paddingLeft) || 0;\n    const padT = parseFloat(cs.paddingTop) || 0;\n    const bordL = parseFloat(cs.borderLeftWidth) || 0;\n    const bordT = parseFloat(cs.borderTopWidth) || 0;\n\n    Object.assign(gameState.dragState, {\n        gridMetricsCached: true,\n        gridRect: { left: rect.left, top: rect.top },\n        cellSize: cellSize,\n        step: cellSize + gap,\n        gridPadL: padL,\n        gridPadT: padT,\n        gridBordL: bordL,\n        gridBordT: bordT,\n    });\n}\n\n// Helper: map a screen point to the nearest grid cell, even when over the gap\n// OPTIMIZED: Uses cached grid metrics when available to avoid DOM reads during drag\nfunction getCellFromPoint(clientX, clientY) {\n    const grid = dom.gameGrid;\n    if (!grid) return null;\n\n    let cellSize, step, gridLeft, gridTop, padL, padT, bordL, bordT;\n\n    // Use cached metrics if available (during drag), otherwise read DOM\n    if (gameState.dragState.gridMetricsCached) {\n        cellSize = gameState.dragState.cellSize;\n        step = gameState.dragState.step;\n        gridLeft = gameState.dragState.gridRect.left;\n        gridTop = gameState.dragState.gridRect.top;\n        padL = gameState.dragState.gridPadL;\n        padT = gameState.dragState.gridPadT;\n        bordL = gameState.dragState.gridBordL;\n        bordT = gameState.dragState.gridBordT;\n    } else {\n        // Fallback: read from DOM if not cached\n        const rect = grid.getBoundingClientRect();\n        gridLeft = rect.left;\n        gridTop = rect.top;\n\n        cellSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-cell-size'));\n        if (!cellSize || Number.isNaN(cellSize)) {\n            const probe = grid.querySelector('.grid-cell');\n            if (probe) cellSize = probe.getBoundingClientRect().width; else cellSize = 40;\n        }\n        let gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-gap'));\n        if (Number.isNaN(gap)) gap = 0;\n\n        step = cellSize + gap;\n        const cs = getComputedStyle(grid);\n        padL = parseFloat(cs.paddingLeft) || 0;\n        padT = parseFloat(cs.paddingTop) || 0;\n        bordL = parseFloat(cs.borderLeftWidth) || 0;\n        bordT = parseFloat(cs.borderTopWidth) || 0;\n    }\n\n    // Quickly reject if completely outside grid bounds\n    const gridWidth = 10 * cellSize + 9 * (step - cellSize);\n    const gridHeight = 10 * cellSize + 9 * (step - cellSize);\n    if (clientX < gridLeft || clientX > gridLeft + gridWidth || \n        clientY < gridTop || clientY > gridTop + gridHeight) {\n        return null;\n    }\n\n    const x = clientX - gridLeft - padL - bordL;\n    const y = clientY - gridTop - padT - bordT;\n    \n    // Snap to the NEAREST cell center so transitions are symmetric (50/50)\n    let col = Math.round((x - cellSize / 2) / step);\n    let row = Math.round((y - cellSize / 2) / step);\n\n    // Clamp within grid\n    col = Math.min(Math.max(0, col), GRID_COLS - 1);\n    row = Math.min(Math.max(0, row), GRID_ROWS - 1);\n\n    return { row, col };\n}\n\nfunction handleDragStart(event) {\n    if (gameState.isPaused || gameState.isGameOver) {\n        event.preventDefault();\n        return;\n    }\n    \n    // Don't allow dragging if in special modes (rotate/flip/hint)\n    if (gameState.specialModes.rotateMode || gameState.specialModes.flipMode || gameState.specialModes.hintMode) {\n        event.preventDefault();\n        return;\n    }\n    \n    // For desktop mouse events, use custom drag behavior instead of HTML5 drag & drop\n    if (event.type === 'mousedown') {\n        // Prevent default HTML5 drag behavior\n        event.preventDefault();\n        \n        audio.initAudioContext();\n        audio.playHapticFeedback(30);\n\n        const pieceElement = event.target.closest('.piece');\n        if (!pieceElement || pieceElement.classList.contains('empty')) {\n            return;\n        }\n        const pieceIndex = parseInt(pieceElement.dataset.pieceIndex);\n        const pieceData = gameState.currentPieces[pieceIndex];\n        \n        logger.logDragStart(pieceIndex, event.clientX, event.clientY, { row: 0, col: 0 });\n        \n        const pieceRect = pieceElement.getBoundingClientRect();\n        const clickXInPiece = event.clientX - pieceRect.left;\n        const clickYInPiece = event.clientY - pieceRect.top;\n\n        let closestBlock = { dist: Infinity, row: 0, col: 0 };\n        pieceElement.querySelectorAll('.piece-block[data-shape-row]').forEach(block => {\n            const blockRect = block.getBoundingClientRect();\n            const blockCenterX = (blockRect.left - pieceRect.left) + blockRect.width / 2;\n            const blockCenterY = (blockRect.top - pieceRect.top) + blockRect.height / 2;\n            const distance = Math.hypot(clickXInPiece - blockCenterX, clickYInPiece - blockCenterY);\n            if (distance < closestBlock.dist) {\n                closestBlock = {\n                    dist: distance,\n                    row: parseInt(block.dataset.shapeRow),\n                    col: parseInt(block.dataset.shapeCol)\n                };\n            }\n        });\n\n        resetDragState();\n        // OPTIMIZATION: Cache grid metrics now for fast getCellFromPoint calls during drag\n        cacheGridMetrics();\n        \n        Object.assign(gameState.dragState, {\n            isDragging: true,\n            pieceIndex: pieceIndex,\n            pieceSourceElement: pieceElement,\n            offsetX: closestBlock.col,\n            offsetY: closestBlock.row,\n            startX: event.clientX,\n            startY: event.clientY,\n            startTime: Date.now(),\n            hasMoved: false,\n            lastTargetRow: undefined,\n            lastTargetCol: undefined,\n        });\n\n        render.createDraggedPieceClone(pieceData);\n        render.updateDraggedPiecePosition(event.clientX, event.clientY);\n        \n        pieceElement.classList.add('dragging');\n        \n        // Add global mouse listeners for custom drag behavior (like touch)\n        document.addEventListener('mousemove', handleMouseMove);\n        document.addEventListener('mouseup', handleMouseUp);\n        // Also add mouseup to window as backup\n        window.addEventListener('mouseup', handleMouseUp);\n        // Add mouseleave as another backup\n        document.addEventListener('mouseleave', handleMouseUp);\n        \n        // Also try pointer events as backup if supported\n        if ('onpointerup' in window) {\n            document.addEventListener('pointerup', handleMouseUp);\n        }\n        \n        return;\n    }\n    \n    // For HTML5 drag events, prevent them to avoid conflicts\n    if (event.type === 'dragstart') {\n        event.preventDefault();\n        return;\n    }\n\n    pieceElement.classList.add('dragging');\n}\n\nfunction handleDragOver(event) {\n    event.preventDefault();\n    if (!gameState.dragState.isDragging) return;\n\n    const clientX = event.clientX;\n    const clientY = event.clientY;\n\n    render.updateDraggedPiecePosition(clientX, clientY);\n\n    // Prefer math-based mapping to handle gaps between cells\n    const pos = getCellFromPoint(clientX, clientY);\n    if (!pos) {\n        render.clearHighlights();\n        gameState.dragState.lastTargetRow = undefined;\n        gameState.dragState.lastTargetCol = undefined;\n        return;\n    }\n\n    const startRow = pos.row - gameState.dragState.offsetY;\n    const startCol = pos.col - gameState.dragState.offsetX;\n\n    const piece = gameState.currentPieces[gameState.dragState.pieceIndex];\n    const isValid = logic.isValidPlacement(piece.currentShape, startRow, startCol);\n\n    render.showGhostAndHighlight(piece, startRow, startCol, isValid);\n\n    gameState.dragState.lastTargetRow = startRow;\n    gameState.dragState.lastTargetCol = startCol;\n}\n\nfunction handleDrop(event) {\n    event.preventDefault();\n    if (!gameState.dragState.isDragging) return;\n\n    const { pieceIndex, lastTargetRow, lastTargetCol } = gameState.dragState;\n    \n    if (lastTargetRow !== undefined && lastTargetCol !== undefined) {\n        const piece = gameState.currentPieces[pieceIndex];\n        if (logic.isValidPlacement(piece.currentShape, lastTargetRow, lastTargetCol)) {\n            processSuccessfulPlacement(piece, pieceIndex, lastTargetRow, lastTargetCol);\n            // finishDrag() will be called from processSuccessfulPlacement callback\n        } else {\n            processFailedPlacement();\n            finishDrag();\n        }\n    } else {\n        processFailedPlacement();\n        finishDrag();\n    }\n}\n\nfunction handleDragEnd() {\n    if (!gameState.dragState.isDragging) return;\n    finishDrag();\n}\n\n// Fallback handler for desktop mouse operations\nfunction handleDragEndFallback() {\n    // Only trigger if we're actually dragging and haven't handled it yet\n    if (gameState.dragState.isDragging) {\n        finishDrag();\n    }\n}\n\n// --- TOUCH EVENT CLEANUP FUNCTIONS ---\n\n/**\n * Removes all global touch event listeners to prevent memory leaks\n */\nfunction cleanupTouchListeners() {\n    // Cancel any pending RAF\n    if (__dragRAF) {\n        cancelAnimationFrame(__dragRAF);\n        __dragRAF = 0;\n    }\n    document.removeEventListener('touchmove', handleTouchMove);\n    document.removeEventListener('touchend', handleTouchEnd);\n    document.removeEventListener('touchcancel', handleTouchEnd);\n}\n\n// --- TOUCH MOVE WRAPPER FOR PASSIVE HANDLING ---\nlet __lastTouchEvent = null;\nlet __dragRAF = 0;\n\n/**\n * Wrapper for touchmove to throttle _handleTouchMoveInner via requestAnimationFrame\n * BUT updates visual position IMMEDIATELY without waiting for RAF for smooth feel\n */\nfunction handleTouchMove(event) {\n    if (!gameState.dragState.isDragging) return;\n    if (event.cancelable) {\n        event.preventDefault(); // kill browser scroll/zoom heuristics ASAP\n    }\n    \n    // Find the correct touch by identifier\n    const touch = Array.from(event.touches).find(t => t.identifier === gameState.dragState.touchIdentifier);\n    if (!touch) return;\n    \n    // DRAG LATENCY FIX: Update visual position IMMEDIATELY - don't wait for RAF\n    // This eliminates the \"elastic\" lag by keeping visuals in sync with finger\n    const clientX = touch.clientX;\n    const clientY = touch.clientY;\n    render.updateDraggedPiecePosition(clientX, clientY + gameState.dragState.touchOffsetY);\n    \n    // Mark as moved if threshold exceeded (immediate feedback)\n    if (!gameState.dragState.hasMoved) {\n        const dx = clientX - gameState.dragState.startX;\n        const dy = clientY - gameState.dragState.startY;\n        if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {\n            gameState.dragState.hasMoved = true;\n        }\n    }\n    \n    // Store event for RAF processing (hit-testing and highlighting are deferred to RAF)\n    __lastTouchEvent = event;\n    if (!__dragRAF) {\n        __dragRAF = requestAnimationFrame(() => {\n            const ev = __lastTouchEvent;\n            __dragRAF = 0;\n            if (ev) _handleTouchMoveInner(ev);\n        });\n    }\n}\n\n// --- TOUCH EVENT HANDLERS ---\n\nfunction handleTouchStart(event) {\n    if (gameState.isPaused || gameState.isGameOver) return;\n    \n    // Don't allow dragging if in special modes (rotate/flip/hint)\n    if (gameState.specialModes.rotateMode || gameState.specialModes.flipMode || gameState.specialModes.hintMode) {\n        return;\n    }\n    \n    // Only prevent default if dragging a piece\n    if (event.cancelable && event.target.closest('.piece')) {\n        event.preventDefault();\n    }\n\n    // Clean up any existing touch listeners before adding new ones\n    cleanupTouchListeners();\n\n    audio.initAudioContext();\n    audio.playHapticFeedback(30);\n\n    const touch = event.touches[0];\n    const pieceElement = event.target.closest('.piece');\n    if (!pieceElement || pieceElement.classList.contains('empty')) {\n        return;\n    }\n    const pieceIndex = parseInt(pieceElement.dataset.pieceIndex);\n    const pieceData = gameState.currentPieces[pieceIndex];\n\n    const pieceRect = pieceElement.getBoundingClientRect();\n    const touchXInPiece = touch.clientX - pieceRect.left;\n    const touchYInPiece = touch.clientY - pieceRect.top;\n\n    let closestBlock = { dist: Infinity, row: 0, col: 0 };\n    pieceElement.querySelectorAll('.piece-block[data-shape-row]').forEach(block => {\n        const blockRect = block.getBoundingClientRect();\n        const blockCenterX = (blockRect.left - pieceRect.left) + blockRect.width / 2;\n        const blockCenterY = (blockRect.top - pieceRect.top) + blockRect.height / 2;\n        const distance = Math.hypot(touchXInPiece - blockCenterX, touchYInPiece - blockCenterY);\n        if (distance < closestBlock.dist) {\n            closestBlock = {\n                dist: distance,\n                row: parseInt(block.dataset.shapeRow),\n                col: parseInt(block.dataset.shapeCol)\n            };\n        }\n    });\n    \n    const TOUCH_OFFSET_Y = -85;\n    resetDragState();\n    // OPTIMIZATION: Cache grid metrics now for fast getCellFromPoint calls during drag\n    cacheGridMetrics();\n    \n    Object.assign(gameState.dragState, {\n        isDragging: true,\n        pieceIndex: pieceIndex,\n        pieceSourceElement: pieceElement,\n        offsetX: closestBlock.col,\n        offsetY: closestBlock.row,  // NOW USING ACCURATE OFFSET\n        touchIdentifier: touch.identifier,\n        startX: touch.clientX,\n        startY: touch.clientY,\n        startTime: Date.now(),\n        hasMoved: false,\n        touchOffsetY: TOUCH_OFFSET_Y,\n    });\n    render.createDraggedPieceClone(pieceData);\n    render.updateDraggedPiecePosition(touch.clientX, touch.clientY + TOUCH_OFFSET_Y);\n    pieceElement.classList.add('dragging');\n\n    // Add touch listeners with proper cleanup tracking\n    document.addEventListener('touchmove', handleTouchMove, { passive: false });\n    document.addEventListener('touchend', handleTouchEnd, { passive: false });\n    document.addEventListener('touchcancel', handleTouchEnd, { passive: false });\n}\n\nfunction _handleTouchMoveInner(event) {\n    if (!gameState.dragState.isDragging) return;\n    if (event.cancelable) event.preventDefault();\n\n    startDragTimer('touch:hit-test');\n    \n    // Find the correct touch by identifier\n    const touch = Array.from(event.touches).find(t => t.identifier === gameState.dragState.touchIdentifier);\n    if (!touch) {\n        endDragTimer('touch:hit-test');\n        return;\n    }\n    const clientX = touch.clientX;\n    const clientY = touch.clientY;\n\n    //  Store current pointer position for line clear grid re-positioning\n    gameState.dragState.clientX = clientX;\n    gameState.dragState.clientY = clientY + gameState.dragState.touchOffsetY;\n\n    // NOTE: Visual position update is now done IMMEDIATELY in handleTouchMove(), not here\n    // This eliminates lag and makes drag feel elastic-free\n\n    // Determine drop target using math-based mapping (robust over gaps)\n    const pos = getCellFromPoint(clientX, clientY + gameState.dragState.touchOffsetY);\n    if (!pos) {\n        endDragTimer('touch:hit-test');\n        render.clearHighlights();\n        gameState.dragState.lastTargetRow = undefined;\n        gameState.dragState.lastTargetCol = undefined;\n        return;\n    }\n    const startRow = pos.row - gameState.dragState.offsetY;\n    const startCol = pos.col - gameState.dragState.offsetX;\n    \n    // OPTIMIZATION: Shmanget prditsimi nse pozicioni nuk ka ndryshuar\n    if (startRow === gameState.dragState.lastTargetRow && \n        startCol === gameState.dragState.lastTargetCol) {\n        endDragTimer('touch:hit-test');\n        return; // Asnj ndryshim, mos bj asgj\n    }\n    \n    startDragTimer('touch:validate-placement');\n    const piece = gameState.currentPieces[gameState.dragState.pieceIndex];\n    const isValid = logic.isValidPlacement(piece.currentShape, startRow, startCol);\n    endDragTimer('touch:validate-placement');\n    \n    startDragTimer('touch:highlight');\n    render.showGhostAndHighlight(piece, startRow, startCol, isValid);\n    endDragTimer('touch:highlight');\n    \n    gameState.dragState.lastTargetRow = startRow;\n    gameState.dragState.lastTargetCol = startCol;\n    endDragTimer('touch:hit-test');\n}\n\nfunction handleTouchEnd(event) {\n    if (!gameState.dragState.isDragging) return;\n    \n    // Clean up touch listeners immediately\n    cleanupTouchListeners();\n    \n    const duration = Date.now() - (gameState.dragState.startTime || 0);\n    if (!gameState.dragState.hasMoved && duration < 300) {\n        // Tap  cancel drag\n        finishDrag();\n        return;\n    }\n    // Otherwise, treat as drop. Let handleDrop decide when to call finishDrag().\n    setTimeout(() => {\n        handleDrop(event);\n        // DO NOT call finishDrag() here  handleDrop / processSuccessfulPlacement /\n        // processFailedPlacement already handle it correctly.\n    }, 50);\n}\n\n// --- HELPER FUNCTIONS FOR DRAG/DROP LOGIC ---\n\nfunction processSuccessfulPlacement(piece, pieceIndex, row, col) {\n    logger.logPlacementValid(pieceIndex, row, col, piece.currentShape.length);\n    logger.logPerformanceStart('placement-process');\n    \n    // Clear any active hint highlights when placing a piece\n    if (window.clearHintHighlights) {\n        window.clearHintHighlights();\n    }\n    \n    // DETAILED PERF: Save game state\n    console.time('placement:save-state');\n    logic.saveGameState();\n    console.timeEnd('placement:save-state');\n    \n    // Record cells for placement animation\n    gameState.lastPlacementCells = piece.currentShape.map(([r, c]) => ({ r: row + r, c: col + c }));\n    \n    // DETAILED PERF: Place piece on grid\n    console.time('placement:place-piece');\n    logic.placePieceOnGrid(piece, row, col);\n    console.timeEnd('placement:place-piece');\n    \n    audio.playPlaceSound();\n    \n    // DETAILED PERF: Replace used piece\n    console.time('placement:replace-piece');\n    logic.replaceUsedPiece(pieceIndex);\n    console.timeEnd('placement:replace-piece');\n\n    // DETAILED PERF: Detect and clear lines\n    console.time('placement:detect-lines');\n    const clearResult = logic.checkAndClearLines(piece.color);\n    console.timeEnd('placement:detect-lines');\n    \n    if (clearResult) {\n        const totalLines = clearResult.clearedRows.length + clearResult.clearedCols.length;\n        logger.logLineCleared(clearResult.clearedRows.concat(clearResult.clearedCols), totalLines * 10);\n        logger.logScoreAdded(clearResult.pointsEarned, 'line clear');\n        \n        // DETAILED PERF: Animate line clears\n        console.time('placement:animate-lines');\n        // Animate line clears, then handle Game Over after animations\n        handleLineClearEffects(clearResult, () => {\n            console.timeEnd('placement:animate-lines');\n            \n            // DETAILED PERF: Update special actions and game state\n            console.time('placement:update-state');\n            updateSpecialActionButtons();\n            logic.updateGameOverState();\n            if (gameState.isGameOver) {\n                gameState.isPaused = false;\n                audio.playGameOverSound();\n                logger.logGameOver(gameState.score, pieceIndex + 1);\n            }\n            render.updateOverlays();\n            console.timeEnd('placement:update-state');\n            \n            // DETAILED PERF: Finish drag\n            console.time('placement:finish-drag');\n            finishDrag();\n            console.timeEnd('placement:finish-drag');\n            \n            logger.logPerformanceEnd('placement-process');\n        }, piece.color);\n        checkSpecialRewards(clearResult.pointsEarned, clearResult.comboCount);\n    } else {\n        // No clears: check Game Over immediately\n        logger.logScoreAdded(0, 'placement only');\n        \n        // DETAILED PERF: Update state when no clears\n        console.time('placement:update-state-no-clear');\n        updateSpecialActionButtons();\n        logic.updateGameOverState();\n        if (gameState.isGameOver) {\n            gameState.isPaused = false;\n            audio.playGameOverSound();\n            logger.logGameOver(gameState.score, pieceIndex + 1);\n        }\n        render.updateOverlays();\n        console.timeEnd('placement:update-state-no-clear');\n        \n        // DETAILED PERF: Finish drag\n        console.time('placement:finish-drag-no-clear');\n        finishDrag();\n        console.timeEnd('placement:finish-drag-no-clear');\n        \n        logger.logPerformanceEnd('placement-process');\n    }\n}\n\nfunction processFailedPlacement() {\n    logger.logWarning('Invalid placement attempt - piece cannot be placed there');\n    render.shakeDraggedPieceClone(INVALID_PLACEMENT_SHAKE_DURATION);\n    audio.playHapticFeedback([20, 10, 20]);\n}\n\nfunction finishDrag() {\n    console.time('finishDrag:total');\n    \n    console.time('finishDrag:hide-elements');\n    render.hideDraggedPieceClone();\n    render.clearHighlights();\n    console.timeEnd('finishDrag:hide-elements');\n    \n    // Clean up touch listeners in case they weren't cleaned up elsewhere\n    cleanupTouchListeners();\n    \n    // Clean up mouse listeners in case they weren't cleaned up elsewhere\n    document.removeEventListener('mousemove', handleMouseMove);\n    document.removeEventListener('mouseup', handleMouseUp);\n    window.removeEventListener('mouseup', handleMouseUp);\n    document.removeEventListener('mouseleave', handleMouseUp);\n    if ('onpointerup' in window) {\n        document.removeEventListener('pointerup', handleMouseUp);\n    }\n    \n    if (gameState.dragState.pieceSourceElement) {\n        gameState.dragState.pieceSourceElement.classList.remove('dragging');\n    }\n\n    console.time('finishDrag:reset-state');\n    // Reset drag state completely\n    resetDragState();\n    console.timeEnd('finishDrag:reset-state');\n    \n    console.time('finishDrag:update-grid');\n    render.updateGridDisplay();\n    console.timeEnd('finishDrag:update-grid');\n    \n    console.time('finishDrag:animate-placement');\n    // Animate the recently placed cells\n    render.animatePlacement(gameState.lastPlacementCells);\n    console.timeEnd('finishDrag:animate-placement');\n    \n    console.time('finishDrag:update-pieces');\n    // Always update pieces display after drag operations since pieces may have changed\n    // (when a piece is placed, it gets replaced with a new one)\n    render.updatePiecesDisplay();\n    attachPieceEventListeners();\n    console.timeEnd('finishDrag:update-pieces');\n    \n    console.time('finishDrag:update-ui');\n    render.updateScoreDisplay();\n    render.updateControlButtons();\n    render.updateOverlays(); // Thirrja e re pr t menaxhuar mbivendosjet\n    // Clear placement animation flag\n    render.clearPlacementFlag();\n    console.timeEnd('finishDrag:update-ui');\n    \n    console.timeEnd('finishDrag:total');\n}\n\nfunction handleLineClearEffects(clearResult, onComplete, placedPieceColor = null) {\n    audio.playClearSound(clearResult.totalLinesCleared);\n    const boardSize = GRID_COLS;\n    const gameGrid = dom.gameGrid;\n    const gameArea = document.querySelector('.game-area');\n    \n    // Use placedPieceColor from clearResult if not provided\n    if (!placedPieceColor && clearResult.placedPieceColor) {\n        placedPieceColor = clearResult.placedPieceColor;\n    }\n    \n    // Determine a visual color to use for the clear bar/frame.\n    // Preference order:\n    // 1) explicit placedPieceColor (palette index)\n    // 2) clearResult.placedPieceColor (propagated from gameLogic)\n    // 3) first cell's `animationColor` if present (string hex/rgb)\n    let visualPieceColor = placedPieceColor || (clearResult && clearResult.placedPieceColor) || null;\n    if (!visualPieceColor && clearResult && Array.isArray(clearResult.cellsToAnimate) && clearResult.cellsToAnimate.length) {\n        const firstAnim = clearResult.cellsToAnimate.find(c => c && c.animationColor);\n        if (firstAnim && firstAnim.animationColor) {\n            visualPieceColor = firstAnim.animationColor;\n        }\n    }\n\n    // Call Galaxy Row Clear animation\n    animateLineClearSpectra({\n        ctx: null, // Not using canvas\n        rows: clearResult.clearedRows || [],\n        cols: clearResult.clearedCols || [],\n        boardSize: boardSize,\n        placedPieceColor: visualPieceColor,\n        onClearRow: (r) => {\n            // Clear row from game state\n            gameState.grid[r] = Array(boardSize).fill(0);\n            //  Update DOM immediately (not after 1500ms)\n            render.updateGridDisplay();\n            //  If user is dragging, re-position clone after grid layout change\n            if (gameState.dragState.isDragging) {\n                const { clientX, clientY } = gameState.dragState;\n                if (clientX !== undefined && clientY !== undefined) {\n                    render.updateDraggedPiecePosition(clientX, clientY);\n                }\n            }\n        },\n        onClearCol: (c) => {\n            // Clear column from game state\n            for (let r = 0; r < GRID_ROWS; r++) {\n                gameState.grid[r][c] = 0;\n            }\n            //  Update DOM immediately (not after 1500ms)\n            render.updateGridDisplay();\n            //  If user is dragging, re-position clone after grid layout change\n            if (gameState.dragState.isDragging) {\n                const { clientX, clientY } = gameState.dragState;\n                if (clientX !== undefined && clientY !== undefined) {\n                    render.updateDraggedPiecePosition(clientX, clientY);\n                }\n            }\n        },\n        onDone: () => {\n            // After all clears finished, invoke onComplete callback\n            if (typeof onComplete === 'function') onComplete();\n            if (clearResult.comboCount > 1) {\n                render.showComboMessage(clearResult.comboCount);\n            }\n        },\n        syncStart: true // Start all animations at same time\n    });\n}\n\n// --- EARNING SPECIAL TOKENS ---\nfunction checkSpecialRewards(points, comboCount) {\n    const gameMode = localStorage.getItem('selectedGameMode') || 'collection';\n    \n    // Check for piece unlocks only in Collection Mode\n    if (gameMode === 'collection') {\n        pieceUnlockSystem.checkForUnlocks(gameState.score);\n    }\n    \n    // Every 1000 points earn a rotate\n    if (Math.floor(gameState.score / 1000) > Math.floor((gameState.score - points) / 1000)) {\n        gameState.rotateTokens++;\n    }\n    // Every 2000 points earn an undo\n    if (Math.floor(gameState.score / 2000) > Math.floor((gameState.score - points) / 2000)) {\n        gameState.undoTokens++;\n    }\n    // Combo >= 4 earns a clear line\n    if (comboCount >= 4) {\n        gameState.clearLineTokens++;\n    }\n    // Every 3000 points earn a hint\n    if (Math.floor(gameState.score / 3000) > Math.floor((gameState.score - points) / 3000)) {\n        gameState.hintTokens++;\n    }\n}\n\nfunction updateSpecialActionButtons() {\n    // Legacy button references (for backward compatibility)\n    const rotateBtn = document.getElementById('rotateBtn');\n    const undoBtn = document.getElementById('undoBtn');\n    const clearLineBtn = document.getElementById('clearLineBtn');\n    const flipBtn = document.getElementById('flipBtn');\n    \n    // FAB button references\n    const fabRotate = document.getElementById('fabRotate');\n    const fabUndo = document.getElementById('fabUndo');\n    const fabClearLine = document.getElementById('fabClearLine');\n    const fabFlip = document.getElementById('fabFlip');\n    const fabHint = document.getElementById('fabHint');\n    \n    // Update button states (legacy)\n    if (rotateBtn) {\n        rotateBtn.disabled = gameState.rotateTokens <= 0;\n        rotateBtn.classList.toggle('active-mode', gameState.specialModes.rotateMode);\n    }\n    if (undoBtn) undoBtn.disabled = gameState.undoTokens <= 0;\n    if (clearLineBtn) {\n        clearLineBtn.disabled = gameState.clearLineTokens <= 0;\n        clearLineBtn.classList.toggle('active-mode', gameState.specialModes.clearLineMode);\n    }\n    if (flipBtn) {\n        flipBtn.disabled = gameState.flipTokens <= 0;\n        flipBtn.classList.toggle('active-mode', gameState.specialModes.flipMode);\n    }\n    \n    // Update token counts (legacy)\n    const rotateCountEl = document.getElementById('rotateCount');\n    const undoCountEl = document.getElementById('undoCount');\n    const clearLineCountEl = document.getElementById('clearLineCount');\n    const flipCountEl = document.getElementById('flipCount');\n    \n    if (rotateCountEl) rotateCountEl.textContent = gameState.rotateTokens;\n    if (undoCountEl) undoCountEl.textContent = gameState.undoTokens;\n    if (clearLineCountEl) clearLineCountEl.textContent = gameState.clearLineTokens;\n    if (flipCountEl) flipCountEl.textContent = gameState.flipTokens;\n}\n\n// --- EVENT LISTENERS FOR SPECIAL BUTTONS ---\nfunction setupSpecialActionButtons() {\n    if (specialActionListenersAttached) {\n        return;\n    }\n\n    // Export globals for legacy integrations\n    window.initializeGame = initializeGame;\n    window.attachPieceEventListeners = attachPieceEventListeners;\n\n    // Rotate Button Handler\n    function handleRotateAction(e) {\n        if (gameState.rotateTokens > 0) {\n            // If already in rotate mode, clicking again cancels it.\n            if (gameState.specialModes.rotateMode) {\n                gameState.specialModes.rotateMode = false;\n                gameState.specialModes.isWaitingForRotate = false;\n                showSpecialModeMessage('rotate_cancel', null, 1500);\n            } else {\n                // Activate rotate mode. Deactivate all other modes.\n                gameState.specialModes.clearLineMode = false;\n                gameState.specialModes.hintMode = false;\n                gameState.specialModes.flipMode = false;\n                gameState.specialModes.rotateMode = true;\n                gameState.specialModes.isWaitingForRotate = true;\n                showSpecialModeMessage('rotate', null, 2000);\n            }\n            // Update UI for all cases\n            updateSpecialActionButtons();\n            attachPieceEventListeners();\n        }\n    }\n\n    // Undo Button Handler\n    function handleUndoAction(e) {\n        if (gameState.undoTokens > 0) {\n            // Show visual feedback\n            const undoBtn = e?.currentTarget || document.getElementById('undoBtn');\n            if (undoBtn) {\n                undoBtn.classList.add('active-mode');\n                setTimeout(() => undoBtn.classList.remove('active-mode'), 300);\n            }\n            \n            gameState.undoTokens--; // Consume the token immediately\n\n            if (logic.undoLastMove()) {\n                // State was successfully restored. Now update the UI to reflect it.\n                render.updateGridDisplay();\n                render.updatePiecesDisplay();\n                render.updateScoreDisplay();\n                updateSpecialActionButtons(); // This will show the new token count\n                attachPieceEventListeners();\n\n                showSpecialModeMessage('undo', 'Last move undone!', 2000);\n            } else {\n                // The undo failed (no history), so refund the token.\n                gameState.undoTokens++;\n                updateSpecialActionButtons(); // Also update UI on failure\n                showSpecialModeMessage('error', 'No moves to undo!', 2000);\n            }\n        }\n    }\n\n    // Clear Line Button Handler\n    function handleClearLineAction() {\n        if (gameState.clearLineTokens > 0) {\n            // Toggle clear line mode\n            const activating = !gameState.specialModes.clearLineMode;\n            // Deactivate all other modes\n            gameState.specialModes.rotateMode = false;\n            gameState.specialModes.flipMode = false;\n            gameState.specialModes.hintMode = false;\n            gameState.specialModes.clearLineMode = activating;\n            gameState.specialModes.isWaitingForRotate = false;\n            gameState.specialModes.isWaitingForFlip = false;\n            gameState.specialModes.isWaitingForSelection = activating; // Set flag for grid cell click detection\n\n            if (activating) {\n                render.highlightClearableLines(); // Show which lines can be cleared\n                showSpecialModeMessage('clearLine'); // Show the instructional message\n            } else {\n                render.clearLineHighlights(); // Remove highlights\n                showSpecialModeMessage('clearLine_cancel', 'Clear line mode cancelled.', 2000);\n            }\n            // Update button styles and piece draggability\n            updateSpecialActionButtons();\n            attachPieceEventListeners();\n        }\n    }\n\n    // Flip Button Handler (Enter flip mode, then click piece to rotate 180)\n    function handleFlipAction(e) {\n        if (gameState.flipTokens > 0) {\n            // If already in flip mode, clicking again cancels it.\n            if (gameState.specialModes.flipMode) {\n                gameState.specialModes.flipMode = false;\n                gameState.specialModes.isWaitingForFlip = false;\n                showSpecialModeMessage('flip_cancel', 'Flip mode cancelled', 1500);\n            } else {\n                // Activate flip mode. Deactivate all other modes.\n                gameState.specialModes.rotateMode = false;\n                gameState.specialModes.clearLineMode = false;\n                gameState.specialModes.flipMode = true;\n                gameState.specialModes.isWaitingForFlip = true;\n                showSpecialModeMessage('flip', 'Click a piece to flip it', 2000);\n            }\n            // Update UI for all cases\n            updateSpecialActionButtons();\n            attachPieceEventListeners();\n        }\n    }\n\n\n    // Wire up buttons (legacy + FAB variants)\n    const legacyRotateBtn = document.getElementById('rotateBtn');\n    if (legacyRotateBtn) {\n        legacyRotateBtn.addEventListener('click', handleRotateAction);\n        legacyRotateBtn.addEventListener('touchend', (e) => {\n            e.preventDefault();\n            handleRotateAction(e);\n        });\n    }\n\n    const fabRotateBtn = document.getElementById('fabRotate');\n    if (fabRotateBtn) {\n        fabRotateBtn.addEventListener('click', handleRotateAction);\n        fabRotateBtn.addEventListener('touchend', (e) => {\n            e.preventDefault();\n            handleRotateAction(e);\n        });\n    }\n\n    const legacyUndoBtn = document.getElementById('undoBtn');\n    if (legacyUndoBtn) {\n        legacyUndoBtn.addEventListener('click', handleUndoAction);\n        legacyUndoBtn.addEventListener('touchend', (e) => {\n            e.preventDefault();\n            handleUndoAction(e);\n        });\n    }\n\n    const fabUndoBtn = document.getElementById('fabUndo');\n    if (fabUndoBtn) {\n        fabUndoBtn.addEventListener('click', handleUndoAction);\n        fabUndoBtn.addEventListener('touchend', (e) => {\n            e.preventDefault();\n            handleUndoAction(e);\n        });\n    }\n\n    const legacyClearLineBtn = document.getElementById('clearLineBtn');\n    if (legacyClearLineBtn) {\n        legacyClearLineBtn.addEventListener('click', handleClearLineAction);\n        legacyClearLineBtn.addEventListener('touchend', (e) => {\n            e.preventDefault();\n            handleClearLineAction(e);\n        });\n    }\n\n    const fabClearLineBtn = document.getElementById('fabClearLine');\n    if (fabClearLineBtn) {\n        fabClearLineBtn.addEventListener('click', handleClearLineAction);\n        fabClearLineBtn.addEventListener('touchend', (e) => {\n            e.preventDefault();\n            handleClearLineAction(e);\n        });\n    }\n\n    const legacyFlipBtn = document.getElementById('flipBtn');\n    if (legacyFlipBtn) {\n        legacyFlipBtn.addEventListener('click', handleFlipAction);\n        legacyFlipBtn.addEventListener('touchend', (e) => {\n            e.preventDefault();\n            handleFlipAction(e);\n        });\n    }\n\n    const fabFlipBtn = document.getElementById('fabFlip');\n    if (fabFlipBtn) {\n        fabFlipBtn.addEventListener('click', handleFlipAction);\n        fabFlipBtn.addEventListener('touchend', (e) => {\n            e.preventDefault();\n            handleFlipAction(e);\n        });\n    }\n\n\n\n    specialActionListenersAttached = true;\n}\n\nwhenDomReady(setupSpecialActionButtons);\n\n// --- Event Listener Setup ---\n\n// Global event delegation for piece clicks\nfunction handleDelegatedPieceClick(event) {\n    // Find the piece element\n    const pieceElement = event.target.closest('.piece');\n    \n    if (!pieceElement || pieceElement.classList.contains('empty')) {\n        return;\n    }\n    \n    // Call the original handler with modified event\n    const syntheticEvent = {\n        ...event,\n        target: pieceElement,\n        currentTarget: pieceElement\n    };\n    \n    handlePieceClick(syntheticEvent);\n}\n\n// Touch event delegation for mobile piece interactions\nfunction handleDelegatedPieceTouch(event) {\n    // Only handle if we're in a special mode where drag is disabled\n    const inSpecialMode = gameState.specialModes.rotateMode || gameState.specialModes.flipMode || gameState.specialModes.clearLineMode || gameState.specialModes.hintMode;\n    if (!inSpecialMode) {\n        return; // Let touchstart handler handle normal drag\n    }\n    \n    // Prevent default to avoid ghost clicks\n    event.preventDefault();\n    \n    // Find the piece element\n    const pieceElement = event.target.closest('.piece');\n    \n    if (!pieceElement || pieceElement.classList.contains('empty')) {\n        return;\n    }\n    \n    // Call the original handler with modified event\n    const syntheticEvent = {\n        ...event,\n        target: pieceElement,\n        currentTarget: pieceElement\n    };\n    \n    handlePieceClick(syntheticEvent);\n}\n\nfunction attachPieceEventListeners() {\n    // Setup event delegation on pieces container\n    const piecesContainer = document.querySelector('.pieces-container');\n    if (piecesContainer) {\n        // Always remove existing listener first to prevent duplicates\n        piecesContainer.removeEventListener('click', handleDelegatedPieceClick);\n        piecesContainer.addEventListener('click', handleDelegatedPieceClick);\n        \n        // Add touch event delegation for mobile special modes\n        piecesContainer.removeEventListener('touchend', handleDelegatedPieceTouch);\n        piecesContainer.addEventListener('touchend', handleDelegatedPieceTouch, { passive: false });\n    }\n    \n    // Still attach drag listeners directly to pieces\n    const pieces = document.querySelectorAll('.piece:not(.empty)');\n    \n    pieces.forEach((piece, index) => {\n        \n        // Disable drag on pieces if in special modes to allow clicks\n        const shouldDisableDrag = gameState.specialModes.rotateMode || gameState.specialModes.flipMode || gameState.specialModes.clearLineMode || gameState.specialModes.hintMode;\n        // Always disable HTML5 drag to avoid conflicts with custom mouse handling\n        piece.setAttribute('draggable', 'false');\n        \n        // ALWAYS remove existing listeners first to prevent memory leaks\n        piece.removeEventListener('dragstart', handleDragStart);\n        piece.removeEventListener('mousedown', handleDragStart);\n        piece.removeEventListener('touchstart', handleDragStart);\n        \n        // Add drag listeners only when not in special modes\n        if (!shouldDisableDrag) {\n            // Don't add dragstart listener - we're using custom mouse handling\n            piece.addEventListener('mousedown', handleDragStart);\n            piece.addEventListener('touchstart', handleTouchStart, { passive: false });\n        }\n        \n    });\n    \n    // Mark listeners as attached\n    listenersAttached = true;\n}\n\n// Entry point of the application\n\n// --- THEME SETUP (ADDED SECTION) ---\nfunction setupLegacyLandingFlow() {\n    if (legacyLandingSetupDone) {\n        return;\n    }\n\n    render.cacheDOMElements();\n    render.createGridDOM();\n\n    const initialTheme = localStorage.getItem('blokusTheme') || 'default';\n    if (initialTheme === 'magic-universe') {\n        activateMagicUniverseBackground();\n    }\n\n    updateLandingPageStats();\n\n    const dom = render.dom;\n\n    // Game Mode Selection Handlers - kept for backward compatibility with older landing layout\n    const classicModeCard = document.getElementById('classicMode');\n    const collectionModeCard = document.getElementById('collectionMode');\n    const feedbackElement = document.querySelector('.feedback');\n\n    if (classicModeCard && collectionModeCard) {\n        const savedMode = localStorage.getItem('selectedGameMode');\n        if (savedMode) {\n            selectGameMode(savedMode);\n        }\n\n        function selectGameMode(mode) {\n            selectedGameMode = mode;\n\n            localStorage.setItem('selectedGameMode', selectedGameMode);\n\n            if (feedbackElement) {\n                feedbackElement.style.display = 'none';\n                feedbackElement.textContent = '';\n            }\n\n            document.querySelectorAll('.card.selectable').forEach(card => {\n                card.classList.remove('selected');\n            });\n\n            if (mode === 'classic') {\n                classicModeCard.classList.add('selected');\n            } else if (mode === 'collection') {\n                collectionModeCard.classList.add('selected');\n            }\n\n            if (dom.startButton) {\n                dom.startButton.classList.remove('hidden');\n                dom.startButton.disabled = false;\n                dom.startButton.innerHTML = `<i class=\"fas fa-play-circle\"></i> Start ${mode === 'classic' ? 'Classic' : 'Collection'}`;\n                dom.startButton.style.transform = 'scale(1.05)';\n                setTimeout(() => {\n                    dom.startButton.style.transform = 'scale(1)';\n                }, 300);\n            }\n        }\n\n        // Legacy event listeners remain disabled intentionally (handled via landing.js)\n    }\n\n    if (dom.gameOverRestartButton) {\n        dom.gameOverRestartButton.addEventListener('click', () => {\n            // Hide special-actions container when returning to landing\n            const specialActions = document.querySelector('.special-actions');\n            if (specialActions) specialActions.classList.add('hidden');\n\n            dom.landingPage.classList.remove('hidden');\n            dom.gameContainer.classList.add('hidden');\n\n            initializeGame();\n        });\n    }\n\n    document.body.addEventListener('click', audio.initAudioContext, { once: true });\n    document.body.addEventListener('touchstart', audio.initAudioContext, { once: true });\n\n    legacyLandingSetupDone = true;\n}\n\nwhenDomReady(setupLegacyLandingFlow);\n\ndocument.addEventListener('touchmove', function(event) {\n    if (gameState.dragState && gameState.dragState.isDragging && event.scale !== 1) {\n        event.preventDefault();\n    }\n}, { passive: false });\n\n// --- FUNCTIONS FOR SPECIAL MODES ---\n\nfunction attachGridEventListeners() {\n    // Attach drag & drop listeners to the main grid container\n    if (dom.gameGrid) {\n        // Remove existing listeners first to prevent duplicates\n        dom.gameGrid.removeEventListener('dragover', handleDragOver);\n        dom.gameGrid.removeEventListener('drop', handleDrop);\n        dom.gameGrid.removeEventListener('dragend', handleDragEnd);\n        \n        // Add drag & drop listeners\n        dom.gameGrid.addEventListener('dragover', handleDragOver);\n        dom.gameGrid.addEventListener('drop', handleDrop);\n        dom.gameGrid.addEventListener('dragend', handleDragEnd);\n    }\n    \n    // Add global dragend listener to handle drops outside the grid\n    document.removeEventListener('dragend', handleDragEnd);\n    document.addEventListener('dragend', handleDragEnd);\n    \n    // Add global mouseup listener as backup for desktop drag operations\n    document.removeEventListener('mouseup', handleDragEndFallback);\n    document.addEventListener('mouseup', handleDragEndFallback);\n    \n    // Attach click listeners to individual grid cells (for special modes)\n    const gridCells = document.querySelectorAll('.grid-cell');\n    gridCells.forEach(cell => {\n        // Remove existing listener first to prevent duplicates\n        cell.removeEventListener('click', handleGridCellClick);\n        cell.addEventListener('click', handleGridCellClick);\n    });\n}\n\nfunction handleGridCellClick(event) {\n    if (!gameState.specialModes.clearLineMode || !gameState.specialModes.isWaitingForSelection) return;\n    \n    // Find the actual grid-cell (could be .grid-cell-block that was clicked)\n    let cell = event.target;\n    if (!cell.classList.contains('grid-cell')) {\n        cell = cell.closest('.grid-cell');\n    }\n    \n    if (!cell || !cell.classList.contains('grid-cell')) {\n        return;\n    }\n    \n    const row = parseInt(cell.dataset.row);\n    const col = parseInt(cell.dataset.col);\n\n    // Save state for undo\n    logic.saveGameState();\n    gameState.clearLineTokens--;\n\n    // Pastro t gjitha qelizat n rresht dhe kolon\n    const clearedCells = [];\n    const clearedRows = [];\n    const clearedCols = [];\n    \n    // Check if entire row should be cleared\n    let shouldClearRow = false;\n    for (let c = 0; c < gameState.grid[0].length; c++) {\n        if (gameState.grid[row][c] !== 0) {\n            shouldClearRow = true;\n            break;\n        }\n    }\n    \n    // Check if entire column should be cleared\n    let shouldClearCol = false;\n    for (let r = 0; r < gameState.grid.length; r++) {\n        if (gameState.grid[r][col] !== 0) {\n            shouldClearCol = true;\n            break;\n        }\n    }\n\n    if (!shouldClearRow && !shouldClearCol) {\n        // Asgj pr t'u pastruar - kthe token-in dhe dil shpejt pa hedhur gabime\n        gameState.clearLineTokens++;\n        updateSpecialActionButtons();\n        showSpecialModeMessage('clearLine_cancel', 'Nuk ka linja t mbushura n kt qeliz.', 2000);\n        gameState.specialModes.clearLineMode = false;\n        gameState.specialModes.isWaitingForSelection = false;\n        render.clearLineHighlights();\n        return;\n    }\n    \n    // Mark rows/cols to clear; don't mutate grid now. We'll clear per-line in animation callbacks.\n    if (shouldClearRow) {\n        clearedRows.push(row);\n        for (let c = 0; c < gameState.grid[0].length; c++) {\n            if (gameState.grid[row][c] !== 0) {\n                clearedCells.push({ row, col: c, animationColor: 'rgba(198,140,83,1)' });\n            }\n        }\n    }\n    if (shouldClearCol) {\n        clearedCols.push(col);\n        for (let r = 0; r < gameState.grid.length; r++) {\n            if (gameState.grid[r][col] !== 0) {\n                if (!clearedCells.some(cell => cell.row === r && cell.col === col)) {\n                    clearedCells.push({ row: r, col, animationColor: 'rgba(198,140,83,1)' });\n                }\n            }\n        }\n    }\n\n    // Do NOT immediately update the grid DOM: keep previous visuals so the canvas\n    // animation can sample the filled cell colors and produce identical visuals\n    updateSpecialActionButtons();\n\n    // Use the new canvas animation system for clear line effect\n    if (clearedRows.length > 0 || clearedCols.length > 0) {\n        const clearResult = {\n            cellsToAnimate: clearedCells,\n            pointsEarned: 0, // No points for manual clear\n            comboCount: 1,\n            totalLinesCleared: clearedRows.length + clearedCols.length,\n            clearedRows: clearedRows,\n            clearedCols: clearedCols,\n            // Post animation hook will update DOM/UI once canvas completes\n            _postAnimation: () => {\n                render.updateGridDisplay();\n                updateSpecialActionButtons();\n            }\n        };\n        \n        // Use the same animation system as natural line clears\n        handleLineClearEffects(clearResult);\n    }\n\n    showSpecialModeMessage('clearLine_success', `Row ${row + 1} and Column ${col + 1} cleared!`, 2000);\n    audio.playClearSound(1);\n\n    // Reset clear line mode pas veprimit\n    gameState.specialModes.clearLineMode = false;\n    gameState.specialModes.isWaitingForSelection = false;\n    updateSpecialActionButtons();\n    render.clearLineHighlights();\n}\n\n// --- HELPER FUNCTIONS FOR SPECIAL MESSAGES ---\nfunction showSpecialModeMessage(type, message, autoHideDelay = null) {\n    // Creates or updates the special mode message\n    let messageElement = document.getElementById('specialModeMessage');\n    if (!messageElement) {\n        messageElement = document.createElement('div');\n        messageElement.id = 'specialModeMessage';\n        messageElement.className = 'special-mode-message';\n        document.body.appendChild(messageElement);\n    }\n    \n    // Clear any existing timeout\n    if (messageElement.hideTimeout) {\n        clearTimeout(messageElement.hideTimeout);\n        messageElement.hideTimeout = null;\n    }\n    \n    // Enhanced message mapping with better instructions\n    const englishMessages = {\n        rotate: 'ROTATE MODE: Click any piece to rotate it',\n        rotate_cancel: 'Rotate mode cancelled',\n        clearLine: 'CLEAR LINE MODE: Click any cell in a complete row/column to clear it',\n        clearLine_success: 'Line cleared successfully!',\n        clearLine_cancel: 'Clear line mode cancelled',\n        undo: 'Last move undone successfully!',\n        swap: 'All pieces swapped successfully!',\n        error: 'Action failed - please try again'\n    };\n    const displayMsg = message || englishMessages[type] || 'Special action activated';\n    \n    messageElement.textContent = displayMsg;\n    messageElement.className = `special-mode-message ${type}`;\n    messageElement.classList.remove('hidden');\n    \n    // Auto-hide if delay is specified\n    if (autoHideDelay) {\n        messageElement.hideTimeout = setTimeout(() => {\n            messageElement.classList.add('hidden');\n            messageElement.hideTimeout = null;\n        }, autoHideDelay);\n    }\n}\n\n// Eksporto funksionin globalisht pr prdorim n gameLogic.js\nwindow.showSpecialModeMessage = showSpecialModeMessage;\n\n// --- FUNCTIONS FOR GAME STATE MANAGEMENT ---\n// DELETED: Redundant undoLastMove, saveGameState, loadGameState, and other game logic functions.\n// All game logic has been centralized in `gameLogic.js` to avoid conflicts and bugs.\n// The event listeners in this file now correctly call functions from the `logic` module.\n\nfunction populateInitialPieces() {\n    const pieceShapes = [\n        [ // First shape\n            [1, 1, 1],\n            [0, 1, 0],\n            [0, 1, 0]\n        ],\n        [ // Second shape\n            [0, 2, 2],\n            [0, 2, 0],\n            [0, 2, 0]\n        ],\n        [ // Third shape\n            [3, 3, 0],\n            [0, 3, 3],\n            [0, 0, 0]\n        ],\n        [ // Fourth shape\n            [0, 4, 0],\n            [4, 4, 4],\n            [0, 0, 0]\n        ],\n        [ // Fifth shape\n            [5, 5, 5],\n            [5, 0, 0],\n            [0, 0, 0]\n        ],\n        [ // Sixth shape\n            [0, 0, 6],\n            [0, 6, 6],\n            [0, 6, 0]\n        ],\n        [ // Seventh shape\n            [7, 0, 0],\n            [7, 7, 7],\n            [0, 0, 0]\n        ]\n    ];\n\n    // Populate current pieces with random shapes from pieceShapes\n    gameState.currentPieces = gameState.currentPieces.map((piece, index) => {\n        const shapeIndex = index % pieceShapes.length;\n        return {\n            currentShape: pieceShapes[shapeIndex],\n            previousPosition: { row: -1, col: -1 },\n            isEmpty: false\n        };\n    });\n}\n\n// --- FUNCTIONS FOR REFILLING THE GAME WITH NEW PIECES ---\nfunction refillPieces() {\n    gameState.currentPieces = gameState.currentPieces.map(piece => {\n        if (piece.isEmpty) {\n            // Create a new piece with a random shape\n            const randomShapeIndex = Math.floor(Math.random() * gameState.availableShapes.length);\n            const newShape = gameState.availableShapes[randomShapeIndex];\n            return {\n                currentShape: newShape,\n                previousPosition: { row: -1, col: -1 },\n                isEmpty: false\n            };\n        }\n        return piece;\n    });\n}\n\n// --- FUNCTIONS FOR APPLYING THEMES ---\nfunction applyTheme(themeName) {\n    const root = document.documentElement;\n    root.className = ''; // Remove any existing class\n    root.classList.add(`theme-${themeName}`);\n}\n\n// --- FUNCTIONS FOR ROTATING A SPECIFIC PIECE ---\nfunction rotateSpecificPiece(pieceIndex) {\n    const piece = gameState.currentPieces[pieceIndex];\n    if (!piece || piece.isEmpty) return false;\n    \n    // Save state before rotation for undo\n    logic.saveGameState();\n    \n    // Rotate the piece shape in the correct direction\n    const newShape = piece.currentShape[0].map((val, index) => \n        piece.currentShape.map(row => row[index]).reverse()\n    );\n    \n    // Check if the new placement is valid\n    if (logic.isValidPlacement(newShape, piece.previousPosition.row, piece.previousPosition.col)) {\n        piece.currentShape = newShape;\n        render.updatePiecesDisplay();\n        return true;\n    } else {\n        // If rotation is not valid, revert to original shape\n        logic.undoLastMove();\n        return false;\n    }\n}\n\n// --- FUNCTIONS FOR PLAYING WITH SPECIAL CARDS ---\nfunction playCardEffect(cardName) {\n    switch(cardName) {\n        case 'doubleScore':\n            gameState.score *= 2;\n            render.updateScoreDisplay();\n            showSpecialModeMessage('score', 'Points doubled!', 2000);\n            break;\n        case 'resetGrid':\n            logic.saveGameState();\n            gameState.grid = logic.createEmptyGrid();\n            logic.clearAllCaches();\n            render.updateGridDisplay();\n            showSpecialModeMessage('grid', 'Grid reset!', 2000);\n            break;\n        case 'extraRotate':\n            gameState.rotateTokens++;\n            updateSpecialActionButtons();\n            showSpecialModeMessage('rotate', 'Extra rotate granted!', 2000);\n            break;\n        case 'swapPieces':\n            logic.saveGameState();\n            logic.populateInitialPieces();\n            render.updatePiecesDisplay();\n            showSpecialModeMessage('swap', 'Pieces swapped!', 2000);\n            break;\n        case 'clearLine': {\n            const randomRow = Math.floor(Math.random() * GRID_ROWS);\n            \n            if (logic.clearRowOrColumn(randomRow, true)) {\n                // Use animation system instead of direct updateGridDisplay\n                const clearResult = {\n                    clearedRows: [randomRow],\n                    clearedCols: [],\n                    totalLinesCleared: 1,\n                    comboCount: 1,\n                    pointsEarned: 100\n                };\n                handleLineClearEffects(clearResult, () => {\n                    showSpecialModeMessage('clearLine', `Row ${randomRow + 1} cleared!`, 2000);\n                });\n            }\n            break;\n        }\n        case 'horizontalClear': {\n            const randomRow = Math.floor(Math.random() * GRID_ROWS);\n            \n            if (logic.clearRowOrColumn(randomRow, true)) {\n                // Use animation system\n                const clearResult = {\n                    clearedRows: [randomRow],\n                    clearedCols: [],\n                    totalLinesCleared: 1,\n                    comboCount: 1,\n                    pointsEarned: 100\n                };\n                handleLineClearEffects(clearResult, () => {\n                    showSpecialModeMessage('clearLine', `Row ${randomRow + 1} cleared horizontally!`, 2000);\n                });\n            }\n            break;\n        }\n        case 'verticalClear': {\n            const randomCol = Math.floor(Math.random() * GRID_COLS);\n            \n            if (logic.clearRowOrColumn(randomCol, false)) {\n                // Use animation system\n                const clearResult = {\n                    clearedRows: [],\n                    clearedCols: [randomCol],\n                    totalLinesCleared: 1,\n                    comboCount: 1,\n                    pointsEarned: 100\n                };\n                handleLineClearEffects(clearResult, () => {\n                    showSpecialModeMessage('clearLine', `Column ${randomCol + 1} cleared vertically!`, 2000);\n                });\n            }\n            break;\n        }\n        case 'fullClear':\n            logic.saveGameState();\n            gameState.grid = logic.createEmptyGrid();\n            logic.clearAllCaches();\n            render.updateGridDisplay();\n            showSpecialModeMessage('clearLine', 'Entire grid cleared!', 2000);\n            break;\n        case 'rowShift': {\n            const randomCol = Math.floor(Math.random() * GRID_COLS);\n            const direction = Math.random() < 0.5 ? 1 : -1;\n            logic.saveGameState();\n            if (logic.shiftColumn(randomCol, direction)) {\n                render.updateGridDisplay();\n                showSpecialModeMessage('shift', `Column ${randomCol + 1} shifted ${direction === 1 ? 'up' : 'down'}!`, 2000);\n            }\n            break;\n        }\n        default:\n            break;\n    }\n}\n\n/**\n * Comprehensive cleanup function to remove all event listeners and DOM elements\n * Call this when restarting the game or when the page is about to unload\n */\nfunction cleanupGameResources() {\n    // Clean up touch listeners\n    cleanupTouchListeners();\n    \n    // Clean up global drag listeners\n    document.removeEventListener('dragend', handleDragEnd);\n    document.removeEventListener('mouseup', handleDragEndFallback);\n    document.removeEventListener('mousemove', handleMouseMove);\n    document.removeEventListener('mouseup', handleMouseUp);\n    window.removeEventListener('mouseup', handleMouseUp);\n    document.removeEventListener('mouseleave', handleMouseUp);\n    if ('onpointerup' in window) {\n        document.removeEventListener('pointerup', handleMouseUp);\n    }\n    \n    // Clean up any remaining particles\n    if (typeof render.cleanupOldParticles === 'function') {\n        render.cleanupOldParticles();\n    }\n    \n    // Clean up floating score elements\n    if (typeof render.cleanupOldFloatingScores === 'function') {\n        render.cleanupOldFloatingScores();\n    }\n    \n    // Clean up any remaining floating score elements manually\n    document.querySelectorAll('.floating-score').forEach(element => {\n        element.remove();\n    });\n    \n    // Clean up unlock progress indicator\n    const unlockProgress = document.getElementById('unlock-progress');\n    if (unlockProgress) {\n        unlockProgress.remove();\n    }\n    \n    // Clean up highlights and visual states\n    render.clearHighlights();\n    render.clearLineHighlights();\n    \n    // Reset listener attachment tracking\n    listenersAttached = false;\n    \n    // Reset drag state completely\n    if (gameState.dragState) {\n        resetDragState();\n    }\n}\n\n// Clean up resources when page unloads\nwindow.addEventListener('beforeunload', cleanupGameResources);\n\n// Track if listeners are already attached to prevent duplicate attachments\nlet listenersAttached = false;\ndocument.addEventListener('lines:cleared', () => import('./nativeBridge.js').then(m=>m.hapticSuccess&&m.hapticSuccess()).catch(()=>{}));\ndocument.addEventListener('combo:achieved', e => import('./nativeBridge.js').then(m=>{ if(e.detail?.lines>=3 && m.hapticHeavy) m.hapticHeavy(); else if(m.hapticSuccess) m.hapticSuccess(); }).catch(()=>{}));\ndocument.addEventListener('game:over', () => import('./nativeBridge.js').then(m=>m.hapticHeavy&&m.hapticHeavy()).catch(()=>{}));\n\n// DEBUG: Log dimensionet e .game-container n desktop\nwindow.addEventListener('DOMContentLoaded', () => {\n  if (window.innerWidth >= 900) {\n    const gc = document.querySelector('.game-container');\n    if (gc) {\n      const rect = gc.getBoundingClientRect();\n      // Debug logs removed for production\n    }\n  }\n});\n\n// Handle responsive CSS reload when viewport crosses breakpoints (for DevTools testing)\nlet lastBreakpoint = window.innerWidth <= 768 ? 'mobile' : 'desktop';\nlet resizeDebounce;\n\nwindow.addEventListener('resize', () => {\n    clearTimeout(resizeDebounce);\n    resizeDebounce = setTimeout(() => {\n        const currentBreakpoint = window.innerWidth <= 768 ? 'mobile' : 'desktop';\n        \n        if (currentBreakpoint !== lastBreakpoint) {\n            // Breakpoint changed - force CSS re-evaluation\n            const mobileCssLink = document.querySelector('link[href*=\"mobile.css\"]');\n            const desktopCssLink = document.querySelector('link[href*=\"desktop.css\"]');\n            \n            if (currentBreakpoint === 'mobile' && mobileCssLink) {\n                // Force mobile.css to re-apply by toggling media attribute\n                mobileCssLink.media = 'all';\n                setTimeout(() => mobileCssLink.media = '(max-width:768px)', 0);\n            } else if (currentBreakpoint === 'desktop' && desktopCssLink) {\n                // Force desktop.css to re-apply\n                desktopCssLink.media = 'all';\n                setTimeout(() => desktopCssLink.media = '(min-width:769px)', 0);\n            }\n            \n            // Force layout recalculation\n            requestAnimationFrame(() => {\n                const gameContainer = document.querySelector('.game-container');\n                const gameArea = document.querySelector('.game-area');\n                const gameGrid = document.getElementById('gameGrid');\n                \n                [gameContainer, gameArea, gameGrid].forEach(el => {\n                    if (el) void el.offsetHeight;\n                });\n            });\n            \n            lastBreakpoint = currentBreakpoint;\n        }\n    }, 300);\n});\n"],"file":"assets/main-B_dPMwCp.js"}