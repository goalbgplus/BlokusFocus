{"version":3,"mappings":"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","names":["LOG_DRAG","COLORS","styled","text","color","log","label","message","data","prefix","style","logDragStart","pieceId","startX","startY","gridPosition","logDragMove","currentX","currentY","gridCell","isValid","logPlacementValid","row","col","cellsFilled","logLineCleared","lines","cellsCleared","logScoreAdded","points","reason","logGameOver","finalScore","piecesUsed","logPerformanceStart","operation","logPerformanceEnd","duration","logWarning","details","logGameStateSnapshot","state","_gameStartLogged","logGameStart","resetGameStartFlag","logGameMode","mode","GRID_ROWS","GRID_COLS","INVALID_PLACEMENT_SHAKE_DURATION","PIECE_SHAPES","createEmptyGrid","rows","cols","getDefaultDragState","gameState","fillRandomBlocks","grid","ratio","total","toFill","filled","r","c","resetCombo","resetDragState","setScore","newScore","setHighScore","newHighScore","initializeState","currentHighScore","AIHintEngine","piece","currentGrid","context","userPreferences","strategicSituations","hints","weightedHints","optimizedHints","occupiedCells","fragmentationLevel","riskLevel","opportunityScore","playHistory","shape","analysis","futureGrid","spaceOptimization","flexibilityScore","comboAnalysis","riskAreas","defenseScore","riskAnalysis","hint","adjustedScore","neuralWeights","features","mlScore","count","b","typesSeen","diverseHints","remaining","h","presentedHints","chosenHint","outcome","occupied","fragments","nr","nc","occupancy","fragmentation","opportunities","emptyCells","cell","opportunity","score","confidence","reasoning","futureOpportunities","testGrid","completedLines","almostComplete","efficiency","benefits","sr","sc","gridRow","gridCol","completed","columnComplete","currentLines","potentialCombos","surroundingOccupied","reliability","explanation","mitigatedRisks","risk","area","critical","currentRisk","newRisk","riskReduction","weights","typeWeight","hintType","recentMoves","move","PieceUnlockSystem","currentScore","newUnlocks","tiers","tier","tierNames","tierEmojis","groupedByTier","unlock","pieces","p","notification","audio","milestones","milestone","unlockedCount","percentage","nextUnlock","pieceUnlockSystem","domCache","placementCache","clearRowOrColumn","index","isRow","shiftColumn","columnIndex","direction","normalizedDirection","values","first","last","clearAllCaches","clearDOMCache","isInBounds","getRandomPiece","availablePieces","rotatePiece","randomIndex","selectedPiece","i","populateInitialPieces","replaceUsedPiece","pieceData","minR","maxR","minC","height","newShape","newMinR","newMinC","normalizedShape","flipPieceHorizontally","maxC","width","isValidPlacement","pieceShape","startRow","startCol","placePieceOnGrid","checkAndClearLines","placedPieceColor","clearedRows","clearedCols","isColFull","totalLinesCleared","animationColor","getBaseColor","clearedCellsSet","cellsToAnimate","str","pointsEarned","calculateLineClearScore","result","combo","baseScore","comboBonus","updateGameOverState","activePieces","canPieceBePlaced","rot","saveGameState","currentState","undoLastMove","previousState","isLineComplete","getLineCells","cells","rotateSpecificPiece","pieceIndex","colorNumber","findValidPlacements","validPlacements","findBestPlacements","shapeKey","gridChecksum","calculateGridChecksum","cacheKey","allValidPlacements","scoredPlacements","placement","calculatePlacementScore","a","bestPlacements","hash","completionBonus","calculateCompletionPotential","adjacencyBonus","calculateAdjacencyBonus","potential","occupiedRows","occupiedCols","filledCells","fillPercentage","adjacentCount","dr","dc","checkRow","checkCol","audioContext","isAudioInitialized","initAudioContext","playTone","frequency","volume","type","allowWhenInactive","oscillator","gainNode","playHapticFeedback","playPlaceSound","playClearSound","numLines","playGameOverSound","playRotateSound","playUIButtonSound","playPauseSound","playResumeSound","playRestartSound","playPieceAppearSound","AnimationPool","size","item","animPool","dom","cellElements","highlightedCells","lastPieceColor","PIECE_ANIMATION_DURATION","cacheDOMElements","id","createUnlockProgressIndicator","existingProgress","progressDiv","onClickOutside","e","cleanup","autoDismissId","updateUnlockProgress","createGridDOM","rowElements","blockWrapper","createPieceElement","pieceElement","pieceGrid","createPieceGridElement","maxRow","maxCol","visualGrid","block","hasPieceChanged","existingElement","newPieceData","shouldBeEmpty","isCurrentlyEmpty","existingId","nextId","animatePieceEntry","isInitialLoad","allowSound","delay","audio.playPieceAppearSound","rebuildPiecesContainer","animateAll","updateGridDisplay","updates","cellValue","cellElement","needsCreation","newClass","clearPlacementFlag","animatePlacement","centerR","centerC","cellsWithDelay","obj","distance","_a","jitter","finalDelay","updatePiecesDisplay","renderedPieces","nextPieces","changedIndices","soundPlayed","newElement","reference","updateScoreDisplay","scoreEl","progressInfo","progressFill","progressText","nextUnlockText","updateOverlays","showGameOver","playAgainBtn","newBtn","__vitePreload","gameLogic","logic","main","err","updateControlButtons","showComboMessage","comboCount","comboMsg","cleanupOldFloatingScores","floatingScores","now","maxAge","element","created","createDraggedPieceClone","blockSize","cloneBlock","gap","cloneGrid","computed","gapValue","parsedGap","cloneStyle","paddingX","paddingY","hideDraggedPieceClone","shakeDraggedPieceClone","updateDraggedPiecePosition","clientX","clientY","offsetX","offsetY","metricsCached","cloneWidth","cloneHeight","measuredBlockSize","measuredGap","measuredPaddingX","measuredPaddingY","measuredWidth","measuredHeight","anchorXInClone","anchorYInClone","rawLeft","rawTop","clearHighlights","showGhostAndHighlight","highlightClass","cls","highlightClearableLines","clearLineHighlights","cleanupOldParticles","particles","particle","timeoutId","__perfLite","createMagicStars","container","colors","star","createSpecialShapes","createSparkles","sparkle","activateMagicUniverseBackground","bgContainer","__pb","__rb","applyStatusBar","theme","S","_b","t","initDebugOverlay","n","o","s","isNative","readyNativeUI","attachAppLifecycle","A","isActive","ev","hapticTap","H","hapticSuccess","hapticHeavy","LOGIC_DELAY_MS","VISUAL_CLEANUP_DELAY_MS","getFrameColor","dominantColor","isDarkTheme","baseColor","brightness","getColorBrightness","lightenPercent","lightenColor","extractCellColors","rowOrColIndex","pieceColor","colorCount","idx","filledClass","maxCount","defaults","hex","percent","num","g","getGridCellBorderRadius","gameGrid","fallbackVar","fallback","sampleCell","triggerGameAreaShake","normalCls","strongCls","useStrong","onAnimEnd","playGalaxyRowClear","rowIndex","gameAreaParent","onComplete","createClearBar","animatedBlocks","blockCount","shakeDuration","isStrong","target","playGalaxyColClear","colIndex","createClearBarColumn","parentRect","gridStyle","firstCellRect","targetCellIndex","topInParent","leftInParent","barWidth","barBorderRadius","barContainer","inner","particleCount","isMobile","isLowEnd","frameColor","baseSize","left","dur","dxStart","dyStart","dxEnd","dyEnd","gameAreaRect","targetCellRect","lastCellRect","barHeight","top","LINE_DELAY","OVERLAY_HOST_ID","overlayHostElement","ensureOverlayHost","host","alignOverlayHost","gridRect","overlay","hostRect","animateLineClearSpectra","ctx","boardSize","onClearRow","onClearCol","onDone","syncStart","metrics","computeGridMetrics","tasks","order","line","buildRowData","resolve","runRowAnimation","buildColData","runColAnimation","totalRows","x","y","cellCenter","createCellOverlay","particleEngine","onLogicalClear","onResolved","gameArea","cleanupLineOverlays","canvas","cellW","cellH","overlayHost","rect","colorDark1","colorDark2","colorCoreLight","colorCoreMid","colorBevelLight","colorBevelDark","borderRadius","cleanupOverlayHostIfEmpty","parent","initMain","boot","initializeSettings","initializeGame","initializeLandingPageEffects","selectedGameMode","whenDomReady","callback","specialActionListenersAttached","legacyLandingSetupDone","updateLandingPageStats","highScoreEl","savedHighScore","piecesUnlockedEl","unlockedPieces","achievementsEl","achievements","logger.resetGameStartFlag","logger.logGameStart","cleanupGameResources","gameContainer","render.cacheDOMElements","listenersAttached","togglePause","addNeonClickEffect","handleRestart","render.createGridDOM","logger.logGameMode","logic.populateInitialPieces","logger.logPerformanceStart","landingPage","render.createUnlockProgressIndicator","render.updateGridDisplay","render.updatePiecesDisplay","render.updateScoreDisplay","render.updateControlButtons","updateSpecialActionButtons","attachPieceEventListeners","attachGridEventListeners","logger.logPerformanceEnd","button","audio.playUIButtonSound","themeToggleLanding","btn","audio.playPauseSound","audio.playResumeSound","logger.logGameStateSnapshot","logger.log","audio.playRestartSound","handlePieceClick","event","logic.rotateSpecificPiece","audio.playRotateSound","showSpecialModeMessage","flipped","logic.flipPieceHorizontally","__lastMouseEvent","__mouseRAF","handleMouseMove","render.updateDraggedPiecePosition","dx","dy","_handleMouseMoveInner","pos","getCellFromPoint","render.clearHighlights","logic.isValidPlacement","logger.LOG_DRAG","logger.logDragMove","render.showGhostAndHighlight","handleMouseUp","finishDrag","lastTargetRow","lastTargetCol","processSuccessfulPlacement","processFailedPlacement","cacheGridMetrics","cellSize","probe","cs","padL","padT","bordL","bordT","step","gridLeft","gridTop","gridWidth","gridHeight","handleDragStart","audio.initAudioContext","audio.playHapticFeedback","logger.logDragStart","pieceRect","clickXInPiece","clickYInPiece","closestBlock","blockRect","blockCenterX","blockCenterY","render.createDraggedPieceClone","handleDragOver","handleDrop","handleDragEnd","handleDragEndFallback","cleanupTouchListeners","__dragRAF","handleTouchMove","handleTouchEnd","__lastTouchEvent","touch","_handleTouchMoveInner","handleTouchStart","touchXInPiece","touchYInPiece","TOUCH_OFFSET_Y","logger.logPlacementValid","logic.saveGameState","logic.placePieceOnGrid","audio.playPlaceSound","logic.replaceUsedPiece","clearResult","logic.checkAndClearLines","totalLines","logger.logLineCleared","logger.logScoreAdded","handleLineClearEffects","logic.updateGameOverState","audio.playGameOverSound","logger.logGameOver","render.updateOverlays","checkSpecialRewards","logger.logWarning","render.shakeDraggedPieceClone","render.hideDraggedPieceClone","render.animatePlacement","render.clearPlacementFlag","audio.playClearSound","visualPieceColor","firstAnim","render.showComboMessage","rotateBtn","undoBtn","clearLineBtn","flipBtn","rotateCountEl","undoCountEl","clearLineCountEl","flipCountEl","setupSpecialActionButtons","handleRotateAction","handleUndoAction","logic.undoLastMove","handleClearLineAction","activating","render.highlightClearableLines","render.clearLineHighlights","handleFlipAction","legacyRotateBtn","fabRotateBtn","legacyUndoBtn","fabUndoBtn","legacyClearLineBtn","fabClearLineBtn","legacyFlipBtn","fabFlipBtn","handleDelegatedPieceClick","syntheticEvent","handleDelegatedPieceTouch","piecesContainer","shouldDisableDrag","setupLegacyLandingFlow","render.dom","classicModeCard","collectionModeCard","feedbackElement","selectGameMode","card","savedMode","specialActions","handleGridCellClick","clearedCells","shouldClearRow","shouldClearCol","autoHideDelay","messageElement","displayMsg","render.cleanupOldParticles","render.cleanupOldFloatingScores","unlockProgress","nativeBridge","m","gc","lastBreakpoint","resizeDebounce","currentBreakpoint","mobileCssLink","desktopCssLink","el"],"ignoreList":[],"sources":["../../js/logger.js","../../js/constants.js","../../js/state.js","../../js/aiHints.js","../../js/pieceUnlockSystem.js","../../js/gameLogic.js","../../js/audio.js","../../js/render.js","../../js/backgroundEffects.js","../../js/statusBarTheme.js","../../js/debugOverlay.js","../../js/nativeBridge.js","../../js/animationAdapters/galaxyRowClear.js","../../js/rowClearSpectra.js","../../js/main.js"],"sourcesContent":["/**\r\n * Game Logger - Monitors all important game events and state changes\r\n * Useful for debugging, performance analysis, and understanding game flow\r\n */\r\n\r\n// Enable/disable logging globally\r\nexport const LOG_ENABLED = true;\r\nexport const LOG_DRAG = true;\r\nexport const LOG_PLACEMENT = true;\r\nexport const LOG_SCORE = true;\r\nexport const LOG_PERFORMANCE = true;\r\nexport const LOG_GRID = true;\r\nexport const LOG_ERRORS = true;\r\n\r\n// Color coding for console\r\nconst COLORS = {\r\n    DRAG: '#FF6B6B',      // Red\r\n    PLACEMENT: '#4ECDC4', // Teal\r\n    SCORE: '#FFE66D',     // Yellow\r\n    PERF: '#95E1D3',      // Mint\r\n    GRID: '#A8D8EA',      // Light Blue\r\n    ERROR: '#FF4444',     // Dark Red\r\n    SUCCESS: '#66BB6A',   // Green\r\n    INFO: '#90CAF9'       // Bright Blue\r\n};\r\n\r\nfunction styled(text, color) {\r\n    return `%c${text}`;\r\n}\r\n\r\nexport function log(label, message, color, data = null) {\r\n    if (!LOG_ENABLED) return;\r\n    \r\n    const timestamp = new Date().toLocaleTimeString('en-US', { \r\n        hour12: false, \r\n        hour: '2-digit', \r\n        minute: '2-digit', \r\n        second: '2-digit',\r\n        fractionalSecondDigits: 3\r\n    });\r\n    \r\n    const prefix = `[${timestamp}] ${label}`;\r\n    const style = `color: ${color}; font-weight: bold; font-size: 12px;`;\r\n    \r\n    if (data) {\r\n        console.log(styled(prefix, color), style, message, data);\r\n    } else {\r\n        console.log(styled(prefix, color), style, message);\r\n    }\r\n}\r\n\r\n// ============= DRAG & DROP LOGGING =============\r\nexport function logDragStart(pieceId, startX, startY, gridPosition) {\r\n    if (!LOG_DRAG) return;\r\n    log('DRAG START', `Piece #${pieceId} from (${startX}, ${startY})`, COLORS.DRAG, { gridPosition });\r\n}\r\n\r\nexport function logDragMove(pieceId, currentX, currentY, gridCell, isValid) {\r\n    if (!LOG_DRAG) return;\r\n    const status = isValid ? ' VALID' : ' INVALID';\r\n    log('DRAG MOVE', `${status} - Piece #${pieceId}  Cell (${gridCell.row}, ${gridCell.col})`, \r\n        isValid ? COLORS.SUCCESS : '#FF9800', \r\n        { pos: `${currentX},${currentY}` });\r\n}\r\n\r\nexport function logDragEnd(pieceId, gridCell, isPlaced) {\r\n    if (!LOG_DRAG) return;\r\n    const result = isPlaced ? ' PLACED' : ' CANCELED';\r\n    log('DRAG END', `${result} - Piece #${pieceId}`, \r\n        isPlaced ? COLORS.SUCCESS : '#FF9800');\r\n}\r\n\r\n// ============= PLACEMENT LOGGING =============\r\nexport function logPlacementAttempt(pieceId, row, col, rotations) {\r\n    if (!LOG_PLACEMENT) return;\r\n    log('PLACEMENT', `Attempting piece #${pieceId} at (${row}, ${col}) [${rotations} rotations]`, \r\n        COLORS.PLACEMENT);\r\n}\r\n\r\nexport function logPlacementValid(pieceId, row, col, cellsFilled) {\r\n    if (!LOG_PLACEMENT) return;\r\n    log('PLACEMENT ', `Valid placement - Piece #${pieceId} fills ${cellsFilled} cells`, \r\n        COLORS.SUCCESS, { position: `(${row}, ${col})` });\r\n}\r\n\r\nexport function logPlacementInvalid(pieceId, row, col, reason) {\r\n    if (!LOG_PLACEMENT) return;\r\n    log('PLACEMENT ', `Invalid - ${reason}`, '#FF9800', \r\n        { piece: pieceId, position: `(${row}, ${col})` });\r\n}\r\n\r\nexport function logLineCleared(lines, cellsCleared) {\r\n    if (!LOG_PLACEMENT) return;\r\n    log('LINE CLEAR', `${lines.length} line(s) cleared! ${cellsCleared} cells freed`, \r\n        COLORS.SUCCESS, { lines: lines.join(', ') });\r\n}\r\n\r\n// ============= SCORE LOGGING =============\r\nexport function logScoreAdded(points, reason) {\r\n    if (!LOG_SCORE) return;\r\n    log('SCORE +', `+${points} points (${reason})`, COLORS.SCORE, { totalAfter: 'see game state' });\r\n}\r\n\r\nexport function logCombo(multiplier, totalBonus) {\r\n    if (!LOG_SCORE) return;\r\n    log('COMBO!', `${multiplier}x multiplier! +${totalBonus} bonus`, \r\n        COLORS.SUCCESS, { multiplier });\r\n}\r\n\r\nexport function logGameOver(finalScore, piecesUsed) {\r\n    if (!LOG_SCORE) return;\r\n    log('GAME OVER', `Final Score: ${finalScore} (${piecesUsed} pieces used)`, \r\n        '#FF4444', { finalScore, piecesUsed });\r\n}\r\n\r\n// ============= PERFORMANCE LOGGING =============\r\nexport function logPerformanceStart(operation) {\r\n    if (!LOG_PERFORMANCE) return;\r\n    performance.mark(`${operation}-start`);\r\n}\r\n\r\nexport function logPerformanceEnd(operation) {\r\n    if (!LOG_PERFORMANCE) return;\r\n    try {\r\n        performance.mark(`${operation}-end`);\r\n        performance.measure(operation, `${operation}-start`, `${operation}-end`);\r\n        const measure = performance.getEntriesByName(operation)[0];\r\n        const duration = measure.duration.toFixed(2);\r\n        \r\n        const color = duration > 16 ? '#FF6B6B' : COLORS.PERF;\r\n        log('PERF', `${operation}: ${duration}ms`, color);\r\n        \r\n        performance.clearMarks(`${operation}-start`);\r\n        performance.clearMarks(`${operation}-end`);\r\n        performance.clearMeasures(operation);\r\n    } catch (e) {\r\n        console.warn('Performance measurement failed:', e);\r\n    }\r\n}\r\n\r\n// ============= GRID STATE LOGGING =============\r\nexport function logGridState(gridData, emptyCount) {\r\n    if (!LOG_GRID) return;\r\n    log('GRID STATE', `${emptyCount} empty cells remaining`, COLORS.GRID, \r\n        { occupied: (100 - emptyCount), coverage: `${((100-emptyCount)/100*100).toFixed(1)}%` });\r\n}\r\n\r\nexport function logAvailableMoves(moveCount) {\r\n    if (!LOG_GRID) return;\r\n    const status = moveCount > 0 ? ` ${moveCount} moves` : ' NO MOVES';\r\n    log('MOVES', status, moveCount > 0 ? COLORS.SUCCESS : '#FF9800');\r\n}\r\n\r\nexport function logGridCellOccupied(row, col, pieceId) {\r\n    if (!LOG_GRID) return;\r\n    log('GRID CELL', `Cell (${row}, ${col}) occupied by piece #${pieceId}`, '#90CAF9');\r\n}\r\n\r\n// ============= ERROR LOGGING =============\r\nexport function logError(errorType, message, details = null) {\r\n    if (!LOG_ERRORS) return;\r\n    log('ERROR!', `${errorType}: ${message}`, COLORS.ERROR, details);\r\n    console.trace('Error stacktrace:');\r\n}\r\n\r\nexport function logWarning(message, details = null) {\r\n    if (!LOG_ERRORS) return;\r\n    log('WARNING', message, '#FFA500', details);\r\n}\r\n\r\n// ============= STATE LOGGING =============\r\nexport function logGameStateSnapshot(state) {\r\n    if (!LOG_ENABLED) return;\r\n    \r\n    console.group('%c GAME STATE SNAPSHOT', `color: ${COLORS.INFO}; font-weight: bold;`);\r\n    console.log('Score:', state.score);\r\n    console.log('High Score:', state.highScore);\r\n    console.log('Game Over:', state.isGameOver);\r\n    console.log('Paused:', state.isPaused);\r\n    console.log('Combo Multiplier:', state.currentComboMultiplier);\r\n    console.log('Grid Empty Cells:', state.gridEmptyCellCount);\r\n    console.log('Dragging:', state.dragState.isDragging);\r\n    console.groupEnd();\r\n}\r\n\r\nexport function logMoveHistory(moves) {\r\n    if (!LOG_ENABLED) return;\r\n    \r\n    console.group('%c MOVE HISTORY', `color: ${COLORS.INFO}; font-weight: bold;`);\r\n    moves.forEach((move, idx) => {\r\n        console.log(`${idx + 1}. Piece #${move.pieceId}  (${move.row}, ${move.col}) = +${move.pointsEarned}`);\r\n    });\r\n    console.groupEnd();\r\n}\r\n\r\n// ============= INITIALIZATION =============\r\nlet _gameStartLogged = false; // Prevent duplicate logging on resume\r\n\r\nexport function logGameStart() {\r\n    if (!LOG_ENABLED || _gameStartLogged) return;\r\n    _gameStartLogged = true; // Mark that we've logged start\r\n    // Note: console.clear() blocked by 'Preserve log' setting - using separator instead\r\n    console.log('%c' + '='.repeat(80), `color: ${COLORS.SUCCESS}; font-size: 11px;`);\r\n    console.log('%c BLOKUS GAME STARTED', `color: ${COLORS.SUCCESS}; font-size: 16px; font-weight: bold;`);\r\n    console.log('%cLogger enabled - monitoring all game events', `color: ${COLORS.INFO};`);\r\n}\r\n\r\nexport function resetGameStartFlag() {\r\n    _gameStartLogged = false; // Reset for next full game session\r\n}\r\n\r\nexport function logGameMode(mode) {\r\n    if (!LOG_ENABLED) return;\r\n    log('GAME MODE', `Mode: ${mode}`, COLORS.INFO);\r\n}\r\n\r\n// ============= DETAILED PERFORMANCE TIMING GUIDE =============\r\n/**\r\n * Guide for interpreting detailed performance timings\r\n * Use this to understand what console.time/timeEnd logs mean\r\n */\r\nexport function logPerformanceGuide() {\r\n    if (!LOG_ENABLED) return;\r\n    \r\n    console.group('%c DETAILED PERFORMANCE TIMING GUIDE', `color: ${COLORS.PERF}; font-weight: bold; font-size: 14px;`);\r\n    \r\n    console.log('%cPLACEMENT TIMINGS:', 'color: #FFE66D; font-weight: bold;');\r\n    console.log('   placement:save-state: Time to save game state for undo');\r\n    console.log('   placement:place-piece: Time to add piece to grid array');\r\n    console.log('   placement:replace-piece: Time to generate new random piece');\r\n    console.log('   placement:detect-lines: Time to scan for completed lines (CRITICAL)');\r\n    console.log('   placement:animate-lines: Time for line clear animation');\r\n    console.log('   placement:update-state: Time to update game state after clears');\r\n    console.log('   placement:finish-drag: Time to reset UI after placement');\r\n    console.log('   placement:finish-drag-no-clear: Same as above but without line clears');\r\n    \r\n    console.log('%cFINISH DRAG TIMINGS:', 'color: #FFE66D; font-weight: bold;');\r\n    console.log('   finishDrag:total: Total time for all cleanup and UI updates');\r\n    console.log('   finishDrag:hide-elements: Hide clone and highlights');\r\n    console.log('   finishDrag:reset-state: Reset drag state object');\r\n    console.log('   finishDrag:update-grid: Redraw entire game grid');\r\n    console.log('   finishDrag:animate-placement: Show placement animation');\r\n    console.log('   finishDrag:update-pieces: Refresh piece display and event listeners');\r\n    console.log('   finishDrag:update-ui: Update score, buttons, overlays');\r\n    \r\n    console.log('%cDRAG MOVEMENT TIMINGS (per frame):', 'color: #FFE66D; font-weight: bold;');\r\n    console.log('   drag:hit-test: Total time for hit-testing and validation');\r\n    console.log('   drag:validate-placement: Time to check if piece placement is valid');\r\n    console.log('   drag:highlight: Time to update ghost piece and highlights');\r\n    console.log('   touch:hit-test: Same as drag:hit-test but for touch events');\r\n    console.log('   touch:validate-placement: Same as drag:validate-placement but for touch');\r\n    console.log('   touch:highlight: Same as drag:highlight but for touch');\r\n    \r\n    console.log('%c PERFORMANCE TARGETS:', 'color: #66BB6A; font-weight: bold;');\r\n    console.log('   placement:detect-lines < 10ms (critical - runs on every placement)');\r\n    console.log('   drag:hit-test < 16ms (must complete in one frame)');\r\n    console.log('   finishDrag:total < 50ms (should be much faster)');\r\n    console.log('   drag:validate-placement < 5ms (bottleneck for smoothness)');\r\n    \r\n    console.groupEnd();\r\n}\r\n","// js/constants.js\r\n\r\n// --- Grid Dimensions ---\r\nexport const GRID_ROWS = 10;\r\nexport const GRID_COLS = 10;\r\n\r\n// --- Timing & Animations (in milliseconds) ---\r\nexport const COMBO_MESSAGE_DURATION = 1500;\r\nexport const GRID_CLEAR_ANIMATION_DELAY = 300;\r\nexport const GRID_RENDER_AFTER_CLEAR_DELAY = 400; // Duhet t jet > GRID_CLEAR_ANIMATION_DELAY\r\nexport const INVALID_PLACEMENT_SHAKE_DURATION = 400;\r\n\r\n// --- Piece Definitions ---\r\n// Pieces are now managed by PieceUnlockSystem\r\n// This maintains backward compatibility while allowing dynamic piece management\r\nexport const PIECE_SHAPES = [\r\n    { shape: [[0, 0]], color: 1, size: 1, name: '1x1' },\r\n    { shape: [[0, 0], [0, 1]], color: 2, size: 2, name: '1x2' },\r\n    { shape: [[0, 0], [1, 0]], color: 2, size: 2, name: '2x1' },\r\n    { shape: [[0, 0], [0, 1], [0, 2]], color: 3, size: 3, name: '1x3' },\r\n    { shape: [[0, 0], [1, 0], [2, 0]], color: 3, size: 3, name: '3x1' },\r\n    { shape: [[0, 0], [0, 1], [0, 2], [0, 3]], color: 4, size: 4, name: '1x4' },\r\n    { shape: [[0, 0], [1, 0], [2, 0], [3, 0]], color: 4, size: 4, name: '4x1' },\r\n    { shape: [[0, 0], [0, 1], [0, 2], [0, 3], [0, 4]], color: 5, size: 5, name: '1x5' },\r\n    { shape: [[0, 0], [1, 0], [2, 0], [3, 0], [4, 0]], color: 5, size: 5, name: '5x1' },\r\n    { shape: [[0, 0], [0, 1], [1, 0], [1, 1]], color: 6, size: 4, name: '2x2' },\r\n    { shape: [[0,0],[0,1],[0,2],[1,0],[1,1],[1,2],[2,0],[2,1],[2,2]], color: 7, size: 9, name: '3x3'},\r\n    { shape: [[0, 0], [1, 0], [2, 0], [2, 1]], color: 1, size: 4, name: 'L4_1' },\r\n    { shape: [[0, 0], [1, 0], [0, 1], [0, 2]], color: 1, size: 4, name: 'L4_2' },\r\n    { shape: [[0, 1], [1, 0], [1, 1], [1, 2]], color: 2, size: 4, name: 'T4' },\r\n    { shape: [[0, 0], [0, 1], [1, 1], [1, 2]], color: 3, size: 4, name: 'Z4' },\r\n    { shape: [[0, 1], [1, 0], [1, 1], [2, 0]], color: 3, size: 4, name: 'Z4_vert' }\r\n];\r\n\r\n// --- Theming ---\r\n","// State structure for the game. Comments cleaned for clarity.\r\n\r\nimport { GRID_ROWS, GRID_COLS } from './constants.js';\r\n\r\nexport function createEmptyGrid(rows = GRID_ROWS, cols = GRID_COLS) {\r\n    return Array.from({ length: rows }, () => Array(cols).fill(0));\r\n}\r\n\r\nfunction getDefaultDragState() {\r\n    return {\r\n        isDragging: false,\r\n        pieceIndex: -1,\r\n        pieceSourceElement: null,\r\n        offsetX: 0,\r\n        offsetY: 0,\r\n        touchIdentifier: null,\r\n    touchOffsetY: 0,\r\n        lastTargetRow: undefined,\r\n        lastTargetCol: undefined,\r\n        blockSize: 30,\r\n        gap: 0,\r\n        paddingX: 0,\r\n        paddingY: 0,\r\n        metricsCached: false,\r\n        cloneWidth: 80,\r\n        cloneHeight: 80,\r\n        startX: 0,\r\n        startY: 0,\r\n        startTime: 0,\r\n        hasMoved: false,\r\n        // Grid metrics caching for performance optimization (used in getCellFromPoint)\r\n        gridMetricsCached: false,\r\n        gridRect: { left: 0, top: 0 },\r\n        cellSize: 0,\r\n        step: 0,\r\n        gridPadL: 0,\r\n        gridPadT: 0,\r\n        gridBordL: 0,\r\n        gridBordT: 0,\r\n    };\r\n}\r\n\r\n// Objekti kryesor i gjendjes\r\nexport const gameState = {\r\n    grid: [],\r\n    score: 0,\r\n    highScore: 0,\r\n    isGameOver: false,\r\n    isPaused: false,\r\n    currentPieces: [],\r\n    combo: {\r\n        count: 0,\r\n        timeoutId: null\r\n    },\r\n    dragState: getDefaultDragState(),\r\n    rotateTokens: 0,\r\n    undoTokens: 0,\r\n    clearLineTokens: 0,\r\n    flipTokens: 0,\r\n    swapTokens: 0,\r\n    // Cells of the most recently placed piece for animation\r\n    lastPlacementCells: [],\r\n    // Shtuar pr veprime speciale\r\n    gameHistory: [], // Pr undo functionality\r\n    specialModes: {\r\n        rotateMode: false,\r\n        undoMode: false, // Player can undo one move\r\n        clearLineMode: false,\r\n        flipMode: false, // Player can flip piece 180\r\n        isWaitingForRotate: false,\r\n        isWaitingForFlip: false\r\n    }\r\n};\r\n\r\n/**\r\n * Mbush nj prqindje t caktuar t fushs me blloqe rastsore\r\n * @param {array} grid - matrica e lojs\r\n * @param {number} ratio - prqindja (0-1) e blloqeve fillestare\r\n */\r\nfunction fillRandomBlocks(grid, ratio) {\r\n    const rows = grid.length;\r\n    const cols = grid[0].length;\r\n    const total = rows * cols;\r\n    const toFill = Math.floor(total * ratio);\r\n    let filled = 0;\r\n    while (filled < toFill) {\r\n        const r = Math.floor(Math.random() * rows);\r\n        const c = Math.floor(Math.random() * cols);\r\n        if (grid[r][c] === 0) {\r\n            // vendos ngjyr rastsore 1-7\r\n            grid[r][c] = Math.ceil(Math.random() * 7);\r\n            filled++;\r\n        }\r\n    }\r\n}\r\n\r\n// Funksion ndihms pr t resetuar combo\r\nexport function resetCombo() {\r\n    if (gameState.combo.timeoutId) {\r\n        clearTimeout(gameState.combo.timeoutId);\r\n    }\r\n    gameState.combo.count = 0;\r\n    gameState.combo.timeoutId = null;\r\n}\r\n\r\n// Funksion ndihms pr t resetuar dragState\r\nexport function resetDragState() {\r\n    gameState.dragState = getDefaultDragState();\r\n}\r\n\r\n// Funksion pr t vendosur pikt\r\nexport function setScore(newScore) {\r\n    gameState.score = newScore;\r\n}\r\n\r\n// Funksion pr t vendosur highScore\r\nexport function setHighScore(newHighScore) {\r\n    gameState.highScore = newHighScore;\r\n}\r\n\r\n// Funksion pr t inicializuar ose resetuar gjendjen e lojs\r\nexport function initializeState() {\r\n    // Ruaj high score, reset-o gjithka tjetr\r\n    const currentHighScore = localStorage.getItem('blokusHighScore') ? parseInt(localStorage.getItem('blokusHighScore')) : 0;\r\n\r\n    gameState.grid = createEmptyGrid();\r\n    setScore(0);\r\n    setHighScore(currentHighScore);\r\n    gameState.isGameOver = false;\r\n    gameState.isPaused = false;\r\n    gameState.currentPieces = [];\r\n    resetCombo();\r\n    resetDragState();\r\n    \r\n    // Reset special action states\r\n    gameState.gameHistory = [];\r\n    gameState.specialModes = {\r\n        rotateMode: false,\r\n        undoMode: false, // Player can undo one move\r\n        clearLineMode: false,\r\n        flipMode: false, // Player can flip piece 180\r\n        isWaitingForRotate: false,\r\n        isWaitingForFlip: false\r\n    };\r\n    \r\n    // N Classic Mode, mbush rastsisht nj prqindje t fushs me blloqe parazgjedhje\r\n    const selectedMode = localStorage.getItem('selectedGameMode') || 'collection';\r\n    if (selectedMode === 'classic') {\r\n        fillRandomBlocks(gameState.grid, 0.2);\r\n    }\r\n    // Starting tokens for all players (mobile, desktop, production)\r\n    // Players earn additional tokens during gameplay as rewards\r\n    // Every 1000 points = 1 rotate token\r\n    // Every 2000 points = 1 undo token\r\n    // Combo >= 4 = 1 clear line token\r\n    // Every 3000 points = 1 hint token\r\n    // Flip tokens are earned through special events/milestones\r\n    gameState.rotateTokens = 1;\r\n    gameState.undoTokens = 1;\r\n    gameState.clearLineTokens = 1;\r\n    gameState.flipTokens = 1;\r\n    gameState.swapTokens = 0;\r\n    // Reset placement animation cells\r\n    gameState.lastPlacementCells = [];\r\n}","// AI-Enhanced Hints System pr lojn Tetris/Blokus\r\n// Ky sistem analizon stilin e lojs s prdoruesit dhe jep hints inteligjente\r\n\r\nimport { gameState } from './state.js';\r\nimport { GRID_ROWS, GRID_COLS } from './constants.js';\r\n\r\n/**\r\n * AI-Powered Hint Engine q mson nga lojrat e prdoruesit\r\n */\r\nexport class AIHintEngine {\r\n    constructor() {\r\n        this.userPlayStyle = this.loadUserPlayStyle();\r\n        this.gameAnalytics = this.loadGameAnalytics();\r\n        this.learningData = this.loadLearningData();\r\n    }\r\n\r\n    /**\r\n     * Gjneron hints inteligjente bazuar n AI analysis\r\n     */\r\n    generateSmartHints(piece, currentGrid) {\r\n        const context = this.analyzeGameContext(currentGrid);\r\n        const userPreferences = this.analyzeUserPreferences();\r\n        const strategicSituations = this.identifyStrategicSituations(currentGrid);\r\n        \r\n        // Multi-layered analysis\r\n        const hints = [\r\n            ...this.analyzeLineCompletionPotential(piece, currentGrid),\r\n            ...this.analyzeFutureSpaceOptimization(piece, currentGrid),\r\n            ...this.analyzeComboSetupOpportunities(piece, currentGrid),\r\n            ...this.analyzeDefensivePositioning(piece, currentGrid),\r\n            ...this.analyzeRiskMitigation(piece, currentGrid)\r\n        ];\r\n\r\n        // AI Weight Application bazuar n user behavior\r\n        const weightedHints = this.applyAIWeights(hints, context, userPreferences);\r\n        \r\n        // Machine Learning Optimization\r\n        const optimizedHints = this.applyMLOptimization(weightedHints, strategicSituations);\r\n        \r\n        return this.selectBestHints(optimizedHints, 3);\r\n    }\r\n\r\n    /**\r\n     * Analizon kontekstin aktual t lojs\r\n     */\r\n    analyzeGameContext(grid) {\r\n        const occupiedCells = this.calculateOccupancy(grid);\r\n        const fragmentationLevel = this.calculateFragmentation(grid);\r\n        const riskLevel = this.calculateRiskLevel(grid);\r\n        const opportunityScore = this.calculateOpportunityScore(grid);\r\n        \r\n        return {\r\n            gamePhase: this.determineGamePhase(occupiedCells),\r\n            urgencyLevel: this.calculateUrgencyLevel(riskLevel, occupiedCells),\r\n            spaceEfficiency: this.calculateSpaceEfficiency(grid),\r\n            strategicPriority: this.determineStrategicPriority(fragmentationLevel, opportunityScore)\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Analizon preferencat e prdoruesit bazuar n historikun e lojrave\r\n     */\r\n    analyzeUserPreferences() {\r\n        const playHistory = this.userPlayStyle.recentMoves || [];\r\n        \r\n        return {\r\n            preferredStrategy: this.identifyPreferredStrategy(playHistory),\r\n            riskTolerance: this.calculateRiskTolerance(playHistory),\r\n            planningHorizon: this.calculatePlanningHorizon(playHistory),\r\n            efficiencyFocus: this.calculateEfficiencyFocus(playHistory)\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Advanced Line Completion Analysis me AI prediction\r\n     */\r\n    analyzeLineCompletionPotential(piece, grid) {\r\n        const hints = [];\r\n        const shape = piece.currentShape || piece.shape;\r\n        \r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            for (let c = 0; c < GRID_COLS; c++) {\r\n                if (this.isValidPlacement(shape, r, c, grid)) {\r\n                    const analysis = this.analyzeLinePotential(shape, r, c, grid);\r\n                    \r\n                    if (analysis.score > 0.6) { // Threshold pr hints t mir\r\n                        hints.push({\r\n                            row: r,\r\n                            col: c,\r\n                            type: 'line_completion',\r\n                            score: analysis.score,\r\n                            confidence: analysis.confidence,\r\n                            reasoning: analysis.reasoning,\r\n                            futureOpportunities: analysis.futureOpportunities\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        \r\n        return hints;\r\n    }\r\n\r\n    /**\r\n     * Future Space Optimization Analysis\r\n     */\r\n    analyzeFutureSpaceOptimization(piece, grid) {\r\n        const hints = [];\r\n        const shape = piece.currentShape || piece.shape;\r\n        \r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            for (let c = 0; c < GRID_COLS; c++) {\r\n                if (this.isValidPlacement(shape, r, c, grid)) {\r\n                    // Simulo vendosjen dhe analizoj t ardhmen\r\n                    const futureGrid = this.simulatePlacement(shape, r, c, grid);\r\n                    const spaceOptimization = this.calculateSpaceOptimization(futureGrid);\r\n                    const flexibilityScore = this.calculateFlexibilityScore(futureGrid);\r\n                    \r\n                    if (spaceOptimization.score > 0.7) {\r\n                        hints.push({\r\n                            row: r,\r\n                            col: c,\r\n                            type: 'space_optimization',\r\n                            score: spaceOptimization.score,\r\n                            confidence: flexibilityScore,\r\n                            reasoning: `Optimizes future space usage: ${spaceOptimization.benefits}`,\r\n                            futureFlexibility: flexibilityScore\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        \r\n        return hints;\r\n    }\r\n\r\n    /**\r\n     * Combo Setup Analysis me predictive modeling\r\n     */\r\n    analyzeComboSetupOpportunities(piece, grid) {\r\n        const hints = [];\r\n        const shape = piece.currentShape || piece.shape;\r\n        \r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            for (let c = 0; c < GRID_COLS; c++) {\r\n                if (this.isValidPlacement(shape, r, c, grid)) {\r\n                    const comboAnalysis = this.predictComboOpportunities(shape, r, c, grid);\r\n                    \r\n                    if (comboAnalysis.potentialCombos > 1) {\r\n                        hints.push({\r\n                            row: r,\r\n                            col: c,\r\n                            type: 'combo_setup',\r\n                            score: comboAnalysis.totalScore,\r\n                            confidence: comboAnalysis.confidence,\r\n                            reasoning: `Sets up ${comboAnalysis.potentialCombos}-line combo`,\r\n                            comboDetails: comboAnalysis.details\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        \r\n        return hints;\r\n    }\r\n\r\n    /**\r\n     * Defensive Positioning Analysis\r\n     */\r\n    analyzeDefensivePositioning(piece, grid) {\r\n        const hints = [];\r\n        const shape = piece.currentShape || piece.shape;\r\n        const riskAreas = this.identifyRiskAreas(grid);\r\n        \r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            for (let c = 0; c < GRID_COLS; c++) {\r\n                if (this.isValidPlacement(shape, r, c, grid)) {\r\n                    const defenseScore = this.calculateDefenseScore(shape, r, c, grid, riskAreas);\r\n                    \r\n                    if (defenseScore.score > 0.6) {\r\n                        hints.push({\r\n                            row: r,\r\n                            col: c,\r\n                            type: 'defensive',\r\n                            score: defenseScore.score,\r\n                            confidence: defenseScore.reliability,\r\n                            reasoning: defenseScore.explanation,\r\n                            riskMitigation: defenseScore.mitigatedRisks\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        \r\n        return hints;\r\n    }\r\n\r\n    /**\r\n     * Risk Mitigation Analysis\r\n     */\r\n    analyzeRiskMitigation(piece, grid) {\r\n        const hints = [];\r\n        const criticalAreas = this.identifyCriticalAreas(grid);\r\n        const shape = piece.currentShape || piece.shape;\r\n        \r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            for (let c = 0; c < GRID_COLS; c++) {\r\n                if (this.isValidPlacement(shape, r, c, grid)) {\r\n                    const riskAnalysis = this.analyzeGameOverRisk(shape, r, c, grid);\r\n                    \r\n                    if (riskAnalysis.riskReduction > 0.5) {\r\n                        hints.push({\r\n                            row: r,\r\n                            col: c,\r\n                            type: 'risk_mitigation',\r\n                            score: riskAnalysis.score,\r\n                            confidence: riskAnalysis.confidence,\r\n                            reasoning: `Reduces game over risk by ${Math.round(riskAnalysis.riskReduction * 100)}%`,\r\n                            riskFactors: riskAnalysis.factors\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        \r\n        return hints;\r\n    }\r\n\r\n    /**\r\n     * Aplikon pesha AI bazuar n kontekstin e lojs\r\n     */\r\n    applyAIWeights(hints, context, userPreferences) {\r\n        return hints.map(hint => {\r\n            let adjustedScore = hint.score;\r\n            \r\n            // Context-based weights\r\n            switch (context.gamePhase) {\r\n                case 'early':\r\n                    if (hint.type === 'space_optimization') adjustedScore *= 1.3;\r\n                    break;\r\n                case 'middle':\r\n                    if (hint.type === 'combo_setup') adjustedScore *= 1.2;\r\n                    break;\r\n                case 'late':\r\n                    if (hint.type === 'risk_mitigation') adjustedScore *= 1.5;\r\n                    break;\r\n            }\r\n            \r\n            // User preference weights\r\n            if (userPreferences.preferredStrategy === 'aggressive' && hint.type === 'combo_setup') {\r\n                adjustedScore *= 1.2;\r\n            }\r\n            if (userPreferences.riskTolerance === 'low' && hint.type === 'defensive') {\r\n                adjustedScore *= 1.3;\r\n            }\r\n            \r\n            return { ...hint, adjustedScore };\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Machine Learning Optimization\r\n     */\r\n    applyMLOptimization(hints, strategicSituations) {\r\n        // Simulate neural network weights based on historical data\r\n        const neuralWeights = this.calculateNeuralWeights(strategicSituations);\r\n        \r\n        return hints.map(hint => {\r\n            const features = this.extractHintFeatures(hint);\r\n            const mlScore = this.calculateMLScore(features, neuralWeights);\r\n            \r\n            return {\r\n                ...hint,\r\n                mlScore,\r\n                finalScore: (hint.adjustedScore * 0.7) + (mlScore * 0.3)\r\n            };\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Zgjedh hints-et m t mira\r\n     */\r\n    selectBestHints(hints, count = 3) {\r\n        // Sort by final score\r\n        hints.sort((a, b) => b.finalScore - a.finalScore);\r\n        \r\n        // Ensure diversity in hint types\r\n        const diverseHints = this.ensureHintDiversity(hints.slice(0, count * 2));\r\n        \r\n        return diverseHints.slice(0, count);\r\n    }\r\n\r\n    /**\r\n     * Siguron diversitet n llojet e hints-ave\r\n     */\r\n    ensureHintDiversity(hints) {\r\n        const typesSeen = new Set();\r\n        const diverseHints = [];\r\n        \r\n        for (const hint of hints) {\r\n            if (!typesSeen.has(hint.type) || diverseHints.length < 2) {\r\n                diverseHints.push(hint);\r\n                typesSeen.add(hint.type);\r\n            }\r\n        }\r\n        \r\n        // Fill remaining slots with best remaining hints\r\n        const remaining = hints.filter(h => !diverseHints.includes(h));\r\n        diverseHints.push(...remaining.slice(0, 3 - diverseHints.length));\r\n        \r\n        return diverseHints;\r\n    }\r\n\r\n    /**\r\n     * Ruaj t dhnat e t msuarit pr prmirsim t vazhdueshm\r\n     */\r\n    recordUserDecision(presentedHints, chosenHint, outcome) {\r\n        this.learningData.decisions.push({\r\n            timestamp: Date.now(),\r\n            hints: presentedHints,\r\n            chosen: chosenHint,\r\n            outcome: outcome, // success, failure, ignored\r\n            gameContext: this.analyzeGameContext(gameState.grid)\r\n        });\r\n        \r\n        // Update user play style\r\n        this.updateUserPlayStyle(chosenHint, outcome);\r\n        \r\n        // Save to localStorage\r\n        this.saveLearningData();\r\n    }\r\n\r\n    // Utility methods pr AI calculations\r\n    calculateOccupancy(grid) {\r\n        let occupied = 0;\r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            for (let c = 0; c < GRID_COLS; c++) {\r\n                if (grid[r][c] !== 0) occupied++;\r\n            }\r\n        }\r\n        return occupied / (GRID_ROWS * GRID_COLS);\r\n    }\r\n    \r\n    calculateFragmentation(grid) {\r\n        let fragments = 0;\r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            for (let c = 0; c < GRID_COLS; c++) {\r\n                if (grid[r][c] === 0) {\r\n                    // Count isolated empty cells\r\n                    const neighbors = [\r\n                        [r-1, c], [r+1, c], [r, c-1], [r, c+1]\r\n                    ];\r\n                    const emptyNeighbors = neighbors.filter(([nr, nc]) => \r\n                        nr >= 0 && nr < GRID_ROWS && nc >= 0 && nc < GRID_COLS && grid[nr][nc] === 0\r\n                    ).length;\r\n                    if (emptyNeighbors < 2) fragments++;\r\n                }\r\n            }\r\n        }\r\n        return Math.min(fragments / (GRID_ROWS * GRID_COLS), 1);\r\n    }\r\n    \r\n    calculateRiskLevel(grid) {\r\n        const occupancy = this.calculateOccupancy(grid);\r\n        const fragmentation = this.calculateFragmentation(grid);\r\n        return Math.min((occupancy * 0.7) + (fragmentation * 0.3), 1);\r\n    }\r\n    \r\n    calculateOpportunityScore(grid) {\r\n        let opportunities = 0;\r\n        // Check for almost complete lines\r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            const emptyCells = grid[r].filter(cell => cell === 0).length;\r\n            if (emptyCells <= 2 && emptyCells > 0) opportunities++;\r\n        }\r\n        for (let c = 0; c < GRID_COLS; c++) {\r\n            let emptyCells = 0;\r\n            for (let r = 0; r < GRID_ROWS; r++) {\r\n                if (grid[r][c] === 0) emptyCells++;\r\n            }\r\n            if (emptyCells <= 2 && emptyCells > 0) opportunities++;\r\n        }\r\n        return Math.min(opportunities / 10, 1);\r\n    }\r\n    \r\n    determineGamePhase(occupancy) {\r\n        if (occupancy < 0.3) return 'early';\r\n        if (occupancy < 0.7) return 'middle';\r\n        return 'late';\r\n    }\r\n    \r\n    calculateUrgencyLevel(riskLevel, occupancy) {\r\n        return Math.min(riskLevel + (occupancy * 0.3), 1);\r\n    }\r\n    \r\n    calculateSpaceEfficiency(grid) {\r\n        const occupancy = this.calculateOccupancy(grid);\r\n        const fragmentation = this.calculateFragmentation(grid);\r\n        return Math.max(0, occupancy - (fragmentation * 0.5));\r\n    }\r\n    \r\n    determineStrategicPriority(fragmentation, opportunity) {\r\n        if (fragmentation > 0.6) return 'cleanup';\r\n        if (opportunity > 0.5) return 'completion';\r\n        return 'expansion';\r\n    }\r\n    \r\n    identifyPreferredStrategy(playHistory) {\r\n        if (playHistory.length === 0) return 'balanced';\r\n        // Simple heuristic - more moves = more aggressive\r\n        return playHistory.length > 50 ? 'aggressive' : 'defensive';\r\n    }\r\n    \r\n    calculateRiskTolerance(playHistory) {\r\n        // Default to medium risk tolerance\r\n        return 'medium';\r\n    }\r\n    \r\n    calculatePlanningHorizon(playHistory) {\r\n        return playHistory.length > 30 ? 'long-term' : 'short-term';\r\n    }\r\n    \r\n    calculateEfficiencyFocus(playHistory) {\r\n        return 0.7; // Default efficiency focus\r\n    }\r\n    \r\n    analyzeLinePotential(shape, row, col, grid) {\r\n        let score = 0;\r\n        let confidence = 0.5;\r\n        let reasoning = '';\r\n        let futureOpportunities = 0;\r\n        \r\n        // Check if this placement would complete lines\r\n        const testGrid = this.simulatePlacement(shape, row, col, grid);\r\n        const completedLines = this.countCompletedLines(testGrid) - this.countCompletedLines(grid);\r\n        \r\n        if (completedLines > 0) {\r\n            score = 0.8 + (completedLines * 0.1);\r\n            confidence = 0.9;\r\n            reasoning = `Completes ${completedLines} line(s)`;\r\n            futureOpportunities = completedLines * 2;\r\n        } else {\r\n            // Check for almost complete lines\r\n            const almostComplete = this.countAlmostCompleteLines(testGrid);\r\n            if (almostComplete > 0) {\r\n                score = 0.6;\r\n                confidence = 0.7;\r\n                reasoning = `Sets up ${almostComplete} line(s) for completion`;\r\n                futureOpportunities = almostComplete;\r\n            }\r\n        }\r\n        \r\n        return { score, confidence, reasoning, futureOpportunities };\r\n    }\r\n    \r\n    calculateSpaceOptimization(grid) {\r\n        const efficiency = this.calculateSpaceEfficiency(grid);\r\n        const benefits = efficiency > 0.7 ? 'high space efficiency' : 'moderate space usage';\r\n        return { score: efficiency, benefits };\r\n    }\r\n    \r\n    calculateFlexibilityScore(grid) {\r\n        const fragmentation = this.calculateFragmentation(grid);\r\n        return Math.max(0, 1 - fragmentation);\r\n    }\r\n    \r\n    simulatePlacement(shape, row, col, grid) {\r\n        const testGrid = grid.map(r => [...r]);\r\n        shape.forEach(([sr, sc]) => {\r\n            const gridRow = row + sr;\r\n            const gridCol = col + sc;\r\n            if (gridRow >= 0 && gridRow < GRID_ROWS && gridCol >= 0 && gridCol < GRID_COLS) {\r\n                testGrid[gridRow][gridCol] = 1; // Temporary value\r\n            }\r\n        });\r\n        return testGrid;\r\n    }\r\n    \r\n    countCompletedLines(grid) {\r\n        let completed = 0;\r\n        // Check rows\r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            if (grid[r].every(cell => cell !== 0)) completed++;\r\n        }\r\n        // Check columns\r\n        for (let c = 0; c < GRID_COLS; c++) {\r\n            let columnComplete = true;\r\n            for (let r = 0; r < GRID_ROWS; r++) {\r\n                if (grid[r][c] === 0) {\r\n                    columnComplete = false;\r\n                    break;\r\n                }\r\n            }\r\n            if (columnComplete) completed++;\r\n        }\r\n        return completed;\r\n    }\r\n    \r\n    countAlmostCompleteLines(grid) {\r\n        let almostComplete = 0;\r\n        // Check rows\r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            const emptyCells = grid[r].filter(cell => cell === 0).length;\r\n            if (emptyCells <= 2 && emptyCells > 0) almostComplete++;\r\n        }\r\n        // Check columns\r\n        for (let c = 0; c < GRID_COLS; c++) {\r\n            let emptyCells = 0;\r\n            for (let r = 0; r < GRID_ROWS; r++) {\r\n                if (grid[r][c] === 0) emptyCells++;\r\n            }\r\n            if (emptyCells <= 2 && emptyCells > 0) almostComplete++;\r\n        }\r\n        return almostComplete;\r\n    }\r\n    \r\n    predictComboOpportunities(shape, row, col, grid) {\r\n        const testGrid = this.simulatePlacement(shape, row, col, grid);\r\n        const currentLines = this.countCompletedLines(grid);\r\n        const newLines = this.countCompletedLines(testGrid);\r\n        const potentialCombos = newLines - currentLines;\r\n        \r\n        return {\r\n            potentialCombos,\r\n            totalScore: potentialCombos * 0.8,\r\n            confidence: potentialCombos > 0 ? 0.8 : 0.3,\r\n            details: `${potentialCombos} potential combo lines`\r\n        };\r\n    }\r\n    \r\n    identifyRiskAreas(grid) {\r\n        const riskAreas = [];\r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            for (let c = 0; c < GRID_COLS; c++) {\r\n                if (grid[r][c] === 0) {\r\n                    const surroundingOccupied = this.countSurroundingOccupied(grid, r, c);\r\n                    if (surroundingOccupied >= 3) {\r\n                        riskAreas.push({ row: r, col: c, risk: surroundingOccupied / 4 });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return riskAreas;\r\n    }\r\n    \r\n    countSurroundingOccupied(grid, row, col) {\r\n        const neighbors = [\r\n            [row-1, col], [row+1, col], [row, col-1], [row, col+1]\r\n        ];\r\n        return neighbors.filter(([r, c]) => \r\n            r >= 0 && r < GRID_ROWS && c >= 0 && c < GRID_COLS && grid[r][c] !== 0\r\n        ).length;\r\n    }\r\n    \r\n    calculateDefenseScore(shape, row, col, grid, riskAreas) {\r\n        let score = 0.5;\r\n        let reliability = 0.6;\r\n        let explanation = 'Standard placement';\r\n        let mitigatedRisks = 0;\r\n        \r\n        // Check if placement fills risky areas\r\n        shape.forEach(([sr, sc]) => {\r\n            const gridRow = row + sr;\r\n            const gridCol = col + sc;\r\n            const risk = riskAreas.find(area => area.row === gridRow && area.col === gridCol);\r\n            if (risk) {\r\n                score += risk.risk * 0.2;\r\n                mitigatedRisks++;\r\n            }\r\n        });\r\n        \r\n        if (mitigatedRisks > 0) {\r\n            explanation = `Fills ${mitigatedRisks} risky gap(s)`;\r\n            reliability = 0.8;\r\n        }\r\n        \r\n        return { score, reliability, explanation, mitigatedRisks };\r\n    }\r\n    \r\n    identifyCriticalAreas(grid) {\r\n        const critical = [];\r\n        const occupancy = this.calculateOccupancy(grid);\r\n        if (occupancy > 0.7) {\r\n            // In late game, all empty spaces are critical\r\n            for (let r = 0; r < GRID_ROWS; r++) {\r\n                for (let c = 0; c < GRID_COLS; c++) {\r\n                    if (grid[r][c] === 0) {\r\n                        critical.push({ row: r, col: c });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return critical;\r\n    }\r\n    \r\n    analyzeGameOverRisk(shape, row, col, grid) {\r\n        const currentRisk = this.calculateRiskLevel(grid);\r\n        const testGrid = this.simulatePlacement(shape, row, col, grid);\r\n        const newRisk = this.calculateRiskLevel(testGrid);\r\n        const riskReduction = Math.max(0, currentRisk - newRisk);\r\n        \r\n        return {\r\n            score: 0.5 + (riskReduction * 0.5),\r\n            confidence: riskReduction > 0.1 ? 0.8 : 0.4,\r\n            riskReduction,\r\n            factors: ['space optimization', 'fragmentation reduction']\r\n        };\r\n    }\r\n    \r\n    calculateNeuralWeights(strategicSituations) {\r\n        // Simplified neural network weights simulation\r\n        return {\r\n            lineCompletion: 0.8,\r\n            spaceOptimization: 0.6,\r\n            comboSetup: 0.7,\r\n            defensive: 0.5,\r\n            riskMitigation: 0.9\r\n        };\r\n    }\r\n    \r\n    extractHintFeatures(hint) {\r\n        return {\r\n            score: hint.score || 0,\r\n            confidence: hint.confidence || 0.5,\r\n            type: hint.type || 'unknown',\r\n            position: [hint.row || 0, hint.col || 0]\r\n        };\r\n    }\r\n    \r\n    calculateMLScore(features, weights) {\r\n        const typeWeight = weights[features.type] || 0.5;\r\n        return (features.score * 0.4) + (features.confidence * 0.3) + (typeWeight * 0.3);\r\n    }\r\n    \r\n    ensureHintDiversity(hints) {\r\n        const typesSeen = new Set();\r\n        const diverseHints = [];\r\n        \r\n        for (const hint of hints) {\r\n            if (!typesSeen.has(hint.type) || diverseHints.length < 2) {\r\n                diverseHints.push(hint);\r\n                typesSeen.add(hint.type);\r\n            }\r\n        }\r\n        \r\n        // Fill remaining slots with best remaining hints\r\n        const remaining = hints.filter(h => !diverseHints.includes(h));\r\n        diverseHints.push(...remaining.slice(0, 3 - diverseHints.length));\r\n        \r\n        return diverseHints;\r\n    }\r\n    \r\n    recordUserDecision(presentedHints, chosenHint, outcome) {\r\n        if (!this.learningData.decisions) {\r\n            this.learningData.decisions = [];\r\n        }\r\n        \r\n        this.learningData.decisions.push({\r\n            timestamp: Date.now(),\r\n            hints: presentedHints,\r\n            chosen: chosenHint,\r\n            outcome: outcome,\r\n            gameContext: this.analyzeGameContext(gameState.grid)\r\n        });\r\n        \r\n        this.updateUserPlayStyle(chosenHint, outcome);\r\n        this.saveLearningData();\r\n    }\r\n    \r\n    updateUserPlayStyle(chosenHint, outcome) {\r\n        if (!this.userPlayStyle.preferences) {\r\n            this.userPlayStyle.preferences = {};\r\n        }\r\n        \r\n        const hintType = chosenHint?.type || 'unknown';\r\n        if (!this.userPlayStyle.preferences[hintType]) {\r\n            this.userPlayStyle.preferences[hintType] = { count: 0, success: 0 };\r\n        }\r\n        \r\n        this.userPlayStyle.preferences[hintType].count++;\r\n        if (outcome === 'success') {\r\n            this.userPlayStyle.preferences[hintType].success++;\r\n        }\r\n    }\r\n    \r\n    analyzeRecentPerformance() {\r\n        const recentMoves = this.gameAnalytics.recentMoves || [];\r\n        if (recentMoves.length === 0) {\r\n            return { averageSuccess: 0.5 };\r\n        }\r\n        \r\n        const successes = recentMoves.filter(move => move.success).length;\r\n        return { averageSuccess: successes / recentMoves.length };\r\n    }\r\n    \r\n    calculateGameDuration() {\r\n        return gameState.startTime ? Date.now() - gameState.startTime : 0;\r\n    }\r\n    \r\n    identifyStrategicSituations(grid) {\r\n        return {\r\n            occupancy: this.calculateOccupancy(grid),\r\n            fragmentation: this.calculateFragmentation(grid),\r\n            opportunities: this.calculateOpportunityScore(grid)\r\n        };\r\n    }\r\n    \r\n    isValidPlacement(shape, row, col, grid) {\r\n        for (const [sr, sc] of shape) {\r\n            const gridRow = row + sr;\r\n            const gridCol = col + sc;\r\n            if (gridRow < 0 || gridRow >= GRID_ROWS || gridCol < 0 || gridCol >= GRID_COLS) {\r\n                return false;\r\n            }\r\n            if (grid[gridRow][gridCol] !== 0) {\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n    \r\n    // Data persistence methods\r\n    loadUserPlayStyle() {\r\n        return JSON.parse(localStorage.getItem('aiHints_userStyle') || '{}');\r\n    }\r\n    \r\n    loadGameAnalytics() {\r\n        return JSON.parse(localStorage.getItem('aiHints_analytics') || '{\"recentMoves\": [], \"performance\": []}');\r\n    }\r\n    \r\n    loadLearningData() {\r\n        return JSON.parse(localStorage.getItem('aiHints_learningData') || '{\"decisions\": [], \"patterns\": {}}');\r\n    }\r\n    \r\n    saveLearningData() {\r\n        localStorage.setItem('aiHints_learningData', JSON.stringify(this.learningData));\r\n        localStorage.setItem('aiHints_userStyle', JSON.stringify(this.userPlayStyle));\r\n        localStorage.setItem('aiHints_analytics', JSON.stringify(this.gameAnalytics));\r\n    }\r\n}\r\n\r\n// Export pr prdorim n gameLogic.js\r\nexport const aiHintEngine = new AIHintEngine();\r\n","// Progressive Piece Unlock System\r\n// Sistem i hapjes graduale t pjesve bazuar n pik dhe achievements\r\n\r\nimport { gameState } from './state.js';\r\n\r\n/**\r\n * Sistema e hapjes graduale t pjesve\r\n */\r\nexport class PieceUnlockSystem {\r\n    constructor() {\r\n        this.unlockedPieces = this.loadUnlockedPieces();\r\n        this.lastScore = 0;\r\n    }\r\n\r\n    /**\r\n     * Kontrollon pr unlock t rinj bazuar n pikt aktuale\r\n     */\r\n    checkForUnlocks(currentScore) {\r\n        const newUnlocks = [];\r\n        \r\n        // Check each tier\r\n        const tiers = this.getUnlockTiers();\r\n        \r\n        for (const tier of tiers) {\r\n            if (currentScore >= tier.requiredScore && !this.unlockedPieces.includes(tier.id)) {\r\n                this.unlockedPieces.push(tier.id);\r\n                newUnlocks.push(tier);\r\n            }\r\n        }\r\n        \r\n        if (newUnlocks.length > 0) {\r\n            this.saveUnlockedPieces();\r\n            this.showUnlockNotification(newUnlocks);\r\n        }\r\n        \r\n        return newUnlocks;\r\n    }\r\n\r\n    /**\r\n     * Merr t gjitha pjest e disponueshme pr prdorim\r\n     */\r\n    getAvailablePieces() {\r\n        const allPieces = this.getAllPieceDefinitions();\r\n        return allPieces.filter(piece => \r\n            piece.tier === 'starter' || this.unlockedPieces.includes(piece.id)\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Definon tier-at e unlock-ave\r\n     */\r\n    getUnlockTiers() {\r\n        return [\r\n            // Tier 2 - Bronze (1000 pik)\r\n            { id: 'bronze1', requiredScore: 1000, name: 'P-Shape', tier: 'bronze' },\r\n            { id: 'bronze2', requiredScore: 1000, name: 'U-Shape', tier: 'bronze' },\r\n            { id: 'bronze3', requiredScore: 1000, name: 'Y-Shape', tier: 'bronze' },\r\n            { id: 'bronze4', requiredScore: 1000, name: 'F-Shape', tier: 'bronze' },\r\n            { id: 'bronze5', requiredScore: 1000, name: 'N-Shape', tier: 'bronze' },\r\n            \r\n            // Tier 3 - Silver (3000 pik)\r\n            { id: 'silver1', requiredScore: 3000, name: 'V-Shape', tier: 'silver' },\r\n            { id: 'silver2', requiredScore: 3000, name: 'W-Shape', tier: 'silver' },\r\n            { id: 'silver3', requiredScore: 3000, name: 'Cross', tier: 'silver' },\r\n            { id: 'silver4', requiredScore: 3000, name: 'Plus', tier: 'silver' },\r\n            { id: 'silver5', requiredScore: 3000, name: 'Corner', tier: 'silver' },\r\n            { id: 'silver6', requiredScore: 3000, name: 'Step', tier: 'silver' },\r\n            \r\n            // Tier 4 - Gold (7000 pik)\r\n            { id: 'gold1', requiredScore: 7000, name: 'Spiral', tier: 'gold' },\r\n            { id: 'gold2', requiredScore: 7000, name: 'Diamond', tier: 'gold' },\r\n            { id: 'gold3', requiredScore: 7000, name: 'Arrow', tier: 'gold' },\r\n            { id: 'gold4', requiredScore: 7000, name: 'Bridge', tier: 'gold' },\r\n            { id: 'gold5', requiredScore: 7000, name: 'Claw', tier: 'gold' },\r\n            { id: 'gold6', requiredScore: 7000, name: 'Wave', tier: 'gold' },\r\n            \r\n            // Tier 5 - Platinum (15000 pik)\r\n            { id: 'platinum1', requiredScore: 15000, name: 'Master-1', tier: 'platinum' },\r\n            { id: 'platinum2', requiredScore: 15000, name: 'Master-2', tier: 'platinum' },\r\n            { id: 'platinum3', requiredScore: 15000, name: 'Master-3', tier: 'platinum' },\r\n            { id: 'platinum4', requiredScore: 15000, name: 'Master-4', tier: 'platinum' },\r\n            { id: 'platinum5', requiredScore: 15000, name: 'Master-5', tier: 'platinum' },\r\n            { id: 'platinum6', requiredScore: 15000, name: 'Master-6', tier: 'platinum' }\r\n        ];\r\n    }\r\n\r\n    /**\r\n     * Merr milestones pr unlock\r\n     */\r\n    getUnlockMilestones() {\r\n        return [\r\n            { id: 'bronze', requiredScore: 1000, name: 'Bronze Tier', tierName: 'bronze' },\r\n            { id: 'silver', requiredScore: 3000, name: 'Silver Tier', tierName: 'silver' },\r\n            { id: 'gold', requiredScore: 7000, name: 'Gold Tier', tierName: 'gold' },\r\n            { id: 'platinum', requiredScore: 15000, name: 'Platinum Tier', tierName: 'platinum' }\r\n        ];\r\n    }\r\n\r\n    /**\r\n     * T gjitha pjest e lojs - 30 total\r\n     */\r\n    getAllPieceDefinitions() {\r\n        return [\r\n            // TIER 1 - STARTER (7 pjes klasike)\r\n            { id: 'I', name: 'I-Line', shape: [[0, 0], [0, 1], [0, 2], [0, 3]], color: 1, tier: 'starter' },\r\n            { id: 'O', name: 'O-Square', shape: [[0, 0], [0, 1], [1, 0], [1, 1]], color: 2, tier: 'starter' },\r\n            { id: 'T', name: 'T-Shape', shape: [[0, 1], [1, 0], [1, 1], [1, 2]], color: 3, tier: 'starter' },\r\n            { id: 'S', name: 'S-Shape', shape: [[0, 1], [0, 2], [1, 0], [1, 1]], color: 4, tier: 'starter' },\r\n            { id: 'Z', name: 'Z-Shape', shape: [[0, 0], [0, 1], [1, 1], [1, 2]], color: 5, tier: 'starter' },\r\n            { id: 'J', name: 'J-Shape', shape: [[0, 0], [1, 0], [1, 1], [1, 2]], color: 6, tier: 'starter' },\r\n            { id: 'L', name: 'L-Shape', shape: [[0, 2], [1, 0], [1, 1], [1, 2]], color: 7, tier: 'starter' },\r\n            \r\n            // TIER 2 - BRONZE (5 pjes t reja)\r\n            { id: 'bronze1', name: 'P-Shape', shape: [[0, 0], [0, 1], [1, 0], [1, 1], [2, 0]], color: 1, tier: 'bronze' },\r\n            { id: 'bronze2', name: 'U-Shape', shape: [[0, 0], [0, 2], [1, 0], [1, 1], [1, 2]], color: 2, tier: 'bronze' },\r\n            { id: 'bronze3', name: 'Y-Shape', shape: [[0, 1], [1, 0], [1, 1], [2, 1], [3, 1]], color: 3, tier: 'bronze' },\r\n            { id: 'bronze4', name: 'F-Shape', shape: [[0, 1], [0, 2], [1, 0], [1, 1], [2, 1]], color: 4, tier: 'bronze' },\r\n            { id: 'bronze5', name: 'N-Shape', shape: [[0, 1], [1, 0], [1, 1], [2, 0], [3, 0]], color: 5, tier: 'bronze' },\r\n            \r\n            // TIER 3 - SILVER (6 pjes intermediate)\r\n            { id: 'silver1', name: 'V-Shape', shape: [[0, 0], [1, 0], [2, 0], [2, 1], [2, 2]], color: 6, tier: 'silver' },\r\n            { id: 'silver2', name: 'W-Shape', shape: [[0, 0], [1, 0], [1, 1], [2, 1], [2, 2]], color: 7, tier: 'silver' },\r\n            { id: 'silver3', name: 'Cross', shape: [[0, 1], [1, 0], [1, 1], [1, 2], [2, 1]], color: 1, tier: 'silver' },\r\n            { id: 'silver4', name: 'Plus', shape: [[0, 1], [1, 0], [1, 1], [1, 2], [2, 1]], color: 2, tier: 'silver' },\r\n            { id: 'silver5', name: 'Corner', shape: [[0, 0], [0, 1], [0, 2], [1, 0], [2, 0]], color: 3, tier: 'silver' },\r\n            { id: 'silver6', name: 'Step', shape: [[0, 0], [1, 0], [1, 1], [2, 1], [2, 2]], color: 4, tier: 'silver' },\r\n            \r\n            // TIER 4 - GOLD (6 pjes advanced)\r\n            { id: 'gold1', name: 'Spiral', shape: [[0, 0], [0, 1], [1, 1], [1, 2], [2, 0], [2, 2]], color: 5, tier: 'gold' },\r\n            { id: 'gold2', name: 'Diamond', shape: [[0, 1], [1, 0], [1, 1], [1, 2], [2, 1]], color: 6, tier: 'gold' },\r\n            { id: 'gold3', name: 'Arrow', shape: [[0, 1], [1, 0], [1, 1], [1, 2], [2, 1], [3, 1]], color: 7, tier: 'gold' },\r\n            { id: 'gold4', name: 'Bridge', shape: [[0, 0], [0, 1], [0, 2], [1, 0], [1, 2]], color: 1, tier: 'gold' },\r\n            { id: 'gold5', name: 'Claw', shape: [[0, 0], [0, 2], [1, 0], [1, 1], [1, 2]], color: 2, tier: 'gold' },\r\n            { id: 'gold6', name: 'Wave', shape: [[0, 0], [0, 1], [1, 1], [1, 2], [2, 2], [2, 3]], color: 3, tier: 'gold' },\r\n            \r\n            // TIER 5 - PLATINUM (6 pjes master)\r\n            { id: 'platinum1', name: 'Master-1', shape: [[0, 0], [0, 1], [0, 2], [1, 1], [2, 0], [2, 2]], color: 4, tier: 'platinum' },\r\n            { id: 'platinum2', name: 'Master-2', shape: [[0, 1], [1, 0], [1, 1], [1, 2], [2, 0], [2, 2]], color: 5, tier: 'platinum' },\r\n            { id: 'platinum3', name: 'Master-3', shape: [[0, 0], [0, 2], [1, 0], [1, 1], [1, 2], [2, 1]], color: 6, tier: 'platinum' },\r\n            { id: 'platinum4', name: 'Master-4', shape: [[0, 0], [0, 1], [1, 1], [1, 2], [2, 1], [3, 1]], color: 7, tier: 'platinum' },\r\n            { id: 'platinum5', name: 'Master-5', shape: [[0, 1], [1, 0], [1, 1], [2, 1], [2, 2], [3, 1]], color: 1, tier: 'platinum' },\r\n            { id: 'platinum6', name: 'Master-6', shape: [[0, 0], [0, 1], [0, 2], [1, 0], [1, 2], [2, 1]], color: 2, tier: 'platinum' }\r\n        ];\r\n    }\r\n\r\n    /**\r\n     * Shfaq notification pr unlock t rinj\r\n     */\r\n    showUnlockNotification(newUnlocks) {\r\n        const tierNames = {\r\n            bronze: 'BRONZE TIER',\r\n            silver: 'SILVER TIER', \r\n            gold: 'GOLD TIER',\r\n            platinum: 'PLATINUM TIER'\r\n        };\r\n\r\n        const tierEmojis = {\r\n            bronze: '',\r\n            silver: '', \r\n            gold: '',\r\n            platinum: ''\r\n        };\r\n\r\n        const groupedByTier = {};\r\n        newUnlocks.forEach(unlock => {\r\n            if (!groupedByTier[unlock.tier]) {\r\n                groupedByTier[unlock.tier] = [];\r\n            }\r\n            groupedByTier[unlock.tier].push(unlock);\r\n        });\r\n\r\n        Object.keys(groupedByTier).forEach(tier => {\r\n            const pieces = groupedByTier[tier];\r\n            const message = `${tierEmojis[tier]} ${tierNames[tier]} UNLOCKED!\\n${pieces.length} new pieces available: ${pieces.map(p => p.name).join(', ')}`;\r\n            \r\n            this.displayUnlockNotification(message, tier);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Shfaq notification n UI\r\n     */\r\n    displayUnlockNotification(message, tier) {\r\n        // Create notification element\r\n        const notification = document.createElement('div');\r\n        notification.className = `unlock-notification unlock-${tier}`;\r\n        notification.innerHTML = `\r\n            <div class=\"unlock-content\">\r\n                <h3> NEW PIECES UNLOCKED!</h3>\r\n                <p>${message}</p>\r\n            </div>\r\n        `;\r\n\r\n        // Add to page\r\n        document.body.appendChild(notification);\r\n\r\n        // Animate in\r\n        setTimeout(() => notification.classList.add('show'), 100);\r\n\r\n        // Remove after 4 seconds\r\n        setTimeout(() => {\r\n            notification.classList.remove('show');\r\n            setTimeout(() => document.body.removeChild(notification), 500);\r\n        }, 4000);\r\n\r\n        // Play unlock sound if available\r\n        this.playUnlockSound();\r\n    }\r\n\r\n    /**\r\n     * Play unlock sound\r\n     */\r\n    playUnlockSound() {\r\n        try {\r\n            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LGeSYELYTO8teMOAcabLvs5Z0TAA4A');\r\n            audio.volume = 0.3;\r\n            audio.play();\r\n        } catch (e) {\r\n            // Ignore audio errors\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Merr informacion pr unlock-un e ardhshm\r\n     */\r\n    getNextUnlock() {\r\n        const currentScore = gameState?.score || 0;\r\n        const milestones = this.getUnlockMilestones();\r\n\r\n        for (const milestone of milestones) {\r\n            if (currentScore < milestone.requiredScore) {\r\n                return {\r\n                    name: milestone.name,\r\n                    requiredScore: milestone.requiredScore,\r\n                    remaining: Math.max(0, milestone.requiredScore - currentScore)\r\n                };\r\n            }\r\n        }\r\n\r\n        return null; // All unlocked\r\n    }\r\n\r\n    /**\r\n     * Load unlocked pieces nga localStorage\r\n     */\r\n    loadUnlockedPieces() {\r\n        try {\r\n            return JSON.parse(localStorage.getItem('blocustema_unlockedPieces') || '[]');\r\n        } catch {\r\n            return [];\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Save unlocked pieces n localStorage\r\n     */\r\n    saveUnlockedPieces() {\r\n        localStorage.setItem('blocustema_unlockedPieces', JSON.stringify(this.unlockedPieces));\r\n    }\r\n\r\n    /**\r\n     * Merr informacionin e progresit t unlock-eve\r\n     */\r\n    getProgressInfo() {\r\n        const totalPieces = 30;\r\n        \r\n        // Count actual unlocked pieces, not just tier unlocks\r\n        const availablePieces = this.getAvailablePieces();\r\n        const unlockedCount = availablePieces.length;\r\n        const percentage = (unlockedCount / totalPieces) * 100;\r\n        const nextUnlock = this.getNextUnlock();\r\n\r\n        return {\r\n            totalPieces,\r\n            unlockedCount,\r\n            percentage: Math.round(percentage),\r\n            nextUnlock\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Reset t gjitha unlock-et (pr testing)\r\n     */\r\n    resetUnlocks() {\r\n        this.unlockedPieces = [];\r\n        this.saveUnlockedPieces();\r\n    }\r\n}\r\n\r\n// Export instance\r\nexport const pieceUnlockSystem = new PieceUnlockSystem();\r\n","// Centralized game logic. All duplicate or legacy comments removed for clarity.\r\n\r\nimport { gameState, initializeState } from './state.js';\r\nimport { PIECE_SHAPES, GRID_ROWS, GRID_COLS } from './constants.js';\r\nimport { aiHintEngine } from './aiHints.js';\r\nimport { pieceUnlockSystem } from './pieceUnlockSystem.js';\r\n\r\nexport { createEmptyGrid } from './state.js';\r\n\r\n// Cache pr DOM elements - pr optimizimin e performancs\r\nconst domCache = new Map();\r\n// Cache pr placement calculations\r\nconst placementCache = new Map();\r\nexport function clearRowOrColumn(index, isRow = true) {\r\n    if (typeof index !== 'number') {\r\n        return false;\r\n    }\r\n\r\n    if (isRow) {\r\n        if (index < 0 || index >= GRID_ROWS) {\r\n            return false;\r\n        }\r\n        for (let col = 0; col < GRID_COLS; col++) {\r\n            gameState.grid[index][col] = 0;\r\n        }\r\n    } else {\r\n        if (index < 0 || index >= GRID_COLS) {\r\n            return false;\r\n        }\r\n        for (let row = 0; row < GRID_ROWS; row++) {\r\n            gameState.grid[row][index] = 0;\r\n        }\r\n    }\r\n\r\n    placementCache.clear();\r\n    gameState.lastPlacementCells = [];\r\n    return true;\r\n}\r\n\r\nexport function shiftColumn(columnIndex, direction = 1) {\r\n    if (columnIndex < 0 || columnIndex >= GRID_COLS) {\r\n        return false;\r\n    }\r\n\r\n    const normalizedDirection = direction >= 0 ? 1 : -1;\r\n    const values = [];\r\n    for (let row = 0; row < GRID_ROWS; row++) {\r\n        values.push(gameState.grid[row][columnIndex]);\r\n    }\r\n\r\n    if (normalizedDirection === 1) {\r\n        const first = values.shift();\r\n        values.push(first ?? 0);\r\n    } else {\r\n        const last = values.pop();\r\n        values.unshift(last ?? 0);\r\n    }\r\n\r\n    for (let row = 0; row < GRID_ROWS; row++) {\r\n        gameState.grid[row][columnIndex] = values[row];\r\n    }\r\n\r\n    placementCache.clear();\r\n    gameState.lastPlacementCells = [];\r\n    return true;\r\n}\r\n\r\n/**\r\n * Pastron t gjitha cache-et\r\n */\r\nexport function clearAllCaches() {\r\n    domCache.clear();\r\n    placementCache.clear();\r\n}\r\n\r\n/**\r\n * Merr nj grid cell nga cache ose DOM\r\n * @param {number} row - Rreshti\r\n * @param {number} col - Kolona\r\n * @returns {HTMLElement|null} - Elementi i grid cell-it\r\n */\r\nfunction getCachedGridCell(row, col) {\r\n    const key = `cell-${row}-${col}`;\r\n    if (!domCache.has(key)) {\r\n        const cell = document.querySelector(`[data-row=\"${row}\"][data-col=\"${col}\"]`);\r\n        if (cell) {\r\n            domCache.set(key, cell);\r\n        }\r\n        return cell;\r\n    }\r\n    return domCache.get(key);\r\n}\r\n\r\n/**\r\n * Pastron cache-in e DOM elements\r\n */\r\nexport function clearDOMCache() {\r\n    domCache.clear();\r\n}\r\n\r\n/**\r\n * Validon bounds m efikasishm\r\n * @param {number} row - Rreshti\r\n * @param {number} col - Kolona\r\n * @returns {boolean} - True nse sht n bounds\r\n */\r\nfunction isInBounds(row, col) {\r\n    return row >= 0 && row < GRID_ROWS && col >= 0 && col < GRID_COLS;\r\n}\r\n\r\n/**\r\n * Zgjedh nj form t rastsishme nga pjest e disponueshme.\r\n * @returns {object} Nj objekt i ri pjese.\r\n */\r\nexport function getRandomPiece() {\r\n    // Unified piece selection: always use unlock system\r\n    const availablePieces = pieceUnlockSystem.getAvailablePieces();\r\n    \r\n    if (availablePieces.length === 0) {\r\n        // Fallback to PIECE_SHAPES if unlock system fails\r\n        let piece = { ...PIECE_SHAPES[Math.floor(Math.random() * PIECE_SHAPES.length)], id: Date.now() + Math.random() };\r\n        piece.currentShape = piece.shape;\r\n        piece.size = piece.shape.length;  // Add size for fallback case too\r\n        // Apply random rotations for varied orientation\r\n        for (let i = 0, r = Math.floor(Math.random() * 4); i < r; i++) {\r\n            piece = rotatePiece(piece);\r\n        }\r\n        return piece;\r\n    }\r\n    \r\n    // Select random piece from available unlocked pieces\r\n    const randomIndex = Math.floor(Math.random() * availablePieces.length);\r\n    const selectedPiece = availablePieces[randomIndex];\r\n    \r\n    // Create piece instance\r\n    let piece = {\r\n        ...selectedPiece,\r\n        id: Date.now() + Math.random(),\r\n        currentShape: selectedPiece.shape,\r\n        size: selectedPiece.shape.length  // Add size based on shape length\r\n    };\r\n    // Apply random rotations for varied orientation\r\n    for (let i = 0, r = Math.floor(Math.random() * 4); i < r; i++) {\r\n        piece = rotatePiece(piece);\r\n    }\r\n    return piece;\r\n}\r\n\r\n/**\r\n * Mbush raftin e pjesve me 3 pjes t reja.\r\n */\r\nexport function populateInitialPieces() {\r\n    gameState.currentPieces = [];\r\n    for (let i = 0; i < 3; i++) {\r\n        gameState.currentPieces.push(getRandomPiece());\r\n    }\r\n}\r\n\r\n/**\r\n * Zvendson nj pjes t prdorur me nj t re.\r\n * @param {number} index - Indeksi i pjess q do t zvendsohet.\r\n */\r\nexport function replaceUsedPiece(index) {\r\n    gameState.currentPieces[index] = getRandomPiece();\r\n}\r\n\r\n/**\r\n * Rrotullon formn e nj pjese 90 grad.\r\n * @param {object} pieceData - Objekti i pjess q do t rrotullohet.\r\n * @returns {object} - Objekti i pjess me formn e rrotulluar.\r\n */\r\nexport function rotatePiece(pieceData) {\r\n    if (!pieceData || !pieceData.currentShape) return pieceData;\r\n\r\n    // Gjej dimensionet e forms aktuale\r\n    let minR = Infinity, maxR = -Infinity, minC = Infinity, maxC = -Infinity;\r\n    pieceData.currentShape.forEach(([r, c]) => {\r\n        minR = Math.min(minR, r); maxR = Math.max(maxR, r);\r\n        minC = Math.min(minC, c); maxC = Math.max(maxC, c);\r\n    });\r\n    const height = maxR - minR;\r\n\r\n    // Apliko rrotullimin\r\n    const newShape = pieceData.currentShape.map(([r, c]) => [(c - minC), (height - (r - minR))]);\r\n\r\n    // Normalizo formn e re q t filloj nga (0,0)\r\n    let newMinR = Infinity, newMinC = Infinity;\r\n    newShape.forEach(([r, c]) => {\r\n        newMinR = Math.min(newMinR, r);\r\n        newMinC = Math.min(newMinC, c);\r\n    });\r\n\r\n    const normalizedShape = newShape.map(([r, c]) => [r - newMinR, c - newMinC]);\r\n    \r\n    return { ...pieceData, currentShape: normalizedShape };\r\n}\r\n\r\n/**\r\n * Pasqyron nj pjes horizontalisht (flip majtas-djathtas)\r\n * @param {object} pieceData - Objekti i pjess\r\n * @returns {object} - Pjes e pasqyruar\r\n */\r\nexport function flipPieceHorizontally(pieceData) {\r\n    if (!pieceData || !pieceData.currentShape) return pieceData;\r\n\r\n    // Gjej dimensionet e forms aktuale\r\n    let minR = Infinity, maxR = -Infinity, minC = Infinity, maxC = -Infinity;\r\n    pieceData.currentShape.forEach(([r, c]) => {\r\n        minR = Math.min(minR, r); maxR = Math.max(maxR, r);\r\n        minC = Math.min(minC, c); maxC = Math.max(maxC, c);\r\n    });\r\n    const width = maxC - minC;\r\n\r\n    // Apliko pasqyrimin horizontal: c -> (width - (c - minC))\r\n    const newShape = pieceData.currentShape.map(([r, c]) => [r, width - (c - minC)]);\r\n\r\n    // Normalizo formn e re q t filloj nga (0,0)\r\n    let newMinR = Infinity, newMinC = Infinity;\r\n    newShape.forEach(([r, c]) => {\r\n        newMinR = Math.min(newMinR, r);\r\n        newMinC = Math.min(newMinC, c);\r\n    });\r\n\r\n    const normalizedShape = newShape.map(([r, c]) => [r - newMinR, c - newMinC]);\r\n    \r\n    return { ...pieceData, currentShape: normalizedShape };\r\n}\r\n\r\n\r\n/**\r\n * Kontrollon nse nj pjes mund t vendoset n nj pozicion t caktuar n rrjet.\r\n * @param {array} pieceShape - Forma e pjess.\r\n * @param {number} startRow - Rreshti fillestar.\r\n * @param {number} startCol - Kolona fillestare.\r\n * @returns {boolean} - True nse vendosja sht e vlefshme.\r\n */\r\nexport function isValidPlacement(pieceShape, startRow, startCol) {\r\n    for (const [r, c] of pieceShape) {\r\n        const gridRow = startRow + r;\r\n        const gridCol = startCol + c;\r\n        if (\r\n            !isInBounds(gridRow, gridCol) ||\r\n            gameState.grid[gridRow][gridCol] !== 0\r\n        ) {\r\n            return false;\r\n        }\r\n    }\r\n    return true;\r\n}\r\n\r\n/**\r\n * Vendos nj pjes n rrjet (vetm n modelin e t dhnave).\r\n * @param {object} piece - Objekti i pjess.\r\n * @param {number} startRow - Rreshti ku vendoset.\r\n * @param {number} startCol - Kolona ku vendoset.\r\n */\r\nexport function placePieceOnGrid(piece, startRow, startCol) {\r\n    piece.currentShape.forEach(([r, c]) => {\r\n        gameState.grid[startRow + r][startCol + c] = piece.color;\r\n    });\r\n    gameState.score += piece.size;\r\n    // Pastro cache-in kur grid-i ndryshon\r\n    placementCache.clear();\r\n}\r\n\r\n/**\r\n * Kontrollon dhe pastron rreshtat dhe kolonat e plota.\r\n * @param {number} placedPieceColor - Ngjyra e pjess q sapo u vendos dhe shkaktoi pastrimin\r\n * @returns {object|null} - Objekt me t dhna pr efektet vizuale, ose null nse nuk pastrohet gj.\r\n */\r\nexport function checkAndClearLines(placedPieceColor = null) {\r\n  const beforeClearScore = (typeof gameState !== 'undefined' && gameState.score) || 0;\r\n\r\n    const clearedRows = [];\r\n    const clearedCols = [];\r\n\r\n    // Gjej rreshtat e plot\r\n    for (let r = 0; r < GRID_ROWS; r++) {\r\n        if (gameState.grid[r].every(cell => cell !== 0)) {\r\n            clearedRows.push(r);\r\n        }\r\n    }\r\n\r\n    // Gjej kolonat e plota\r\n    for (let c = 0; c < GRID_COLS; c++) {\r\n        let isColFull = true;\r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            if (gameState.grid[r][c] === 0) {\r\n                isColFull = false;\r\n                break;\r\n            }\r\n        }\r\n        if (isColFull) {\r\n            clearedCols.push(c);\r\n        }\r\n    }    const totalLinesCleared = clearedRows.length + clearedCols.length;\r\n    if (totalLinesCleared === 0) {\r\n        gameState.combo.count = 0; // Reset combo if no lines cleared\r\n        return null;\r\n    }\r\n\r\n    // Prcakto ngjyrn pr animacion - prdor ngjyrn e pjess s fundit nse sht dhn\r\n    const animationColor = placedPieceColor ? getBaseColor(placedPieceColor) : 'rgba(133, 76, 19, 1)';\r\n\r\n    // Mblidh t dhnat pr efektet vizuale\r\n    const clearedCellsSet = new Set();\r\n    \r\n    clearedRows.forEach(r => { \r\n        for (let c = 0; c < GRID_COLS; c++) {\r\n            clearedCellsSet.add(JSON.stringify({ row: r, col: c }));\r\n        }\r\n    });\r\n    \r\n    clearedCols.forEach(c => { \r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            clearedCellsSet.add(JSON.stringify({ row: r, col: c }));\r\n        }\r\n    });\r\n    \r\n    const cellsToAnimate = Array.from(clearedCellsSet).map(str => {\r\n        const cell = JSON.parse(str);\r\n        return {\r\n            ...cell,\r\n            animationColor: animationColor // Prdor ngjyrn e pjess s fundit pr t gjitha qelizat\r\n        };\r\n    });\r\n\r\n    // Llogarit pikt dhe combo\r\n    gameState.combo.count++;\r\n    const pointsEarned = calculateLineClearScore(totalLinesCleared, gameState.combo.count);\r\n    gameState.score += pointsEarned;\r\n\r\n    // Mos pastro menjher rrjetn ktu; lejo animacionin t prfundoj.\r\n    // Pastrimi kryhet n shtresn e UI-s (main.js) sapo t prfundoj animacioni pr secilin rresht/kolon.\r\n\r\n    const result = {\r\n        cellsToAnimate,\r\n        pointsEarned,\r\n        comboCount: gameState.combo.count,\r\n        totalLinesCleared,\r\n        clearedRows,\r\n        clearedCols,\r\n        placedPieceColor: placedPieceColor  // Include the piece color that caused the clear\r\n    };\r\n    // Pastro cache-in kur grid-i ndryshon\r\n    placementCache.clear();\r\n    return result;\r\n}\r\n\r\n/**\r\n * Llogarit pikt pr pastrimin e rreshtave, duke prfshir bonusin e combo-s.\r\n * Shton bonus spektakular pr combo >= 5.\r\n */\r\nfunction calculateLineClearScore(lines, combo) {\r\n    let baseScore = 0;\r\n    if (lines === 1) baseScore = 100;\r\n    else if (lines === 2) baseScore = 250;\r\n    else if (lines === 3) baseScore = 500;\r\n    else if (lines === 4) baseScore = 800;\r\n    else if (lines >= 5) baseScore = 1000 + (lines - 4) * 200;\r\n    \r\n    let comboBonus = combo > 1 ? (combo - 1) * 50 : 0;\r\n    // Bonus spektakular pr combo shum t larta\r\n    if (combo >= 5) comboBonus += 500 + (combo - 5) * 100;\r\n    return baseScore + comboBonus;\r\n}\r\n\r\n/**\r\n * Kontrollon nse ka ndonj lvizje t mundshme pr lojtarin.\r\n * Logjika hibride: kontrollon formn aktuale + rrotullimet nse ka token.\r\n * Prditson gameState.isGameOver.\r\n */\r\nexport function updateGameOverState() {\r\n    // Kontrollo vetm nse ka pjes aktive n raft\r\n    const activePieces = gameState.currentPieces.filter(p => p);\r\n    if (activePieces.length === 0) {\r\n        gameState.isGameOver = false; // Nuk ka pjes, nuk mund t jet game over\r\n        return;\r\n    }\r\n\r\n    for (const piece of activePieces) {\r\n        // 1. Provo formn aktuale (pa rrotullim)\r\n        if (canPieceBePlaced(piece.currentShape)) {\r\n            gameState.isGameOver = false;\r\n            return;\r\n        }\r\n        \r\n        // 2. Nse ka token rrotullimi, provo edhe rrotullimet\r\n        if (gameState.rotateTokens > 0) {\r\n            let shape = piece.currentShape;\r\n            for (let rot = 1; rot < 4; rot++) { // Fillo nga rrotullimi 1 (0 sht aktuale)\r\n                shape = rotatePiece({ ...piece, currentShape: shape }).currentShape;\r\n                if (canPieceBePlaced(shape)) {\r\n                    gameState.isGameOver = false;\r\n                    return;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Nse arrijm ktu, asnj pjes nuk mund t vendoset\r\n    gameState.isGameOver = true;\r\n}\r\n\r\n// --- SISTEMA E RE PR VEPRIME SPECIALE ---\r\n\r\n/**\r\n * Ruan gjendjen aktuale t lojs pr undo functionality\r\n */\r\nexport function saveGameState() {\r\n    const currentState = {\r\n        grid: gameState.grid.map(row => [...row]), // Deep copy\r\n        score: gameState.score,\r\n        currentPieces: gameState.currentPieces.map(piece => {\r\n            if (!piece) return null;\r\n            return {\r\n                ...piece,\r\n                currentShape: Array.isArray(piece.currentShape) ? [...piece.currentShape] : piece.currentShape\r\n            };\r\n        }),\r\n        combo: { ...gameState.combo },\r\n        rotateTokens: gameState.rotateTokens,\r\n        undoTokens: gameState.undoTokens,\r\n        clearLineTokens: gameState.clearLineTokens,\r\n        swapTokens: gameState.swapTokens,\r\n        timestamp: Date.now()\r\n    };\r\n    \r\n    gameState.gameHistory.push(currentState);\r\n    \r\n    // Ruaj vetm 10 hapat e fundit pr t menaxhuar memorjen\r\n    if (gameState.gameHistory.length > 10) {\r\n        gameState.gameHistory.shift();\r\n    }\r\n}\r\n\r\n/**\r\n * Kthen lojn n gjendjen e mparshme\r\n * @returns {boolean} true nse undo u krye me sukses\r\n */\r\nexport function undoLastMove() {\r\n    if (gameState.gameHistory.length === 0) {\r\n        return false;\r\n    }\r\n    \r\n    const previousState = gameState.gameHistory.pop();\r\n    \r\n    // Rivendos gjendjen e mparshme\r\n    gameState.grid = previousState.grid;\r\n    gameState.score = previousState.score;\r\n    gameState.currentPieces = previousState.currentPieces;\r\n    gameState.combo = previousState.combo;\r\n    gameState.rotateTokens = previousState.rotateTokens;\r\n    gameState.undoTokens = previousState.undoTokens;\r\n    gameState.clearLineTokens = previousState.clearLineTokens;\r\n    gameState.swapTokens = previousState.swapTokens;\r\n    \r\n    return true;\r\n}\r\n\r\n/**\r\n * Kontrollon nse nj rresht ose kolon sht e plot\r\n * @param {number} index - Indeksi i rreshtit ose kolons\r\n * @param {boolean} isRow - true pr rresht, false pr kolon\r\n * @returns {boolean}\r\n */\r\nexport function isLineComplete(index, isRow) {\r\n    if (isRow) {\r\n        return gameState.grid[index].every(cell => cell !== 0);\r\n    } else {\r\n        return gameState.grid.every(row => row[index] !== 0);\r\n    }\r\n}\r\n\r\n/**\r\n * Merr koordinatat e t gjitha qelizave n nj rresht ose kolon\r\n * @param {number} index - Indeksi i rreshtit ose kolons\r\n * @param {boolean} isRow - true pr rresht, false pr kolon\r\n * @returns {Array} Array me koordinatat {row, col}\r\n */\r\nexport function getLineCells(index, isRow) {\r\n    const cells = [];\r\n    if (isRow) {\r\n        for (let c = 0; c < GRID_COLS; c++) {\r\n            cells.push({ row: index, col: c });\r\n        }\r\n    } else {\r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            cells.push({ row: r, col: index });\r\n        }\r\n    }\r\n    return cells;\r\n}\r\n\r\n/**\r\n * Rrotullon nj pjes specifike duke prdorur token\r\n * @param {number} pieceIndex - Indeksi i pjess pr t'u rrotulluar\r\n * @returns {boolean} true nse rrotullimi u krye me sukses\r\n */\r\nexport function rotateSpecificPiece(pieceIndex) {\r\n    if (gameState.rotateTokens <= 0 || !gameState.currentPieces[pieceIndex]) {\r\n        return false;\r\n    }\r\n    \r\n    gameState.currentPieces[pieceIndex] = rotatePiece(gameState.currentPieces[pieceIndex]);\r\n    // Change ID to force UI update since only shape changed\r\n    gameState.currentPieces[pieceIndex].id = Date.now() + Math.random();\r\n    \r\n    return true;\r\n}\r\n\r\n/**\r\n * Funksion ndihms q kontrollon nse nj form mund t vendoset n grid\r\n * @param {array} shape - Forma pr t kontrolluar\r\n * @returns {boolean} - True nse forma mund t vendoset diku\r\n */\r\nfunction canPieceBePlaced(shape) {\r\n    for (let r = 0; r < GRID_ROWS; r++) {\r\n        for (let c = 0; c < GRID_COLS; c++) {\r\n            if (isValidPlacement(shape, r, c)) {\r\n                return true;\r\n            }\r\n        }\r\n    }\r\n    return false;\r\n}\r\n\r\n/**\r\n * Konverton numrin e ngjyrs n ngjyr CSS.\r\n * @param {number} colorNumber - Numri i ngjyrs nga gameState.grid\r\n * @returns {string} - Ngjyra CSS (hex code)\r\n */\r\nexport function getBaseColor(colorNumber) {\r\n    switch(colorNumber) {\r\n        case 1: return '#0072ff'; // Blu i thell\r\n        case 2: return '#56ab2f'; // Jeshile e gjall\r\n        case 3: return '#6b4f2a'; // Dark bronze\r\n        case 4: return '#fc4a1a'; // Portokalli i zjarrt\r\n        case 5: return '#333399'; // Purpur/Lejla\r\n        case 6: return '#fecfef'; // Roz e but\r\n        case 7: return '#fed6e3'; // Roz e leht\r\n        default: return '#FFD700'; // Default ari\r\n    }\r\n}\r\n\r\n/**\r\n * Gjen t gjitha pozicionet e mundshme ku mund t vendoset nj pjes.\r\n * @param {object} piece - Pjesa q do t vendoset\r\n * @returns {array} - Lista e pozicioneve t mundshme {row, col}\r\n */\r\nexport function findValidPlacements(piece) {\r\n    const validPlacements = [];\r\n    const shape = piece.currentShape || piece.shape;\r\n    \r\n    for (let row = 0; row < GRID_ROWS; row++) {\r\n        for (let col = 0; col < GRID_COLS; col++) {\r\n            if (isValidPlacement(shape, row, col)) {\r\n                validPlacements.push({ row, col });\r\n            }\r\n        }\r\n    }\r\n    \r\n    return validPlacements;\r\n}\r\n\r\n/**\r\n * Gjen vendet m t mira strategjike pr vendosjen e nj pjese (me caching)\r\n * @param {Object} piece - Pjesa pr t ciln duam t gjejm vendet m t mira\r\n * @returns {Array} Array me vendet m t mira t renditura sipas strategjis\r\n */\r\nexport function findBestPlacements(piece) {\r\n    // Krijo cache key bazuar n piece shape dhe grid state\r\n    const shapeKey = JSON.stringify(piece.currentShape || piece.shape);\r\n    const gridChecksum = calculateGridChecksum();\r\n    const cacheKey = `${shapeKey}-${gridChecksum}`;\r\n    \r\n    // Kontrollo cache\r\n    if (placementCache.has(cacheKey)) {\r\n        return placementCache.get(cacheKey);\r\n    }\r\n    \r\n    const allValidPlacements = findValidPlacements(piece);\r\n    const shape = piece.currentShape || piece.shape;\r\n    \r\n    if (allValidPlacements.length === 0) {\r\n        placementCache.set(cacheKey, []);\r\n        return [];\r\n    }\r\n    \r\n    // Vlerso do vendosje dhe jep pik strategjike\r\n    const scoredPlacements = allValidPlacements.map(placement => {\r\n        const { row, col } = placement;\r\n        const score = calculatePlacementScore(shape, row, col);\r\n        return { ...placement, score };\r\n    });\r\n    \r\n    // Renditi sipas pikve (m t mirt n fillim)\r\n    scoredPlacements.sort((a, b) => b.score - a.score);\r\n    \r\n    // Merr vetm 5-8 vendet m t mira (jo t gjitha)\r\n    const bestPlacements = scoredPlacements.slice(0, Math.min(8, Math.max(3, Math.ceil(scoredPlacements.length * 0.2))));\r\n    \r\n    // Ruaj n cache\r\n    placementCache.set(cacheKey, bestPlacements);\r\n    \r\n    return bestPlacements;\r\n}\r\n\r\n/**\r\n * Kalkulon nj checksum t shpejt pr grid state\r\n * @returns {string} - Checksum i grid-it\r\n */\r\nfunction calculateGridChecksum() {\r\n    let hash = 0;\r\n    for (let r = 0; r < GRID_ROWS; r++) {\r\n        for (let c = 0; c < GRID_COLS; c++) {\r\n            hash = ((hash << 5) - hash + gameState.grid[r][c]) >>> 0; // 32-bit rolling hash\r\n        }\r\n    }\r\n    return hash.toString(16);\r\n}\r\n\r\n/**\r\n * Kalkulon score-n pr nj placement specifik\r\n * @param {Array} shape - Forma e pjess\r\n * @param {number} row - Rreshti\r\n * @param {number} col - Kolona\r\n * @returns {number} - Score i placement-it\r\n */\r\nfunction calculatePlacementScore(shape, row, col) {\r\n    let score = 0;\r\n    \r\n    // 1. BONUS pr vendosje n qoshe (strategjike pr loj)\r\n    const isCorner = (row === 0 || row === GRID_ROWS - 1) && (col === 0 || col === GRID_COLS - 1);\r\n    if (isCorner) score += 50;\r\n    \r\n    // 2. BONUS pr vendosje pran mureve\r\n    const nearWall = (row === 0 || row === GRID_ROWS - 1 || col === 0 || col === GRID_COLS - 1);\r\n    if (nearWall) score += 30;\r\n    \r\n    // 3. BONUS pr vendosje q mund t kompletojn rreshta/kolona\r\n    const completionBonus = calculateCompletionPotential(shape, row, col);\r\n    score += completionBonus * 20;\r\n    \r\n    // 4. BONUS pr vendosje pran pjesve ekzistuese (konsolidim)\r\n    const adjacencyBonus = calculateAdjacencyBonus(shape, row, col);\r\n    score += adjacencyBonus * 15;\r\n    \r\n    // 5. PENALITET pr vendosje n mes (m pak strategjike)\r\n    const isCenter = row > 2 && row < GRID_ROWS - 3 && col > 2 && col < GRID_COLS - 3;\r\n    if (isCenter) score -= 20;\r\n    \r\n    return score;\r\n}\r\n\r\n/**\r\n * Kalkulon potencialin pr kompletimin e rreshtave/kolonave\r\n */\r\nfunction calculateCompletionPotential(shape, startRow, startCol) {\r\n    let potential = 0;\r\n    \r\n    // Kontrollo pr do rresht q prekon kjo pjes\r\n    const occupiedRows = new Set();\r\n    const occupiedCols = new Set();\r\n    \r\n    shape.forEach(([r, c]) => {\r\n        const gridRow = startRow + r;\r\n        const gridCol = startCol + c;\r\n        if (isInBounds(gridRow, gridCol)) {\r\n            occupiedRows.add(gridRow);\r\n            occupiedCols.add(gridCol);\r\n        }\r\n    });\r\n    \r\n    // Kontrollo sa t mbushura jan rreshtat/kolonat\r\n    occupiedRows.forEach(row => {\r\n        let filledCells = 0;\r\n        for (let col = 0; col < GRID_COLS; col++) {\r\n            if (gameState.grid[row][col] !== 0) filledCells++;\r\n        }\r\n        const fillPercentage = filledCells / GRID_COLS;\r\n        if (fillPercentage > 0.6) potential += fillPercentage * 2; // Bonus i lart pr rreshta pothuajse t mbushur\r\n    });\r\n    \r\n    occupiedCols.forEach(col => {\r\n        let filledCells = 0;\r\n        for (let row = 0; row < GRID_ROWS; row++) {\r\n            if (gameState.grid[row][col] !== 0) filledCells++;\r\n        }\r\n        const fillPercentage = filledCells / GRID_ROWS;\r\n        if (fillPercentage > 0.6) potential += fillPercentage * 2; // Bonus i lart pr kolona pothuajse t mbushura\r\n    });\r\n    \r\n    return potential;\r\n}\r\n\r\n/**\r\n * Kalkulon bonusin pr vendosje pran pjesve ekzistuese\r\n */\r\nfunction calculateAdjacencyBonus(shape, startRow, startCol) {\r\n    let adjacentCount = 0;\r\n    \r\n    shape.forEach(([r, c]) => {\r\n        const gridRow = startRow + r;\r\n        const gridCol = startCol + c;\r\n        \r\n        if (isInBounds(gridRow, gridCol)) {\r\n            // Kontrollo qelizat prreth\r\n            const directions = [[-1, 0], [1, 0], [0, -1], [0, 1]];\r\n            directions.forEach(([dr, dc]) => {\r\n                const checkRow = gridRow + dr;\r\n                const checkCol = gridCol + dc;\r\n                if (isInBounds(checkRow, checkCol) &&\r\n                    gameState.grid[checkRow][checkCol] !== 0) {\r\n                    adjacentCount++;\r\n                }\r\n            });\r\n        }\r\n    });\r\n    \r\n    return adjacentCount;\r\n}\r\n\r\n","// js/audio.js\r\n// Menaxhon t gjith logjikn pr tingujt dhe feedback-un haptik.\r\n\r\nimport { gameState } from './state.js'; // Importo gjendjen pr t kontrolluar pauzn/game over\r\n\r\nlet audioContext;\r\nlet isAudioInitialized = false;\r\n\r\n/**\r\n * Inicializon AudioContext. Duhet t thirret vetm nj her pas interaksionit\r\n * t par t prdoruesit pr t respektuar politikat e browser-ave.\r\n */\r\nexport function initAudioContext() {\r\n    if (isAudioInitialized) return;\r\n    try {\r\n        // Krijo AudioContext. Prdor 'webkit' pr pajtueshmri me Safari m t vjetr.\r\n        audioContext = new (window.AudioContext || window.webkitAudioContext)();\r\n        isAudioInitialized = true;\r\n    } catch (e) {\r\n        // Audio initialization failed - continue silently\r\n    }\r\n}\r\n\r\n/**\r\n * Funksion i brendshm, i prgjithshm pr t luajtur nj not muzikore.\r\n * @param {number} frequency Frekuenca e nots n Hz.\r\n * @param {number} duration Kohzgjatja n sekonda.\r\n * @param {number} volume Volumi (0.0 deri 1.0).\r\n * @param {string} type Tipi i vals ('sine', 'square', 'sawtooth', 'triangle').\r\n */\r\nfunction playTone(frequency, duration, volume, type = 'sine', { allowWhenInactive = false } = {}) {\r\n    if (!isAudioInitialized || !audioContext) return;\r\n    \r\n    // Check if sound is enabled\r\n    const soundEnabled = localStorage.getItem('soundEnabled') !== 'false';\r\n    if (!soundEnabled) return;\r\n    \r\n    // Mos luaj tinguj n pauz/game over, prve rasteve kur krkohet shprehimisht\r\n    if ((gameState.isPaused || gameState.isGameOver) && !allowWhenInactive) return;\r\n\r\n    const oscillator = audioContext.createOscillator();\r\n    const gainNode = audioContext.createGain();\r\n\r\n    oscillator.connect(gainNode);\r\n    gainNode.connect(audioContext.destination);\r\n\r\n    oscillator.type = type;\r\n    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);\r\n    gainNode.gain.setValueAtTime(volume, audioContext.currentTime);\r\n    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);\r\n\r\n    oscillator.start(audioContext.currentTime);\r\n    oscillator.stop(audioContext.currentTime + duration);\r\n}\r\n\r\n/**\r\n * Aktivizon vibrimin n pajisjet q e suportojn.\r\n * @param {number|number[]} duration Kohzgjatja e vibrimit n milisekonda.\r\n */\r\nexport function playHapticFeedback(duration = 50) {\r\n    // Check if vibration is enabled\r\n    const vibrationEnabled = localStorage.getItem('vibrationEnabled') !== 'false';\r\n    if (!vibrationEnabled) return;\r\n    \r\n    if (window.navigator && window.navigator.vibrate) {\r\n        window.navigator.vibrate(duration);\r\n    }\r\n}\r\n\r\n\r\n// --- Tingujt specifik t lojs ---\r\n\r\nexport const playPlaceSound = () => {\r\n    playTone(440, 0.1, 0.3, 'square');\r\n    playHapticFeedback(30);\r\n};\r\n\r\nexport const playClearSound = (numLines) => {\r\n    playTone(600 + (numLines * 50), 0.15, 0.4, 'triangle');\r\n    playHapticFeedback([50, 30, 50]);\r\n};\r\n\r\nexport const playComboSound = (comboCount) => {\r\n    playTone(800 + (comboCount * 100), 0.2, 0.5, 'sine');\r\n};\r\n\r\nexport const playGameOverSound = () => {\r\n    // Luaj tingullin edhe nse loja sht n pauz\r\n    initAudioContext();\r\n    if (!audioContext) return;\r\n    playTone(200, 0.5, 0.5, 'sawtooth', { allowWhenInactive: true });\r\n    setTimeout(() => playTone(150, 0.5, 0.5, 'sawtooth', { allowWhenInactive: true }), 200);\r\n};\r\n\r\nexport const playRotateSound = () => {\r\n    playTone(1200, 0.05, 0.1, 'sine');\r\n    playHapticFeedback(20);\r\n}\r\n/**\r\n * UI button click sound effect\r\n */\r\nexport const playUIButtonSound = () => {\r\n    // Ensure audio context is initialized on user gesture\r\n    initAudioContext();\r\n    // Resume context if suspended (common on browsers) so sound plays reliably\r\n    if (audioContext && audioContext.state === 'suspended') {\r\n        audioContext.resume();\r\n    }\r\n    // Simple click tone and light haptic feedback\r\n    playTone(400, 0.05, 0.3, 'square', { allowWhenInactive: true });\r\n    playHapticFeedback(20);\r\n};\r\n\r\n// Specialized sound for pause action\r\nexport const playPauseSound = () => {\r\n    initAudioContext();\r\n    if (audioContext && audioContext.state === 'suspended') {\r\n        audioContext.resume();\r\n    }\r\n    playTone(250, 0.1, 0.3, 'triangle', { allowWhenInactive: true });\r\n    playHapticFeedback(30);\r\n};\r\n\r\n// Specialized sound for resume action\r\nexport const playResumeSound = () => {\r\n    initAudioContext();\r\n    if (audioContext && audioContext.state === 'suspended') {\r\n        audioContext.resume();\r\n    }\r\n    playTone(550, 0.1, 0.3, 'triangle', { allowWhenInactive: true });\r\n    playHapticFeedback(30);\r\n};\r\n\r\n// Specialized sound for restart action\r\nexport const playRestartSound = () => {\r\n    initAudioContext();\r\n    if (audioContext && audioContext.state === 'suspended') {\r\n        audioContext.resume();\r\n    }\r\n    playTone(700, 0.1, 0.3, 'sawtooth', { allowWhenInactive: true });\r\n    playHapticFeedback(40);\r\n};\r\n\r\n// Gentle sound for piece appearance animation\r\nexport const playPieceAppearSound = () => {\r\n    initAudioContext();\r\n    if (audioContext && audioContext.state === 'suspended') {\r\n        audioContext.resume();\r\n    }\r\n    // Soft, pleasant tone for piece entrance\r\n    playTone(660, 0.08, 0.15, 'sine');\r\n    playHapticFeedback(15);\r\n};","// Rendering and UI update functions\r\n\r\nimport { gameState } from './state.js';\r\nimport { GRID_ROWS, GRID_COLS } from './constants.js';\r\nimport { pieceUnlockSystem } from './pieceUnlockSystem.js';\r\nimport * as audio from './audio.js';\r\n\r\n//  PERFORMANCE: Object Pool to reduce Garbage Collection pauses\r\nclass AnimationPool {\r\n    constructor(size = 100) {\r\n        this.pool = Array.from({ length: size }, () => ({ r: 0, c: 0, delay: 0 }));\r\n        this.index = 0;\r\n    }\r\n    acquire() {\r\n        const item = this.pool[this.index];\r\n        this.index = (this.index + 1) % this.pool.length;\r\n        return item;\r\n    }\r\n}\r\nconst animPool = new AnimationPool();\r\n\r\n// Element Cache\r\nconst dom = {};\r\nlet cellElements = [];\r\n// Cache pr highlighted cells pr performance\r\nlet highlightedCells = new Set();\r\n// Track current highlight state to avoid redundant updates\r\nlet lastHighlightedCells = new Set();\r\nlet lastHighlightClass = '';\r\nlet lastPieceColor = '';\r\nconst PIECE_ANIMATION_DURATION = 950;\r\n\r\n\r\n\r\n\r\n/**\r\n * Gjen t gjitha elementet e nevojshme nga DOM-i dhe i ruan n objektin 'dom'.\r\n */\r\nexport function cacheDOMElements() {\r\n    const ids = [\r\n        'landingPage', 'startButton', 'gameGrid', 'piecesContainer', 'score',\r\n        'highscore-display', 'restartButton', 'pauseButton', 'settingsButton',\r\n        'gameOverMessage', 'gameOverRestartButton', 'darkModeToggleGame',\r\n        'particles-overlay', 'comboMessage', 'themeSelectorContainer', 'draggedPieceClone',\r\n        'pieces-unlocked', 'achievements-count', 'finalScore', 'gameOverHighScore'\r\n    ];\r\n    ids.forEach(id => dom[id] = document.getElementById(id));\r\n    dom.gameContainer = document.querySelector('.game-container');\r\n    \r\n    // Note: createUnlockProgressIndicator() moved to initializeState based on game mode\r\n}\r\n\r\n/**\r\n * Krijon indicator pr unlock progress\r\n */\r\nfunction createUnlockProgressIndicator() {\r\n    // Remove existing progress indicator if it exists\r\n    const existingProgress = document.getElementById('unlock-progress');\r\n    if (existingProgress) {\r\n        existingProgress.remove();\r\n    }\r\n    \r\n    \r\n    const progressDiv = document.createElement('div');\r\n    progressDiv.id = 'unlock-progress';\r\n    progressDiv.className = 'unlock-progress';\r\n    progressDiv.innerHTML = `\r\n        <h4> Piece Collection</h4>\r\n        <div class=\"progress-bar\">\r\n            <div class=\"progress-fill\" id=\"progress-fill\"></div>\r\n        </div>\r\n        <div class=\"progress-text\" id=\"progress-text\">7/30 pieces unlocked</div>\r\n        <div class=\"progress-text\" id=\"next-unlock-text\">Next unlock: 1000 points</div>\r\n    `;\r\n    document.body.appendChild(progressDiv);\r\n    dom.unlockProgress = progressDiv;\r\n    // Close progress indicator on click\r\n    const onClickOutside = (e) => {\r\n        if (!progressDiv.contains(e.target)) {\r\n            cleanup();\r\n        }\r\n    };\r\n    const cleanup = () => {\r\n        if (progressDiv.parentNode) {\r\n            progressDiv.remove();\r\n        }\r\n        document.removeEventListener('click', onClickOutside);\r\n        if (autoDismissId) {\r\n            clearTimeout(autoDismissId);\r\n        }\r\n    };\r\n    progressDiv.addEventListener('click', cleanup);\r\n    // Auto-dismiss after 3 seconds\r\n    const autoDismissId = setTimeout(() => {\r\n        cleanup();\r\n    }, 3000);\r\n    // Close on click outside progress indicator\r\n    document.addEventListener('click', onClickOutside);\r\n    \r\n    // Update initial progress\r\n    updateUnlockProgress();\r\n}\r\n\r\n/**\r\n * Krijon rrjetn e qelizave n DOM vetm nj her. Kjo sht thelbsore pr performancn.\r\n */\r\nexport function createGridDOM() {\r\n    dom.gameGrid.innerHTML = '';\r\n    cellElements = [];\r\n    for (let r = 0; r < GRID_ROWS; r++) {\r\n        const rowElements = [];\r\n        for (let c = 0; c < GRID_COLS; c++) {\r\n            const cell = document.createElement('div');\r\n            cell.classList.add('grid-cell');\r\n            cell.dataset.row = r;\r\n            cell.dataset.col = c;\r\n            \r\n            // Create a block wrapper inside the cell - this is what we animate\r\n            const blockWrapper = document.createElement('div');\r\n            blockWrapper.classList.add('grid-cell-block');\r\n            cell.appendChild(blockWrapper);\r\n            \r\n            dom.gameGrid.appendChild(cell);\r\n            rowElements.push(cell);\r\n        }\r\n        cellElements.push(rowElements);\r\n    }\r\n}\r\n\r\n/**\r\n * Krijon elementin HTML pr nj pjes t vetme.\r\n */\r\nfunction createPieceElement(pieceData, index) {\r\n    const pieceElement = document.createElement('div');\r\n    pieceElement.classList.add('piece');\r\n    pieceElement.dataset.pieceIndex = index;\r\n\r\n    if (!pieceData) {\r\n        pieceElement.classList.add('empty');\r\n        pieceElement.dataset.pieceId = '';\r\n        return pieceElement;\r\n    }\r\n    \r\n    // Add piece ID for tracking changes\r\n    pieceElement.dataset.pieceId = pieceData.id ? pieceData.id.toString() : '';\r\n    \r\n    pieceElement.setAttribute('draggable', 'true');\r\n    const pieceGrid = createPieceGridElement(pieceData);\r\n    pieceElement.appendChild(pieceGrid);\r\n    \r\n    return pieceElement;\r\n}\r\n\r\n/**\r\n * Krijon rrjetn vizuale pr nj pjes (prdoret pr pjest n raft dhe pr klonin).\r\n */\r\nfunction createPieceGridElement(pieceData) {\r\n    const pieceGrid = document.createElement('div');\r\n    pieceGrid.classList.add('piece-grid');\r\n\r\n    let maxRow = 0, maxCol = 0;\r\n    pieceData.currentShape.forEach(([r, c]) => {\r\n        maxRow = Math.max(maxRow, r);\r\n        maxCol = Math.max(maxCol, c);\r\n    });\r\n\r\n    pieceGrid.style.gridTemplateRows = `repeat(${maxRow + 1}, var(--piece-block-size))`;\r\n    pieceGrid.style.gridTemplateColumns = `repeat(${maxCol + 1}, var(--piece-block-size))`;\r\n\r\n    const visualGrid = Array.from({ length: maxRow + 1 }, () => Array(maxCol + 1).fill(0));\r\n    pieceData.currentShape.forEach(([r, c]) => { visualGrid[r][c] = pieceData.color; });\r\n\r\n    for (let r = 0; r <= maxRow; r++) {\r\n        for (let c = 0; c <= maxCol; c++) {\r\n            const block = document.createElement('div');\r\n            block.classList.add('piece-block');\r\n            if (visualGrid[r][c] !== 0) {\r\n                block.classList.add(`color-${visualGrid[r][c]}`);\r\n                block.dataset.shapeRow = r;\r\n                block.dataset.shapeCol = c;\r\n            } else {\r\n                block.style.visibility = 'hidden';\r\n            }\r\n            pieceGrid.appendChild(block);\r\n        }\r\n    }\r\n    \r\n    return pieceGrid;\r\n}\r\n\r\nfunction hasPieceChanged(existingElement, newPieceData) {\r\n    const shouldBeEmpty = !newPieceData;\r\n    const isCurrentlyEmpty = !existingElement || existingElement.classList.contains('empty');\r\n\r\n    if (shouldBeEmpty || isCurrentlyEmpty) {\r\n        return shouldBeEmpty !== isCurrentlyEmpty;\r\n    }\r\n\r\n    const existingId = existingElement.dataset.pieceId || '';\r\n    const nextId = newPieceData.id ? newPieceData.id.toString() : '';\r\n    return existingId !== nextId;\r\n}\r\n\r\nfunction animatePieceEntry(pieceElement, index, { isInitialLoad = false, allowSound = true } = {}) {\r\n    if (!pieceElement || pieceElement.classList.contains('empty')) {\r\n        return;\r\n    }\r\n\r\n    pieceElement.classList.add('new-piece');\r\n\r\n    if (isInitialLoad) {\r\n        const delay = index * 150;\r\n        pieceElement.style.animationDelay = `${delay}ms`;\r\n        if (allowSound) {\r\n            setTimeout(() => audio.playPieceAppearSound(), delay);\r\n        }\r\n        setTimeout(() => {\r\n            pieceElement.classList.remove('new-piece');\r\n            pieceElement.style.animationDelay = '';\r\n        }, PIECE_ANIMATION_DURATION + delay);\r\n        return;\r\n    }\r\n\r\n    if (allowSound) {\r\n        audio.playPieceAppearSound();\r\n    }\r\n    setTimeout(() => {\r\n        pieceElement.classList.remove('new-piece');\r\n    }, PIECE_ANIMATION_DURATION);\r\n}\r\n\r\nfunction rebuildPiecesContainer({ animateAll = false } = {}) {\r\n    if (!dom.piecesContainer) {\r\n        return;\r\n    }\r\n\r\n    dom.piecesContainer.innerHTML = '';\r\n    gameState.currentPieces.forEach((pieceData, index) => {\r\n        const pieceElement = createPieceElement(pieceData, index);\r\n        dom.piecesContainer.appendChild(pieceElement);\r\n        if (animateAll) {\r\n            animatePieceEntry(pieceElement, index, { isInitialLoad: true, allowSound: true });\r\n        }\r\n    });\r\n}\r\n\r\n// --- Main Render Functions ---\r\n\r\n/**\r\n *  PERFORMANCE: Batched DOM updates to prevent Layout Thrashing\r\n * PHASE 1: READ all DOM state without modifications\r\n * PHASE 2: WRITE all changes in batch (single layout recalculation)\r\n */\r\nexport function updateGridDisplay() {\r\n    const updates = []; // Store changes temporarily\r\n\r\n    // PHASE 1: READ ONLY (Do not touch DOM)\r\n    for (let r = 0; r < GRID_ROWS; r++) {\r\n        for (let c = 0; c < GRID_COLS; c++) {\r\n            const cellValue = gameState.grid[r][c];\r\n            const cellElement = cellElements[r][c];\r\n            \r\n            // Check if wrapper exists without creating it yet\r\n            let blockWrapper = cellElement.firstChild;\r\n            let needsCreation = !blockWrapper;\r\n            \r\n            updates.push({\r\n                cellElement,\r\n                blockWrapper, \r\n                needsCreation,\r\n                cellValue,\r\n                // Calculate class here, not during write\r\n                newClass: cellValue !== 0 ? `filled-${cellValue}` : null\r\n            });\r\n        }\r\n    }\r\n\r\n    // PHASE 2: WRITE ONLY (Apply changes)\r\n    updates.forEach(({ cellElement, blockWrapper, needsCreation, cellValue, newClass }) => {\r\n        if (needsCreation) {\r\n            blockWrapper = document.createElement('div');\r\n            blockWrapper.classList.add('grid-cell-block');\r\n            cellElement.appendChild(blockWrapper);\r\n        }\r\n\r\n        // Reset classes\r\n        blockWrapper.className = 'grid-cell-block';\r\n\r\n        // Add new class if needed\r\n        if (newClass) {\r\n            blockWrapper.classList.add(newClass);\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Clears lastPlacement after one render cycle to avoid re-animating\r\n */\r\nexport function clearPlacementFlag() {\r\n    // Reset lastPlacementCells to avoid re-triggering animation\r\n    gameState.lastPlacementCells = [];\r\n}\r\n/**\r\n * Animon qelizat e sapo vendosura me nj efekt vale fluid dhe organik.\r\n * @param {Array<{r:number, c:number}>} cells - Vargu i pozicioneve t qelizave pr t'u animuar.\r\n */\r\nexport function animatePlacement(cells) {\r\n    if (!Array.isArray(cells) || cells.length === 0) return;\r\n\r\n    let centerR = 0;\r\n    let centerC = 0;\r\n    cells.forEach(({ r, c }) => {\r\n        centerR += r;\r\n        centerC += c;\r\n    });\r\n    centerR /= cells.length;\r\n    centerC /= cells.length;\r\n\r\n    const cellsWithDelay = cells.map(({ r, c }) => {\r\n        //  Use pool instead of creating new object\r\n        const obj = animPool.acquire(); \r\n        \r\n        // Simple distance calculation for ripple effect\r\n        // Assuming grid center is roughly 4,4 (adjust if grid size differs)\r\n        const distance = Math.hypot(r - 4, c - 4); \r\n        \r\n        obj.r = r;\r\n        obj.c = c;\r\n        obj.delay = distance * 30; \r\n        return obj;\r\n    });\r\n\r\n    cells.forEach(({ r, c }) => {\r\n        const cell = cellElements[r]?.[c];\r\n        if (!cell) return;\r\n        const blockWrapper = cell.querySelector('.grid-cell-block');\r\n        if (!blockWrapper) return;\r\n        blockWrapper.classList.remove('placed');\r\n        blockWrapper.style.animation = 'none';\r\n        void blockWrapper.offsetWidth;\r\n    });\r\n\r\n    cellsWithDelay.forEach(({ r, c, delay }) => {\r\n        const cell = cellElements[r]?.[c];\r\n        if (!cell) return;\r\n        const blockWrapper = cell.querySelector('.grid-cell-block');\r\n        if (!blockWrapper) return;\r\n\r\n        const jitter = (Math.random() - 0.5) * 14;\r\n        const finalDelay = Math.max(0, delay + jitter);\r\n\r\n        blockWrapper.style.animation = '';\r\n        blockWrapper.style.animationDelay = `${finalDelay}ms`;\r\n        blockWrapper.classList.add('placed');\r\n\r\n        blockWrapper.addEventListener('animationend', () => {\r\n            blockWrapper.classList.remove('placed');\r\n            blockWrapper.style.animationDelay = '';\r\n        }, { once: true });\r\n    });\r\n}\r\n\r\n/**\r\n * Prditson pamjen e pjesve n dispozitiv.\r\n */\r\nexport function updatePiecesDisplay(isInitialLoad = false) {\r\n    if (!dom.piecesContainer || !Array.isArray(gameState.currentPieces)) {\r\n        return;\r\n    }\r\n\r\n    const renderedPieces = Array.from(dom.piecesContainer.children);\r\n    const nextPieces = gameState.currentPieces;\r\n\r\n    if (isInitialLoad || renderedPieces.length !== nextPieces.length) {\r\n        rebuildPiecesContainer({ animateAll: isInitialLoad });\r\n        return;\r\n    }\r\n\r\n    const changedIndices = [];\r\n    for (let i = 0; i < nextPieces.length; i++) {\r\n        if (hasPieceChanged(renderedPieces[i], nextPieces[i])) {\r\n            changedIndices.push(i);\r\n        }\r\n    }\r\n\r\n    if (changedIndices.length === 0) {\r\n        return;\r\n    }\r\n\r\n    let soundPlayed = false;\r\n    changedIndices.forEach((index) => {\r\n        const newPieceData = nextPieces[index];\r\n        const newElement = createPieceElement(newPieceData, index);\r\n        const reference = renderedPieces[index];\r\n\r\n        if (reference && reference.parentNode === dom.piecesContainer) {\r\n            reference.replaceWith(newElement);\r\n        } else if (dom.piecesContainer.children[index]) {\r\n            dom.piecesContainer.replaceChild(newElement, dom.piecesContainer.children[index]);\r\n        } else {\r\n            dom.piecesContainer.appendChild(newElement);\r\n        }\r\n\r\n        if (newPieceData) {\r\n            const allowSound = !soundPlayed;\r\n            animatePieceEntry(newElement, index, { allowSound, isInitialLoad: false });\r\n            if (allowSound) {\r\n                soundPlayed = true;\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Prditson shfaqjen e pikve dhe pikve m t larta.\r\n */\r\nexport function updateScoreDisplay() {\r\n    // Update current score text\r\n    dom.score.textContent = gameState.score;\r\n    // Pop animation on score change\r\n    const scoreEl = dom.score;\r\n    if (scoreEl) {\r\n        scoreEl.classList.remove('score-animated');\r\n        void scoreEl.offsetWidth; // force reflow to restart animation\r\n        scoreEl.classList.add('score-animated');\r\n    }\r\n    if (gameState.score > gameState.highScore) {\r\n        gameState.highScore = gameState.score;\r\n        localStorage.setItem('blokusHighScore', gameState.highScore);\r\n    }\r\n    // Update high score only in landing page, not during game\r\n    if (dom['highscore-display']) {\r\n        dom['highscore-display'].textContent = gameState.highScore;\r\n    }\r\n}\r\n/**\r\n * Prditson unlock progress indicator\r\n */\r\nfunction updateUnlockProgress() {\r\n    const gameMode = localStorage.getItem('selectedGameMode') || 'collection';\r\n    \r\n    // Only update progress in Collection Mode\r\n    if (gameMode !== 'collection') {\r\n        return;\r\n    }\r\n    \r\n    const progressInfo = pieceUnlockSystem.getProgressInfo();\r\n    \r\n    const progressFill = document.getElementById('progress-fill');\r\n    const progressText = document.getElementById('progress-text');\r\n    const nextUnlockText = document.getElementById('next-unlock-text');\r\n    \r\n    if (progressFill) {\r\n        progressFill.style.width = `${progressInfo.percentage}%`;\r\n    }\r\n    \r\n    if (progressText) {\r\n        progressText.textContent = `${progressInfo.unlockedCount}/${progressInfo.totalPieces} pieces unlocked`;\r\n    }\r\n    \r\n    if (nextUnlockText && progressInfo.nextUnlock) {\r\n        nextUnlockText.textContent = `Next: ${progressInfo.nextUnlock.name} (${progressInfo.nextUnlock.remaining} points)`;\r\n    } else if (nextUnlockText) {\r\n        nextUnlockText.textContent = \" All pieces unlocked!\";\r\n    }\r\n}\r\n\r\n\r\n// --- UI Panels and Messages ---\r\n\r\n/**\r\n * Update overlays - now only handles game over screen\r\n */\r\nexport function updateOverlays() {\r\n    try {\r\n        const showGameOver = gameState.isGameOver;\r\n\r\n        if (dom.gameOverMessage) {\r\n            dom.gameOverMessage.classList.toggle('hidden', !showGameOver);\r\n            \r\n            // If showing game over, attach the Play Again listener\r\n            if (showGameOver) {\r\n                setTimeout(() => {\r\n                    const playAgainBtn = document.getElementById('gameOverRestartButton');\r\n                    \r\n                    if (playAgainBtn) {\r\n                        // Remove existing listeners\r\n                        playAgainBtn.onclick = null;\r\n                        const newBtn = playAgainBtn.cloneNode(true);\r\n                        playAgainBtn.parentNode.replaceChild(newBtn, playAgainBtn);\r\n                        \r\n                        newBtn.addEventListener('click', function(e) {\r\n                            e.preventDefault();\r\n                            e.stopPropagation();\r\n                            \r\n                            // Import necessary modules and restart game\r\n                            import('./state.js').then(({ initializeState }) => {\r\n                                import('./gameLogic.js').then((logic) => {\r\n                                    // Hide game over message\r\n                                    dom.gameOverMessage.classList.add('hidden');\r\n                                    \r\n                                    // Reset game state\r\n                                    initializeState();\r\n                                    logic.populateInitialPieces();\r\n                                    \r\n                                    // Update displays\r\n                                    updateGridDisplay();\r\n                                    updatePiecesDisplay();\r\n                                    updateScoreDisplay();\r\n                                    updateOverlays();\r\n                                    \r\n                                    // Re-attach piece event listeners using main.js function\r\n                                    setTimeout(() => {\r\n                                        if (window.attachPieceEventListeners) {\r\n                                            window.attachPieceEventListeners();\r\n                                        } else {\r\n                                            // Fallback: try to call the function from main module\r\n                                            import('./main.js').then((main) => {\r\n                                                if (main.attachPieceEventListeners) {\r\n                                                    main.attachPieceEventListeners();\r\n                                                }\r\n                                            });\r\n                                        }\r\n                                    }, 200);\r\n                                    \r\n                                }).catch(err => console.log('Error loading gameLogic:', err));\r\n                            }).catch(err => console.log('Error loading state:', err));\r\n                        });\r\n                        \r\n                    }\r\n                }, 100);\r\n            }\r\n        }\r\n\r\n        // Only dim background when game over overlay is active, not when paused\r\n        if (showGameOver) {\r\n            if (dom.piecesContainer) dom.piecesContainer.style.opacity = '0.5';\r\n            if (dom.gameGrid) dom.gameGrid.style.opacity = '0.5';\r\n        } else {\r\n            if (dom.piecesContainer) dom.piecesContainer.style.opacity = '1';\r\n            if (dom.gameGrid) dom.gameGrid.style.opacity = '1';\r\n        }\r\n    } catch (error) {\r\n        // Silent error handling - continue operation\r\n    }\r\n}\r\n\r\nexport function showGameOverMessage() {\r\n    // Update final score and high score in game over screen\r\n    if (dom.finalScore) {\r\n        dom.finalScore.textContent = gameState.score;\r\n    }\r\n    if (dom.gameOverHighScore) {\r\n        dom.gameOverHighScore.textContent = gameState.highScore;\r\n    }\r\n    \r\n    dom.gameOverMessage.classList.remove('hidden');\r\n    dom.piecesContainer.style.opacity = '0.5';\r\n    \r\n    // Attach play again listener\r\n    setTimeout(() => {\r\n        const playAgainBtn = document.getElementById('gameOverRestartButton');\r\n        \r\n        if (playAgainBtn) {\r\n            // Remove any existing listeners\r\n            playAgainBtn.onclick = null;\r\n            const newBtn = playAgainBtn.cloneNode(true);\r\n            playAgainBtn.parentNode.replaceChild(newBtn, playAgainBtn);\r\n            \r\n            // Add new listener - reload page to restart game\r\n            newBtn.addEventListener('click', function(e) {\r\n                e.preventDefault();\r\n                e.stopPropagation();\r\n                location.reload();\r\n            });\r\n        }\r\n    }, 500);\r\n}\r\n\r\nexport function hideGameOverMessage() {\r\n    dom.gameOverMessage.classList.add('hidden');\r\n    dom.piecesContainer.style.opacity = '1';\r\n}\r\n\r\nexport function updateControlButtons() {\r\n    if (dom.pauseButton) {\r\n        dom.pauseButton.disabled = gameState.isGameOver;\r\n        dom.pauseButton.innerHTML = gameState.isPaused ? '<i class=\"fas fa-play\"></i>' : '<i class=\"fas fa-pause\"></i>';\r\n        dom.pauseButton.title = gameState.isPaused ? 'Resume Game' : 'Pause Game';\r\n        dom.pauseButton.setAttribute('aria-label', gameState.isPaused ? 'Resume Game' : 'Pause Game');\r\n    }\r\n    \r\n    if (dom.restartButton) {\r\n        dom.restartButton.disabled = gameState.isGameOver;\r\n        // Explicitly show or hide restart button based on pause state\r\n        if (gameState.isPaused) {\r\n            dom.restartButton.classList.remove('hidden');\r\n        } else {\r\n            dom.restartButton.classList.add('hidden');\r\n        }\r\n    }\r\n}\r\n// Shfaq mesazh combo spektakolar\r\nexport function showComboMessage(comboCount) {\r\n    const comboMsg = dom.comboMessage;\r\n    comboMsg.textContent = comboCount >= 5 ? `SPEKTAKOLARE! COMBO x${comboCount}` : `Combo x${comboCount}`;\r\n    comboMsg.classList.remove('hidden');\r\n    if (comboCount >= 5) comboMsg.classList.add('spectacular');\r\n    setTimeout(() => {\r\n        comboMsg.classList.add('hidden');\r\n        comboMsg.classList.remove('spectacular');\r\n    }, 1200);\r\n}\r\n\r\n\r\n/**\r\n * Clean up old floating score elements to prevent memory leaks\r\n */\r\nexport function cleanupOldFloatingScores() {\r\n    const floatingScores = document.querySelectorAll('.floating-score');\r\n    const now = Date.now();\r\n    const maxAge = 5000; // 5 seconds max age\r\n    \r\n    floatingScores.forEach(element => {\r\n        const created = parseInt(element.dataset.created);\r\n        if (created && (now - created) > maxAge) {\r\n            element.remove();\r\n        }\r\n    });\r\n}\r\n\r\n// --- Drag & Drop Visuals (nga dragVisuals.js) ---\r\n\r\n/**\r\n * Krijon klonin vizual t pjess q trhiqet.\r\n */\r\nexport function createDraggedPieceClone(pieceData) {\r\n    if (!dom.draggedPieceClone) {\r\n        console.warn('draggedPieceClone element not found in DOM');\r\n        return;\r\n    }\r\n    \r\n    const pieceGrid = createPieceGridElement(pieceData);\r\n    dom.draggedPieceClone.innerHTML = '';\r\n    // Mark the clone container so CSS can easily exclude it from grid animations\r\n    dom.draggedPieceClone.setAttribute('data-clone', 'true');\r\n    // Mark inner blocks so they can be targeted precisely if needed\r\n    pieceGrid.querySelectorAll('.piece-block').forEach(b => b.classList.add('clone-block'));\r\n    dom.draggedPieceClone.appendChild(pieceGrid);\r\n    dom.draggedPieceClone.classList.remove('hidden', 'shake');\r\n    dom.draggedPieceClone.classList.add('show');\r\n    \r\n    // Cache geometry metrics for smoother drag calculations\r\n    let blockSize = 30;\r\n    const cloneBlock = dom.draggedPieceClone.querySelector('.piece-block');\r\n    if (cloneBlock) {\r\n        const rect = cloneBlock.getBoundingClientRect();\r\n        blockSize = rect.width;\r\n    }\r\n\r\n    let gap = 0;\r\n    const cloneGrid = dom.draggedPieceClone.querySelector('.piece-grid');\r\n    if (cloneGrid) {\r\n        const computed = getComputedStyle(cloneGrid);\r\n        const gapValue = computed.gap || computed.gridGap;\r\n        const parsedGap = parseFloat(gapValue);\r\n        if (!Number.isNaN(parsedGap)) {\r\n            gap = parsedGap;\r\n        }\r\n    }\r\n\r\n    const cloneStyle = getComputedStyle(dom.draggedPieceClone);\r\n    const paddingX = parseFloat(cloneStyle.paddingLeft) || 0;\r\n    const paddingY = parseFloat(cloneStyle.paddingTop) || 0;\r\n\r\n    Object.assign(gameState.dragState, {\r\n        blockSize,\r\n        gap,\r\n        paddingX,\r\n        paddingY,\r\n        metricsCached: true,\r\n    });\r\n    // debug logs removed for production\r\n}\r\n\r\nexport function hideDraggedPieceClone() {\r\n    dom.draggedPieceClone.classList.remove('show');\r\n}\r\n\r\nexport function shakeDraggedPieceClone(duration) {\r\n    dom.draggedPieceClone.classList.add('shake');\r\n    setTimeout(() => {\r\n        dom.draggedPieceClone.classList.remove('shake');\r\n    }, duration);\r\n}\r\n\r\n/**\r\n * Prditson pozicionin e klonit t trhequr pr t ndjekur kursorin/gishtin,\r\n * duke marr parasysh padding-un pr pozicionim t sakt t bllokut t ankors.\r\n * OPTIMIZED: Avoids offsetWidth/offsetHeight reads which force reflow\r\n */\r\nexport function updateDraggedPiecePosition(clientX, clientY) {\r\n    if (!dom.draggedPieceClone) return;\r\n    if (!dom.draggedPieceClone.classList.contains('show')) return;\r\n    // aktivizo do transformim ekzistues\r\n    dom.draggedPieceClone.style.transform = 'none';\r\n    const { offsetX, offsetY } = gameState.dragState;\r\n    \r\n    let { blockSize, gap, paddingX, paddingY, metricsCached, cloneWidth, cloneHeight } = gameState.dragState;\r\n\r\n    if (!metricsCached) {\r\n        let measuredBlockSize = blockSize;\r\n        const cloneBlock = dom.draggedPieceClone.querySelector('.piece-block');\r\n        if (cloneBlock) {\r\n            const rect = cloneBlock.getBoundingClientRect();\r\n            measuredBlockSize = rect.width;\r\n        }\r\n\r\n        let measuredGap = gap;\r\n        const cloneGrid = dom.draggedPieceClone.querySelector('.piece-grid');\r\n        if (cloneGrid) {\r\n            const computed = getComputedStyle(cloneGrid);\r\n            const gapValue = computed.gap || computed.gridGap;\r\n            const parsedGap = parseFloat(gapValue);\r\n            if (!Number.isNaN(parsedGap)) {\r\n                measuredGap = parsedGap;\r\n            }\r\n        }\r\n\r\n        const cloneStyle = getComputedStyle(dom.draggedPieceClone);\r\n        const measuredPaddingX = parseFloat(cloneStyle.paddingLeft) || 0;\r\n        const measuredPaddingY = parseFloat(cloneStyle.paddingTop) || 0;\r\n        \r\n        // CRITICAL: Cache clone dimensions ONCE to avoid offsetWidth/offsetHeight reflows during drag\r\n        const measuredWidth = dom.draggedPieceClone.offsetWidth || 80;\r\n        const measuredHeight = dom.draggedPieceClone.offsetHeight || 80;\r\n\r\n        Object.assign(gameState.dragState, {\r\n            blockSize: measuredBlockSize || 30,\r\n            gap: !Number.isNaN(measuredGap) ? measuredGap : 0,\r\n            paddingX: measuredPaddingX,\r\n            paddingY: measuredPaddingY,\r\n            metricsCached: true,\r\n            cloneWidth: measuredWidth,\r\n            cloneHeight: measuredHeight,\r\n        });\r\n\r\n        ({ blockSize, gap, paddingX, paddingY, cloneWidth, cloneHeight } = gameState.dragState);\r\n    }\r\n\r\n    if (!blockSize || blockSize <= 0) {\r\n        blockSize = 30;\r\n    }\r\n    if (!Number.isFinite(gap)) {\r\n        gap = 0;\r\n    }\r\n    if (!Number.isFinite(paddingX)) {\r\n        paddingX = 0;\r\n    }\r\n    if (!Number.isFinite(paddingY)) {\r\n        paddingY = 0;\r\n    }\r\n\r\n    // Llogaritjet e pozicionit - vendos gishtin n qendrn e bllokut t ankors\r\n    const anchorXInClone = paddingX + (offsetX * (blockSize + gap)) + (blockSize / 2);\r\n    const anchorYInClone = paddingY + (offsetY * (blockSize + gap)) + (blockSize / 2);\r\n    \r\n    // Prdor metodn absolute t pozicionimit\r\n    const rawLeft = clientX - anchorXInClone;\r\n    const rawTop = clientY - anchorYInClone;\r\n    \r\n    // FIX: HEQJE e viewport clamping - kloni duhet t lviz lirshm n screen\r\n    // Viewport clamping po e bnte klonin ndalohet brenda ekranit dhe nuk shfaqej n qelizat e poshtme t grids\r\n    // Tani clone lviz lirshm me pointer pa klamping artificial\r\n    // Ghost preview (highlighted cells) po punojn sakt sepse jan grid-cell-based\r\n    \r\n    // OPTIMIZATION: Prdor transform translate3d pr hardware acceleration\r\n    // Kjo sht shum m e shpejt se left/top n mobile\r\n    // Use setProperty with 'important' to override any stylesheet rules that might\r\n    // force transform to 'none' (some legacy CSS used '!important'). This ensures\r\n    // the inline transform is applied on all browsers.\r\n    // DRAG LATENCY FIX: Direct translate3d keeps clone perfectly in sync with pointer\r\n    dom.draggedPieceClone.style.setProperty('transform', `translate3d(${rawLeft}px, ${rawTop}px, 0)`, 'important');\r\n    dom.draggedPieceClone.style.left = '0';\r\n    dom.draggedPieceClone.style.top = '0';\r\n}\r\n\r\n/**\r\n * Pastron t gjitha highlight-et dhe hijet nga rrjeta.\r\n * OPTIMIZED: Prdor cache n vend t querySelectorAll pr performance m t mir\r\n */\r\nexport function clearHighlights() {\r\n    highlightedCells.forEach(cell => {\r\n        // Remove highlight classes from the cell itself\r\n        cell.classList.remove('highlight', 'invalid-highlight');\r\n        \r\n        // Clean up ghost + color classes from the inner block wrapper\r\n        const blockWrapper = cell.querySelector('.grid-cell-block');\r\n        if (blockWrapper) {\r\n            blockWrapper.classList.remove('ghost');\r\n            if (lastPieceColor) {\r\n                blockWrapper.classList.remove(`filled-${lastPieceColor}`);\r\n            }\r\n        }\r\n        \r\n        // Clear any inline background styles\r\n        cell.style.backgroundColor = '';\r\n    });\r\n    // Clear cache\r\n    highlightedCells.clear();\r\n}\r\n\r\n/**\r\n * Shfaq hijen e pjess n rrjet ku do t vendoset.\r\n * OPTIMIZED: Prdor cache dhe redukton DOM manipulations\r\n */\r\nexport function showGhostAndHighlight(piece, startRow, startCol, isValid) {\r\n    clearHighlights();\r\n    const highlightClass = isValid ? 'highlight' : 'invalid-highlight';\r\n    \r\n    // Cache the piece color for cleanup later\r\n    lastPieceColor = piece.color;\r\n    lastHighlightClass = highlightClass;\r\n    \r\n    piece.currentShape.forEach(([r, c]) => {\r\n        const gridRow = startRow + r;\r\n        const gridCol = startCol + c;\r\n        if (gridRow >= 0 && gridRow < GRID_ROWS && gridCol >= 0 && gridCol < GRID_COLS) {\r\n            const cell = cellElements[gridRow][gridCol];\r\n            if (!cell) return;\r\n            \r\n            const blockWrapper = cell.querySelector('.grid-cell-block');\r\n            if (!blockWrapper) return;\r\n            \r\n            // Check if the underlying blockWrapper is already filled on the grid\r\n            const isGridFilled = Array.from(blockWrapper.classList).some(cls => cls.startsWith('filled-'));\r\n            \r\n            // Only draw ghost/highlight on empty grid blocks\r\n            if (!isGridFilled) {\r\n                cell.classList.add(highlightClass);\r\n                if (isValid) {\r\n                    // Apply ghost class + filled color for the 3D designed appearance\r\n                    // The filled-* class provides the 3D block design, ghost makes it semi-transparent\r\n                    blockWrapper.classList.add('ghost', `filled-${piece.color}`);\r\n                }\r\n                // Track the cell for fast cleanup later\r\n                highlightedCells.add(cell);\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n\r\n/**\r\n * Prditson emrin e tems q shfaqet n faqe\r\n * @param {string} themeName - Emri i tems\r\n */\r\n/**\r\n * Krijon elementet dinamik pr temn \"Future Galaxies\"\r\n */\r\n/**\r\n * Krijon elementet dinamik pr temn \"Future Galaxies - Universi i Pafund\"\r\n */\r\nfunction createGalaxyElements() {\r\n    // Krijo yjet e afrt\r\n    const closeStars = document.createElement('div');\r\n    closeStars.className = 'close-stars galaxy-element';\r\n    closeStars.style.overflow = 'hidden';\r\n    document.body.appendChild(closeStars);\r\n\r\n    // Krijo nebula efektet\r\n    const nebula1 = document.createElement('div');\r\n    nebula1.className = 'nebula-1 galaxy-element';\r\n    document.body.appendChild(nebula1);\r\n\r\n    const nebula2 = document.createElement('div');\r\n    nebula2.className = 'nebula-2 galaxy-element';\r\n    document.body.appendChild(nebula2);\r\n\r\n    // Krijo yje kryesore me shklqim\r\n    const celestialBodies = document.createElement('div');\r\n    celestialBodies.className = 'galaxy-element';\r\n    celestialBodies.style.position = 'fixed';\r\n    celestialBodies.style.top = '0';\r\n    celestialBodies.style.left = '0';\r\n    celestialBodies.style.width = '100%';\r\n    celestialBodies.style.height = '100%';\r\n    celestialBodies.style.pointerEvents = 'none';\r\n    \r\n    // Krijo 40 yje kryesore\r\n    for (let i = 0; i < 40; i++) {\r\n        const star = document.createElement('div');\r\n        star.className = 'celestial-star';\r\n        \r\n        // Pozicionim\r\n        star.style.left = `${Math.random() * 100}%`;\r\n        star.style.top = `${Math.random() * 100}%`;\r\n        \r\n        // Madhsi dhe shklqim\r\n        const size = Math.random() * 1.2 + 0.3;\r\n        star.style.width = `${size}px`;\r\n        star.style.height = `${size}px`;\r\n        \r\n        // Animacion personalizuar\r\n        star.style.animationDelay = `${Math.random() * 5}s`;\r\n        star.style.animationDuration = `${Math.random() * 5 + 5}s`;\r\n        \r\n        // Shto efekte 3D t lehta\r\n        star.style.transform = `translateZ(${Math.random() * 100}px)`;\r\n        \r\n        celestialBodies.appendChild(star);\r\n    }\r\n    document.body.appendChild(celestialBodies);\r\n\r\n    // Krijo comets\r\n    const comets = [\r\n        { top: '20%', left: '10%', delay: '3s' },\r\n        { top: '70%', left: '30%', delay: '8s' }\r\n    ];\r\n\r\n    comets.forEach(cometData => {\r\n        const comet = document.createElement('div');\r\n        comet.className = 'comet galaxy-element';\r\n        comet.style.top = cometData.top;\r\n        comet.style.left = cometData.left;\r\n        comet.style.animationDelay = cometData.delay;\r\n        document.body.appendChild(comet);\r\n    });\r\n\r\n    // Krijo starfield me Canvas pr realism maksimal\r\n    createStarfield();\r\n    \r\n    // Krijo efekte dinamike\r\n    createDynamicEffects();\r\n}\r\n\r\n/**\r\n * Krijon yje shtes me Canvas pr realism\r\n */\r\nfunction createStarfield() {\r\n    const canvas = document.createElement('canvas');\r\n    canvas.className = 'starfield-canvas galaxy-element';\r\n    canvas.style.position = 'fixed';\r\n    canvas.style.top = '0';\r\n    canvas.style.left = '0';\r\n    canvas.style.width = '100%';\r\n    canvas.style.height = '100%';\r\n    canvas.style.pointerEvents = 'none';\r\n    canvas.style.zIndex = '-4';\r\n    document.body.appendChild(canvas);\r\n    \r\n    // Inicializo canvas\r\n    const ctx = canvas.getContext('2d');\r\n    canvas.width = window.innerWidth;\r\n    canvas.height = window.innerHeight;\r\n    \r\n    // Vizato yje t vegjl\r\n    for (let i = 0; i < 2000; i++) {\r\n        const x = Math.random() * canvas.width;\r\n        const y = Math.random() * canvas.height;\r\n        const opacity = Math.random();\r\n        const radius = Math.random() * 0.5;\r\n        \r\n        ctx.beginPath();\r\n        ctx.arc(x, y, radius, 0, Math.PI * 2);\r\n        ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;\r\n        ctx.fill();\r\n    }\r\n    \r\n    // Prditso kur ndryshon madhsia\r\n    window.addEventListener('resize', () => {\r\n        canvas.width = window.innerWidth;\r\n        canvas.height = window.innerHeight;\r\n    });\r\n}\r\n\r\n/**\r\n * Krijon efekte dinamike\r\n */\r\nfunction createDynamicEffects() {\r\n    // Krijo disa yje pulsuese t mdhenj\r\n    for (let i = 0; i < 5; i++) {\r\n        const pulsar = document.createElement('div');\r\n        pulsar.className = 'celestial-star galaxy-element';\r\n        pulsar.style.left = `${10 + (i * 20)}%`;\r\n        pulsar.style.top = `${15 + (i * 10)}%`;\r\n        pulsar.style.width = '2px';\r\n        pulsar.style.height = '2px';\r\n        pulsar.style.boxShadow = '0 0 10px 5px rgba(255,255,255,0.7)';\r\n        pulsar.style.animation = 'pulsar-glow 3s ease-in-out infinite';\r\n        pulsar.style.zIndex = '-3';\r\n        document.body.appendChild(pulsar);\r\n    }\r\n}\r\n\r\n /**\r\n * Highlights grid lines that can be cleared\r\n */\r\nexport function highlightClearableLines() {\r\n    clearLineHighlights();\r\n    \r\n    // Check all rows\r\n    for (let r = 0; r < GRID_ROWS; r++) {\r\n        if (gameState.grid[r].every(cell => cell !== 0)) {\r\n            for (let c = 0; c < GRID_COLS; c++) {\r\n                cellElements[r][c].classList.add('clearable-line');\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Check all columns\r\n    for (let c = 0; c < GRID_COLS; c++) {\r\n        let isColFull = true;\r\n        for (let r = 0; r < GRID_ROWS; r++) {\r\n            if (gameState.grid[r][c] === 0) {\r\n                isColFull = false;\r\n                break;\r\n            }\r\n        }\r\n        if (isColFull) {\r\n            for (let r = 0; r < GRID_ROWS; r++) {\r\n                cellElements[r][c].classList.add('clearable-line');\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Removes clearable line highlights\r\n */\r\nexport function clearLineHighlights() {\r\n    document.querySelectorAll('.grid-cell.clearable-line').forEach(cell => {\r\n        cell.classList.remove('clearable-line');\r\n    });\r\n}\r\n\r\n/**\r\n * Periodic cleanup function to remove old particles that may have been missed\r\n * This prevents memory leaks from accumulating DOM elements\r\n */\r\nexport function cleanupOldParticles() {\r\n    if (!dom['particles-overlay']) return;\r\n    \r\n    const overlay = dom['particles-overlay'];\r\n    const particles = overlay.querySelectorAll('.particle');\r\n    const now = Date.now();\r\n    const maxAge = 5000; // 5 seconds max age\r\n    \r\n    particles.forEach(particle => {\r\n        const created = parseInt(particle.dataset.created);\r\n        if (created && (now - created) > maxAge) {\r\n            // Clear timeout if it exists\r\n            const timeoutId = particle.dataset.timeoutId;\r\n            if (timeoutId) {\r\n                clearTimeout(parseInt(timeoutId));\r\n            }\r\n            particle.remove();\r\n        }\r\n    });\r\n}\r\n\r\n// Run periodic cleanup every 10 seconds\r\nsetInterval(cleanupOldParticles, 10000);\r\n\r\n\r\n\r\nexport { dom, createUnlockProgressIndicator };\r\n\r\n","let __perfLite=false;document.addEventListener('perf:lite',()=>{__perfLite=true});\r\n// === Kodi pr backgroundEffects.js ===\r\n\r\nfunction createMagicStars() {\r\n    const container = document.getElementById('magicStars');\r\n    if (!container) return;\r\n    container.innerHTML = ''; // Pastron yjet e vjetr\r\n    const colors = ['rgba(255, 200, 255, 0.9)', 'rgba(200, 220, 255, 0.9)', 'rgba(255, 220, 200, 0.9)'];\r\n    for (let i = 0; i < (__perfLite ? 8 : 25); i++) {\r\n        const star = document.createElement('div');\r\n        star.className = 'magic-star';\r\n        star.style.left = `${Math.random() * 100}%`;\r\n        star.style.top = `${Math.random() * 100}%`;\r\n        const size = Math.random() * 5 + 3;\r\n        star.style.width = `${size}px`;\r\n        star.style.height = `${size}px`;\r\n        star.style.background = colors[Math.floor(Math.random() * colors.length)];\r\n        star.style.animationDelay = `${Math.random() * 5}s`;\r\n        container.appendChild(star);\r\n    }\r\n}\r\n\r\nfunction createSpecialShapes() {\r\n    const container = document.getElementById('specialShapes');\r\n    if (!container) return;\r\n    container.innerHTML = '';\r\n    for (let i = 0; i < (__perfLite ? 4 : 10); i++) {\r\n        const shape = document.createElement('div');\r\n        shape.className = Math.random() > 0.5 ? 'star-shape' : 'heart-shape';\r\n        shape.style.left = `${Math.random() * 100}%`;\r\n        shape.style.top = `${Math.random() * 100}%`;\r\n        const color = `hsl(${Math.random() * 60 + 300}, 80%, 80%)`;\r\n        shape.style.background = color;\r\n        shape.style.animationDelay = `${Math.random() * 10}s`;\r\n        shape.style.animationDuration = `${Math.random() * 10 + 10}s`;\r\n        container.appendChild(shape);\r\n    }\r\n}\r\n\r\nfunction createSparkles() {\r\n    const container = document.getElementById('sparkles');\r\n    if (!container) return;\r\n    container.innerHTML = '';\r\n    for (let i = 0; i < (__perfLite ? 10 : 30); i++) {\r\n        const sparkle = document.createElement('div');\r\n        sparkle.className = 'sparkle';\r\n        sparkle.style.left = `${Math.random() * 100}%`;\r\n        sparkle.style.top = `${Math.random() * 100}%`;\r\n        sparkle.style.animationDelay = `${Math.random() * 30}s`;\r\n        sparkle.style.animationDuration = `${Math.random() * 30 + 45}s`; // 45-75 seconds for gentle snow\r\n        const size = Math.random() * 4 + 2;\r\n        sparkle.style.width = `${size}px`;\r\n        sparkle.style.height = `${size}px`;\r\n        container.appendChild(sparkle);\r\n    }\r\n}\r\n\r\n// Kto dy funksione do t'i thrrassh nga main.js pr t ndezur ose fikur sfondin\r\nexport function activateMagicUniverseBackground() {\r\n    const bgContainer = document.querySelector('.magic-universe-background');\r\n    if (bgContainer) {\r\n        bgContainer.style.display = 'block';\r\n    }\r\n    createMagicStars();\r\n    createSpecialShapes();\r\n    createSparkles();\r\n}\r\n\r\nexport function deactivateMagicUniverseBackground() {\r\n    const bgContainer = document.querySelector('.magic-universe-background');\r\n    if (bgContainer) {\r\n        bgContainer.style.display = 'none'; // Hide the background when deactivated\r\n    }\r\n}\r\n\r\nfunction __pb(){const c=document.querySelector('.magic-universe-background'); if(c) c.classList.add('paused');}\r\nfunction __rb(){const c=document.querySelector('.magic-universe-background'); if(c) c.classList.remove('paused');}\r\ndocument.addEventListener('visibilitychange',()=>{document.hidden?__pb():__rb()});\r\ndocument.addEventListener('app:pause',__pb);document.addEventListener('app:resume',__rb);\r\n","export async function applyStatusBar(theme){try{const S=window.Capacitor?.Plugins?.StatusBar;if(!S)return;if(theme==='dark'){await S.setStyle({style:'DARK'});await S.setBackgroundColor({color:'#0b0f1a'})}else{await S.setStyle({style:'LIGHT'});await S.setBackgroundColor({color:'#f2f5ff'})}}catch{}}","let e=new URLSearchParams(location.search).get('debug')==='1',t=null,a=0;export function initDebugOverlay(){if(!e||t)return;t=document.createElement('div');t.id='fpsOverlay';t.textContent='FPS: --';document.body.appendChild(t);let n=0,o=performance.now();const r=s=>{n++;if(s-o>=1000){t&&(t.textContent='FPS: '+n);n=0;o=s}a=requestAnimationFrame(r)};a=requestAnimationFrame(r)}","export const isNative=!!(window.Capacitor&&window.Capacitor.isNativePlatform);export function readyNativeUI(){if(isNative)document.body.classList.add('capacitor-native')}export function attachAppLifecycle(){const A=window.Capacitor?.Plugins?.App;if(!A)return;try{A.addListener('appStateChange',({isActive})=>{const ev=new CustomEvent(isActive?'app:resume':'app:pause');document.dispatchEvent(ev);})}catch{}}export async function hapticTap(){try{const H=window.Capacitor?.Plugins?.Haptics;if(H?.impact)await H.impact({style:'light'})}catch{}}export async function hapticSuccess(){try{const H=window.Capacitor?.Plugins?.Haptics;if(H?.notification)await H.notification({type:'SUCCESS'});else if(H?.impact)await H.impact({style:'Medium'})}catch{}}export async function hapticHeavy(){try{const H=window.Capacitor?.Plugins?.Haptics;if(H?.impact)await H.impact({style:'Heavy'})}catch{}}","// Galaxy Row Clear Animation Adapter\r\n// Integrated into the game's row-clear flow\r\n// Blocks use piece styling; particles emerge from cells without touching grid\r\n// VERSION: 3.0 (Dynamic color system - theme-aware)\r\n\r\nimport { GRID_ROWS, GRID_COLS } from '../constants.js';\r\nimport { getBaseColor } from '../gameLogic.js';\r\n\r\n// Time to call onComplete callback (non-blocking, decoupled from visual duration)\r\nconst LOGIC_DELAY_MS = 80;\r\n\r\n// Time to wait before cleaning up DOM (matches visual animation end - 1000ms for faster, smoother experience)\r\nconst VISUAL_CLEANUP_DELAY_MS = 1000;\r\n\r\n/**\r\n * Get the frame color - prioritize placedPieceColor if provided\r\n * @param {number} placedPieceColor - Color number (1-7) or null\r\n * @param {string} dominantColor - Fallback if placedPieceColor not provided\r\n * @returns {string} - Hex color code\r\n */\r\nfunction getFrameColor(placedPieceColor, dominantColor) {\r\n    const isDarkTheme = document.body.getAttribute('data-theme') === 'dark';\r\n    \r\n    // Support two types for placedPieceColor:\r\n    // - number (1-7) -> palette index, use getBaseColor\r\n    // - string (hex or rgb) -> use directly as base color\r\n    if ((typeof placedPieceColor === 'number' && placedPieceColor >= 1 && placedPieceColor <= 7) || (typeof placedPieceColor === 'string' && placedPieceColor)) {\r\n        let baseColor = typeof placedPieceColor === 'number' ? getBaseColor(placedPieceColor) : placedPieceColor;\r\n        \r\n        // Adaptive lightening for dark theme based on color brightness\r\n        if (isDarkTheme) {\r\n            const brightness = getColorBrightness(baseColor);\r\n            \r\n            // Adaptive lightening strategy:\r\n            // - Dark colors (< 100 brightness): lighten 40%\r\n            // - Medium colors (100-180): lighten 25%\r\n            // - Light colors (180-220): lighten 10%\r\n            // - Very light colors (> 220): no lightening (already visible)\r\n            let lightenPercent = 0;\r\n            if (brightness < 100) {\r\n                lightenPercent = 40;\r\n            } else if (brightness < 180) {\r\n                lightenPercent = 25;\r\n            } else if (brightness < 220) {\r\n                lightenPercent = 10;\r\n            }\r\n            // else: ngjyra sht tashm shum e leht, mos e ndrio\r\n            \r\n            if (lightenPercent > 0) {\r\n                baseColor = lightenColor(baseColor, lightenPercent);\r\n            }\r\n        }\r\n        \r\n        return baseColor;\r\n    }\r\n    return dominantColor; // Fallback to dominant color from grid\r\n}\r\n\r\n/**\r\n * Extract colors from grid cells and adapt for current theme\r\n * If placedPieceColor is provided, use ONLY that color for all particles (unified design)\r\n * Otherwise extract actual colors from cells\r\n * @param {NodeList} cellElements - All grid cells\r\n * @param {number} rowOrColIndex - The row/column index to extract colors from\r\n * @param {boolean} isRow - True if extracting from row, false if from column\r\n * @param {number} placedPieceColor - Color number (1-7) of the piece that caused the clear, or null\r\n * @returns {Object} - {colors: Array<string>, dominantColor: string}\r\n */\r\nfunction extractCellColors(cellElements, rowOrColIndex, isRow, placedPieceColor = null) {\r\n    const isDarkTheme = document.body.getAttribute('data-theme') === 'dark';\r\n    \r\n    // If placedPieceColor is provided, use ONLY that color for unified effect\r\n    if (placedPieceColor && placedPieceColor >= 1 && placedPieceColor <= 7) {\r\n        let pieceColor = getBaseColor(placedPieceColor);\r\n        \r\n        // Lighten for dark theme if needed\r\n        if (isDarkTheme) {\r\n            const brightness = getColorBrightness(pieceColor);\r\n            let lightenPercent = 0;\r\n            if (brightness < 100) {\r\n                lightenPercent = 40;\r\n            } else if (brightness < 180) {\r\n                lightenPercent = 25;\r\n            } else if (brightness < 220) {\r\n                lightenPercent = 10;\r\n            }\r\n            if (lightenPercent > 0) {\r\n                pieceColor = lightenColor(pieceColor, lightenPercent);\r\n            }\r\n        }\r\n        \r\n        // Return same color repeated + cyan accent for sparkle\r\n        // All particles will use the piece color for unified design\r\n        return { \r\n            colors: [pieceColor, pieceColor, pieceColor, '#22d3ee'], \r\n            dominantColor: pieceColor \r\n        };\r\n    }\r\n    \r\n    // Original logic: extract colors from actual grid cells\r\n    const colorCount = {};\r\n    const colors = [];\r\n    \r\n    cellElements.forEach((cell, idx) => {\r\n        const cellPos = isRow ? Math.floor(idx / GRID_COLS) : idx % GRID_COLS;\r\n        if (cellPos === rowOrColIndex) {\r\n            const blockWrapper = cell.querySelector('.grid-cell-block');\r\n            if (!blockWrapper) return;\r\n            \r\n            // Find filled-X class to get color number\r\n            const filledClass = Array.from(blockWrapper.classList).find(cls => cls.startsWith('filled-'));\r\n            if (filledClass) {\r\n                const colorNumber = parseInt(filledClass.replace('filled-', ''));\r\n                let baseColor = getBaseColor(colorNumber);\r\n                \r\n                // Lighten colors for dark theme to maintain visibility\r\n                if (isDarkTheme) {\r\n                    baseColor = lightenColor(baseColor, 20);\r\n                }\r\n                \r\n                colors.push(baseColor);\r\n                colorCount[baseColor] = (colorCount[baseColor] || 0) + 1;\r\n            }\r\n        }\r\n    });\r\n    \r\n    // Find dominant color (most frequent)\r\n    let dominantColor = '#60a5fa'; // Default cyan-blue\r\n    let maxCount = 0;\r\n    for (const [color, count] of Object.entries(colorCount)) {\r\n        if (count > maxCount) {\r\n            maxCount = count;\r\n            dominantColor = color;\r\n        }\r\n    }\r\n    \r\n    // Add cyan accent for sparkle effect (complements most colors)\r\n    colors.push('#22d3ee');\r\n    \r\n    // If no colors found, use theme-appropriate defaults\r\n    if (colors.length === 1) {\r\n        const defaults = isDarkTheme \r\n            ? ['#60a5fa', '#22d3ee', '#a78bfa']\r\n            : ['#3b82f6', '#06b6d4', '#8b5cf6'];\r\n        return { colors: defaults, dominantColor: defaults[0] };\r\n    }\r\n    \r\n    return { colors, dominantColor };\r\n}\r\n\r\n/**\r\n * Lighten a hex color by a percentage\r\n * @param {string} hex - Hex color code\r\n * @param {number} percent - Percentage to lighten (0-100)\r\n * @returns {string} - Lightened hex color\r\n */\r\nfunction lightenColor(hex, percent) {\r\n    const num = parseInt(hex.replace('#', ''), 16);\r\n    const r = Math.min(255, ((num >> 16) & 0xff) + Math.round(255 * (percent / 100)));\r\n    const g = Math.min(255, ((num >> 8) & 0xff) + Math.round(255 * (percent / 100)));\r\n    const b = Math.min(255, (num & 0xff) + Math.round(255 * (percent / 100)));\r\n    return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;\r\n}\r\n\r\n/**\r\n * Calculate color brightness (0-255 scale)\r\n * @param {string} hex - Hex color code\r\n * @returns {number} - Brightness value (0-255)\r\n */\r\nfunction getColorBrightness(hex) {\r\n    const num = parseInt(hex.replace('#', ''), 16);\r\n    const r = (num >> 16) & 0xff;\r\n    const g = (num >> 8) & 0xff;\r\n    const b = num & 0xff;\r\n    // Use perceived brightness formula (human eye sensitivity)\r\n    return (r * 0.299 + g * 0.587 + b * 0.114);\r\n}\r\n\r\nfunction getGridCellBorderRadius(gameGrid) {\r\n    const fallbackVar = getComputedStyle(document.documentElement).getPropertyValue('--grid-cell-radius')?.trim();\r\n    const fallback = fallbackVar && fallbackVar.length ? fallbackVar : '8px';\r\n\r\n    if (!gameGrid) {\r\n        return fallback;\r\n    }\r\n\r\n    try {\r\n        const sampleCell = gameGrid.querySelector('.grid-cell');\r\n        if (sampleCell) {\r\n            const computed = window.getComputedStyle(sampleCell).borderRadius;\r\n            if (computed && computed.trim().length) {\r\n                return computed;\r\n            }\r\n        }\r\n    } catch (err) {\r\n        console.warn('[galaxyRowClear] Failed to read grid cell border radius', err);\r\n    }\r\n\r\n    return fallback;\r\n}\r\n\r\n/**\r\n * Trigger a subtle shake on the main game area to emphasize clears.\r\n * @param {number} duration - ms to keep the shake class applied (default 380ms)\r\n */\r\nfunction triggerGameAreaShake(duration = 380) {\r\n    try {\r\n        // Prefer animating the inner grid element because some mobile CSS\r\n        // pins `.game-area` with `transform: translate(...) !important` which\r\n        // can prevent transform-based animations from being visible. Animating\r\n        // `.game-grid` (the actual grid) avoids that conflict. Fall back to\r\n        // `.game-grid-container` if present, otherwise `.game-area`.\r\n        const container = document.querySelector('.game-area .game-grid') || document.querySelector('.game-area .game-grid-container') || document.querySelector('.game-area');\r\n        if (!container) return;\r\n        const normalCls = 'ext-game-area-shake';\r\n        const strongCls = 'ext-game-area-shake-strong';\r\n        // Default to normal shake unless caller set data-strong attribute on container\r\n        const useStrong = container.getAttribute('data-ext-shake-strong') === '1';\r\n        // Debug: log invocation so we can verify shake is fired for rows/cols\r\n        try {\r\n        } catch (logErr) {\r\n            // ignore logging errors in older browsers\r\n        }\r\n        const cls = useStrong ? strongCls : normalCls;\r\n        container.classList.add(cls);\r\n        // Remove class when the CSS animation ends so duration is controlled by CSS\r\n        const onAnimEnd = (ev) => {\r\n            try {\r\n                // Only respond to animationend from the container itself\r\n                if (ev && ev.target !== container) return;\r\n            } catch (e) {}\r\n            try {\r\n                container.classList.remove(cls);\r\n                container.removeEventListener('animationend', onAnimEnd);\r\n                // Clear the transient strong marker so future calls compute correctly\r\n                try { container.removeAttribute('data-ext-shake-strong'); } catch (e) {}\r\n            } catch (e) {\r\n                // swallow cleanup errors\r\n            }\r\n        };\r\n        // Use once:true so listener auto-removes in older browsers; we also remove in handler for safety\r\n        container.addEventListener('animationend', onAnimEnd, { once: true });\r\n    } catch (e) {\r\n        console.warn('triggerGameAreaShake error', e);\r\n    }\r\n}\r\n\r\n/**\r\n * Plays Galaxy Row Clear animation at specified row\r\n * NON-BLOCKING: onComplete fires at LOGIC_DELAY_MS (~150ms) instead of waiting for full animation\r\n * Visual effects (bar, particles, block collapse) continue for full VISUAL_CLEANUP_DELAY_MS (~900ms)\r\n * \r\n * @param {number} rowIndex - The row to animate\r\n * @param {HTMLElement} gameGrid - The game grid DOM element\r\n * @param {HTMLElement} gameAreaParent - The parent container (usually .game-area)\r\n * @param {Function} onComplete - Callback fired quickly to resume game logic (not blocked by animation)\r\n * @param {number} placedPieceColor - The color number (1-7) of the piece that caused the clear\r\n */\r\nexport function playGalaxyRowClear(rowIndex, gameGrid, gameAreaParent, onComplete, placedPieceColor = null) {\r\n    if (!gameGrid || rowIndex < 0 || rowIndex >= GRID_ROWS) {\r\n        if (onComplete) onComplete();\r\n        return;\r\n    }\r\n\r\n    const cellElements = gameGrid.querySelectorAll('.grid-cell');\r\n    \r\n    // Create and play clear bar animation\r\n    createClearBar(rowIndex, gameGrid, gameAreaParent, placedPieceColor);\r\n    const animatedBlocks = [];\r\n    cellElements.forEach((cell, idx) => {\r\n        const cellRow = Math.floor(idx / GRID_COLS);\r\n        if (cellRow === rowIndex) {\r\n            const blockWrapper = cell.querySelector('.grid-cell-block');\r\n            if (!blockWrapper) return;\r\n            \r\n            const isFilled = Array.from(blockWrapper.classList).some(cls => cls.startsWith('filled-'));\r\n            if (isFilled) {\r\n                // Reset animation and apply it\r\n                blockWrapper.classList.remove('ext-galaxy-block-collapse');\r\n                void blockWrapper.offsetWidth; // Trigger reflow\r\n                blockWrapper.classList.add('ext-galaxy-block-collapse');\r\n                animatedBlocks.push(blockWrapper);\r\n            }\r\n        }\r\n    });\r\n\r\n    // Trigger shake after we've determined how many blocks are animating so\r\n    // we can scale duration/intensity to match the collapse animation.\r\n    try {\r\n        const blockCount = animatedBlocks.length;\r\n        // Use a short, CSS-driven shake duration (JS no longer controls removal)\r\n        const shakeDuration = 380;\r\n        // If many blocks clear, use a stronger shake\r\n        const isStrong = blockCount >= 6;\r\n        // mark container so triggerGameAreaShake picks the strong class\r\n        const target = document.querySelector('.game-area .game-grid') || document.querySelector('.game-area .game-grid-container') || document.querySelector('.game-area');\r\n        if (target) target.setAttribute('data-ext-shake-strong', isStrong ? '1' : '0');\r\n        triggerGameAreaShake(shakeDuration);\r\n    } catch (e) {\r\n        console.warn('shake trigger failed', e);\r\n    }\r\n\r\n    // EARLY CALLBACK: Fire onComplete quickly to unblock game logic\r\n    // This allows the game to continue immediately while animations run on GPU\r\n    setTimeout(() => {\r\n        if (onComplete) onComplete();\r\n    }, LOGIC_DELAY_MS);\r\n\r\n    // LATE CLEANUP: Remove filled classes and animation class after visual effects complete\r\n    // This happens in background and doesn't block game flow\r\n    setTimeout(() => {\r\n        cellElements.forEach((cell, idx) => {\r\n            const cellRow = Math.floor(idx / GRID_COLS);\r\n            if (cellRow === rowIndex) {\r\n                const blockWrapper = cell.querySelector('.grid-cell-block');\r\n                if (!blockWrapper) return;\r\n                \r\n                // Remove animation class to stop animation\r\n                blockWrapper.classList.remove('ext-galaxy-block-collapse');\r\n                \r\n                // Remove all filled-* classes from the block wrapper\r\n                Array.from(blockWrapper.classList).forEach(cls => {\r\n                    if (cls.startsWith('filled-')) {\r\n                        blockWrapper.classList.remove(cls);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }, VISUAL_CLEANUP_DELAY_MS);\r\n}\r\n\r\n/**\r\n * Plays Galaxy Column Clear animation at specified column\r\n * NON-BLOCKING: onComplete fires at LOGIC_DELAY_MS (~150ms) instead of waiting for full animation\r\n * Visual effects (bar, particles, block collapse) continue for full VISUAL_CLEANUP_DELAY_MS (~900ms)\r\n * \r\n * @param {number} colIndex - The column to animate\r\n * @param {HTMLElement} gameGrid - The game grid DOM element\r\n * @param {HTMLElement} gameAreaParent - The parent container\r\n * @param {Function} onComplete - Callback fired quickly to resume game logic (not blocked by animation)\r\n * @param {number} placedPieceColor - The color number (1-7) of the piece that caused the clear\r\n */\r\nexport function playGalaxyColClear(colIndex, gameGrid, gameAreaParent, onComplete, placedPieceColor = null) {\r\n    if (!gameGrid || colIndex < 0 || colIndex >= GRID_COLS) {\r\n        if (onComplete) onComplete();\r\n        return;\r\n    }\r\n\r\n    const cellElements = gameGrid.querySelectorAll('.grid-cell');\r\n    \r\n    // Create and play clear bar animation\r\n    createClearBarColumn(colIndex, gameGrid, gameAreaParent, placedPieceColor);\r\n\r\n    // Animate the filled blocks directly (no copies needed)\r\n    const animatedBlocks = [];\r\n    cellElements.forEach((cell, idx) => {\r\n        const cellCol = idx % GRID_COLS;\r\n        if (cellCol === colIndex) {\r\n            const blockWrapper = cell.querySelector('.grid-cell-block');\r\n            if (!blockWrapper) return;\r\n            \r\n            const isFilled = Array.from(blockWrapper.classList).some(cls => cls.startsWith('filled-'));\r\n            if (isFilled) {\r\n                // Reset animation and apply it\r\n                blockWrapper.classList.remove('ext-galaxy-block-collapse');\r\n                void blockWrapper.offsetWidth; // Trigger reflow\r\n                blockWrapper.classList.add('ext-galaxy-block-collapse');\r\n                animatedBlocks.push(blockWrapper);\r\n            }\r\n        }\r\n    });\r\n\r\n    // Trigger shake after we've determined how many blocks are animating so\r\n    // we can scale duration/intensity to match the collapse animation.\r\n    try {\r\n        const blockCount = animatedBlocks.length;\r\n        const shakeDuration = 380;\r\n        const isStrong = blockCount >= 6;\r\n        const target = document.querySelector('.game-area .game-grid') || document.querySelector('.game-area .game-grid-container') || document.querySelector('.game-area');\r\n        if (target) target.setAttribute('data-ext-shake-strong', isStrong ? '1' : '0');\r\n        triggerGameAreaShake(shakeDuration);\r\n    } catch (e) {\r\n        console.warn('shake trigger failed', e);\r\n    }\r\n\r\n    // EARLY CALLBACK: Fire onComplete quickly to unblock game logic\r\n    // This allows the game to continue immediately while animations run on GPU\r\n    setTimeout(() => {\r\n        if (onComplete) onComplete();\r\n    }, LOGIC_DELAY_MS);\r\n\r\n    // LATE CLEANUP: Remove filled classes and animation class after visual effects complete\r\n    // This happens in background and doesn't block game flow\r\n    setTimeout(() => {\r\n        cellElements.forEach((cell, idx) => {\r\n            const cellCol = idx % GRID_COLS;\r\n            if (cellCol === colIndex) {\r\n                const blockWrapper = cell.querySelector('.grid-cell-block');\r\n                if (!blockWrapper) return;\r\n                \r\n                // Remove animation class to stop animation\r\n                blockWrapper.classList.remove('ext-galaxy-block-collapse');\r\n                \r\n                // Remove all filled-* classes from the block wrapper\r\n                Array.from(blockWrapper.classList).forEach(cls => {\r\n                    if (cls.startsWith('filled-')) {\r\n                        blockWrapper.classList.remove(cls);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }, VISUAL_CLEANUP_DELAY_MS);\r\n}\r\n\r\n/**\r\n * Creates and animates the clear bar for a row\r\n * @private\r\n */\r\nfunction createClearBar(rowIndex, gameGrid, gameAreaParent, placedPieceColor = null) {\r\n    if (!gameAreaParent || !gameGrid) return;\r\n\r\n    const gridRect = gameGrid.getBoundingClientRect();\r\n    const parentRect = gameAreaParent.getBoundingClientRect();\r\n    const gridStyle = getComputedStyle(gameGrid);\r\n\r\n    // Get exact grid parameters\r\n    const cellSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-cell-size')) || 40;\r\n    const gap = parseFloat(gridStyle.gap) || 0;\r\n    const gridPaddingLeft = parseFloat(gridStyle.paddingLeft) || 0;\r\n    const gridPaddingTop = parseFloat(gridStyle.paddingTop) || 0;\r\n    const gridBorderLeft = parseFloat(gridStyle.borderLeftWidth) || 0;\r\n    const gridBorderTop = parseFloat(gridStyle.borderTopWidth) || 0;\r\n\r\n    // Get first cell element to calculate exact position\r\n    const cellElements = gameGrid.querySelectorAll('.grid-cell');\r\n    if (cellElements.length === 0) return;\r\n    \r\n    const firstCell = cellElements[0];\r\n    const firstCellRect = firstCell.getBoundingClientRect();\r\n    \r\n    // Calculate the Y position of the target row\r\n    let targetCellIndex = rowIndex * GRID_COLS;\r\n    if (cellElements.length > targetCellIndex) {\r\n        const targetCell = cellElements[targetCellIndex];\r\n        const targetCellRect = targetCell.getBoundingClientRect();\r\n        \r\n        const topInParent = targetCellRect.top - parentRect.top;\r\n        const leftInParent = firstCellRect.left - parentRect.left;\r\n        const barWidth = firstCellRect.width * GRID_COLS + gap * (GRID_COLS - 1);\r\n\r\n        const barBorderRadius = getGridCellBorderRadius(gameGrid);\r\n\r\n        const barContainer = document.createElement('div');\r\n        barContainer.className = 'ext-galaxy-clear-bar-container';\r\n        barContainer.style.position = 'absolute';\r\n        barContainer.style.top = topInParent + 'px';\r\n        barContainer.style.left = leftInParent + 'px';\r\n        barContainer.style.width = barWidth + 'px';\r\n        barContainer.style.height = firstCellRect.height + 'px';\r\n        barContainer.style.borderRadius = barBorderRadius;\r\n\r\n        const inner = document.createElement('div');\r\n        inner.className = 'ext-galaxy-clear-bar-inner';\r\n        inner.style.borderRadius = barBorderRadius;\r\n\r\n        // Adaptive particle count based on device\r\n        let particleCount = 30;\r\n        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);\r\n        const isLowEnd = (navigator.hardwareConcurrency || 4) <= 4;\r\n        if (isMobile) {\r\n            particleCount = isLowEnd ? 15 : 22;\r\n        }\r\n\r\n        // Extract colors from the actual grid cells being cleared\r\n        // Pass placedPieceColor to use unified piece color if available\r\n        const { colors, dominantColor } = extractCellColors(cellElements, rowIndex, true, placedPieceColor);\r\n        \r\n        // Get frame color from the piece that caused the clear, or use dominant grid color\r\n        const frameColor = getFrameColor(placedPieceColor, dominantColor);\r\n        \r\n        // Apply frame color as border with strong inner glow only\r\n        inner.style.border = `2px solid ${frameColor}`;\r\n        inner.style.background = `radial-gradient(ellipse at center, ${frameColor}15, transparent)`;\r\n        inner.style.boxShadow = `\r\n            inset 0 0 40px ${frameColor}80,\r\n            inset 0 0 30px ${frameColor}70,\r\n            inset 0 0 20px ${frameColor}60,\r\n            inset 0 0 10px ${frameColor}40\r\n        `;\r\n\r\n        for (let i = 0; i < particleCount; i++) {\r\n            const p = document.createElement('div');\r\n            p.className = 'ext-galaxy-particle';\r\n\r\n            // Make particles smaller on mobile to avoid large squares inside the frame\r\n            const baseSize = isMobile ? (4 + Math.random() * 6) : (8 + Math.random() * 12);\r\n            const size = Math.round(baseSize);\r\n            const color = colors[Math.floor(Math.random() * colors.length)];\r\n            const left = Math.random() * 100;\r\n\r\n            const dur = (isMobile ? 700 : 900) + Math.random() * (isMobile ? 400 : 600);  // slightly faster on mobile\r\n            const delay = Math.random() * 150;\r\n\r\n            const dxStart = (Math.random() - 0.5) * (isMobile ? 12 : 20);\r\n            const dyStart = (Math.random() - 0.5) * (isMobile ? 6 : 10);\r\n\r\n            const direction = Math.random() > 0.5 ? 1 : -1;\r\n            const dxEnd = direction * ((isMobile ? 30 : 50) + Math.random() * (isMobile ? 40 : 80));\r\n            const dyEnd = (Math.random() - 0.5) * (isMobile ? 18 : 30);\r\n\r\n            p.style.width = size + 'px';\r\n            p.style.height = size + 'px';\r\n            p.style.backgroundColor = color;\r\n            p.style.color = color;\r\n            p.style.left = left + '%';\r\n            p.style.top = '50%';\r\n            p.style.marginTop = (-size / 2) + 'px';\r\n            p.style.borderRadius = Math.max(2, Math.round(size * 0.25)) + 'px';\r\n\r\n            p.style.animationDuration = dur + 'ms';\r\n            p.style.animationDelay = delay + 'ms';\r\n\r\n            p.style.setProperty('--ext-dx-start', dxStart + 'px');\r\n            p.style.setProperty('--ext-dy-start', dyStart + 'px');\r\n            p.style.setProperty('--ext-dx-end', dxEnd + 'px');\r\n            p.style.setProperty('--ext-dy-end', dyEnd + 'px');\r\n\r\n            inner.appendChild(p);\r\n        }\r\n\r\n        barContainer.appendChild(inner);\r\n        gameAreaParent.appendChild(barContainer);\r\n\r\n        // Clean up after animation\r\n        setTimeout(() => {\r\n            if (barContainer.parentNode) {\r\n                barContainer.remove();\r\n            }\r\n        }, 1500);\r\n    }\r\n}\r\n\r\n/**\r\n * Creates and animates the clear bar for a column (vertical variant)\r\n * @private\r\n */\r\nfunction createClearBarColumn(colIndex, gameGrid, gameAreaParent, placedPieceColor = null) {\r\n    if (!gameAreaParent || !gameGrid) return;\r\n\r\n    const gameAreaRect = gameAreaParent.getBoundingClientRect();\r\n    const gridStyle = getComputedStyle(gameGrid);\r\n    \r\n    // Get cell elements\r\n    const cellElements = gameGrid.querySelectorAll('.grid-cell');\r\n    if (cellElements.length === 0) return;\r\n\r\n    // Get the first cell and target cell to calculate positions\r\n    const firstCell = cellElements[0];\r\n    const firstCellRect = firstCell.getBoundingClientRect();\r\n    \r\n    // Calculate the X position of the target column\r\n    let targetCellIndex = colIndex;\r\n    if (cellElements.length > targetCellIndex) {\r\n        const targetCell = cellElements[targetCellIndex];\r\n        const targetCellRect = targetCell.getBoundingClientRect();\r\n        \r\n        // Calculate height (all rows)\r\n        const lastCell = cellElements[cellElements.length - 1];\r\n        const lastCellRect = lastCell.getBoundingClientRect();\r\n        const gap = parseFloat(gridStyle.gap) || 0;\r\n        const barHeight = (lastCellRect.bottom - firstCellRect.top) + gap;\r\n\r\n        const leftInParent = targetCellRect.left - gameAreaRect.left;\r\n        const topInParent = firstCellRect.top - gameAreaRect.top;\r\n\r\n        const barBorderRadius = getGridCellBorderRadius(gameGrid);\r\n\r\n        const barContainer = document.createElement('div');\r\n        barContainer.className = 'ext-galaxy-clear-bar-container';\r\n        barContainer.style.position = 'absolute';\r\n        barContainer.style.left = leftInParent + 'px';\r\n        barContainer.style.top = topInParent + 'px';\r\n        barContainer.style.width = firstCellRect.width + 'px';\r\n        barContainer.style.height = barHeight + 'px';\r\n        barContainer.style.borderRadius = barBorderRadius;\r\n\r\n        const inner = document.createElement('div');\r\n        inner.className = 'ext-galaxy-clear-bar-inner';\r\n        inner.style.width = '100%';\r\n        inner.style.height = '100%';\r\n        inner.style.borderRadius = barBorderRadius;\r\n\r\n        // Adaptive particle count based on device\r\n        let particleCount = 30;\r\n        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);\r\n        const isLowEnd = (navigator.hardwareConcurrency || 4) <= 4;\r\n        if (isMobile) {\r\n            particleCount = isLowEnd ? 15 : 22;\r\n        }\r\n\r\n        // Extract colors from the actual grid cells being cleared\r\n        // Pass placedPieceColor to use unified piece color if available\r\n        const { colors, dominantColor } = extractCellColors(cellElements, colIndex, false, placedPieceColor);\r\n        \r\n        // Get frame color from the piece that caused the clear, or use dominant grid color\r\n        const frameColor = getFrameColor(placedPieceColor, dominantColor);\r\n        \r\n        // Apply frame color as border with strong inner glow\r\n        inner.style.border = `2px solid ${frameColor}`;\r\n        inner.style.background = `radial-gradient(ellipse at center, ${frameColor}15, transparent)`;\r\n        inner.style.boxShadow = `\r\n            inset 0 0 40px ${frameColor}80,\r\n            inset 0 0 30px ${frameColor}70,\r\n            inset 0 0 20px ${frameColor}60,\r\n            inset 0 0 10px ${frameColor}40\r\n        `;\r\n\r\n        for (let i = 0; i < particleCount; i++) {\r\n            const p = document.createElement('div');\r\n            p.className = 'ext-galaxy-particle';\r\n\r\n            const baseSize = isMobile ? (4 + Math.random() * 6) : (8 + Math.random() * 12);\r\n            const size = Math.round(baseSize);\r\n            const color = colors[Math.floor(Math.random() * colors.length)];\r\n            const top = Math.random() * 100;\r\n\r\n            const dur = (isMobile ? 700 : 900) + Math.random() * (isMobile ? 400 : 600);\r\n            const delay = Math.random() * 150;\r\n\r\n            const dxStart = (Math.random() - 0.5) * (isMobile ? 8 : 10);\r\n            const dyStart = (Math.random() - 0.5) * (isMobile ? 12 : 20);\r\n\r\n            const direction = Math.random() > 0.5 ? 1 : -1;\r\n            const dxEnd = (Math.random() - 0.5) * (isMobile ? 18 : 30);\r\n            const dyEnd = direction * ((isMobile ? 30 : 50) + Math.random() * (isMobile ? 40 : 80));\r\n\r\n            p.style.width = size + 'px';\r\n            p.style.height = size + 'px';\r\n            p.style.backgroundColor = color;\r\n            p.style.color = color;\r\n            p.style.left = '50%';\r\n            p.style.marginLeft = (-size / 2) + 'px';\r\n            p.style.top = top + '%';\r\n            p.style.borderRadius = Math.max(2, Math.round(size * 0.25)) + 'px';\r\n\r\n            p.style.animationDuration = dur + 'ms';\r\n            p.style.animationDelay = delay + 'ms';\r\n\r\n            p.style.setProperty('--ext-dx-start', dxStart + 'px');\r\n            p.style.setProperty('--ext-dy-start', dyStart + 'px');\r\n            p.style.setProperty('--ext-dx-end', dxEnd + 'px');\r\n            p.style.setProperty('--ext-dy-end', dyEnd + 'px');\r\n\r\n            inner.appendChild(p);\r\n        }\r\n\r\n        barContainer.appendChild(inner);\r\n        gameAreaParent.appendChild(barContainer);\r\n\r\n        setTimeout(() => {\r\n            if (barContainer.parentNode) {\r\n                barContainer.remove();\r\n            }\r\n        }, 1500);\r\n    }\r\n}\r\n","// Row clear animation - Galaxy Row Clear integration with grid isolation\r\n\r\nimport { playGalaxyRowClear, playGalaxyColClear } from './animationAdapters/galaxyRowClear.js';\r\n\r\nconst LINE_DELAY = 110;          // ms between lines when not sync\r\nconst OVERLAY_HOST_ID = 'rowClearOverlay';\r\nlet overlayHostElement = null;\r\n\r\nfunction ensureOverlayHost(host = document.querySelector('.game-area') || document.body) {\r\n  if (!host) return null;\r\n  if (!overlayHostElement) {\r\n    overlayHostElement = document.getElementById(OVERLAY_HOST_ID) || document.createElement('div');\r\n    overlayHostElement.id = OVERLAY_HOST_ID;\r\n    overlayHostElement.setAttribute('aria-hidden', 'true');\r\n  }\r\n  if (overlayHostElement.parentElement !== host) {\r\n    host.appendChild(overlayHostElement);\r\n  }\r\n  return overlayHostElement;\r\n}\r\n\r\nfunction alignOverlayHost(gridRect, host) {\r\n  const overlay = ensureOverlayHost(host);\r\n  if (!overlay || !gridRect || !host) return overlay;\r\n  const hostRect = host.getBoundingClientRect();\r\n  overlay.style.position = 'absolute';\r\n  overlay.style.left = `${gridRect.left - hostRect.left}px`;\r\n  overlay.style.top = `${gridRect.top - hostRect.top}px`;\r\n  overlay.style.width = `${gridRect.width}px`;\r\n  overlay.style.height = `${gridRect.height}px`;\r\n  return overlay;\r\n}\r\n\r\nexport function animateRowClearSpectra({\r\n  ctx,\r\n  rows,\r\n  blockSize,\r\n  boardSize,\r\n  getCellColor,   // (r,c)=>color (unused for animation core but kept for API compat)\r\n  renderBase,     // () => redraw board below canvas; kept to avoid regressions\r\n  onLogicalClear, // (rowIndex)=>void\r\n  onDone          // ()=>void\r\n}) {\r\n  if (!rows || !rows.length) { onDone && onDone(); return; }\r\n\r\n  // Align canvas to grid at 1x to reduce pixel cost\r\n  const canvas = ctx?.canvas;\r\n  const gameGrid = document.getElementById('gameGrid');\r\n  const metrics = computeGridMetrics(gameGrid, canvas);\r\n\r\n  // Build per-line data once (DOM lookups once, no per-frame layout)\r\n  const totalCols = boardSize;\r\n  const lines = rows.map((rowIndex, order) => buildRowData({\r\n    rowIndex,\r\n    order,\r\n    boardSize: totalCols,\r\n    metrics,\r\n    gameGrid\r\n  }));\r\n\r\n  const tasks = lines.map(line => new Promise(resolve => {\r\n    setTimeout(() => runRowAnimation({\r\n      line,\r\n      metrics,\r\n      onLogicalClear,\r\n      onResolved: resolve\r\n    }), line.delay);\r\n  }));\r\n\r\n  Promise.all(tasks).then(() => {\r\n    onDone && onDone();\r\n  });\r\n}\r\n\r\n// Combined lightweight line clear for rows and columns to match existing integration\r\nexport function animateLineClearSpectra({\r\n  ctx,\r\n  rows = [],\r\n  cols = [],\r\n  boardSize,\r\n  onClearRow,\r\n  onClearCol,\r\n  onDone,\r\n  syncStart = false,\r\n  placedPieceColor = null\r\n}) {\r\n  const canvas = ctx?.canvas;\r\n  const gameGrid = document.getElementById('gameGrid');\r\n  const metrics = computeGridMetrics(gameGrid, canvas);\r\n\r\n  const tasks = [];\r\n\r\n  // Rows\r\n  rows.forEach((rowIndex, order) => {\r\n    const line = buildRowData({ rowIndex, order: syncStart ? 0 : order, boardSize, metrics, gameGrid });\r\n    tasks.push(new Promise(resolve => {\r\n      setTimeout(() => runRowAnimation({\r\n        line,\r\n        metrics,\r\n        onLogicalClear: (r) => onClearRow && onClearRow(r),\r\n        onResolved: resolve,\r\n        placedPieceColor\r\n      }), line.delay);\r\n    }));\r\n  });\r\n\r\n  // Columns\r\n  cols.forEach((colIndex, order) => {\r\n    const line = buildColData({ colIndex, order: syncStart ? 0 : (rows.length + order), boardSize, metrics, gameGrid });\r\n    tasks.push(new Promise(resolve => {\r\n      setTimeout(() => runColAnimation({\r\n        line,\r\n        metrics,\r\n        onLogicalClear: (c) => onClearCol && onClearCol(c),\r\n        onResolved: resolve,\r\n        placedPieceColor\r\n      }), line.delay);\r\n    }));\r\n  });\r\n\r\n  if (!tasks.length) { onDone && onDone(); return; }\r\n\r\n  Promise.all(tasks).then(() => {\r\n    onDone && onDone();\r\n  });\r\n}\r\n\r\nfunction buildColData({ colIndex, order, boardSize, metrics, gameGrid }) {\r\n  const cells = [];\r\n  if (metrics && gameGrid) {\r\n    const totalRows = Math.floor(gameGrid.children.length / boardSize) || boardSize;\r\n    for (let r = 0; r < totalRows; r++) {\r\n      const element = gameGrid.children[r * boardSize + colIndex];\r\n      if (!element) continue;\r\n      \r\n      // Only include filled cells (blocks) that will be cleared\r\n      const isFilled = Array.from(element.classList).some(cls => cls.startsWith('filled-'));\r\n      if (!isFilled) continue;\r\n      \r\n      const { x, y } = cellCenter(r, colIndex, metrics);\r\n      const overlay = createCellOverlay(element);\r\n      cells.push({ element, centerX: x, centerY: y, overlay });\r\n    }\r\n  }\r\n  return {\r\n    colIndex,\r\n    cells,\r\n    delay: order * LINE_DELAY,\r\n    cleared: false\r\n  };\r\n}\r\n\r\nfunction runColAnimation({ line, metrics, particleEngine, onLogicalClear, onResolved, placedPieceColor }) {\r\n  // Play Galaxy Column Clear animation\r\n  const gameGrid = document.getElementById('gameGrid');\r\n  const gameArea = document.querySelector('.game-area');\r\n  \r\n  playGalaxyColClear(line.colIndex, gameGrid, gameArea, () => {\r\n    // Perform logical clear AFTER animation\r\n    if (!line.cleared) {\r\n      onLogicalClear && onLogicalClear(line.colIndex);\r\n      line.cleared = true;\r\n    }\r\n    cleanupLineOverlays(line);\r\n    onResolved();\r\n  }, placedPieceColor);\r\n}\r\n\r\nfunction runRowAnimation({ line, metrics, particleEngine, onLogicalClear, onResolved, placedPieceColor }) {\r\n  // Play Galaxy Row Clear animation\r\n  const gameGrid = document.getElementById('gameGrid');\r\n  const gameArea = document.querySelector('.game-area');\r\n  \r\n  playGalaxyRowClear(line.rowIndex, gameGrid, gameArea, () => {\r\n    // Perform logical clear AFTER animation\r\n    if (!line.cleared) {\r\n      onLogicalClear && onLogicalClear(line.rowIndex);\r\n      line.cleared = true;\r\n    }\r\n    cleanupLineOverlays(line);\r\n    onResolved();\r\n  }, placedPieceColor);\r\n}\r\n\r\nfunction buildRowData({ rowIndex, order, boardSize, metrics, gameGrid }) {\r\n  const cells = [];\r\n  if (gameGrid) {\r\n    for (let c = 0; c < boardSize; c++) {\r\n      const element = gameGrid.children[rowIndex * boardSize + c];\r\n      if (!element) continue;\r\n      \r\n      // Only include filled cells (blocks) that will be cleared\r\n      const isFilled = Array.from(element.classList).some(cls => cls.startsWith('filled-'));\r\n      if (!isFilled) continue;\r\n      \r\n      if (metrics) {\r\n        const { x, y } = cellCenter(rowIndex, c, metrics);\r\n        const overlay = createCellOverlay(element);\r\n        cells.push({ element, centerX: x, centerY: y, overlay });\r\n      } else {\r\n        cells.push({ element, centerX: 0, centerY: 0, overlay: null });\r\n      }\r\n    }\r\n  }\r\n  return {\r\n    rowIndex,\r\n    cells,\r\n    delay: order * LINE_DELAY,\r\n    cleared: false\r\n  };\r\n}\r\n\r\nfunction computeGridMetrics(gameGrid, canvas) {\r\n  if (!gameGrid || !canvas) return null;\r\n  const gridRect = gameGrid.getBoundingClientRect();\r\n  const host = canvas.offsetParent || document.querySelector('.game-area') || document.body;\r\n  const hostRect = host.getBoundingClientRect();\r\n  const style = getComputedStyle(gameGrid);\r\n\r\n  const padLeft = parseFloat(style.paddingLeft) || 0;\r\n  const padRight = parseFloat(style.paddingRight) || 0;\r\n  const padTop = parseFloat(style.paddingTop) || 0;\r\n  const padBottom = parseFloat(style.paddingBottom) || 0;\r\n  const gap = parseFloat(style.getPropertyValue('--grid-gap')) || parseFloat(style.gap) || 0;\r\n\r\n  // Align canvas in CSS pixels (no DPR scaling)\r\n  canvas.style.position = 'absolute';\r\n  canvas.style.left = `${gridRect.left - hostRect.left}px`;\r\n  canvas.style.top = `${gridRect.top - hostRect.top}px`;\r\n  canvas.style.width = `${gridRect.width}px`;\r\n  canvas.style.height = `${gridRect.height}px`;\r\n  canvas.width = Math.round(gridRect.width);\r\n  canvas.height = Math.round(gridRect.height);\r\n  canvas.getContext('2d')?.setTransform(1, 0, 0, 1, 0, 0);\r\n\r\n  alignOverlayHost(gridRect, host);\r\n\r\n  return {\r\n    padLeft, padRight, padTop, padBottom,\r\n    colGap: gap, rowGap: gap,\r\n    canvasWidth: Math.round(gridRect.width),\r\n    canvasHeight: Math.round(gridRect.height)\r\n  };\r\n}\r\n\r\nfunction cellCenter(row, col, metrics) {\r\n  const width = metrics.canvasWidth - metrics.padLeft - metrics.padRight;\r\n  const height = metrics.canvasHeight - metrics.padTop - metrics.padBottom;\r\n  const gameGrid = document.getElementById('gameGrid');\r\n  const cols = gameGrid ? (getComputedStyle(gameGrid).gridTemplateColumns.split(' ').length) : 10;\r\n  const rows = gameGrid ? (getComputedStyle(gameGrid).gridTemplateRows.split(' ').length) : 10;\r\n  const cellW = cols ? (width - metrics.colGap * (cols - 1)) / cols : 0;\r\n  const cellH = rows ? (height - metrics.rowGap * (rows - 1)) / rows : 0;\r\n  const x = metrics.padLeft + col * (cellW + metrics.colGap) + cellW / 2;\r\n  const y = metrics.padTop + row * (cellH + metrics.rowGap) + cellH / 2;\r\n  return { x, y };\r\n}\r\n\r\nfunction createCellOverlay(element) {\r\n  if (!element) return null;\r\n  \r\n  const host = overlayHostElement?.parentElement || document.querySelector('.game-area') || document.body;\r\n  const grid = document.getElementById('gameGrid');\r\n  const gridRect = grid?.getBoundingClientRect() || null;\r\n  alignOverlayHost(gridRect, host);\r\n  const overlayHost = overlayHostElement || ensureOverlayHost(host);\r\n  if (!overlayHost) return null;\r\n  \r\n  const hostRect = overlayHost.getBoundingClientRect();\r\n  if (!hostRect.width || !hostRect.height) return null;\r\n  \r\n  // Batch getComputedStyle() call - vetm nj her\r\n  const style = getComputedStyle(element);\r\n  const rect = element.getBoundingClientRect();\r\n  \r\n  // Lexo t gjitha ngjyrat n nj pass\r\n  const colorDark1 = style.getPropertyValue('--color-dark-1') || '#14b8a6';\r\n  const colorDark2 = style.getPropertyValue('--color-dark-2') || '#0f766e';\r\n  const colorCoreLight = style.getPropertyValue('--color-core-light') || 'rgba(173, 255, 219, 0.8)';\r\n  const colorCoreMid = style.getPropertyValue('--color-core-mid') || 'rgba(81, 238, 176, 0.5)';\r\n  const colorBevelLight = style.getPropertyValue('--color-bevel-light') || 'rgba(255,255,255,0.2)';\r\n  const colorBevelDark = style.getPropertyValue('--color-bevel-dark') || 'rgba(0,0,0,0.4)';\r\n  const borderRadius = style.borderRadius || '25%';\r\n  \r\n  // Krijo overlay\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'cell-clear-overlay';\r\n  \r\n  // Poziciono dhe vendos madhsin\r\n  overlay.style.left = `${rect.left - hostRect.left}px`;\r\n  overlay.style.top = `${rect.top - hostRect.top}px`;\r\n  overlay.style.width = `${rect.width}px`;\r\n  overlay.style.height = `${rect.height}px`;\r\n  overlay.style.borderRadius = borderRadius;\r\n  \r\n  // Vendos t gjitha CSS variablat n nj batch\r\n  overlay.style.setProperty('--color-dark-1', colorDark1);\r\n  overlay.style.setProperty('--color-dark-2', colorDark2);\r\n  overlay.style.setProperty('--color-core-light', colorCoreLight);\r\n  overlay.style.setProperty('--color-core-mid', colorCoreMid);\r\n  overlay.style.setProperty('--color-bevel-light', colorBevelLight);\r\n  overlay.style.setProperty('--color-bevel-dark', colorBevelDark);\r\n  overlay.style.setProperty('--overlay-color', colorDark1);\r\n  overlay.style.setProperty('--row-clear-color', colorDark1);\r\n  \r\n  // Vendos background gradient\r\n  overlay.style.background = `linear-gradient(135deg, ${colorDark1}, ${colorDark2})`;\r\n  \r\n  overlayHost.appendChild(overlay);\r\n  return overlay;\r\n}\r\n\r\nfunction cleanupLineOverlays(line) {\r\n  if (!line || !line.cells) return;\r\n  line.cells.forEach(cell => {\r\n    // Rikthe opacity-n e blloqeve origjinale\r\n    if (cell && cell.element) {\r\n      cell.element.style.opacity = '';\r\n    }\r\n    // Fshi overlay-t\r\n    if (cell && cell.overlay) {\r\n      cell.overlay.remove();\r\n      cell.overlay = null;\r\n    }\r\n  });\r\n  cleanupOverlayHostIfEmpty();\r\n}\r\n\r\nfunction cleanupOverlayHostIfEmpty() {\r\n  if (!overlayHostElement) return;\r\n  if (overlayHostElement.childElementCount > 0) return;\r\n  const parent = overlayHostElement.parentElement;\r\n  overlayHostElement.remove();\r\n  overlayHostElement = null;\r\n  if (parent && parent.hasChildNodes()) return;\r\n}\r\n\r\n\r\n","// Main game logic and event handlers\r\n//  IMPORTANT: When making optimizations/fixes, increment version in:\r\n//    1. index.html  <meta name=\"app-version\" content=\"vX.X\">\r\n//    2. The version badge will automatically change color so user sees the refresh\r\n\r\nimport { gameState, initializeState, resetDragState } from './state.js';\r\nimport * as logic from './gameLogic.js';\r\nimport * as render from './render.js';\r\nimport { dom } from './render.js';  // DOM cache used in initMain\r\nimport * as audio from './audio.js';\r\nimport { INVALID_PLACEMENT_SHAKE_DURATION, COMBO_MESSAGE_DURATION, GRID_COLS, GRID_ROWS } from './constants.js';\r\nimport { activateMagicUniverseBackground, deactivateMagicUniverseBackground } from './backgroundEffects.js';\r\n// import FABManager removed (we no longer use a floating action button container)\r\nimport { pieceUnlockSystem } from './pieceUnlockSystem.js';\r\nimport { applyStatusBar } from './statusBarTheme.js';\r\nimport { initDebugOverlay } from './debugOverlay.js';\r\nimport { readyNativeUI, attachAppLifecycle } from './nativeBridge.js';\r\nimport { initializeSettings } from './modalManager.js';\r\nimport { animateLineClearSpectra } from './rowClearSpectra.js';\r\nimport * as logger from './logger.js';\r\n\r\n// Exported bootstrap expected by app.js\r\nexport function initMain() {\r\n    // If DOM is already ready, run immediately\r\n    const boot = () => {\r\n        try { readyNativeUI(); } catch(e) {}\r\n        try { attachAppLifecycle(); } catch(e) {}\r\n        try { initDebugOverlay(); } catch(e) {}\r\n        try { applyStatusBar(document.body.dataset.theme || 'dark'); } catch(e) {}\r\n        try { initializeSettings(); } catch(e) { console.warn('Failed to initialize settings:', e); }\r\n        // Initialize the game UI and logic\r\n        try { initializeGame(); } catch(e) { /* initializeGame defined later */ }\r\n        // Initialize landing page button effects\r\n        try { initializeLandingPageEffects(); } catch(e) {}\r\n    };\r\n    if (document.readyState === 'complete' || document.readyState === 'interactive') {\r\n        setTimeout(boot, 0);\r\n    } else {\r\n        document.addEventListener('DOMContentLoaded', boot);\r\n    }\r\n}\r\n\r\n// --- Simple FPS sampler + auto lite-mode ---\r\n\r\n\r\n// --- Game Mode Management ---\r\nlet selectedGameMode = null; // 'classic' or 'collection'\r\n\r\nfunction whenDomReady(callback) {\r\n    if (document.readyState === 'loading') {\r\n        document.addEventListener('DOMContentLoaded', callback, { once: true });\r\n    } else {\r\n        callback();\r\n    }\r\n}\r\n\r\nlet specialActionListenersAttached = false;\r\nlet legacyLandingSetupDone = false;\r\n\r\n\r\n// --- Landing Page Stats Update ---\r\nexport function updateLandingPageStats() {\r\n    // Update high score\r\n    const highScoreEl = document.getElementById('highscore-display');\r\n    if (highScoreEl) {\r\n        const savedHighScore = localStorage.getItem('blokusHighScore') || '0';\r\n        highScoreEl.textContent = savedHighScore;\r\n    }\r\n    \r\n    // Update pieces unlocked based on current progress\r\n    const piecesUnlockedEl = document.getElementById('pieces-unlocked');\r\n    if (piecesUnlockedEl) {\r\n        try {\r\n            const currentScore = parseInt(localStorage.getItem('blokusHighScore') || '0');\r\n            if (typeof pieceUnlockSystem !== 'undefined' && pieceUnlockSystem.getAvailablePieces) {\r\n                const unlockedPieces = pieceUnlockSystem.getAvailablePieces();\r\n                piecesUnlockedEl.textContent = unlockedPieces.length;\r\n            } else {\r\n                // Fallback calculation\r\n                let pieces = 7; // Start with 7 basic pieces\r\n                if (currentScore >= 2000) pieces += 6;\r\n                if (currentScore >= 4000) pieces += 6;\r\n                if (currentScore >= 6000) pieces += 6;\r\n                if (currentScore >= 8000) pieces += 5;\r\n                piecesUnlockedEl.textContent = Math.min(pieces, 30);\r\n            }\r\n        } catch (error) {\r\n            piecesUnlockedEl.textContent = '7';\r\n        }\r\n    }\r\n    \r\n    // Update achievements count (placeholder for future implementation)\r\n    const achievementsEl = document.getElementById('achievements-count');\r\n    if (achievementsEl) {\r\n        // For now, calculate based on score milestones\r\n        const currentScore = parseInt(localStorage.getItem('blokusHighScore') || '0');\r\n        let achievements = 0;\r\n        if (currentScore >= 1000) achievements++;\r\n        if (currentScore >= 5000) achievements++;\r\n        if (currentScore >= 10000) achievements++;\r\n        if (currentScore >= 20000) achievements++;\r\n        if (currentScore >= 50000) achievements++;\r\n        achievementsEl.textContent = achievements;\r\n    }\r\n}\r\n\r\n// --- Main Game Flow ---\r\n\r\n\r\nfunction initializeGame() {\r\n    // Clean up resources from previous game session and reset paused state\r\n    logger.resetGameStartFlag(); // Reset for fresh game session\r\n    logger.logGameStart();\r\n    cleanupGameResources();\r\n    // Remove paused class so animations run on new game\r\n    const gameContainer = document.querySelector('.game-container');\r\n    if (gameContainer) {\r\n        gameContainer.classList.remove('paused');\r\n    }\r\n    render.cacheDOMElements();\r\n    // Attach pause, restart, and settings handlers once DOM cache is ready\r\n    if (!listenersAttached) {\r\n        if (dom.pauseButton) {\r\n            dom.pauseButton.addEventListener('click', togglePause);\r\n            addNeonClickEffect(dom.pauseButton);\r\n        }\r\n        if (dom.restartButton) {\r\n            dom.restartButton.addEventListener('click', handleRestart);\r\n            addNeonClickEffect(dom.restartButton);\r\n        }\r\n        if (dom.settingsButton && window.showSettingsModal) {\r\n            dom.settingsButton.addEventListener('click', window.showSettingsModal);\r\n            addNeonClickEffect(dom.settingsButton);\r\n        }\r\n        if (dom.darkModeToggleGame) {\r\n            addNeonClickEffect(dom.darkModeToggleGame);\r\n        }\r\n        listenersAttached = true;\r\n    }\r\n    render.createGridDOM();\r\n    initializeState();\r\n    logger.logGameMode('Blokus Grid');\r\n    logic.populateInitialPieces();\r\n    logger.logPerformanceStart('game-init');\r\n    // Always create unlock progress indicator when landing hidden\r\n    const landingPage = document.getElementById('landingPage');\r\n    if (typeof render.createUnlockProgressIndicator === 'function' && landingPage && landingPage.classList.contains('hidden')) {\r\n        render.createUnlockProgressIndicator();\r\n    }\r\n    render.updateGridDisplay();\r\n    render.updatePiecesDisplay(true); // Pass true for initial load animation\r\n    render.updateScoreDisplay();\r\n    render.updateControlButtons();\r\n    updateSpecialActionButtons();\r\n    attachPieceEventListeners();\r\n    attachGridEventListeners();\r\n    logger.logPerformanceEnd('game-init');\r\n}\r\n\r\n// Add neon glow effect on button click\r\nfunction addNeonClickEffect(button) {\r\n    if (!button) return;\r\n    \r\n    button.addEventListener('click', function(e) {\r\n        // Remove existing class if present\r\n        this.classList.remove('neon-clicked');\r\n        \r\n        // Trigger reflow\r\n        void this.offsetWidth;\r\n        \r\n    // Play click sound effect\r\n    audio.playUIButtonSound();\r\n    // Add the neon effect class\r\n        this.classList.add('neon-clicked');\r\n        \r\n        // Remove the class after animation completes\r\n        setTimeout(() => {\r\n            this.classList.remove('neon-clicked');\r\n        }, 400);\r\n    });\r\n}\r\n\r\n// Initialize landing page button effects\r\nfunction initializeLandingPageEffects() {\r\n    const themeToggleLanding = document.getElementById('theme-toggle');\r\n    if (themeToggleLanding) {\r\n        addNeonClickEffect(themeToggleLanding);\r\n    }\r\n    // Add sound + neon click to mode buttons\r\n    const modeButtons = document.querySelectorAll('.mode-button.selectable');\r\n    modeButtons.forEach(btn => addNeonClickEffect(btn));\r\n}\r\n\r\nfunction togglePause() {\r\n    if (gameState.isGameOver) return;\r\n    gameState.isPaused = !gameState.isPaused;\r\n    \r\n    render.updateControlButtons();\r\n    // Play pause or resume sound and toggle background animations\r\n    if (gameState.isPaused) {\r\n        audio.playPauseSound();\r\n        document.dispatchEvent(new Event('app:pause'));\r\n        const gameContainer = document.querySelector('.game-container');\r\n        if (gameContainer) {\r\n            gameContainer.classList.add('paused');\r\n        }\r\n    } else {\r\n        audio.playResumeSound();\r\n        document.dispatchEvent(new Event('app:resume'));\r\n        const gameContainer = document.querySelector('.game-container');\r\n        if (gameContainer) {\r\n            gameContainer.classList.remove('paused');\r\n            // Force reflow to restart paused animations\r\n            void gameContainer.offsetWidth;\r\n        }\r\n    }\r\n}\r\n\r\nfunction handleRestart() {\r\n    logger.logGameStateSnapshot(gameState);\r\n    logger.log('INFO', ' Game Restarted', '#90CAF9');\r\n    // Play restart sound\r\n    audio.playRestartSound();\r\n    // Remove paused state from container so animations reset\r\n    const gameContainer = document.querySelector('.game-container');\r\n    if (gameContainer) {\r\n        gameContainer.classList.remove('paused');\r\n    }\r\n    // Then reinitialize game\r\n    initializeGame();\r\n    // Ensure control buttons are updated (hide restart based on pause state)\r\n    render.updateControlButtons();\r\n}\r\n\r\n// --- Event Handlers ---\r\n\r\nfunction handlePieceClick(event) {\r\n    if (gameState.isPaused || gameState.isGameOver || gameState.dragState.isDragging) {\r\n        return;\r\n    }\r\n    \r\n    const pieceElement = event.target.closest('.piece');\r\n    \r\n    if (!pieceElement || pieceElement.classList.contains('empty')) {\r\n        return;\r\n    }\r\n    \r\n    const pieceIndex = parseInt(pieceElement.dataset.pieceIndex);\r\n    \r\n    // If we are in rotate mode, use token and rotate\r\n    if (gameState.specialModes.rotateMode && gameState.specialModes.isWaitingForRotate) {\r\n        const success = logic.rotateSpecificPiece(pieceIndex);\r\n        \r\n        if (success) {\r\n            gameState.rotateTokens--; // Consume token on success\r\n            render.updatePiecesDisplay();\r\n            audio.playRotateSound();\r\n            showSpecialModeMessage('rotate', 'Piece rotated successfully!', 1000);\r\n        }\r\n        \r\n        // Reset rotate mode\r\n        gameState.specialModes.rotateMode = false;\r\n        gameState.specialModes.isWaitingForRotate = false;\r\n        updateSpecialActionButtons();\r\n        // Re-enable dragging after exiting rotate mode\r\n        attachPieceEventListeners();\r\n        return;\r\n    }\r\n\r\n    // If we are in flip mode, flip piece horizontally\r\n    if (gameState.specialModes.flipMode && gameState.specialModes.isWaitingForFlip) {\r\n        const piece = gameState.currentPieces[pieceIndex];\r\n        \r\n        if (!piece || !piece.currentShape) {\r\n            showSpecialModeMessage('flip', 'Cannot flip this piece', 1500);\r\n            return;\r\n        }\r\n        \r\n        // Apply horizontal flip (mirror left-right)\r\n        const flipped = logic.flipPieceHorizontally(piece);\r\n        \r\n        if (!flipped || !flipped.currentShape) {\r\n            showSpecialModeMessage('flip', 'Flip failed', 1500);\r\n            return;\r\n        }\r\n        \r\n        piece.currentShape = flipped.currentShape;\r\n        piece.id = Date.now() + Math.random(); // Force UI update\r\n        gameState.flipTokens--; // Consume flip token\r\n        \r\n        render.updatePiecesDisplay();\r\n        audio.playRotateSound();\r\n        showSpecialModeMessage('flip', 'Piece flipped!', 1000);\r\n        \r\n        // Reset flip mode\r\n        gameState.specialModes.flipMode = false;\r\n        gameState.specialModes.isWaitingForFlip = false;\r\n        updateSpecialActionButtons();\r\n        attachPieceEventListeners();\r\n        return;\r\n    }\r\n\r\n    // If we are in clear line mode, user should click a grid cell not a piece\r\n    if (gameState.specialModes.clearLineMode) {\r\n        showSpecialModeMessage('clearLine', 'Click on a grid cell to clear a line', 1500);\r\n        return;\r\n    }\r\n}\r\n\r\n// --- MOUSE EVENT HANDLERS FOR CUSTOM DRAG (Alternative to HTML5 drag & drop) ---\r\n\r\n// --- MOUSE MOVE OPTIMIZATION ---\r\nlet __lastMouseEvent = null;\r\nlet __mouseRAF = 0;\r\nconst DRAG_PROFILING_ENABLED = false;\r\nfunction startDragTimer(label) {\r\n    if (DRAG_PROFILING_ENABLED) console.time(label);\r\n}\r\nfunction endDragTimer(label) {\r\n    if (DRAG_PROFILING_ENABLED) console.timeEnd(label);\r\n}\r\n\r\n/**\r\n * Wrapper for mousemove to throttle via requestAnimationFrame for better performance\r\n * BUT updates visual position IMMEDIATELY without waiting for RAF for smooth feel\r\n */\r\nfunction handleMouseMove(event) {\r\n    if (!gameState.dragState.isDragging) return;\r\n    \r\n    // DRAG LATENCY FIX: Update visual position IMMEDIATELY - don't wait for RAF\r\n    const clientX = event.clientX;\r\n    const clientY = event.clientY;\r\n    render.updateDraggedPiecePosition(clientX, clientY);\r\n    \r\n    // Mark as moved if threshold exceeded (immediate feedback)\r\n    if (!gameState.dragState.hasMoved) {\r\n        const dx = clientX - gameState.dragState.startX;\r\n        const dy = clientY - gameState.dragState.startY;\r\n        if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {\r\n            gameState.dragState.hasMoved = true;\r\n        }\r\n    }\r\n    \r\n    // Store event for RAF processing (hit-testing and highlighting are deferred to RAF)\r\n    __lastMouseEvent = event;\r\n    if (!__mouseRAF) {\r\n        __mouseRAF = requestAnimationFrame(() => {\r\n            const ev = __lastMouseEvent;\r\n            __mouseRAF = 0;\r\n            if (ev) _handleMouseMoveInner(ev);\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Inner handler q ekzekuton logjikn aktuale t lvizjes s mouse\r\n * OPTIMIZED: Shmanget prditsimi kur pozicioni nuk ka ndryshuar\r\n * NOTE: Visual position update is done IMMEDIATELY in handleMouseMove(), not here\r\n */\r\nfunction _handleMouseMoveInner(event) {\r\n    if (!gameState.dragState.isDragging) return;\r\n    \r\n    startDragTimer('drag:hit-test');\r\n    const clientX = event.clientX;\r\n    const clientY = event.clientY;\r\n    \r\n    //  Store current pointer position for line clear grid re-positioning\r\n    gameState.dragState.clientX = clientX;\r\n    gameState.dragState.clientY = clientY;\r\n    \r\n    // NOTE: Visual position update is now done IMMEDIATELY in handleMouseMove(), not here\r\n    // This eliminates lag and makes drag feel elastic-free\r\n    \r\n    // Determine drop target using math-based mapping\r\n    const pos = getCellFromPoint(clientX, clientY);\r\n    if (!pos) {\r\n        endDragTimer('drag:hit-test');\r\n        render.clearHighlights();\r\n        gameState.dragState.lastTargetRow = undefined;\r\n        gameState.dragState.lastTargetCol = undefined;\r\n        return;\r\n    }\r\n    \r\n    const startRow = pos.row - gameState.dragState.offsetY;\r\n    const startCol = pos.col - gameState.dragState.offsetX;\r\n    \r\n    // OPTIMIZATION: Shmanget prditsimi nse pozicioni nuk ka ndryshuar\r\n    if (startRow === gameState.dragState.lastTargetRow && \r\n        startCol === gameState.dragState.lastTargetCol) {\r\n        endDragTimer('drag:hit-test');\r\n        return; // Asnj ndryshim, mos bj asgj\r\n    }\r\n    \r\n    startDragTimer('drag:validate-placement');\r\n    const piece = gameState.currentPieces[gameState.dragState.pieceIndex];\r\n    const isValid = logic.isValidPlacement(piece.currentShape, startRow, startCol);\r\n    endDragTimer('drag:validate-placement');\r\n    \r\n    // Log only when validity changes (not every frame)\r\n    if ((!gameState.dragState._lastValidState || gameState.dragState._lastValidState !== isValid) && logger.LOG_DRAG) {\r\n        logger.logDragMove(gameState.dragState.pieceIndex, clientX, clientY, \r\n                          { row: startRow, col: startCol }, isValid);\r\n        gameState.dragState._lastValidState = isValid;\r\n    }\r\n    \r\n    startDragTimer('drag:highlight');\r\n    render.showGhostAndHighlight(piece, startRow, startCol, isValid);\r\n    endDragTimer('drag:highlight');\r\n    \r\n    gameState.dragState.lastTargetRow = startRow;\r\n    gameState.dragState.lastTargetCol = startCol;\r\n    endDragTimer('drag:hit-test');\r\n}\r\n\r\nfunction handleMouseUp(event) {\r\n    if (!gameState.dragState.isDragging) return;\r\n    \r\n    // Cancel any pending RAF\r\n    if (__mouseRAF) {\r\n        cancelAnimationFrame(__mouseRAF);\r\n        __mouseRAF = 0;\r\n    }\r\n    \r\n    // Clean up mouse listeners\r\n    document.removeEventListener('mousemove', handleMouseMove);\r\n    document.removeEventListener('mouseup', handleMouseUp);\r\n    window.removeEventListener('mouseup', handleMouseUp);\r\n    document.removeEventListener('mouseleave', handleMouseUp);\r\n    if ('onpointerup' in window) {\r\n        document.removeEventListener('pointerup', handleMouseUp);\r\n    }\r\n    \r\n    const duration = Date.now() - (gameState.dragState.startTime || 0);\r\n    if (!gameState.dragState.hasMoved && duration < 300) {\r\n        // Tap/click  cancel drag without placement\r\n        finishDrag();\r\n        return;\r\n    }\r\n    \r\n    // Process drop like touch\r\n    const { pieceIndex, lastTargetRow, lastTargetCol } = gameState.dragState;\r\n    \r\n    if (lastTargetRow !== undefined && lastTargetCol !== undefined) {\r\n        const piece = gameState.currentPieces[pieceIndex];\r\n        const isValid = logic.isValidPlacement(piece.currentShape, lastTargetRow, lastTargetCol);\r\n        \r\n        if (isValid) {\r\n            // IMPORTANT: processSuccessfulPlacement itself will call finishDrag()\r\n            // (either directly or via the line-clear animation callback).\r\n            processSuccessfulPlacement(piece, pieceIndex, lastTargetRow, lastTargetCol);\r\n        } else {\r\n            // Invalid placement  shake + single finishDrag()\r\n            processFailedPlacement();\r\n            finishDrag();\r\n        }\r\n    } else {\r\n        // No target at all  failed placement + single finishDrag()\r\n        processFailedPlacement();\r\n        finishDrag();\r\n    }\r\n}\r\n\r\n// --- DRAG & DROP (MOUSE) HANDLERS ---\r\n\r\n// OPTIMIZATION: Cache grid metrics at drag start to avoid repeated DOM reads during drag move\r\nfunction cacheGridMetrics() {\r\n    const grid = dom.gameGrid;\r\n    if (!grid) return;\r\n\r\n    const rect = grid.getBoundingClientRect();\r\n    let cellSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-cell-size'));\r\n    if (!cellSize || Number.isNaN(cellSize)) {\r\n        const probe = grid.querySelector('.grid-cell');\r\n        if (probe) cellSize = probe.getBoundingClientRect().width; else cellSize = 40;\r\n    }\r\n    let gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-gap'));\r\n    if (Number.isNaN(gap)) gap = 0;\r\n\r\n    const cs = getComputedStyle(grid);\r\n    const padL = parseFloat(cs.paddingLeft) || 0;\r\n    const padT = parseFloat(cs.paddingTop) || 0;\r\n    const bordL = parseFloat(cs.borderLeftWidth) || 0;\r\n    const bordT = parseFloat(cs.borderTopWidth) || 0;\r\n\r\n    Object.assign(gameState.dragState, {\r\n        gridMetricsCached: true,\r\n        gridRect: { left: rect.left, top: rect.top },\r\n        cellSize: cellSize,\r\n        step: cellSize + gap,\r\n        gridPadL: padL,\r\n        gridPadT: padT,\r\n        gridBordL: bordL,\r\n        gridBordT: bordT,\r\n    });\r\n}\r\n\r\n// Helper: map a screen point to the nearest grid cell, even when over the gap\r\n// OPTIMIZED: Uses cached grid metrics when available to avoid DOM reads during drag\r\nfunction getCellFromPoint(clientX, clientY) {\r\n    const grid = dom.gameGrid;\r\n    if (!grid) return null;\r\n\r\n    let cellSize, step, gridLeft, gridTop, padL, padT, bordL, bordT;\r\n\r\n    // Use cached metrics if available (during drag), otherwise read DOM\r\n    if (gameState.dragState.gridMetricsCached) {\r\n        cellSize = gameState.dragState.cellSize;\r\n        step = gameState.dragState.step;\r\n        gridLeft = gameState.dragState.gridRect.left;\r\n        gridTop = gameState.dragState.gridRect.top;\r\n        padL = gameState.dragState.gridPadL;\r\n        padT = gameState.dragState.gridPadT;\r\n        bordL = gameState.dragState.gridBordL;\r\n        bordT = gameState.dragState.gridBordT;\r\n    } else {\r\n        // Fallback: read from DOM if not cached\r\n        const rect = grid.getBoundingClientRect();\r\n        gridLeft = rect.left;\r\n        gridTop = rect.top;\r\n\r\n        cellSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-cell-size'));\r\n        if (!cellSize || Number.isNaN(cellSize)) {\r\n            const probe = grid.querySelector('.grid-cell');\r\n            if (probe) cellSize = probe.getBoundingClientRect().width; else cellSize = 40;\r\n        }\r\n        let gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-gap'));\r\n        if (Number.isNaN(gap)) gap = 0;\r\n\r\n        step = cellSize + gap;\r\n        const cs = getComputedStyle(grid);\r\n        padL = parseFloat(cs.paddingLeft) || 0;\r\n        padT = parseFloat(cs.paddingTop) || 0;\r\n        bordL = parseFloat(cs.borderLeftWidth) || 0;\r\n        bordT = parseFloat(cs.borderTopWidth) || 0;\r\n    }\r\n\r\n    // Quickly reject if completely outside grid bounds\r\n    const gridWidth = 10 * cellSize + 9 * (step - cellSize);\r\n    const gridHeight = 10 * cellSize + 9 * (step - cellSize);\r\n    if (clientX < gridLeft || clientX > gridLeft + gridWidth || \r\n        clientY < gridTop || clientY > gridTop + gridHeight) {\r\n        return null;\r\n    }\r\n\r\n    const x = clientX - gridLeft - padL - bordL;\r\n    const y = clientY - gridTop - padT - bordT;\r\n    \r\n    // Snap to the NEAREST cell center so transitions are symmetric (50/50)\r\n    let col = Math.round((x - cellSize / 2) / step);\r\n    let row = Math.round((y - cellSize / 2) / step);\r\n\r\n    // Clamp within grid\r\n    col = Math.min(Math.max(0, col), GRID_COLS - 1);\r\n    row = Math.min(Math.max(0, row), GRID_ROWS - 1);\r\n\r\n    return { row, col };\r\n}\r\n\r\nfunction handleDragStart(event) {\r\n    if (gameState.isPaused || gameState.isGameOver) {\r\n        event.preventDefault();\r\n        return;\r\n    }\r\n    \r\n    // Don't allow dragging if in special modes (rotate/flip/hint)\r\n    if (gameState.specialModes.rotateMode || gameState.specialModes.flipMode || gameState.specialModes.hintMode) {\r\n        event.preventDefault();\r\n        return;\r\n    }\r\n    \r\n    // For desktop mouse events, use custom drag behavior instead of HTML5 drag & drop\r\n    if (event.type === 'mousedown') {\r\n        // Prevent default HTML5 drag behavior\r\n        event.preventDefault();\r\n        \r\n        audio.initAudioContext();\r\n        audio.playHapticFeedback(30);\r\n\r\n        const pieceElement = event.target.closest('.piece');\r\n        if (!pieceElement || pieceElement.classList.contains('empty')) {\r\n            return;\r\n        }\r\n        const pieceIndex = parseInt(pieceElement.dataset.pieceIndex);\r\n        const pieceData = gameState.currentPieces[pieceIndex];\r\n        \r\n        logger.logDragStart(pieceIndex, event.clientX, event.clientY, { row: 0, col: 0 });\r\n        \r\n        const pieceRect = pieceElement.getBoundingClientRect();\r\n        const clickXInPiece = event.clientX - pieceRect.left;\r\n        const clickYInPiece = event.clientY - pieceRect.top;\r\n\r\n        let closestBlock = { dist: Infinity, row: 0, col: 0 };\r\n        pieceElement.querySelectorAll('.piece-block[data-shape-row]').forEach(block => {\r\n            const blockRect = block.getBoundingClientRect();\r\n            const blockCenterX = (blockRect.left - pieceRect.left) + blockRect.width / 2;\r\n            const blockCenterY = (blockRect.top - pieceRect.top) + blockRect.height / 2;\r\n            const distance = Math.hypot(clickXInPiece - blockCenterX, clickYInPiece - blockCenterY);\r\n            if (distance < closestBlock.dist) {\r\n                closestBlock = {\r\n                    dist: distance,\r\n                    row: parseInt(block.dataset.shapeRow),\r\n                    col: parseInt(block.dataset.shapeCol)\r\n                };\r\n            }\r\n        });\r\n\r\n        resetDragState();\r\n        // OPTIMIZATION: Cache grid metrics now for fast getCellFromPoint calls during drag\r\n        cacheGridMetrics();\r\n        \r\n        Object.assign(gameState.dragState, {\r\n            isDragging: true,\r\n            pieceIndex: pieceIndex,\r\n            pieceSourceElement: pieceElement,\r\n            offsetX: closestBlock.col,\r\n            offsetY: closestBlock.row,\r\n            startX: event.clientX,\r\n            startY: event.clientY,\r\n            startTime: Date.now(),\r\n            hasMoved: false,\r\n            lastTargetRow: undefined,\r\n            lastTargetCol: undefined,\r\n        });\r\n\r\n        render.createDraggedPieceClone(pieceData);\r\n        render.updateDraggedPiecePosition(event.clientX, event.clientY);\r\n        \r\n        pieceElement.classList.add('dragging');\r\n        \r\n        // Add global mouse listeners for custom drag behavior (like touch)\r\n        document.addEventListener('mousemove', handleMouseMove);\r\n        document.addEventListener('mouseup', handleMouseUp);\r\n        // Also add mouseup to window as backup\r\n        window.addEventListener('mouseup', handleMouseUp);\r\n        // Add mouseleave as another backup\r\n        document.addEventListener('mouseleave', handleMouseUp);\r\n        \r\n        // Also try pointer events as backup if supported\r\n        if ('onpointerup' in window) {\r\n            document.addEventListener('pointerup', handleMouseUp);\r\n        }\r\n        \r\n        return;\r\n    }\r\n    \r\n    // For HTML5 drag events, prevent them to avoid conflicts\r\n    if (event.type === 'dragstart') {\r\n        event.preventDefault();\r\n        return;\r\n    }\r\n\r\n    pieceElement.classList.add('dragging');\r\n}\r\n\r\nfunction handleDragOver(event) {\r\n    event.preventDefault();\r\n    if (!gameState.dragState.isDragging) return;\r\n\r\n    const clientX = event.clientX;\r\n    const clientY = event.clientY;\r\n\r\n    render.updateDraggedPiecePosition(clientX, clientY);\r\n\r\n    // Prefer math-based mapping to handle gaps between cells\r\n    const pos = getCellFromPoint(clientX, clientY);\r\n    if (!pos) {\r\n        render.clearHighlights();\r\n        gameState.dragState.lastTargetRow = undefined;\r\n        gameState.dragState.lastTargetCol = undefined;\r\n        return;\r\n    }\r\n\r\n    const startRow = pos.row - gameState.dragState.offsetY;\r\n    const startCol = pos.col - gameState.dragState.offsetX;\r\n\r\n    const piece = gameState.currentPieces[gameState.dragState.pieceIndex];\r\n    const isValid = logic.isValidPlacement(piece.currentShape, startRow, startCol);\r\n\r\n    render.showGhostAndHighlight(piece, startRow, startCol, isValid);\r\n\r\n    gameState.dragState.lastTargetRow = startRow;\r\n    gameState.dragState.lastTargetCol = startCol;\r\n}\r\n\r\nfunction handleDrop(event) {\r\n    event.preventDefault();\r\n    if (!gameState.dragState.isDragging) return;\r\n\r\n    const { pieceIndex, lastTargetRow, lastTargetCol } = gameState.dragState;\r\n    \r\n    if (lastTargetRow !== undefined && lastTargetCol !== undefined) {\r\n        const piece = gameState.currentPieces[pieceIndex];\r\n        if (logic.isValidPlacement(piece.currentShape, lastTargetRow, lastTargetCol)) {\r\n            processSuccessfulPlacement(piece, pieceIndex, lastTargetRow, lastTargetCol);\r\n            // finishDrag() will be called from processSuccessfulPlacement callback\r\n        } else {\r\n            processFailedPlacement();\r\n            finishDrag();\r\n        }\r\n    } else {\r\n        processFailedPlacement();\r\n        finishDrag();\r\n    }\r\n}\r\n\r\nfunction handleDragEnd() {\r\n    if (!gameState.dragState.isDragging) return;\r\n    finishDrag();\r\n}\r\n\r\n// Fallback handler for desktop mouse operations\r\nfunction handleDragEndFallback() {\r\n    // Only trigger if we're actually dragging and haven't handled it yet\r\n    if (gameState.dragState.isDragging) {\r\n        finishDrag();\r\n    }\r\n}\r\n\r\n// --- TOUCH EVENT CLEANUP FUNCTIONS ---\r\n\r\n/**\r\n * Removes all global touch event listeners to prevent memory leaks\r\n */\r\nfunction cleanupTouchListeners() {\r\n    // Cancel any pending RAF\r\n    if (__dragRAF) {\r\n        cancelAnimationFrame(__dragRAF);\r\n        __dragRAF = 0;\r\n    }\r\n    document.removeEventListener('touchmove', handleTouchMove);\r\n    document.removeEventListener('touchend', handleTouchEnd);\r\n    document.removeEventListener('touchcancel', handleTouchEnd);\r\n}\r\n\r\n// --- TOUCH MOVE WRAPPER FOR PASSIVE HANDLING ---\r\nlet __lastTouchEvent = null;\r\nlet __dragRAF = 0;\r\n\r\n/**\r\n * Wrapper for touchmove to throttle _handleTouchMoveInner via requestAnimationFrame\r\n * BUT updates visual position IMMEDIATELY without waiting for RAF for smooth feel\r\n */\r\nfunction handleTouchMove(event) {\r\n    if (!gameState.dragState.isDragging) return;\r\n    if (event.cancelable) {\r\n        event.preventDefault(); // kill browser scroll/zoom heuristics ASAP\r\n    }\r\n    \r\n    // Find the correct touch by identifier\r\n    const touch = Array.from(event.touches).find(t => t.identifier === gameState.dragState.touchIdentifier);\r\n    if (!touch) return;\r\n    \r\n    // DRAG LATENCY FIX: Update visual position IMMEDIATELY - don't wait for RAF\r\n    // This eliminates the \"elastic\" lag by keeping visuals in sync with finger\r\n    const clientX = touch.clientX;\r\n    const clientY = touch.clientY;\r\n    render.updateDraggedPiecePosition(clientX, clientY + gameState.dragState.touchOffsetY);\r\n    \r\n    // Mark as moved if threshold exceeded (immediate feedback)\r\n    if (!gameState.dragState.hasMoved) {\r\n        const dx = clientX - gameState.dragState.startX;\r\n        const dy = clientY - gameState.dragState.startY;\r\n        if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {\r\n            gameState.dragState.hasMoved = true;\r\n        }\r\n    }\r\n    \r\n    // Store event for RAF processing (hit-testing and highlighting are deferred to RAF)\r\n    __lastTouchEvent = event;\r\n    if (!__dragRAF) {\r\n        __dragRAF = requestAnimationFrame(() => {\r\n            const ev = __lastTouchEvent;\r\n            __dragRAF = 0;\r\n            if (ev) _handleTouchMoveInner(ev);\r\n        });\r\n    }\r\n}\r\n\r\n// --- TOUCH EVENT HANDLERS ---\r\n\r\nfunction handleTouchStart(event) {\r\n    if (gameState.isPaused || gameState.isGameOver) return;\r\n    \r\n    // Don't allow dragging if in special modes (rotate/flip/hint)\r\n    if (gameState.specialModes.rotateMode || gameState.specialModes.flipMode || gameState.specialModes.hintMode) {\r\n        return;\r\n    }\r\n    \r\n    // Only prevent default if dragging a piece\r\n    if (event.cancelable && event.target.closest('.piece')) {\r\n        event.preventDefault();\r\n    }\r\n\r\n    // Clean up any existing touch listeners before adding new ones\r\n    cleanupTouchListeners();\r\n\r\n    audio.initAudioContext();\r\n    audio.playHapticFeedback(30);\r\n\r\n    const touch = event.touches[0];\r\n    const pieceElement = event.target.closest('.piece');\r\n    if (!pieceElement || pieceElement.classList.contains('empty')) {\r\n        return;\r\n    }\r\n    const pieceIndex = parseInt(pieceElement.dataset.pieceIndex);\r\n    const pieceData = gameState.currentPieces[pieceIndex];\r\n\r\n    const pieceRect = pieceElement.getBoundingClientRect();\r\n    const touchXInPiece = touch.clientX - pieceRect.left;\r\n    const touchYInPiece = touch.clientY - pieceRect.top;\r\n\r\n    let closestBlock = { dist: Infinity, row: 0, col: 0 };\r\n    pieceElement.querySelectorAll('.piece-block[data-shape-row]').forEach(block => {\r\n        const blockRect = block.getBoundingClientRect();\r\n        const blockCenterX = (blockRect.left - pieceRect.left) + blockRect.width / 2;\r\n        const blockCenterY = (blockRect.top - pieceRect.top) + blockRect.height / 2;\r\n        const distance = Math.hypot(touchXInPiece - blockCenterX, touchYInPiece - blockCenterY);\r\n        if (distance < closestBlock.dist) {\r\n            closestBlock = {\r\n                dist: distance,\r\n                row: parseInt(block.dataset.shapeRow),\r\n                col: parseInt(block.dataset.shapeCol)\r\n            };\r\n        }\r\n    });\r\n    \r\n    const TOUCH_OFFSET_Y = -85;\r\n    resetDragState();\r\n    // OPTIMIZATION: Cache grid metrics now for fast getCellFromPoint calls during drag\r\n    cacheGridMetrics();\r\n    \r\n    Object.assign(gameState.dragState, {\r\n        isDragging: true,\r\n        pieceIndex: pieceIndex,\r\n        pieceSourceElement: pieceElement,\r\n        offsetX: closestBlock.col,\r\n        offsetY: closestBlock.row,  // NOW USING ACCURATE OFFSET\r\n        touchIdentifier: touch.identifier,\r\n        startX: touch.clientX,\r\n        startY: touch.clientY,\r\n        startTime: Date.now(),\r\n        hasMoved: false,\r\n        touchOffsetY: TOUCH_OFFSET_Y,\r\n    });\r\n    render.createDraggedPieceClone(pieceData);\r\n    render.updateDraggedPiecePosition(touch.clientX, touch.clientY + TOUCH_OFFSET_Y);\r\n    pieceElement.classList.add('dragging');\r\n\r\n    // Add touch listeners with proper cleanup tracking\r\n    document.addEventListener('touchmove', handleTouchMove, { passive: false });\r\n    document.addEventListener('touchend', handleTouchEnd, { passive: false });\r\n    document.addEventListener('touchcancel', handleTouchEnd, { passive: false });\r\n}\r\n\r\nfunction _handleTouchMoveInner(event) {\r\n    if (!gameState.dragState.isDragging) return;\r\n    if (event.cancelable) event.preventDefault();\r\n\r\n    startDragTimer('touch:hit-test');\r\n    \r\n    // Find the correct touch by identifier\r\n    const touch = Array.from(event.touches).find(t => t.identifier === gameState.dragState.touchIdentifier);\r\n    if (!touch) {\r\n        endDragTimer('touch:hit-test');\r\n        return;\r\n    }\r\n    const clientX = touch.clientX;\r\n    const clientY = touch.clientY;\r\n\r\n    //  Store current pointer position for line clear grid re-positioning\r\n    gameState.dragState.clientX = clientX;\r\n    gameState.dragState.clientY = clientY + gameState.dragState.touchOffsetY;\r\n\r\n    // NOTE: Visual position update is now done IMMEDIATELY in handleTouchMove(), not here\r\n    // This eliminates lag and makes drag feel elastic-free\r\n\r\n    // Determine drop target using math-based mapping (robust over gaps)\r\n    const pos = getCellFromPoint(clientX, clientY + gameState.dragState.touchOffsetY);\r\n    if (!pos) {\r\n        endDragTimer('touch:hit-test');\r\n        render.clearHighlights();\r\n        gameState.dragState.lastTargetRow = undefined;\r\n        gameState.dragState.lastTargetCol = undefined;\r\n        return;\r\n    }\r\n    const startRow = pos.row - gameState.dragState.offsetY;\r\n    const startCol = pos.col - gameState.dragState.offsetX;\r\n    \r\n    // OPTIMIZATION: Shmanget prditsimi nse pozicioni nuk ka ndryshuar\r\n    if (startRow === gameState.dragState.lastTargetRow && \r\n        startCol === gameState.dragState.lastTargetCol) {\r\n        endDragTimer('touch:hit-test');\r\n        return; // Asnj ndryshim, mos bj asgj\r\n    }\r\n    \r\n    startDragTimer('touch:validate-placement');\r\n    const piece = gameState.currentPieces[gameState.dragState.pieceIndex];\r\n    const isValid = logic.isValidPlacement(piece.currentShape, startRow, startCol);\r\n    endDragTimer('touch:validate-placement');\r\n    \r\n    startDragTimer('touch:highlight');\r\n    render.showGhostAndHighlight(piece, startRow, startCol, isValid);\r\n    endDragTimer('touch:highlight');\r\n    \r\n    gameState.dragState.lastTargetRow = startRow;\r\n    gameState.dragState.lastTargetCol = startCol;\r\n    endDragTimer('touch:hit-test');\r\n}\r\n\r\nfunction handleTouchEnd(event) {\r\n    if (!gameState.dragState.isDragging) return;\r\n    \r\n    // Clean up touch listeners immediately\r\n    cleanupTouchListeners();\r\n    \r\n    const duration = Date.now() - (gameState.dragState.startTime || 0);\r\n    if (!gameState.dragState.hasMoved && duration < 300) {\r\n        // Tap  cancel drag\r\n        finishDrag();\r\n        return;\r\n    }\r\n    // Otherwise, treat as drop. Let handleDrop decide when to call finishDrag().\r\n    setTimeout(() => {\r\n        handleDrop(event);\r\n        // DO NOT call finishDrag() here  handleDrop / processSuccessfulPlacement /\r\n        // processFailedPlacement already handle it correctly.\r\n    }, 50);\r\n}\r\n\r\n// --- HELPER FUNCTIONS FOR DRAG/DROP LOGIC ---\r\n\r\nfunction processSuccessfulPlacement(piece, pieceIndex, row, col) {\r\n    logger.logPlacementValid(pieceIndex, row, col, piece.currentShape.length);\r\n    logger.logPerformanceStart('placement-process');\r\n    \r\n    // Clear any active hint highlights when placing a piece\r\n    if (window.clearHintHighlights) {\r\n        window.clearHintHighlights();\r\n    }\r\n    \r\n    // DETAILED PERF: Save game state\r\n    console.time('placement:save-state');\r\n    logic.saveGameState();\r\n    console.timeEnd('placement:save-state');\r\n    \r\n    // Record cells for placement animation\r\n    gameState.lastPlacementCells = piece.currentShape.map(([r, c]) => ({ r: row + r, c: col + c }));\r\n    \r\n    // DETAILED PERF: Place piece on grid\r\n    console.time('placement:place-piece');\r\n    logic.placePieceOnGrid(piece, row, col);\r\n    console.timeEnd('placement:place-piece');\r\n    \r\n    audio.playPlaceSound();\r\n    \r\n    // DETAILED PERF: Replace used piece\r\n    console.time('placement:replace-piece');\r\n    logic.replaceUsedPiece(pieceIndex);\r\n    console.timeEnd('placement:replace-piece');\r\n\r\n    // DETAILED PERF: Detect and clear lines\r\n    console.time('placement:detect-lines');\r\n    const clearResult = logic.checkAndClearLines(piece.color);\r\n    console.timeEnd('placement:detect-lines');\r\n    \r\n    if (clearResult) {\r\n        const totalLines = clearResult.clearedRows.length + clearResult.clearedCols.length;\r\n        logger.logLineCleared(clearResult.clearedRows.concat(clearResult.clearedCols), totalLines * 10);\r\n        logger.logScoreAdded(clearResult.pointsEarned, 'line clear');\r\n        \r\n        // DETAILED PERF: Animate line clears\r\n        console.time('placement:animate-lines');\r\n        // Animate line clears, then handle Game Over after animations\r\n        handleLineClearEffects(clearResult, () => {\r\n            console.timeEnd('placement:animate-lines');\r\n            \r\n            // DETAILED PERF: Update special actions and game state\r\n            console.time('placement:update-state');\r\n            updateSpecialActionButtons();\r\n            logic.updateGameOverState();\r\n            if (gameState.isGameOver) {\r\n                gameState.isPaused = false;\r\n                audio.playGameOverSound();\r\n                logger.logGameOver(gameState.score, pieceIndex + 1);\r\n            }\r\n            render.updateOverlays();\r\n            console.timeEnd('placement:update-state');\r\n            \r\n            // DETAILED PERF: Finish drag\r\n            console.time('placement:finish-drag');\r\n            finishDrag();\r\n            console.timeEnd('placement:finish-drag');\r\n            \r\n            logger.logPerformanceEnd('placement-process');\r\n        }, piece.color);\r\n        checkSpecialRewards(clearResult.pointsEarned, clearResult.comboCount);\r\n    } else {\r\n        // No clears: check Game Over immediately\r\n        logger.logScoreAdded(0, 'placement only');\r\n        \r\n        // DETAILED PERF: Update state when no clears\r\n        console.time('placement:update-state-no-clear');\r\n        updateSpecialActionButtons();\r\n        logic.updateGameOverState();\r\n        if (gameState.isGameOver) {\r\n            gameState.isPaused = false;\r\n            audio.playGameOverSound();\r\n            logger.logGameOver(gameState.score, pieceIndex + 1);\r\n        }\r\n        render.updateOverlays();\r\n        console.timeEnd('placement:update-state-no-clear');\r\n        \r\n        // DETAILED PERF: Finish drag\r\n        console.time('placement:finish-drag-no-clear');\r\n        finishDrag();\r\n        console.timeEnd('placement:finish-drag-no-clear');\r\n        \r\n        logger.logPerformanceEnd('placement-process');\r\n    }\r\n}\r\n\r\nfunction processFailedPlacement() {\r\n    logger.logWarning('Invalid placement attempt - piece cannot be placed there');\r\n    render.shakeDraggedPieceClone(INVALID_PLACEMENT_SHAKE_DURATION);\r\n    audio.playHapticFeedback([20, 10, 20]);\r\n}\r\n\r\nfunction finishDrag() {\r\n    console.time('finishDrag:total');\r\n    \r\n    console.time('finishDrag:hide-elements');\r\n    render.hideDraggedPieceClone();\r\n    render.clearHighlights();\r\n    console.timeEnd('finishDrag:hide-elements');\r\n    \r\n    // Clean up touch listeners in case they weren't cleaned up elsewhere\r\n    cleanupTouchListeners();\r\n    \r\n    // Clean up mouse listeners in case they weren't cleaned up elsewhere\r\n    document.removeEventListener('mousemove', handleMouseMove);\r\n    document.removeEventListener('mouseup', handleMouseUp);\r\n    window.removeEventListener('mouseup', handleMouseUp);\r\n    document.removeEventListener('mouseleave', handleMouseUp);\r\n    if ('onpointerup' in window) {\r\n        document.removeEventListener('pointerup', handleMouseUp);\r\n    }\r\n    \r\n    if (gameState.dragState.pieceSourceElement) {\r\n        gameState.dragState.pieceSourceElement.classList.remove('dragging');\r\n    }\r\n\r\n    console.time('finishDrag:reset-state');\r\n    // Reset drag state completely\r\n    resetDragState();\r\n    console.timeEnd('finishDrag:reset-state');\r\n    \r\n    console.time('finishDrag:update-grid');\r\n    render.updateGridDisplay();\r\n    console.timeEnd('finishDrag:update-grid');\r\n    \r\n    console.time('finishDrag:animate-placement');\r\n    // Animate the recently placed cells\r\n    render.animatePlacement(gameState.lastPlacementCells);\r\n    console.timeEnd('finishDrag:animate-placement');\r\n    \r\n    console.time('finishDrag:update-pieces');\r\n    // Always update pieces display after drag operations since pieces may have changed\r\n    // (when a piece is placed, it gets replaced with a new one)\r\n    render.updatePiecesDisplay();\r\n    attachPieceEventListeners();\r\n    console.timeEnd('finishDrag:update-pieces');\r\n    \r\n    console.time('finishDrag:update-ui');\r\n    render.updateScoreDisplay();\r\n    render.updateControlButtons();\r\n    render.updateOverlays(); // Thirrja e re pr t menaxhuar mbivendosjet\r\n    // Clear placement animation flag\r\n    render.clearPlacementFlag();\r\n    console.timeEnd('finishDrag:update-ui');\r\n    \r\n    console.timeEnd('finishDrag:total');\r\n}\r\n\r\nfunction handleLineClearEffects(clearResult, onComplete, placedPieceColor = null) {\r\n    audio.playClearSound(clearResult.totalLinesCleared);\r\n    const boardSize = GRID_COLS;\r\n    const gameGrid = dom.gameGrid;\r\n    const gameArea = document.querySelector('.game-area');\r\n    \r\n    // Use placedPieceColor from clearResult if not provided\r\n    if (!placedPieceColor && clearResult.placedPieceColor) {\r\n        placedPieceColor = clearResult.placedPieceColor;\r\n    }\r\n    \r\n    // Determine a visual color to use for the clear bar/frame.\r\n    // Preference order:\r\n    // 1) explicit placedPieceColor (palette index)\r\n    // 2) clearResult.placedPieceColor (propagated from gameLogic)\r\n    // 3) first cell's `animationColor` if present (string hex/rgb)\r\n    let visualPieceColor = placedPieceColor || (clearResult && clearResult.placedPieceColor) || null;\r\n    if (!visualPieceColor && clearResult && Array.isArray(clearResult.cellsToAnimate) && clearResult.cellsToAnimate.length) {\r\n        const firstAnim = clearResult.cellsToAnimate.find(c => c && c.animationColor);\r\n        if (firstAnim && firstAnim.animationColor) {\r\n            visualPieceColor = firstAnim.animationColor;\r\n        }\r\n    }\r\n\r\n    // Call Galaxy Row Clear animation\r\n    animateLineClearSpectra({\r\n        ctx: null, // Not using canvas\r\n        rows: clearResult.clearedRows || [],\r\n        cols: clearResult.clearedCols || [],\r\n        boardSize: boardSize,\r\n        placedPieceColor: visualPieceColor,\r\n        onClearRow: (r) => {\r\n            // Clear row from game state\r\n            gameState.grid[r] = Array(boardSize).fill(0);\r\n            //  Update DOM immediately (not after 1500ms)\r\n            render.updateGridDisplay();\r\n            //  If user is dragging, re-position clone after grid layout change\r\n            if (gameState.dragState.isDragging) {\r\n                const { clientX, clientY } = gameState.dragState;\r\n                if (clientX !== undefined && clientY !== undefined) {\r\n                    render.updateDraggedPiecePosition(clientX, clientY);\r\n                }\r\n            }\r\n        },\r\n        onClearCol: (c) => {\r\n            // Clear column from game state\r\n            for (let r = 0; r < GRID_ROWS; r++) {\r\n                gameState.grid[r][c] = 0;\r\n            }\r\n            //  Update DOM immediately (not after 1500ms)\r\n            render.updateGridDisplay();\r\n            //  If user is dragging, re-position clone after grid layout change\r\n            if (gameState.dragState.isDragging) {\r\n                const { clientX, clientY } = gameState.dragState;\r\n                if (clientX !== undefined && clientY !== undefined) {\r\n                    render.updateDraggedPiecePosition(clientX, clientY);\r\n                }\r\n            }\r\n        },\r\n        onDone: () => {\r\n            // After all clears finished, invoke onComplete callback\r\n            if (typeof onComplete === 'function') onComplete();\r\n            if (clearResult.comboCount > 1) {\r\n                render.showComboMessage(clearResult.comboCount);\r\n            }\r\n        },\r\n        syncStart: true // Start all animations at same time\r\n    });\r\n}\r\n\r\n// --- EARNING SPECIAL TOKENS ---\r\nfunction checkSpecialRewards(points, comboCount) {\r\n    const gameMode = localStorage.getItem('selectedGameMode') || 'collection';\r\n    \r\n    // Check for piece unlocks only in Collection Mode\r\n    if (gameMode === 'collection') {\r\n        pieceUnlockSystem.checkForUnlocks(gameState.score);\r\n    }\r\n    \r\n    // Every 1000 points earn a rotate\r\n    if (Math.floor(gameState.score / 1000) > Math.floor((gameState.score - points) / 1000)) {\r\n        gameState.rotateTokens++;\r\n    }\r\n    // Every 2000 points earn an undo\r\n    if (Math.floor(gameState.score / 2000) > Math.floor((gameState.score - points) / 2000)) {\r\n        gameState.undoTokens++;\r\n    }\r\n    // Combo >= 4 earns a clear line\r\n    if (comboCount >= 4) {\r\n        gameState.clearLineTokens++;\r\n    }\r\n    // Every 3000 points earn a hint\r\n    if (Math.floor(gameState.score / 3000) > Math.floor((gameState.score - points) / 3000)) {\r\n        gameState.hintTokens++;\r\n    }\r\n}\r\n\r\nfunction updateSpecialActionButtons() {\r\n    // Legacy button references (for backward compatibility)\r\n    const rotateBtn = document.getElementById('rotateBtn');\r\n    const undoBtn = document.getElementById('undoBtn');\r\n    const clearLineBtn = document.getElementById('clearLineBtn');\r\n    const flipBtn = document.getElementById('flipBtn');\r\n    \r\n    // FAB button references\r\n    const fabRotate = document.getElementById('fabRotate');\r\n    const fabUndo = document.getElementById('fabUndo');\r\n    const fabClearLine = document.getElementById('fabClearLine');\r\n    const fabFlip = document.getElementById('fabFlip');\r\n    const fabHint = document.getElementById('fabHint');\r\n    \r\n    // Update button states (legacy)\r\n    if (rotateBtn) {\r\n        rotateBtn.disabled = gameState.rotateTokens <= 0;\r\n        rotateBtn.classList.toggle('active-mode', gameState.specialModes.rotateMode);\r\n    }\r\n    if (undoBtn) undoBtn.disabled = gameState.undoTokens <= 0;\r\n    if (clearLineBtn) {\r\n        clearLineBtn.disabled = gameState.clearLineTokens <= 0;\r\n        clearLineBtn.classList.toggle('active-mode', gameState.specialModes.clearLineMode);\r\n    }\r\n    if (flipBtn) {\r\n        flipBtn.disabled = gameState.flipTokens <= 0;\r\n        flipBtn.classList.toggle('active-mode', gameState.specialModes.flipMode);\r\n    }\r\n    \r\n    // Update token counts (legacy)\r\n    const rotateCountEl = document.getElementById('rotateCount');\r\n    const undoCountEl = document.getElementById('undoCount');\r\n    const clearLineCountEl = document.getElementById('clearLineCount');\r\n    const flipCountEl = document.getElementById('flipCount');\r\n    \r\n    if (rotateCountEl) rotateCountEl.textContent = gameState.rotateTokens;\r\n    if (undoCountEl) undoCountEl.textContent = gameState.undoTokens;\r\n    if (clearLineCountEl) clearLineCountEl.textContent = gameState.clearLineTokens;\r\n    if (flipCountEl) flipCountEl.textContent = gameState.flipTokens;\r\n}\r\n\r\n// --- EVENT LISTENERS FOR SPECIAL BUTTONS ---\r\nfunction setupSpecialActionButtons() {\r\n    if (specialActionListenersAttached) {\r\n        return;\r\n    }\r\n\r\n    // Export globals for legacy integrations\r\n    window.initializeGame = initializeGame;\r\n    window.attachPieceEventListeners = attachPieceEventListeners;\r\n\r\n    // Rotate Button Handler\r\n    function handleRotateAction(e) {\r\n        if (gameState.rotateTokens > 0) {\r\n            // If already in rotate mode, clicking again cancels it.\r\n            if (gameState.specialModes.rotateMode) {\r\n                gameState.specialModes.rotateMode = false;\r\n                gameState.specialModes.isWaitingForRotate = false;\r\n                showSpecialModeMessage('rotate_cancel', null, 1500);\r\n            } else {\r\n                // Activate rotate mode. Deactivate all other modes.\r\n                gameState.specialModes.clearLineMode = false;\r\n                gameState.specialModes.hintMode = false;\r\n                gameState.specialModes.flipMode = false;\r\n                gameState.specialModes.rotateMode = true;\r\n                gameState.specialModes.isWaitingForRotate = true;\r\n                showSpecialModeMessage('rotate', null, 2000);\r\n            }\r\n            // Update UI for all cases\r\n            updateSpecialActionButtons();\r\n            attachPieceEventListeners();\r\n        }\r\n    }\r\n\r\n    // Undo Button Handler\r\n    function handleUndoAction(e) {\r\n        if (gameState.undoTokens > 0) {\r\n            // Show visual feedback\r\n            const undoBtn = e?.currentTarget || document.getElementById('undoBtn');\r\n            if (undoBtn) {\r\n                undoBtn.classList.add('active-mode');\r\n                setTimeout(() => undoBtn.classList.remove('active-mode'), 300);\r\n            }\r\n            \r\n            gameState.undoTokens--; // Consume the token immediately\r\n\r\n            if (logic.undoLastMove()) {\r\n                // State was successfully restored. Now update the UI to reflect it.\r\n                render.updateGridDisplay();\r\n                render.updatePiecesDisplay();\r\n                render.updateScoreDisplay();\r\n                updateSpecialActionButtons(); // This will show the new token count\r\n                attachPieceEventListeners();\r\n\r\n                showSpecialModeMessage('undo', 'Last move undone!', 2000);\r\n            } else {\r\n                // The undo failed (no history), so refund the token.\r\n                gameState.undoTokens++;\r\n                updateSpecialActionButtons(); // Also update UI on failure\r\n                showSpecialModeMessage('error', 'No moves to undo!', 2000);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Clear Line Button Handler\r\n    function handleClearLineAction() {\r\n        if (gameState.clearLineTokens > 0) {\r\n            // Toggle clear line mode\r\n            const activating = !gameState.specialModes.clearLineMode;\r\n            // Deactivate all other modes\r\n            gameState.specialModes.rotateMode = false;\r\n            gameState.specialModes.flipMode = false;\r\n            gameState.specialModes.hintMode = false;\r\n            gameState.specialModes.clearLineMode = activating;\r\n            gameState.specialModes.isWaitingForRotate = false;\r\n            gameState.specialModes.isWaitingForFlip = false;\r\n            gameState.specialModes.isWaitingForSelection = activating; // Set flag for grid cell click detection\r\n\r\n            if (activating) {\r\n                render.highlightClearableLines(); // Show which lines can be cleared\r\n                showSpecialModeMessage('clearLine'); // Show the instructional message\r\n            } else {\r\n                render.clearLineHighlights(); // Remove highlights\r\n                showSpecialModeMessage('clearLine_cancel', 'Clear line mode cancelled.', 2000);\r\n            }\r\n            // Update button styles and piece draggability\r\n            updateSpecialActionButtons();\r\n            attachPieceEventListeners();\r\n        }\r\n    }\r\n\r\n    // Flip Button Handler (Enter flip mode, then click piece to rotate 180)\r\n    function handleFlipAction(e) {\r\n        if (gameState.flipTokens > 0) {\r\n            // If already in flip mode, clicking again cancels it.\r\n            if (gameState.specialModes.flipMode) {\r\n                gameState.specialModes.flipMode = false;\r\n                gameState.specialModes.isWaitingForFlip = false;\r\n                showSpecialModeMessage('flip_cancel', 'Flip mode cancelled', 1500);\r\n            } else {\r\n                // Activate flip mode. Deactivate all other modes.\r\n                gameState.specialModes.rotateMode = false;\r\n                gameState.specialModes.clearLineMode = false;\r\n                gameState.specialModes.flipMode = true;\r\n                gameState.specialModes.isWaitingForFlip = true;\r\n                showSpecialModeMessage('flip', 'Click a piece to flip it', 2000);\r\n            }\r\n            // Update UI for all cases\r\n            updateSpecialActionButtons();\r\n            attachPieceEventListeners();\r\n        }\r\n    }\r\n\r\n\r\n    // Wire up buttons (legacy + FAB variants)\r\n    const legacyRotateBtn = document.getElementById('rotateBtn');\r\n    if (legacyRotateBtn) {\r\n        legacyRotateBtn.addEventListener('click', handleRotateAction);\r\n        legacyRotateBtn.addEventListener('touchend', (e) => {\r\n            e.preventDefault();\r\n            handleRotateAction(e);\r\n        });\r\n    }\r\n\r\n    const fabRotateBtn = document.getElementById('fabRotate');\r\n    if (fabRotateBtn) {\r\n        fabRotateBtn.addEventListener('click', handleRotateAction);\r\n        fabRotateBtn.addEventListener('touchend', (e) => {\r\n            e.preventDefault();\r\n            handleRotateAction(e);\r\n        });\r\n    }\r\n\r\n    const legacyUndoBtn = document.getElementById('undoBtn');\r\n    if (legacyUndoBtn) {\r\n        legacyUndoBtn.addEventListener('click', handleUndoAction);\r\n        legacyUndoBtn.addEventListener('touchend', (e) => {\r\n            e.preventDefault();\r\n            handleUndoAction(e);\r\n        });\r\n    }\r\n\r\n    const fabUndoBtn = document.getElementById('fabUndo');\r\n    if (fabUndoBtn) {\r\n        fabUndoBtn.addEventListener('click', handleUndoAction);\r\n        fabUndoBtn.addEventListener('touchend', (e) => {\r\n            e.preventDefault();\r\n            handleUndoAction(e);\r\n        });\r\n    }\r\n\r\n    const legacyClearLineBtn = document.getElementById('clearLineBtn');\r\n    if (legacyClearLineBtn) {\r\n        legacyClearLineBtn.addEventListener('click', handleClearLineAction);\r\n        legacyClearLineBtn.addEventListener('touchend', (e) => {\r\n            e.preventDefault();\r\n            handleClearLineAction(e);\r\n        });\r\n    }\r\n\r\n    const fabClearLineBtn = document.getElementById('fabClearLine');\r\n    if (fabClearLineBtn) {\r\n        fabClearLineBtn.addEventListener('click', handleClearLineAction);\r\n        fabClearLineBtn.addEventListener('touchend', (e) => {\r\n            e.preventDefault();\r\n            handleClearLineAction(e);\r\n        });\r\n    }\r\n\r\n    const legacyFlipBtn = document.getElementById('flipBtn');\r\n    if (legacyFlipBtn) {\r\n        legacyFlipBtn.addEventListener('click', handleFlipAction);\r\n        legacyFlipBtn.addEventListener('touchend', (e) => {\r\n            e.preventDefault();\r\n            handleFlipAction(e);\r\n        });\r\n    }\r\n\r\n    const fabFlipBtn = document.getElementById('fabFlip');\r\n    if (fabFlipBtn) {\r\n        fabFlipBtn.addEventListener('click', handleFlipAction);\r\n        fabFlipBtn.addEventListener('touchend', (e) => {\r\n            e.preventDefault();\r\n            handleFlipAction(e);\r\n        });\r\n    }\r\n\r\n\r\n\r\n    specialActionListenersAttached = true;\r\n}\r\n\r\nwhenDomReady(setupSpecialActionButtons);\r\n\r\n// --- Event Listener Setup ---\r\n\r\n// Global event delegation for piece clicks\r\nfunction handleDelegatedPieceClick(event) {\r\n    // Find the piece element\r\n    const pieceElement = event.target.closest('.piece');\r\n    \r\n    if (!pieceElement || pieceElement.classList.contains('empty')) {\r\n        return;\r\n    }\r\n    \r\n    // Call the original handler with modified event\r\n    const syntheticEvent = {\r\n        ...event,\r\n        target: pieceElement,\r\n        currentTarget: pieceElement\r\n    };\r\n    \r\n    handlePieceClick(syntheticEvent);\r\n}\r\n\r\n// Touch event delegation for mobile piece interactions\r\nfunction handleDelegatedPieceTouch(event) {\r\n    // Only handle if we're in a special mode where drag is disabled\r\n    const inSpecialMode = gameState.specialModes.rotateMode || gameState.specialModes.flipMode || gameState.specialModes.clearLineMode || gameState.specialModes.hintMode;\r\n    if (!inSpecialMode) {\r\n        return; // Let touchstart handler handle normal drag\r\n    }\r\n    \r\n    // Prevent default to avoid ghost clicks\r\n    event.preventDefault();\r\n    \r\n    // Find the piece element\r\n    const pieceElement = event.target.closest('.piece');\r\n    \r\n    if (!pieceElement || pieceElement.classList.contains('empty')) {\r\n        return;\r\n    }\r\n    \r\n    // Call the original handler with modified event\r\n    const syntheticEvent = {\r\n        ...event,\r\n        target: pieceElement,\r\n        currentTarget: pieceElement\r\n    };\r\n    \r\n    handlePieceClick(syntheticEvent);\r\n}\r\n\r\nfunction attachPieceEventListeners() {\r\n    // Setup event delegation on pieces container\r\n    const piecesContainer = document.querySelector('.pieces-container');\r\n    if (piecesContainer) {\r\n        // Always remove existing listener first to prevent duplicates\r\n        piecesContainer.removeEventListener('click', handleDelegatedPieceClick);\r\n        piecesContainer.addEventListener('click', handleDelegatedPieceClick);\r\n        \r\n        // Add touch event delegation for mobile special modes\r\n        piecesContainer.removeEventListener('touchend', handleDelegatedPieceTouch);\r\n        piecesContainer.addEventListener('touchend', handleDelegatedPieceTouch, { passive: false });\r\n    }\r\n    \r\n    // Still attach drag listeners directly to pieces\r\n    const pieces = document.querySelectorAll('.piece:not(.empty)');\r\n    \r\n    pieces.forEach((piece, index) => {\r\n        \r\n        // Disable drag on pieces if in special modes to allow clicks\r\n        const shouldDisableDrag = gameState.specialModes.rotateMode || gameState.specialModes.flipMode || gameState.specialModes.clearLineMode || gameState.specialModes.hintMode;\r\n        // Always disable HTML5 drag to avoid conflicts with custom mouse handling\r\n        piece.setAttribute('draggable', 'false');\r\n        \r\n        // ALWAYS remove existing listeners first to prevent memory leaks\r\n        piece.removeEventListener('dragstart', handleDragStart);\r\n        piece.removeEventListener('mousedown', handleDragStart);\r\n        piece.removeEventListener('touchstart', handleDragStart);\r\n        \r\n        // Add drag listeners only when not in special modes\r\n        if (!shouldDisableDrag) {\r\n            // Don't add dragstart listener - we're using custom mouse handling\r\n            piece.addEventListener('mousedown', handleDragStart);\r\n            piece.addEventListener('touchstart', handleTouchStart, { passive: false });\r\n        }\r\n        \r\n    });\r\n    \r\n    // Mark listeners as attached\r\n    listenersAttached = true;\r\n}\r\n\r\n// Entry point of the application\r\n\r\n// --- THEME SETUP (ADDED SECTION) ---\r\nfunction setupLegacyLandingFlow() {\r\n    if (legacyLandingSetupDone) {\r\n        return;\r\n    }\r\n\r\n    render.cacheDOMElements();\r\n    render.createGridDOM();\r\n\r\n    const initialTheme = localStorage.getItem('blokusTheme') || 'default';\r\n    if (initialTheme === 'magic-universe') {\r\n        activateMagicUniverseBackground();\r\n    }\r\n\r\n    updateLandingPageStats();\r\n\r\n    const dom = render.dom;\r\n\r\n    // Game Mode Selection Handlers - kept for backward compatibility with older landing layout\r\n    const classicModeCard = document.getElementById('classicMode');\r\n    const collectionModeCard = document.getElementById('collectionMode');\r\n    const feedbackElement = document.querySelector('.feedback');\r\n\r\n    if (classicModeCard && collectionModeCard) {\r\n        const savedMode = localStorage.getItem('selectedGameMode');\r\n        if (savedMode) {\r\n            selectGameMode(savedMode);\r\n        }\r\n\r\n        function selectGameMode(mode) {\r\n            selectedGameMode = mode;\r\n\r\n            localStorage.setItem('selectedGameMode', selectedGameMode);\r\n\r\n            if (feedbackElement) {\r\n                feedbackElement.style.display = 'none';\r\n                feedbackElement.textContent = '';\r\n            }\r\n\r\n            document.querySelectorAll('.card.selectable').forEach(card => {\r\n                card.classList.remove('selected');\r\n            });\r\n\r\n            if (mode === 'classic') {\r\n                classicModeCard.classList.add('selected');\r\n            } else if (mode === 'collection') {\r\n                collectionModeCard.classList.add('selected');\r\n            }\r\n\r\n            if (dom.startButton) {\r\n                dom.startButton.classList.remove('hidden');\r\n                dom.startButton.disabled = false;\r\n                dom.startButton.innerHTML = `<i class=\"fas fa-play-circle\"></i> Start ${mode === 'classic' ? 'Classic' : 'Collection'}`;\r\n                dom.startButton.style.transform = 'scale(1.05)';\r\n                setTimeout(() => {\r\n                    dom.startButton.style.transform = 'scale(1)';\r\n                }, 300);\r\n            }\r\n        }\r\n\r\n        // Legacy event listeners remain disabled intentionally (handled via landing.js)\r\n    }\r\n\r\n    if (dom.gameOverRestartButton) {\r\n        dom.gameOverRestartButton.addEventListener('click', () => {\r\n            // Hide special-actions container when returning to landing\r\n            const specialActions = document.querySelector('.special-actions');\r\n            if (specialActions) specialActions.classList.add('hidden');\r\n\r\n            dom.landingPage.classList.remove('hidden');\r\n            dom.gameContainer.classList.add('hidden');\r\n\r\n            initializeGame();\r\n        });\r\n    }\r\n\r\n    document.body.addEventListener('click', audio.initAudioContext, { once: true });\r\n    document.body.addEventListener('touchstart', audio.initAudioContext, { once: true });\r\n\r\n    legacyLandingSetupDone = true;\r\n}\r\n\r\nwhenDomReady(setupLegacyLandingFlow);\r\n\r\ndocument.addEventListener('touchmove', function(event) {\r\n    if (gameState.dragState && gameState.dragState.isDragging && event.scale !== 1) {\r\n        event.preventDefault();\r\n    }\r\n}, { passive: false });\r\n\r\n// --- FUNCTIONS FOR SPECIAL MODES ---\r\n\r\nfunction attachGridEventListeners() {\r\n    // Attach drag & drop listeners to the main grid container\r\n    if (dom.gameGrid) {\r\n        // Remove existing listeners first to prevent duplicates\r\n        dom.gameGrid.removeEventListener('dragover', handleDragOver);\r\n        dom.gameGrid.removeEventListener('drop', handleDrop);\r\n        dom.gameGrid.removeEventListener('dragend', handleDragEnd);\r\n        \r\n        // Add drag & drop listeners\r\n        dom.gameGrid.addEventListener('dragover', handleDragOver);\r\n        dom.gameGrid.addEventListener('drop', handleDrop);\r\n        dom.gameGrid.addEventListener('dragend', handleDragEnd);\r\n    }\r\n    \r\n    // Add global dragend listener to handle drops outside the grid\r\n    document.removeEventListener('dragend', handleDragEnd);\r\n    document.addEventListener('dragend', handleDragEnd);\r\n    \r\n    // Add global mouseup listener as backup for desktop drag operations\r\n    document.removeEventListener('mouseup', handleDragEndFallback);\r\n    document.addEventListener('mouseup', handleDragEndFallback);\r\n    \r\n    // Attach click listeners to individual grid cells (for special modes)\r\n    const gridCells = document.querySelectorAll('.grid-cell');\r\n    gridCells.forEach(cell => {\r\n        // Remove existing listener first to prevent duplicates\r\n        cell.removeEventListener('click', handleGridCellClick);\r\n        cell.addEventListener('click', handleGridCellClick);\r\n    });\r\n}\r\n\r\nfunction handleGridCellClick(event) {\r\n    if (!gameState.specialModes.clearLineMode || !gameState.specialModes.isWaitingForSelection) return;\r\n    \r\n    // Find the actual grid-cell (could be .grid-cell-block that was clicked)\r\n    let cell = event.target;\r\n    if (!cell.classList.contains('grid-cell')) {\r\n        cell = cell.closest('.grid-cell');\r\n    }\r\n    \r\n    if (!cell || !cell.classList.contains('grid-cell')) {\r\n        return;\r\n    }\r\n    \r\n    const row = parseInt(cell.dataset.row);\r\n    const col = parseInt(cell.dataset.col);\r\n\r\n    // Save state for undo\r\n    logic.saveGameState();\r\n    gameState.clearLineTokens--;\r\n\r\n    // Pastro t gjitha qelizat n rresht dhe kolon\r\n    const clearedCells = [];\r\n    const clearedRows = [];\r\n    const clearedCols = [];\r\n    \r\n    // Check if entire row should be cleared\r\n    let shouldClearRow = false;\r\n    for (let c = 0; c < gameState.grid[0].length; c++) {\r\n        if (gameState.grid[row][c] !== 0) {\r\n            shouldClearRow = true;\r\n            break;\r\n        }\r\n    }\r\n    \r\n    // Check if entire column should be cleared\r\n    let shouldClearCol = false;\r\n    for (let r = 0; r < gameState.grid.length; r++) {\r\n        if (gameState.grid[r][col] !== 0) {\r\n            shouldClearCol = true;\r\n            break;\r\n        }\r\n    }\r\n\r\n    if (!shouldClearRow && !shouldClearCol) {\r\n        // Asgj pr t'u pastruar - kthe token-in dhe dil shpejt pa hedhur gabime\r\n        gameState.clearLineTokens++;\r\n        updateSpecialActionButtons();\r\n        showSpecialModeMessage('clearLine_cancel', 'Nuk ka linja t mbushura n kt qeliz.', 2000);\r\n        gameState.specialModes.clearLineMode = false;\r\n        gameState.specialModes.isWaitingForSelection = false;\r\n        render.clearLineHighlights();\r\n        return;\r\n    }\r\n    \r\n    // Mark rows/cols to clear; don't mutate grid now. We'll clear per-line in animation callbacks.\r\n    if (shouldClearRow) {\r\n        clearedRows.push(row);\r\n        for (let c = 0; c < gameState.grid[0].length; c++) {\r\n            if (gameState.grid[row][c] !== 0) {\r\n                clearedCells.push({ row, col: c, animationColor: 'rgba(198,140,83,1)' });\r\n            }\r\n        }\r\n    }\r\n    if (shouldClearCol) {\r\n        clearedCols.push(col);\r\n        for (let r = 0; r < gameState.grid.length; r++) {\r\n            if (gameState.grid[r][col] !== 0) {\r\n                if (!clearedCells.some(cell => cell.row === r && cell.col === col)) {\r\n                    clearedCells.push({ row: r, col, animationColor: 'rgba(198,140,83,1)' });\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Do NOT immediately update the grid DOM: keep previous visuals so the canvas\r\n    // animation can sample the filled cell colors and produce identical visuals\r\n    updateSpecialActionButtons();\r\n\r\n    // Use the new canvas animation system for clear line effect\r\n    if (clearedRows.length > 0 || clearedCols.length > 0) {\r\n        const clearResult = {\r\n            cellsToAnimate: clearedCells,\r\n            pointsEarned: 0, // No points for manual clear\r\n            comboCount: 1,\r\n            totalLinesCleared: clearedRows.length + clearedCols.length,\r\n            clearedRows: clearedRows,\r\n            clearedCols: clearedCols,\r\n            // Post animation hook will update DOM/UI once canvas completes\r\n            _postAnimation: () => {\r\n                render.updateGridDisplay();\r\n                updateSpecialActionButtons();\r\n            }\r\n        };\r\n        \r\n        // Use the same animation system as natural line clears\r\n        handleLineClearEffects(clearResult);\r\n    }\r\n\r\n    showSpecialModeMessage('clearLine_success', `Row ${row + 1} and Column ${col + 1} cleared!`, 2000);\r\n    audio.playClearSound(1);\r\n\r\n    // Reset clear line mode pas veprimit\r\n    gameState.specialModes.clearLineMode = false;\r\n    gameState.specialModes.isWaitingForSelection = false;\r\n    updateSpecialActionButtons();\r\n    render.clearLineHighlights();\r\n}\r\n\r\n// --- HELPER FUNCTIONS FOR SPECIAL MESSAGES ---\r\nfunction showSpecialModeMessage(type, message, autoHideDelay = null) {\r\n    // Creates or updates the special mode message\r\n    let messageElement = document.getElementById('specialModeMessage');\r\n    if (!messageElement) {\r\n        messageElement = document.createElement('div');\r\n        messageElement.id = 'specialModeMessage';\r\n        messageElement.className = 'special-mode-message';\r\n        document.body.appendChild(messageElement);\r\n    }\r\n    \r\n    // Clear any existing timeout\r\n    if (messageElement.hideTimeout) {\r\n        clearTimeout(messageElement.hideTimeout);\r\n        messageElement.hideTimeout = null;\r\n    }\r\n    \r\n    // Enhanced message mapping with better instructions\r\n    const englishMessages = {\r\n        rotate: 'ROTATE MODE: Click any piece to rotate it',\r\n        rotate_cancel: 'Rotate mode cancelled',\r\n        clearLine: 'CLEAR LINE MODE: Click any cell in a complete row/column to clear it',\r\n        clearLine_success: 'Line cleared successfully!',\r\n        clearLine_cancel: 'Clear line mode cancelled',\r\n        undo: 'Last move undone successfully!',\r\n        swap: 'All pieces swapped successfully!',\r\n        error: 'Action failed - please try again'\r\n    };\r\n    const displayMsg = message || englishMessages[type] || 'Special action activated';\r\n    \r\n    messageElement.textContent = displayMsg;\r\n    messageElement.className = `special-mode-message ${type}`;\r\n    messageElement.classList.remove('hidden');\r\n    \r\n    // Auto-hide if delay is specified\r\n    if (autoHideDelay) {\r\n        messageElement.hideTimeout = setTimeout(() => {\r\n            messageElement.classList.add('hidden');\r\n            messageElement.hideTimeout = null;\r\n        }, autoHideDelay);\r\n    }\r\n}\r\n\r\n// Eksporto funksionin globalisht pr prdorim n gameLogic.js\r\nwindow.showSpecialModeMessage = showSpecialModeMessage;\r\n\r\n// --- FUNCTIONS FOR GAME STATE MANAGEMENT ---\r\n// DELETED: Redundant undoLastMove, saveGameState, loadGameState, and other game logic functions.\r\n// All game logic has been centralized in `gameLogic.js` to avoid conflicts and bugs.\r\n// The event listeners in this file now correctly call functions from the `logic` module.\r\n\r\nfunction populateInitialPieces() {\r\n    const pieceShapes = [\r\n        [ // First shape\r\n            [1, 1, 1],\r\n            [0, 1, 0],\r\n            [0, 1, 0]\r\n        ],\r\n        [ // Second shape\r\n            [0, 2, 2],\r\n            [0, 2, 0],\r\n            [0, 2, 0]\r\n        ],\r\n        [ // Third shape\r\n            [3, 3, 0],\r\n            [0, 3, 3],\r\n            [0, 0, 0]\r\n        ],\r\n        [ // Fourth shape\r\n            [0, 4, 0],\r\n            [4, 4, 4],\r\n            [0, 0, 0]\r\n        ],\r\n        [ // Fifth shape\r\n            [5, 5, 5],\r\n            [5, 0, 0],\r\n            [0, 0, 0]\r\n        ],\r\n        [ // Sixth shape\r\n            [0, 0, 6],\r\n            [0, 6, 6],\r\n            [0, 6, 0]\r\n        ],\r\n        [ // Seventh shape\r\n            [7, 0, 0],\r\n            [7, 7, 7],\r\n            [0, 0, 0]\r\n        ]\r\n    ];\r\n\r\n    // Populate current pieces with random shapes from pieceShapes\r\n    gameState.currentPieces = gameState.currentPieces.map((piece, index) => {\r\n        const shapeIndex = index % pieceShapes.length;\r\n        return {\r\n            currentShape: pieceShapes[shapeIndex],\r\n            previousPosition: { row: -1, col: -1 },\r\n            isEmpty: false\r\n        };\r\n    });\r\n}\r\n\r\n// --- FUNCTIONS FOR REFILLING THE GAME WITH NEW PIECES ---\r\nfunction refillPieces() {\r\n    gameState.currentPieces = gameState.currentPieces.map(piece => {\r\n        if (piece.isEmpty) {\r\n            // Create a new piece with a random shape\r\n            const randomShapeIndex = Math.floor(Math.random() * gameState.availableShapes.length);\r\n            const newShape = gameState.availableShapes[randomShapeIndex];\r\n            return {\r\n                currentShape: newShape,\r\n                previousPosition: { row: -1, col: -1 },\r\n                isEmpty: false\r\n            };\r\n        }\r\n        return piece;\r\n    });\r\n}\r\n\r\n// --- FUNCTIONS FOR APPLYING THEMES ---\r\nfunction applyTheme(themeName) {\r\n    const root = document.documentElement;\r\n    root.className = ''; // Remove any existing class\r\n    root.classList.add(`theme-${themeName}`);\r\n}\r\n\r\n// --- FUNCTIONS FOR ROTATING A SPECIFIC PIECE ---\r\nfunction rotateSpecificPiece(pieceIndex) {\r\n    const piece = gameState.currentPieces[pieceIndex];\r\n    if (!piece || piece.isEmpty) return false;\r\n    \r\n    // Save state before rotation for undo\r\n    logic.saveGameState();\r\n    \r\n    // Rotate the piece shape in the correct direction\r\n    const newShape = piece.currentShape[0].map((val, index) => \r\n        piece.currentShape.map(row => row[index]).reverse()\r\n    );\r\n    \r\n    // Check if the new placement is valid\r\n    if (logic.isValidPlacement(newShape, piece.previousPosition.row, piece.previousPosition.col)) {\r\n        piece.currentShape = newShape;\r\n        render.updatePiecesDisplay();\r\n        return true;\r\n    } else {\r\n        // If rotation is not valid, revert to original shape\r\n        logic.undoLastMove();\r\n        return false;\r\n    }\r\n}\r\n\r\n// --- FUNCTIONS FOR PLAYING WITH SPECIAL CARDS ---\r\nfunction playCardEffect(cardName) {\r\n    switch(cardName) {\r\n        case 'doubleScore':\r\n            gameState.score *= 2;\r\n            render.updateScoreDisplay();\r\n            showSpecialModeMessage('score', 'Points doubled!', 2000);\r\n            break;\r\n        case 'resetGrid':\r\n            logic.saveGameState();\r\n            gameState.grid = logic.createEmptyGrid();\r\n            logic.clearAllCaches();\r\n            render.updateGridDisplay();\r\n            showSpecialModeMessage('grid', 'Grid reset!', 2000);\r\n            break;\r\n        case 'extraRotate':\r\n            gameState.rotateTokens++;\r\n            updateSpecialActionButtons();\r\n            showSpecialModeMessage('rotate', 'Extra rotate granted!', 2000);\r\n            break;\r\n        case 'swapPieces':\r\n            logic.saveGameState();\r\n            logic.populateInitialPieces();\r\n            render.updatePiecesDisplay();\r\n            showSpecialModeMessage('swap', 'Pieces swapped!', 2000);\r\n            break;\r\n        case 'clearLine': {\r\n            const randomRow = Math.floor(Math.random() * GRID_ROWS);\r\n            \r\n            if (logic.clearRowOrColumn(randomRow, true)) {\r\n                // Use animation system instead of direct updateGridDisplay\r\n                const clearResult = {\r\n                    clearedRows: [randomRow],\r\n                    clearedCols: [],\r\n                    totalLinesCleared: 1,\r\n                    comboCount: 1,\r\n                    pointsEarned: 100\r\n                };\r\n                handleLineClearEffects(clearResult, () => {\r\n                    showSpecialModeMessage('clearLine', `Row ${randomRow + 1} cleared!`, 2000);\r\n                });\r\n            }\r\n            break;\r\n        }\r\n        case 'horizontalClear': {\r\n            const randomRow = Math.floor(Math.random() * GRID_ROWS);\r\n            \r\n            if (logic.clearRowOrColumn(randomRow, true)) {\r\n                // Use animation system\r\n                const clearResult = {\r\n                    clearedRows: [randomRow],\r\n                    clearedCols: [],\r\n                    totalLinesCleared: 1,\r\n                    comboCount: 1,\r\n                    pointsEarned: 100\r\n                };\r\n                handleLineClearEffects(clearResult, () => {\r\n                    showSpecialModeMessage('clearLine', `Row ${randomRow + 1} cleared horizontally!`, 2000);\r\n                });\r\n            }\r\n            break;\r\n        }\r\n        case 'verticalClear': {\r\n            const randomCol = Math.floor(Math.random() * GRID_COLS);\r\n            \r\n            if (logic.clearRowOrColumn(randomCol, false)) {\r\n                // Use animation system\r\n                const clearResult = {\r\n                    clearedRows: [],\r\n                    clearedCols: [randomCol],\r\n                    totalLinesCleared: 1,\r\n                    comboCount: 1,\r\n                    pointsEarned: 100\r\n                };\r\n                handleLineClearEffects(clearResult, () => {\r\n                    showSpecialModeMessage('clearLine', `Column ${randomCol + 1} cleared vertically!`, 2000);\r\n                });\r\n            }\r\n            break;\r\n        }\r\n        case 'fullClear':\r\n            logic.saveGameState();\r\n            gameState.grid = logic.createEmptyGrid();\r\n            logic.clearAllCaches();\r\n            render.updateGridDisplay();\r\n            showSpecialModeMessage('clearLine', 'Entire grid cleared!', 2000);\r\n            break;\r\n        case 'rowShift': {\r\n            const randomCol = Math.floor(Math.random() * GRID_COLS);\r\n            const direction = Math.random() < 0.5 ? 1 : -1;\r\n            logic.saveGameState();\r\n            if (logic.shiftColumn(randomCol, direction)) {\r\n                render.updateGridDisplay();\r\n                showSpecialModeMessage('shift', `Column ${randomCol + 1} shifted ${direction === 1 ? 'up' : 'down'}!`, 2000);\r\n            }\r\n            break;\r\n        }\r\n        default:\r\n            break;\r\n    }\r\n}\r\n\r\n/**\r\n * Comprehensive cleanup function to remove all event listeners and DOM elements\r\n * Call this when restarting the game or when the page is about to unload\r\n */\r\nfunction cleanupGameResources() {\r\n    // Clean up touch listeners\r\n    cleanupTouchListeners();\r\n    \r\n    // Clean up global drag listeners\r\n    document.removeEventListener('dragend', handleDragEnd);\r\n    document.removeEventListener('mouseup', handleDragEndFallback);\r\n    document.removeEventListener('mousemove', handleMouseMove);\r\n    document.removeEventListener('mouseup', handleMouseUp);\r\n    window.removeEventListener('mouseup', handleMouseUp);\r\n    document.removeEventListener('mouseleave', handleMouseUp);\r\n    if ('onpointerup' in window) {\r\n        document.removeEventListener('pointerup', handleMouseUp);\r\n    }\r\n    \r\n    // Clean up any remaining particles\r\n    if (typeof render.cleanupOldParticles === 'function') {\r\n        render.cleanupOldParticles();\r\n    }\r\n    \r\n    // Clean up floating score elements\r\n    if (typeof render.cleanupOldFloatingScores === 'function') {\r\n        render.cleanupOldFloatingScores();\r\n    }\r\n    \r\n    // Clean up any remaining floating score elements manually\r\n    document.querySelectorAll('.floating-score').forEach(element => {\r\n        element.remove();\r\n    });\r\n    \r\n    // Clean up unlock progress indicator\r\n    const unlockProgress = document.getElementById('unlock-progress');\r\n    if (unlockProgress) {\r\n        unlockProgress.remove();\r\n    }\r\n    \r\n    // Clean up highlights and visual states\r\n    render.clearHighlights();\r\n    render.clearLineHighlights();\r\n    \r\n    // Reset listener attachment tracking\r\n    listenersAttached = false;\r\n    \r\n    // Reset drag state completely\r\n    if (gameState.dragState) {\r\n        resetDragState();\r\n    }\r\n}\r\n\r\n// Clean up resources when page unloads\r\nwindow.addEventListener('beforeunload', cleanupGameResources);\r\n\r\n// Track if listeners are already attached to prevent duplicate attachments\r\nlet listenersAttached = false;\r\ndocument.addEventListener('lines:cleared', () => import('./nativeBridge.js').then(m=>m.hapticSuccess&&m.hapticSuccess()).catch(()=>{}));\r\ndocument.addEventListener('combo:achieved', e => import('./nativeBridge.js').then(m=>{ if(e.detail?.lines>=3 && m.hapticHeavy) m.hapticHeavy(); else if(m.hapticSuccess) m.hapticSuccess(); }).catch(()=>{}));\r\ndocument.addEventListener('game:over', () => import('./nativeBridge.js').then(m=>m.hapticHeavy&&m.hapticHeavy()).catch(()=>{}));\r\n\r\n// DEBUG: Log dimensionet e .game-container n desktop\r\nwindow.addEventListener('DOMContentLoaded', () => {\r\n  if (window.innerWidth >= 900) {\r\n    const gc = document.querySelector('.game-container');\r\n    if (gc) {\r\n      const rect = gc.getBoundingClientRect();\r\n      // Debug logs removed for production\r\n    }\r\n  }\r\n});\r\n\r\n// Handle responsive CSS reload when viewport crosses breakpoints (for DevTools testing)\r\nlet lastBreakpoint = window.innerWidth <= 768 ? 'mobile' : 'desktop';\r\nlet resizeDebounce;\r\n\r\nwindow.addEventListener('resize', () => {\r\n    clearTimeout(resizeDebounce);\r\n    resizeDebounce = setTimeout(() => {\r\n        const currentBreakpoint = window.innerWidth <= 768 ? 'mobile' : 'desktop';\r\n        \r\n        if (currentBreakpoint !== lastBreakpoint) {\r\n            // Breakpoint changed - force CSS re-evaluation\r\n            const mobileCssLink = document.querySelector('link[href*=\"mobile.css\"]');\r\n            const desktopCssLink = document.querySelector('link[href*=\"desktop.css\"]');\r\n            \r\n            if (currentBreakpoint === 'mobile' && mobileCssLink) {\r\n                // Force mobile.css to re-apply by toggling media attribute\r\n                mobileCssLink.media = 'all';\r\n                setTimeout(() => mobileCssLink.media = '(max-width:768px)', 0);\r\n            } else if (currentBreakpoint === 'desktop' && desktopCssLink) {\r\n                // Force desktop.css to re-apply\r\n                desktopCssLink.media = 'all';\r\n                setTimeout(() => desktopCssLink.media = '(min-width:769px)', 0);\r\n            }\r\n            \r\n            // Force layout recalculation\r\n            requestAnimationFrame(() => {\r\n                const gameContainer = document.querySelector('.game-container');\r\n                const gameArea = document.querySelector('.game-area');\r\n                const gameGrid = document.getElementById('gameGrid');\r\n                \r\n                [gameContainer, gameArea, gameGrid].forEach(el => {\r\n                    if (el) void el.offsetHeight;\r\n                });\r\n            });\r\n            \r\n            lastBreakpoint = currentBreakpoint;\r\n        }\r\n    }, 300);\r\n});\r\n"],"file":"assets/main-BkIJmi97.js"}